# 第三章：探索渗透测试和 AWS

欢迎来到旅程的下一部分。在这里，我们将开始应用我们从前两章中学到的知识，并开始进一步了解有关渗透测试和 AWS 的知识。重要的是您理解前两章，因为我们将在本书中构建更多实例，并将使用您在*第二章**，渗透测试和道德黑客*中阅读到的渗透测试方法。

在本章中，我们将专注于从我们构建的主机以及其他一般系统中扫描和枚举信息的含义。扫描和枚举是渗透测试中最重要的步骤之一，因此我们必须沿着侦察的道路前行，以了解各种枚举和了解我们的枚举策略。我们还将了解渗透测试和对抗性评估以及心态中的各种攻击路径。重要的是要理解，侦察和枚举在创建可能导致客户妥协并暴露之前管理员可能忽视的威胁的攻击路径中起着重要作用。

在本章中，我们将学习以下内容：

+   侦察

+   枚举和 AWS 服务

+   扫描和检查目标

+   创建攻击路径

+   SSH 密钥

+   扫描和连接到 AWS

+   从经验中学习

# 技术要求

要按照本章的说明进行操作，您将需要以下内容：

+   Metasploit：[`github.com/rapid7/metasploit-framework/blob/master//modules/post/multi/gather/aws_ec2_instance_metadata.rb`](https://github.com/rapid7/metasploit-framework/blob/master//modules/post/multi/gather/aws_ec2_instance_metadata.rb)

+   LambdaGuard：[`github.com/Skyscanner/LambdaGuard`](https://github.com/Skyscanner/LambdaGuard)

查看以下视频以查看代码的实际应用：[`bit.ly/3eicsXx`](https://bit.ly/3eicsXx)

# 探索侦察

**侦察**，通常也被称为**侦察**，涉及使用工具来收集有关目标的信息，这些信息可以用来对目标获得优势。侦察使您可以像詹姆斯·邦德一样行事，并允许您收集有关目标的情报。如*第二章**，渗透测试和道德黑客*中所述，在白盒测试中，测试人员将了解有关目标的一切。最好使用搜索客户可能忘记告诉您的信息的工具，或者让我们查看客户可能认为不重要的开放源信息。各种组织将确定什么是重要的，什么不重要-这不是“一刀切”的交易。让我们讨论一种简单的侦察方法，可以应用于大多数组织。

## 驱动枚举以进行侦察

在进行成功的侦察时，您必须确保尽可能多地发现信息。这意味着您需要寻找对客户有影响的事物，并继续搜索，直到您获得足够的信息以继续前进。结果因渗透测试而异，因此您必须根据“足够”信息的判断。以下是进行基本侦察和信息收集的基本方法：

+   查找有关目标网站的信息。查找电子邮件地址，电话号码以及任何可用于直接联系客户的信息。

+   使用其他工具自动化发现信息的过程，例如 DNS，开放的 S3 存储桶，员工姓名，电话号码，电子邮件地址，街道地址等等！

+   使用您选择的工具记下笔记，以便稍后在您的渗透测试中使用。

按照这些步骤将允许你对客户或目标执行适当的侦察，并帮助你创建一个更好的攻击路径，从而导致对整个系统的完全妥协。现在我们已经讨论了这些步骤，让我们来看看一些我们可以用于侦察的工具。

重要提示

在渗透测试过程中，你会发现各种服务器的记录。虽然这与本书无关，但了解不同的记录类型是很有好处的。在这里查看更多信息：[`docs.aws.amazon.com/Route53/latest/DeveloperGuide/ResourceRecordTypes.html`](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/ResourceRecordTypes.html)。

## 收集电子邮件地址

在渗透测试过程中收集电子邮件地址可能非常重要。收集电子邮件地址可以让你看到谁在目标公司工作，以及如何直接联系他们。攻击者使用这种方法来钓鱼组织，并试图诱使用户登录到一个假网站或点击某种恶意软件。对于渗透测试，我们使用它来全面了解公开的情况，以便与客户讨论，除非目标明确要求进行钓鱼。

我们将使用一个名为**theHarvester**的工具来执行这个任务。theHarvester 允许我们通过查询特定的数据库来收集有关目标的各种信息。在我们的案例中，我们将以公司 Packt Publishing 为目标，看看我们能找到什么。

要开始，请按照以下步骤操作：

1.  打开你的 Kali Linux 机器。

1.  在机器上打开一个终端。

1.  输入以下命令：

```
theHarvester command, you'll see a list of names that have been retrieved from LinkedIn based on individuals that work with or for Packt Publishing. An attacker could use this list to gather more information, such as emails, phone numbers, and even physical addresses: ![Figure 3.1 – Output from theHarvester    ](img/Figure_3.01_B15630.jpg)Figure 3.1 – Output from theHarvesterAs you can see, we didn't manage to find any emails, but we did discover some employees. Now that we know employees' names, let's see what we can query using two popular search engines. 
```

1.  我们将使用 Google 和 Yahoo 来查询信息：

```
$ theHarvester -d packtpub.com -l 100 -b yahoo,google
```

与之前的尝试一样，我们正在使用 theHarvester 来帮助我们找到我们或攻击者可以用来帮助映射攻击路径的现成信息。在这种情况下，我们正在使用该工具来查找任何潜在的域和 IP 地址，以便映射潜在的攻击：

![图 3.2 - 来自 Google 和 Yahoo 的 theHarvester 输出](img/Figure_3.02_B15630.jpg)

图 3.2 - 来自 Google 和 Yahoo 的 theHarvester 输出

正如你所看到的，我们找到了一个可以用于联系的电子邮件地址，以及一些我们以后可以攻击的主机。所有这些信息在你的渗透测试过程中或渗透测试后的报告中都会证明有益。向客户提供 theHarvester 收集的数据等信息，可以展示组织外部的情况。

现在我们已经收集了姓名、电子邮件和主机等信息，让我们来看看一些工具，我们可以用来发现 DNS 信息。

## WHOIS 命令

DNS 名称在这些域名注册后分配给 IP 地址。例如，`foo.com`可能使用`WHOIS`命令来从公共或内部备用处发现这些信息。使用该命令可以揭示有关域名、注册这些域名的人、ISP 联系人以及攻击者可以用来创建对目标的深入攻击路径的其他有用技术信息。

让我们快速看一下如何使用 WHOIS 来查找有关一个组织的一些信息。在这种情况下，我们将以 Packt Publishing 为目标，看看我们能发现关于他们的什么信息。接下来的步骤将说明如何正确执行这个任务：

1.  启动你的 Kali Linux 机器。

1.  打开终端。

1.  输入以下命令：

```
$ whois packtpub.com
```

让命令运行一会儿后，你应该会看到有关域的信息结果出现：

![图 3.3 - 从 WHOIS 检索的 DNS 信息](img/Figure_3.03_B15630.jpg)

图 3.3 - 从 WHOIS 检索的 DNS 信息

WHOIS 将允许渗透测试人员收集有关客户域的信息，他们可以利用这些信息制定攻击路径，以针对特定的主机，如 Web 服务器或域控制器。此外，您可以通过 WHOIS 命令或使用 Netcraft 命令收集 AWS 区域的信息，我们将在下面讨论。

## Netcraft

**Netcraft**是一个很好的资源，当试图查找有关特定目标的任何公共信息时使用。该工具允许人员通过搜索单个主机来查找多个域。从查询结果中得到的一些信息可能包括：

+   IP 地址

+   域名服务器

+   反向 DNS

+   网络块所有者

+   DNS 管理员

+   域名注册

+   AWS 区域

我建议在对组织进行渗透测试时始终运行 Netcraft。这是一个很棒的工具，它有一个图形用户界面，可以为您生成报告，不像 WHOIS。此外，在进行黑盒测试时，它可以向您显示与目标域名相关的 AWS 信息，并向您显示客户公司可能忽视的信息。

在这里了解更多关于 Netcraft 的信息：[`www.netcraft.com`](https://www.netcraft.com)。

现在我们已经讨论了一些快速有效的方法，可以找到有关我们目标的信息，让我们开始更多地了解如何开始对 AWS 服务进行侦察。

# 列举和理解 AWS 服务

列举是在对目标进行侦察期间收集有价值的特征信息的过程。列举涉及执行侦察和扫描目标。这意味着获取有关服务、域名、端口等的信息。虽然我们一直在通过收集开源信息来进行列举，但让我们快速看一下我们可能在 AWS 渗透测试期间针对或遇到的一些 AWS 服务。讨论这些服务可以让我们在开始利用它们之前更多地了解我们的目标。

重要提示

有关列举的更多信息，请查看渗透测试标准：[`www.pentest-standard.org/`](http://www.pentest-standard.org/)。

## S3 存储桶和发现带有 Web 应用程序的开放存储桶

S3 存储桶是 AWS 提供的一个很好的资源。S3 存储桶充当“容器”，允许用户在其中存储对象或数据，并且只要用户有适当的权限访问数据，就可以随时检索数据。虽然我们在本章不会深入研究 S3，但是了解对 S3 资源进行侦察是 AWS 渗透测试的一个重要部分是很有必要的。我们将在*第四章**，利用 S3 存储桶*中更深入地了解 S3。然而，让我们看一下如何公开查询缺乏安全控制的 S3 存储桶。

在 AWS 环境中，开放的 S3 存储桶是发现的较大问题之一。这些类型的漏洞过去曾经给组织带来了压力和负面影响，并且有一些公司甚至因为开放的 S3 存储桶而遭受了损害并成为新闻头条。我们可以通过使用一个叫做**Grayhat Warfare**的工具来帮助我们的目标防止这种情况。

Grayhat Warfare 是一个 Web 应用程序工具，它允许我们通过 Web 应用程序查询开放的 S3 存储桶。这使得列举和侦察变得非常简单和容易，因为一切都以简单而高效的图形用户界面呈现出来。

重要提示

Grayhat Warfare 可以在以下链接找到：[`buckets.grayhatwarfare.com/`](https://buckets.grayhatwarfare.com/)。

以下屏幕截图显示了我们在[packtpub.com](http://packtpub.com)上查询任何开放存储桶的基本示例。正如您所看到的，只有两个文件对互联网开放。通过从 Web 浏览器检查文件，您可以知道它们是图像文件，这让我们可以假设没有重要的数据是公开的：

![图 3.4 - 使用 Grayhat Warfare 发现开放的 S3 存储桶](img/Figure_3.04_B15630.jpg)

图 3.4 - 使用 Grayhat Warfare 发现开放的 S3 存储桶

现在我们对使用 S3 存储桶收集信息有了更多了解，让我们简要地查看并讨论一些在本书中将会看到的其他服务。

## Lambda

Lambda 是一种无服务器计算服务，允许用户对查询和/或触发事件做出响应并运行代码。在 Lambda 内部运行的代码称为**Lambda 函数**。当执行 Lambda 函数时，它会执行您想要的任何操作。Lambda 非常适合用于针对在 AWS 中运行的应用程序执行代码。

重要提示

要了解有关 Lambda 的更多信息，请查看这里：[`docs.aws.amazon.com/lambda/latest/dg/welcome.html`](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html)

我们将在本书的后面深入了解 Lambda，在*第七章**，评估和渗透测试*中。现在，了解 Lambda 是一种计算服务，可以让您在不需要预配或管理服务器的情况下运行代码。我们将在引用章节中执行更多的实际操作技术。

现在让我们继续前进，开始讨论 EC2 实例。

## EC2 实例

EC2 实例充当特定操作系统的主机。将 EC2 实例视为属于他人的实际设备，允许您“远程”使用该硬件来存储和使用操作系统，然后是您自己的应用程序。然后，该实例可以用于托管公司可以用来执行业务实践的应用程序和其他服务。

这使公司和其他组织能够在不必购买物理资源的情况下扩展和扩展业务。正如我们已经了解的那样，在本书中我们将不断地遇到使用 EC2 实例。

在执行渗透测试时，侦察和枚举是您开始的第一步。执行成功的枚举对于帮助您更好地了解目标并能够绘制出您发现的服务非常重要。现在我们了解了这些主题，让我们继续使用扫描技术来枚举信息！

# 扫描和检查目标以进行侦察

扫描是测试 AWS 的基本部分之一。扫描可以让您查看实例及其环境的整体状况。这样做将使您能够查看开放的端口、漏洞和服务版本，攻击者可能能够轻松利用它们。随着我们在本书中的深入，我们将开始使用更多的扫描技术并执行它们来枚举和利用服务。

在真实的渗透测试场景中，您通常会有一个需要扫描的资产清单 - 除非这是一个黑盒评估，在这种情况下，您将不会知道任何关于网络的信息。然后，您会拿出资产清单，并使用各种工具对其进行扫描。如果您使用诸如 Nmap 之类的工具，您的主要任务将是发现开放的端口和服务。端口为我们提供了进入系统的不同途径，而运行在这些端口上的服务有时会在服务易受攻击且过时的情况下为我们提供便捷的入口。

重要提示

关于不同类型的渗透测试，如白盒测试和黑盒测试的快速回顾，请参阅*第二章**，渗透测试和道德黑客*。

另一方面，您可能需要对活动主机运行漏洞扫描，以获取有关每个资产的所有漏洞信息。漏洞扫描是向公司提供其安全状况的整体概述的好方法，因为它提供了系统中每个主机上存在的每个漏洞。但是，渗透测试人员通常需要提供允许扫描器进行身份验证并扫描主机的系统主机的凭据。向白帽黑客提供凭据会使参与度略微降低，因为测试人员已经拥有用户名和密码，而无需进行渗透测试。

让我们继续并看看我们可能用于扫描的一些工具。请注意，下一节将不会用作利用练习，而是将讨论用于扫描和收集信息的某些工具。在本书的其余部分中，我们将使用各种工具和技术来进行利用。但是，我们需要学会走路才能跑，这在本书中会看到很多次。

重要提示

在应用知识之前，了解工具的理论是非常重要的。

## Metasploit

虽然 Metasploit 以其利用模块和自动利用而闻名，但它也是一个非常好的工具，可以进行扫描。在其库中，它拥有所谓的“辅助模块”。这些模块可以用作允许扫描和验证漏洞的工具。您还可以使用 Metasploit 来扫描端口，就像您使用 Nmap 一样 - 稍后我们会详细介绍 - 并探测开放的 TCP 和 UDP 端口。

当然，寻找开放端口和漏洞是很好的，但在渗透测试中，适当的枚举仍然是关键。Metasploit 有助于减轻一些流程，并允许您搜索服务的版本和默认凭据，并且可以发现您通常找不到的开放 Web 目录。在本书中，我们将花费相当多的时间来使用 Metasploit，所以不用担心！将 Metasploit 添加到您的工具库中会有无限的可能性。另一个具有无限扫描可能性的工具是 Nmap。

## Nmap

我们在*第二章**《渗透测试和道德黑客》*中提到了 Nmap，但是需要再次提到 Nmap 是一个非常好的工具，可以添加到您的扫描工具集中。Nmap 提供了许多脚本，允许您枚举在扫描目标上运行的各种端口上的软件版本。找到服务的版本可以让您攻击可能过时并且有公开漏洞的服务。

让我们使用 Nmap 对[packtpub.com](http://packtpub.com)进行扫描，看看我们能发现什么信息。以下步骤说明了我们如何做到这一点：

要积极扫描我们的目标，请执行以下操作：

1.  在 Kali Linux 中打开终端。

1.  输入以下命令：

```
nmap scan should show us everything that we can retrieve with the command. Using the -A parameter allows us to run all scripts and service scans against our target to pull the most information possible:
```

![图 3.5 - 使用 Grayhat Warfare 发现开放的 S3 存储桶](img/Figure_3.05_B15630.jpg)

图 3.5 - 使用 Grayhat Warfare 发现开放的 S3 存储桶

注意我们获得了一些更多的信息，比如 IP 和到地址的跳数。这让我们知道到主机的路径。

提示

SPARTA 是一个基于 Python 的工具，为您提供了一个图形用户界面来与您的目标进行交互。虽然我们在本书中不会使用 SPARTA，但根据您的需求，您可能会发现它很有用。SPARTA 可以在点击按钮时结合各种扫描和检查。您还可以将 Nmap 扫描导入到 SPARTA 中 - 这为攻击路径和自动化提供了无限的可能性。要了解有关 SPARTA 的更多信息，请查看此处的链接以发现工具的更多用途：[`tools.kali.org/information-gathering/sparta`](https://tools.kali.org/information-gathering/sparta)。

现在让我们讨论一些关于 AWS 服务工具、技巧和窍门。

## LambdaGuard

Lambda 是一个计算服务，可以执行代码，这意味着只有在应该执行代码时才会执行-为消费者节省资源和金钱。然而，并不是说它没有问题-特别是因为它是由人类创建的代码驱动 Lambda 环境。LambdaGuard 是一个工具，可以对审计 Lambda 服务进行可视化，并扫描可能成为攻击向量的潜在问题。它可能发现的其他问题包括以下内容：

+   公共 S3 存储桶是公开可用的，任何人都可以在互联网上找到它们。这意味着您可以查询公共存储桶并找到可能敏感的信息。在公共存储桶中可能存在个人信息、信用卡号码或健康记录等敏感信息。

+   公共 API 网关充当互联网的门户，但这并不意味着每个人都应该有权访问它们。AWS API 网关用于内部资源，如果保持公开，可能会允许任何人潜在地访问网络，如果 API 没有得到保护。但是，请注意，公共 API 也是为了允许环境内的授权人员访问而创建的。

+   配置不良的策略会产生安全问题，可能会演变成影响深远的情况。例如，策略可能允许某人绕过安全限制并访问资源，如 S3 存储桶。

要安装该工具，请按以下步骤操作：

1.  使用 Git 从其存储库中拉取代码：

```
$ git clone https://github.com/Skyscanner/lambdaguard
```

1.  然后切换到目录：

```
$ cd lambdaguard
```

1.  一旦进入 LambdaGuard 工作目录，继续通过运行以下命令来安装应用程序：

```
$ sudo make install
```

现在您应该可以使用该工具了。我强烈建议您使用它并熟悉它，除了本书之外。

## S3 扫描

最近几年，配置错误的 S3 存储桶已经成为一个相当严重的问题，并且是渗透测试 AWS 时寻找问题的热门地点之一。S3 存储桶具有内置的安全性，但在个别配置后安全权限被修改。

我们将在*第四章**，利用 S3 存储桶*中讨论大量关于 S3 的信息；重要的是要理解扫描是对 S3 进行侦察和信息收集的重要功能。

在这种情况下，我们将重点介绍扫描企业 S3 存储桶通常需要的简要概述。S3 存储桶充当存储桶，存储诸如档案、PDF 报表和其他冗余信息等信息。扫描 S3 存储桶对于确保不存在配置错误至关重要。如果存在配置错误，可能会泄露信息，例如上述提到的信息，这可能会落入错误的手中。

继续利用我们对 AWS 及其服务的了解，让我们开始讨论一些不同类型的攻击者以及我们可以模拟的潜在攻击路径。

# 了解攻击者

假设您正在进行渗透测试任务，您的客户要求您测试他们的系统。我们可以通过几种方式来做这件事。我们可以从外部视角或内部视角进行测试。根据客户的业务需求，这两种方式都会为客户提供不同的结果和投资回报。让我们快速看一下**内部**和**外部**究竟是什么。

### 内部人员

更常见的请求将来自内部视角。内部人员被认为是员工或者有权访问客户系统的人。这意味着您作为测试人员将获得连接到 AWS 环境所需的信息。您将获得一个帐户 ID 和凭据来访问云环境，然后可以让您的脚本运行以发现 S3 中的问题。

通常，白盒渗透测试将与内部人员的视角相结合。这意味着客户需要渗透测试公司检查系统中的任何事物。这意味着渗透测试的范围将列出所有系统和访问这些系统所需的凭据，允许测试人员找到任何脆弱和可利用的东西。

现在，有不同类型的内部人员，你可能需要模拟以满足客户对其请求的渗透测试的特定需求或目标。重要的是，你了解可能对组织构成威胁的各种恶意内部人员。以下是一些你应该注意的类型：

+   **情绪攻击者**：这些人让自己的情绪失控，并采取了恶意的转变。通常情况下，这些攻击者是之前和现在不满的员工。他们不满的原因各不相同，但任务通常都是一样的：为了利润或竞争对手窃取数据。在进行渗透测试时，最好查看业务和人员流程，以确保这些内部人员不会做出可能伤害公司的恶意或有意的改变。

+   **无意和无意的**：这种类型的内部人员并不是攻击者，他们并不知道自己的行为。例如，数据库管理员可能会意外删除了一个包含重要客户信息的表。他们可能并不知道自己做了什么，只是缺乏培训。

事件是意外还是威胁的区别在于个体是否持续。如果他们持续下去，那么可能不是缺乏知识，而可能是其他原因。确保员工接受培训并定期跟进将有助于减轻这种类型事件可能恶化的可能性。此外，密切关注他们是至关重要的，因为他们最容易受到攻击。虽然我们不一定会模拟这种类型的内部人员，但了解这些是很有用的。

+   **持续内部人员**：最危险的威胁之一就是持续的威胁。这意味着这个人会不惜一切手段获取他们想要的信息或结果。他们的理由可能因情况而异，但他们对利用或利润的渴望使他们固执而坚定。

### 外部人员

外部人员包括与公司直接合作的任何人，包括承包商和特权较低的人员，如访客或第三方供应商。有时，一些人可能被认为是**近端人员**- 但在本书中，我们将坚持称他们为外部人员，以保持简单。

外部人员是指必须获得系统授权访问但不应该对目标系统有任何了解的人。这里要记住的关键词是“授权”，因为可能会有不幸的时候，外部人员可能会获得未经授权的访问-这仍然被视为访问。

外部人员的描述各不相同，可以是试图利用他人代码攻击 Web 服务器的脚本小子，也可以是一个不惜一切代价获取系统控制权的国家支持的威胁，通常是**高级持续威胁**（**APT**）- 他们有权力和资金来实现这一目标。在许多情况下，APT 的客户或资金直接来自他们的政府。

既然我们了解了各种攻击者，让我们继续讨论攻击路径以及这些攻击者如何使用场景来执行攻击。

# 创建攻击路径

攻击路径涉及使用从目标处收集的信息，制定一个关于你或实际威胁如何利用这些信息来利用目标系统或应用程序的“故事”或“场景”。网络上有一些框架可以让你从实际先前事件中获取攻击路径的想法。

提示

虽然这与本书的主题有些偏离，但我强烈建议查看 MITRE ATT&CK 框架获取更多信息：[`attack.mitre.org/`](https://attack.mitre.org/)。

不同的攻击场景需要不同的渗透测试方式。有些场景需要全面的方法，有些则更加目标导向。在甚至开始扫描和尝试连接到任何 AWS 设备之前，了解您需要知道的信息是非常重要的！一些客户可能有更自然的方法，而另一些客户则会有一个直接的目标，他们希望您攻击并尝试利用。

## 有机攻击路径

有机攻击路径包括以一种自然的方式利用系统。这意味着您——测试人员——没有被给予一个特定的目标，应该以任何**道德**方式接近系统。我们强调“道德”这个词，因为确保客户和自己的安全至关重要。

有机攻击路径可能如下所示：

1.  测试人员被给予**规则约束**（**ROE**）和系统架构概述。

1.  测试人员发送钓鱼邮件。

1.  一个权限很高的用户点击了一封钓鱼邮件，允许测试人员获取域的管理员凭据。

1.  测试人员能够从一台机器转移到另一台机器。

1.  在网络上进行横向移动后，测试人员能够获得**域管理员**。一旦建立为域管理员，测试人员就能在目标环境中执行任何操作。

获得**域控制器**上的域管理员通常是渗透测试的主要目标。基本上，如果用户对网络拥有域管理员权限，他们就拥有了网络——这里的“拥有”意味着他们对网络拥有了完全控制权。

有时，获得域管理员并不是渗透测试的目标。不同的项目将有不同的范围，不同的范围可能包含不同的目标。这些类型的项目被称为“目标导向”项目。

## 目标导向攻击路径

目标导向攻击路径包括利用客户组织的特定目标，同时保持在范围内。目标导向评估的目的可能是测试一个即将投入生产的系统，或者用于复制特定**高级持续威胁**（**APT**）的攻击方法。

客户可能希望以与特定对手可能攻击他们的方式来测试系统。这在国防工业中很常见，用于测试系统的防御能力。客户可能希望确保他们的系统是最新的，并且能够检测和响应——以防发生意外。

## AWS 攻击路径

AWS 攻击在渗透测试中并不那么常见。这在很大程度上是由于 AWS 的新实施，不是所有的渗透测试和对抗模拟都跟得上 AWS。然而，这并不意味着我们仍然可以使用我们传统的思维方式来创建攻击路径，这些路径不能应用于 AWS。以下展示了我们在渗透测试或练习中可以攻击 AWS 实例的一种方式。

在 AWS 方面，攻击路径通常如下所示：

1.  测试人员在互联网上搜索公共 S3 存储桶。

1.  测试人员搜索常见的存储桶名称并找到匹配项。

1.  测试人员在存储桶中搜索对象。

1.  测试人员找到匹配项并泄露信息。

请注意，您可能会被提供凭据以访问 AWS 环境，这将允许您以内部人员的身份访问系统。如果给予访问系统的凭据，最好查找员工在创建 S3 存储桶后可能实施的错误配置。查看这个潜在问题很重要，因为它可能导致更严重的副作用，比如信息泄露，或者允许未经授权的用户查看他们不应该查看的信息。

## 渗透测试攻击路径

在真实世界的渗透测试场景中，您的攻击路径会因参与而异，参与即为渗透测试本身，以及该渗透测试的每个方面。在进行渗透测试之前，对客户网站进行功课是明智的，以确保您已经收集到足够的信息，以便为目标组织执行高效和有效的渗透测试。要开始收集信息，您可以使用 Google 搜索目标的各种属性。也许您可以找到目标的电子邮件和电话号码，甚至找到存储重要信息的公共 S3 存储桶。

## 企业的红队行动

红队行动并不是一种攻击路径，而是对企业流程和政策的质量保证检查。红队行动可以涉及对渗透测试的不同领域的观察，以及根据客户的需求或要求，混合攻击路径。由于其灵活性和强度，红队行动测试企业的所有方面。然而，重要的是要理解客户在进行渗透测试之前需要拥有成熟的商业模式。

通常情况下，客户在对公司进行红队参与评估之前，会更多地从漏洞评估或基本的渗透测试中受益。公司需要拥有一个成熟和强大的商业模式和安全计划，否则，红队行动将无法突出公司内部问题的全部范围。

## 深入攻击者心态

这个主题有点禁忌，但在本书的过程中会一再提到。由于黑客术被用于窃取数据和攻击政府等犯罪活动，黑客术一直是禁忌。然而，近年来，它变得更加主流，现在被用于测试公司并让它们真正了解其安全姿态。

了解攻击者的心态至关重要，因为这是优秀结果和出色结果之间的区别所在。优秀的结果来自于对系统的理解，以及向客户提供详细报告，指出如何修复和消除漏洞。具有攻击者心态的白帽黑客能够提供关于恶意黑客如何通过任何必要手段侵入系统的见解。

我们现在已经讨论了很多不同的主题。我们从讨论侦察和信息收集开始，然后讨论了不同的攻击者类型，以帮助说明信息对公司的影响。现在，让我们来看一些实际操作的练习，并应用这些信息。不过，首先，让我们提到一些重要的东西 - SSH 密钥。

# 发现 SSH 密钥

**SSH**，或**安全外壳**，是各种系统管理员在其基础设施中实施的常见登录服务。这种快速和安全的系统使该服务成为安全目的的理想选择，同时也因其类似密钥的基础设施而具有“可行性”。密钥使身份验证变得无缝，就像我们在*第一章**，构建您的 AWS 环境*中所做的那样，使用我们从 AWS 实例中下载的密钥。这些密钥给了我们“王国的钥匙”，让我们能够访问我们的 AWS 实例。

## 密钥的工作原理

必须创建一个私钥和公钥来使用该服务。创建密钥对时，会生成并存储一个私钥在系统中。在这种情况下，密钥存储在我们的 EC2 实例中。私钥是绝对不应该与任何人分享的密钥。近年来，私钥的曝光和造成公司的损害已经引起了关注。

![图 3.6 - 公钥和私钥示意图](img/Figure_3.06_B15630.jpg)

图 3.6 - 公钥和私钥示意图

私钥只是认证关系的第一部分。需要生成一个公钥，允许用户对系统进行身份验证。公钥由用户持有 - 在这种情况下，是我们 - 并确保来回的流量从客户端到服务器都是加密的。如果公钥与服务器上授权密钥列表不匹配，那么身份验证将失败，用户将无法登录到服务器。您可以在 Linux 实例的`~/.ssh`中找到这些密钥存储。

## 良好的卫生习惯

一个好的做法是永远不要将您的私钥存储在不安全的地方，比如一个开放的 Web 目录。开放共享是一个可能是可以通过匿名 FTP 访问的目录的文件。丢失服务器的私钥可能会带来严重的后果，可能难以克服。请记住**永远**不要分享私钥，并将它们存储在一个具有访问控制的地方，不允许未经授权的用户访问密钥。

现在我们了解了这些 SSH 密钥的用途，让我们把这些知识应用到实践中，连接到我们的 EC2 实例！

# 扫描和连接到 AWS

现在我们将扫描 AWS 内部的系统。这在渗透测试中起着重要作用，因为正如我们提到的，扫描和枚举构成了 AWS 和一般渗透测试的第一个技术部分。在开始对 AWS 环境进行渗透测试时，了解从何处开始是很重要的。假设所有先决条件都已满足，并且一切都井井有条，那么继续扫描和连接到实例应该是测试 AWS 的下一个逻辑组成部分。

在开始之前，请确保您的 Windows 主机正在运行。登录到 AWS 管理控制台，回顾*第一章**，构建您的 AWS 环境*，如果需要复习 - 然后返回到这里。

一旦准备好，我们将继续使用 Nmap 来扫描我们的 AWS 环境。

## 使用 Nmap 进行扫描

现在让我们让 Nmap 发挥作用，用它来检查 Windows 2008 服务器，并查看我们在系统上启用的开放 RDP 端口：

1.  首先，我们将通过 Nmap 扫描主机来查看主机。这将允许我们检查并查看**远程桌面协议**（**RDP**）是否开放。RDP 将允许我们从我们自己的机器远程连接到主机。

1.  要扫描主机，请使用我们之前设置的 Kali Linux 主机，在*第一章**，构建您的 AWS 环境*。一旦您的主机正在运行，打开终端并执行以下命令：

```
$ nmap -p 3389 -Pn <AWS host>
```

让我们快速分解一下这个简单而有效的命令。使用了以下开关：

+   `-p`：指示我们要探测的端口，探测意味着发送请求，试图从主机获取响应。在这种情况下，我们正在检查端口`3389`，这是与 RDP 相关的端口。如果我们想要扫描更多端口，可以通过用逗号分隔端口来添加它们。我们还可以扫描一个范围，例如使用以下命令扫描前 100 个端口：

```
0, because this is often a port that is overlooked but at times can offer a way into a system. 
```

+   `-Pn`：此开关禁用了`nmap`扫描的`ping`。`ping`通常会引起不必要的噪音，并且有时不会给出对扫描主机的合理输出，如果主机不响应`ping`。重要的是要注意，如果主机不响应`ping`，那么这并不意味着主机不活着，因为主机不响应`ping`是很常见的。特别是在 AWS 环境中，确保习惯使用`nmap`扫描的`-Pn`开关。

扫描完成后，您将收到反馈，提示 RDP 已开放，并给出以下类似的输出：

![图 3.7 - 扫描 RDP](img/Figure_3.07_B15630.jpg)

图 3.7 - 扫描 RDP

正如你所看到的，我们的实例显示主机实际上正在运行，并且端口`3389`，远程桌面是开放的，并且允许我们连接。在查看打开 RDP 的主机之前，让我们看看如何使用 Metasploit 来扫描 RDP。我们想要尝试这样做的原因是测试针对主机的各种工具是一个很好的实践。最终，这为你提供了选择的机会，以防你需要使用特定的工具。

## 启动 Metasploit

你可以使用 Metasploit 进行扫描，在这种情况下，由于我们只关注 RDP，我们只需要使用 Metasploit 中的端口扫描模块来探测开放的端口。正如我们提到的，能够使用不同的工具来执行场景是一个好的实践，以防一个工具不起作用，而你又没有时间进行故障排除。接下来的步骤将讨论使用 Metasploit 扫描我们的主机所需的步骤。

确保 Metasploit 已经启动：

```
$ msfdb run
```

现在你应该有一个终端，可以为你提供 Metasploit 的主要背景：

![图 3.8-Metasploit 控制台](img/Figure_3.08_B15630.jpg)

图 3.8-Metasploit 控制台

如果这是一个真实的参与，比如为客户进行的渗透测试，下一步将是连接到资源并开始评估 AWS 资源。在参与过程中，获取与主机交互所需的凭据非常重要。在这种情况下，我们已经拥有了所需的信息，并可以从我们设置的 Windows 机器中获取我们的凭据。

现在我们已经启动了 Metasploit，是时候看一看我们可以用来扫描主机上的 RDP 的几个不同的扫描模块了。在接下来的步骤中，我们将在我们本地的 Kali 实例上使用 Metasploit，但是，如果你选择这样做，也可以在 AWS 中使用 Kali 镜像。

## 使用 Metasploit 进行 TCP 扫描

接下来，我们想要扫描我们的 Windows 主机并检查开放的端口。Metasploit 提供了各种模块来执行扫描你的主机。每个模块提供不同的技术和针对各种服务的扫描。在启动扫描之前，让我们谈谈其中一些模块：

1.  首先，在你的 Metasploit 终端中输入以下内容：

```
$ search portscan
```

如果你正确输入命令，你应该会得到一个类似以下的提示：

![图 3.9-端口扫描 Metasploit 模块](img/Figure_3.09_B15630.jpg)

图 3.9-端口扫描 Metasploit 模块

如果你没有得到类似前面截图的结果，请更新你的 Metasploit，然后再回到本章的这部分。

1.  接下来，我们将使用 TCP 扫描。TCP 扫描将执行完整的 TCP 三次握手并与主机建立完整连接，以枚举主机。这并不意味着我们的机器将对主机进行身份验证-稍后会详细介绍。我们的主机将发送`3389`（RDP）。

1.  回到使用 Metasploit，我们将使用 TCP 端口扫描模块执行 3 次握手，并获取我们所需的信息。启动 Metasploit 后，输入以下内容使用 TCP 端口扫描器：

```
$ use auxiliary/scanner/portscan/tcp
```

在我们能够看到端口`3389`是否开放之前，你需要在模块中更改一些参数。首先，你需要输入`options`命令查看参数（Metasploit 将它们标记为选项），并设置这些参数以适应你的需求。在这种情况下，我们只会更改以下参数：

+   `RHOSTS`：此选项设置为你要测试的目标，或者在这种情况下，我们要扫描的目标。将选项设置为你的 AWS 实例的公共 DNS 地址。

+   `PORTS`：此选项可以设置为单个端口或范围-就像在 Nmap 中设置端口一样。在这种情况下，我们将使用端口`3389`。

确保正确设置这些参数。如果你发现自己在犹豫不决，你可以输入`options`命令查看当前设置的选项。之后，你可以输入`run`或`exploit`命令来执行模块：

![图 3.11-使用 Metasploit 进行端口扫描](img/Figure_3.11_B15630.jpg)

图 3.11 – 使用 Metasploit 进行端口扫描

正如你所看到的，我们得到了输出，告诉我们端口`3389`在我们的主机上是开放的。这是由模块使用以下格式向我们显示的：

```
[+] <IP>	- IP:PORT - TCP OPEN
```

好消息 – 我们已经成功地用 Metasploit 扫描了我们的 Windows 主机！现在我们知道了 TCP 扫描模块的工作原理，让我们来看看可以用于较少侵入性扫描的不同模块。

## 使用 Metasploit 进行 ACK 扫描

接下来，我们将使用一种我喜欢用来查看端口是否被过滤的扫描。通常，端口将被过滤以仅允许特定的流量进入，或者只允许特定的主机使用该端口。这经常使渗透测试人员使用欺骗攻击来尝试破坏服务，或者只是转移到其他事物。

检查端口是否被过滤的一个好方法是使用 ACK 扫描。这种类型的扫描是由主机发送一个`3389`是否被过滤。如果它没有被过滤，那么我们可以尝试在该端口上继续。在我们的实验环境中，该端口将是开放的 – 然而，如果这是一个真正的渗透测试，并且我们被告知某个端口*被*过滤了，那么看看其他没有被过滤的端口和服务是明智的。

在我们继续之前，看一下下面的图表，它显示了 ACK 扫描的简要概述。这张图片是对这种扫描如何工作以及可以用于什么的一个非常简单的分解：

![图 3.12 – ACK 扫描](img/Figure_3.12_B15630.jpg)

图 3.12 – ACK 扫描

现在我们对 ACK 扫描有了一个基本的理解，让我们使用以下模块来完成工作：

```
$ use auxiliary/scanner/portscan/ACK
```

就像以前一样，我们需要为我们的模块设置参数。我们可以通过设置与我们之前为 TCP 扫描设置的相同参数来实现这一点。就像以前一样，设置您的参数并对您的 AWS 主机运行扫描：

![图 3.13 – 使用 Metasploit 进行 ACK 扫描](img/Figure_3.13_B15630.jpg)

图 3.13 – 使用 Metasploit 进行 ACK 扫描

如果扫描按计划进行，您将得到反馈，主机已成功被扫描，并且端口未被过滤。

现在我们已经在我们的主机上使用了 TCP 和 ACK 扫描，让我们再看看另一个模块来对我们的主机进行一些侦察。对于我们的下一个扫描，我们将使用 Metasploit 中提供的内置 RDP 扫描程序。

## 使用 Metasploit 进行 RDP 扫描

自从我们开始使用 Metasploit 进行扫描以来，我们已经对我们的主机进行了大量的侦察和枚举。在使用 Metasploit 和 Nmap 之间，我们现在对我们的目标有了以下了解：

+   端口`3389`是开放的。

+   端口`3389`未被过滤。

如果这是一个真正的测试，下一步将是查看主机上运行的操作系统。我们可以通过在 Nmap 中使用`-O`开关来做到这一点，但由于我们已经启动并运行了 Metasploit，让我们继续使用它：

1.  首先，使用以下模块：

```
RDP_USER parameter to a username on the host. This parameter allows us to use a known username (that must be active on the target) to scan the machine and check for ports and a possible operating system. We already know that our Windows host username is Administrator, however, in a real pentest, it is common to try more than just default usernames. 
```

1.  设置参数后，使用`run`命令开始扫描并查看输出。如果一切顺利，输出将显示端口`3389`是开放的，并且实例正在运行 Windows：![图 3.14 – 使用 Metasploit 进行 RDP 扫描](img/Figure_3.14_B15630.jpg)

图 3.14 – 使用 Metasploit 进行 RDP 扫描

1.  如果您想看到结果的不同，使用`UNSET`命令来擦除您放入选项中的值。`UNSET`命令正是它的名字所说的 – 它取消刚刚设置的参数！

现在我们已经成功地进行了一些枚举并扫描了我们的主机。随意查看其他模块来扫描主机，并了解 Metasploit 如何通常用于扫描主机。

让我们继续前进，实际连接到我们的 Windows 主机。首先，我们将使用我们的 Kali Linux 镜像 – 随意使用您的本地或 AWS Kali 机器。之后，我们将使用远程桌面客户端来测试我们与 AWS 主机的连接。

## 使用 Kali 进行连接

现在我们确切地知道`RDP`是打开的，我们可以使用我们从解密 Windows AWS 密钥中获得的用户名和密码连接到它。如果需要，回去看看如何检索您的 Windows 密码，然后再回到这里：

1.  首先，您需要使用一个名为“管理员”的工具。有一个参数允许在终端中输入密码，但是这是以明文显示的。最佳做法（稍后会详细介绍）是不要以明文显示密码：![图 3.15 - 通过 rdesktop 通过 RDP 连接](img/Figure_3.15_B15630.jpg)

图 3.15 - 通过 rdesktop 连接 RDP

1.  因为密码参数允许密码以明文显示，所以当您看到登录屏幕时，您将输入您的密码。输入您的 AWS 密钥分配给您的密码：

![图 3.16 - Windows 服务器的登录屏幕](img/Figure_3.16_B15630.jpg)

图 3.16 - Windows 服务器的登录屏幕

一旦成功登录，您可以像对待常规 Windows 主机一样进行更改。

如果连接成功，您应该会看到一个类似以下内容的桌面：

![图 3.17 - Windows 桌面](img/Figure_3.17_B15630.jpg)

图 3.17 - Windows 桌面

随意四处看看，感受一下。可能需要一点时间来适应。

## 连接 Windows

现在我们已经在我们的 Kali 机器上使用了 rdesktop，是时候转向更受欢迎，或者至少更常规的通过 RDP 连接的方法了。如果您没有基于 Windows 的主机，不要担心；您也可以下载其他操作系统的远程桌面：

1.  首先，打开“远程桌面”，然后按*Enter*。它应该会自动打开您安装的 RDP 应用程序。如果没有，您需要解决问题，然后返回完成本章的这一部分。

1.  就像以前一样，我们将输入我们的 AWS 实例的公共 DNS 名称，以及用户名“管理员”来开始连接：![图 3.18 - Windows 上的远程桌面应用程序](img/Figure_3.18_B15630.jpg)

图 3.18 - Windows 上的远程桌面应用程序

1.  一旦点击**连接**按钮，您将被提示输入 Windows 主机的凭据。继续复制并粘贴密码到**密码**字段，并记住连接，这样您就不必每次想要登录到 AWS 实例时都输入密码：

![图 3.19 - 远程桌面的登录提示](img/Figure_3.19_B15630.jpg)

图 3.19 - 远程桌面的登录提示

连接后，您应该会看到一个占满整个桌面的桌面。这个新桌面是您的 AWS Windows 实例的桌面。

恭喜！您已成功扫描并连接到您的 AWS 实例！在本章中，我们学到了很多东西，现在应该可以熟练使用一些渗透测试工具，并启动我们自己的带有各种操作系统的 EC2 实例。既然我们已经掌握了渗透测试和 AWS 的基础知识 - 让我们谈谈学到的经验以及它们如何适用于本书的后续内容。

# 从经验中学习

您在渗透测试中学到的经验是您在作为渗透测试人员的时间中获得的最宝贵的资源之一。无论您是否以此为职业或作为业余爱好，所学到的经验都涉及使用您从专业和个人经验中获得的知识，并将其应用于未来的努力。

利用远见来审视您的渗透测试努力，让您能够查看自己的错误，并将这些错误视为一种学习经验，而不是严厉的失败。这是关于向前失败，而不是向后失败，这将确保您在渗透测试知识方面的成长。通常，这就是决定专业人士和业余爱好者在渗透测试社区中成败的关键。

对于本书来说，重要的是要理解所学到的教训可能需要您多次复习材料，或者您可能需要回头尝试以不同的方式做某件事，因为这对您更合适，或者您意识到自己一直在错误地输入 Metasploit 中的参数，现在知道在将来设置参数之前需要自我约束。本书中所学到的教训将帮助您在学习过程中不断成长。

在现实生活中的渗透测试中，为客户提供高投资回报（ROI）通常是确保您将自己定位为渗透测试人员并保持专业渗透测试关系的关键。因此，不断评估自己是至关重要的，以便您和您的客户能够充分利用渗透测试。我们将在本书的后面更多地讨论这一点，但了解到教训和投资回报与渗透测试有一定的相关性和因果关系仍然是很好的。

# 总结

您现在已经具备了继续阅读本书所需的知识。本章包括了渗透测试技术的概述，以及不同类型的渗透测试及其执行方式。简要了解渗透测试可以以不同的方式使用，例如红队行动或目标导向型渗透测试，这一点非常重要。我们将在本书中探讨更多的方式，并在这些情况出现时提醒您。

本章的重要测试是扫描我们的 AWS 主机，然后通过 RDP 连接到它。我们展示了如何在扫描主机以成功枚举并使用该信息连接主机的理论和实际知识。在本书中，我们将使用类似的技术和方法-因此，请确保您将迄今为止学到的作为本书的基准。

在下一章中，我们将继续进行更多实践性的话题，并开始利用 AWS 服务。

# 进一步阅读

+   网络安全框架：[`www.nist.gov/cyberframework/online-learning/five-functions`](https://www.nist.gov/cyberframework/online-learning/five-functions)

+   有关 Metasploit 的更多信息：[`www.offensive-security.com/metasploit-unleashed/port-scanning/`](https://www.offensive-security.com/metasploit-unleashed/port-scanning/)

+   三次握手：[`study-ccna.com/tcp-three-way-handshake/`](https://study-ccna.com/tcp-three-way-handshake/)

+   端口扫描：[`resources.infosecinstitute.com/port-scanning-using-scapy/#gref`](https://resources.infosecinstitute.com/port-scanning-using-scapy/#gref)

+   有关远程桌面的更多信息：[`www.microsoft.com/en-us/p/microsoft-remote-desktop/9wzdncrfj3ps?activetab=pivot:overviewtab`](https://www.microsoft.com/en-us/p/microsoft-remote-desktop/9wzdncrfj3ps?activetab=pivot:overviewtab)
