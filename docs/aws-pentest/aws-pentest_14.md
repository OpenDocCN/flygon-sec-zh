# 第十一章：避免麻烦

对 AWS 系统进行渗透测试可能会对系统造成严重干扰，如果执行不正确还可能导致法律问题。在对 AWS 进行渗透测试时，了解您作为渗透测试人员可以执行和不能执行的操作至关重要。这些类型的攻击会在渗透测试期间使系统崩溃，破坏您的声誉，同时还可能破坏客户系统，并给渗透测试公司和目标客户带来重大收入损失。

本章将讨论**拒绝服务**（DoS）和洪水攻击以及它们的工作原理。了解这些攻击的工作原理说明了攻击的严重性，以及为什么我们应该远离它们。

我们将通过讨论压力测试来结束本章，有时也称为负载测试，并对压力测试是什么以及客户是否应该担心有一个高层次的了解。

在本章中，我们将涵盖以下主题：

+   禁止的活动

+   通过 DoS 耗尽服务

+   了解洪水

+   避免法律问题

+   压力测试

# 禁止的活动

在进行渗透测试时，了解哪些活动是允许的，哪些是不允许的是至关重要的。正如我们在整本书中所述，这就是我们所说的“范围内”和“范围外”。当我们提到范围内的系统时，我们讨论的是我们可以在什么时间测试以及我们对这些范围内主机产生多大影响。然而，了解范围外的内容同样重要。了解范围外的内容可以确保您只测试客户要求的内容，并且可以避免您和您的团队逃避任何类型的法律罚款或惩罚。

接下来的部分将讨论 AWS 在其基础设施和服务方面禁止的活动。请记住，共享安全模型的一部分依赖于 AWS 及其硬件的正常运行 - 因此 AWS 对其产品的测试方式有发言权。

让我们继续讨论在 AWS 上禁止的攻击 - DoS 和洪水。

## 通过 DoS 耗尽服务

DoS 和分布式拒绝服务（DDoS）是破坏性攻击，目标包括各种系统，如网站和应用程序，有时还可能针对用户。DoS 攻击会产生大量流量，旨在压倒目标并使其无用或使其下线。DDoS 攻击执行相同的攻击，只是它是从多个受损或受控主机 - 称为僵尸网络 - 进行攻击。

重要说明

大量受控或受损的主机通常被称为僵尸网络。AWS 有一篇关于僵尸网络的较旧但有趣的文章，位于这里：[`aws.amazon.com/security/security-bulletins/zeus-botnet-controller/`](https://aws.amazon.com/security/security-bulletins/zeus-botnet-controller/)。

DoS 和 DDoS 攻击将攻击**开放系统互联**（OSI）模型的多个图层；然而，我们经常看到的攻击更多发生在图层 3、图层 4、图层 6 和图层 7。以下截图来自 AWS 的网站，显示了各种图层：

![图 11.1 - AWS 的图层](img/Figure_11.01_B15630.jpg)

图 11.1 - AWS 的图层

图层 3、4、6 和 7 说明了破坏性攻击最突出的图层，并可以分为两个不同的图层。将这些图层分组可以简化缓解过程，因为它允许我们将缓解技术应用于一个组中的多个图层。我们将图层分为以下组：

+   基础架构层（图层 3 和 4）

+   应用层（图层 6 和 7）

在考虑我们的分组时，让我们讨论它们以及它们在 AWS 方面的目标服务。

### 基础架构层攻击

基础架构层攻击侧重于攻击网络层（**3**）和传输层（**4**）。在 AWS 中，我们看到的一些更常见的攻击涉及 SYN 洪水和 UDP 洪水——我们将在本章的*了解洪水*部分进一步讨论——旨在使该层的服务崩溃。这包括通过 TCP、UDP 和 IP 建立的任何连接的中断，例如在 AWS 环境中与其他节点建立连接。

现在，让我们讨论下一层，即应用层，并考虑它对 AWS 的影响。

### 应用层攻击

应用层发生的攻击通常较少见；然而，它们也存在自己的问题。虽然这些类型的 DoS 攻击可以产生大量流量值以使服务崩溃，但它们也可能是简单的改变文件、策略或其他类型的数据的完整性，从而允许访问和授权资源。我们在本书中已经看到了一些攻击情况和方法，这些情况说明通过改变 S3 策略或更改 EC2 实例上的 SSH 密钥来拒绝服务。

应用层攻击主要针对 AWS 的 SSH 和 HTTP。这意味着如果 API 和 EC2 实例的访问没有得到正确的保护，它们可能会受到攻击。我们将在本章的*减轻洪水攻击和 DoS*部分进一步讨论保护和减轻措施。

现在我们了解了各层，让我们继续讨论洪水以及在渗透测试期间的含义。

## 了解洪水

洪水是一种简单但有效的策略，恶意和好奇的用户通过向目标主机发送大量数据包来希望淹没主机。洪水的另一个部分使其**简单**是它使用网络中的最短路径到达目标，或者在我们的情况下，到达我们的**VPC**和云环境。这意味着当洪水攻击发生时，它可能会影响除目标之外的其他主机，因为洪水会**喷射**到其他节点以找到最短路径。

此外，洪水是 DoS 攻击中常见的技术。DoS 攻击的任务是压倒和淹没网络、系统或环境，使可用性受到干扰，服务被关闭。

现在，让我们提到一些洪水技术，以及一些 DoS 攻击的风格。

### UDP 洪水

端口洪水涉及攻击系统的端口并用**用户数据协议**（**UDP**）数据包溢出它们。由于 UDP 数据包是无连接的，它们可以以不需要目标主机建立任何已建立连接的洪水发送。当目标收到大量 UDP 数据包时，它可能会变得不堪重负并下线。如果目标主机下线，将向我们发送一条表明**目的地不可达**的消息。

### 讨论 SYN 洪水和 TCP 握手

SYN 洪水，或 TCP SYN 洪水，是一种利用三向 TCP 握手的 DoS 攻击，通过发送大量 SYN 请求而不接受目标发送的 ACK 请求来进行攻击。基本上，这样做会让目标等待来自攻击者的响应，同时处理来自攻击者机器的大量 SYN 请求。

为了更好地理解 SYN 洪水，我们需要了解 TCP 握手及其工作原理。以下步骤突出了 TCP 握手在两个节点之间启动的三个步骤——在我们的情况下，这可能是目标和攻击者之间的连接：

1.  攻击者机器向目标发送一个 SYN 消息以请求与目标建立连接。

1.  目标向攻击者机器发送一个 SYN-ACK 请求并确认该请求。

1.  攻击者机器响应 ACK 消息，并启动连接。

以下图表说明了我们刚才提到的步骤，并帮助直观地理解 TCP 三次握手：

![图 11.2 - TCP 三次握手](img/Figure_11.02_B15630.jpg)

图 11.2 - TCP 三次握手

现在我们了解了握手的工作原理，让我们讨论一下如何利用这个握手来攻击我们的目标。以下步骤将突出显示 SYN 洪水是如何执行的：

1.  攻击发起 SYN 洪水。攻击者发送多个 SYN 请求，这些请求发送到目标服务器。

1.  目标接收并响应来自攻击机器的过载请求，而没有收到 ACK 响应。在试图从攻击者机器接收 ACK 时，目标仍将受到来自攻击者机器的 SYN 请求的过载。

1.  服务中断，使目标无法处理合法请求。

下图说明了我们在洪水方法论中提到的三个步骤：

![图 11.3 - 滥用三次握手的 DoS](img/Figure_11.03_B15630.jpg)

图 11.3 - 滥用三次握手的 DoS

正如我们所看到的，如果不正确减轻洪水攻击，洪水攻击可能会带来危险。服务中断意味着收入损失、声誉损失和员工信任的潜在损失。我们将在稍后更详细地探讨这些原因；然而，请记住，尽管洪水是一种危险的攻击，但在 AWS 中有一个很好的解决方案。

现在我们从高层次理解了 DoS、DDoS 和洪水攻击，让我们提到如何防止这些攻击发生。这是我们向客户推荐的如何保护其系统免受破坏性攻击的建议。

#### 减轻洪水攻击和 DoS

对洪水的最基本理解以及如何减轻其影响是，大多数操作系统（如 Windows）会限制 ICMP 响应并过滤掉请求的过载。您也可以使用更传统的方法，使用防火墙解决方案来帮助减轻这些攻击。AWS 提供了一项名为**AWS 防火墙**的服务，它充当**Web 应用程序防火墙**（**WAF**），可用于过滤您的 AWS 环境和 API 的流量，并防止针对您的 Web 应用程序的常见利用。

还有另一项名为**AWS Shield**的服务，它有助于防止针对在 AWS 中运行的任何应用程序的 DoS 和 DDoS 攻击。这两层服务提供了实时检测和减轻，以防止发送到应用程序的过载流量实际上造成任何损害 - 这很棒，因为 AWS Shield 基本上承担了所有繁重的工作，而不需要您额外的 AWS 支持。

那么，AWS Shield 究竟是如何工作的，为什么应该推荐它来防止任何类型的 DoS 攻击呢？

简而言之，AWS Shield 创建并提供基于启发式的实时监控和内联减轻。这意味着 AWS Shield 使用先进的监控技术，在环境中创建基于通常流量的基线，并将报告任何偏离该流量的情况。此外，它还将对常见和更频繁的攻击进行实时减轻，例如 DoS 和洪水攻击。它还将提供更具体的检测和高级的减轻技术，有助于阻碍更高级的攻击方式，例如 DDoS 攻击。

您可以在这里了解更多关于 AWS Shield 以及它如何帮助您制定减轻策略：[`aws.amazon.com/shield/`](https://aws.amazon.com/shield/)。

另一种减轻任何破坏性攻击的方法是减少 AWS 环境的攻击面。这意味着确保 EC2 实例不公开可用，除非基于业务原因需要。应用程序对互联网的暴露越少，它们被发现和攻击的可能性就越小。我们还可以通过放置负载均衡器在环境中来帮助承担环境将承受的负载。以下图表显示了负载均衡器如何在四个不同节点之间分配负载，并根据它们在那个时候能够处理的流量类型来分配负载：

![图 11.4 - AWS 内的负载均衡](img/Figure_11.04_B15630.jpg)

图 11.4 - AWS 内的负载均衡

如您所见，负载均衡器不是每个节点独立处理流量，而是根据每个节点能够处理的流量量来分发流量。

最后要提到的一点，但也非常重要的是，您必须有受过培训的 AWS 工程师，能够在环境中安全有效地实施安全控制。您的工程师实施这些控制的最佳方式是了解并知道环境中的正常流量和异常流量。这就是为什么文化在安全中如此重要，不仅在 AWS 中，也在企业本身。

虽然文化是一个巨大的影响，但同样重要的是要知道内部人员可能会对组织产生影响，以及他们的恶意黑客心态如何在组织内部引发问题。接下来的部分将讨论黑客心态与 DoS 和 DDoS 攻击的关系。

#### DoS 和 DDoS 的攻击者心态

攻击者执行破坏性攻击的原因有很多。在这种情况下，威胁行为将是 DoS 或 DDoS 攻击，旨在直接制造破坏公司声誉的麻烦，或者很多时候用于制造政治状态，如果政治关联方拥有 AWS 系统。

我们在*第三章*中提到，*探索渗透测试和 AWS*，一些不同类型的攻击者，如内部人员和外部人员。这些相同的攻击者心态可以应用于执行 DoS 和洪水攻击的原因。

现在我们更多地了解了我们需要远离的攻击，让我们结束本章，并讨论一些您可能会面临的法律问题，如果超出了渗透测试的范围。

# 避免法律问题

正如我们在本书中所看到的，渗透测试可能会非常侵入性，有时甚至可能非常危险，如果您的团队不完全了解渗透测试的范围，可能会导致罚款，甚至可能会被认为违反《计算机欺诈和滥用法》（CFAA）而采取行动。根据渗透测试团队测试的对象和内容，您还可能违反其他法律，如联邦和州法律；然而，这将取决于每次渗透测试。

说了这些，让我们快速看一下如何在法律和客户方面避免麻烦。

## 免于监狱的牌

这是确保在渗透测试期间避免任何法律冲突的最重要的基本因素之一。免于监狱的牌本质上是一张纸，说明渗透测试团队被授权对目标组织进行渗透测试 - 但是，它还应该注明渗透测试团队被允许进行渗透测试的“什么”，“在哪里”，和“何时”。这非常重要，因为由于高价值流量时间，渗透测试人员可能无法在某些时间进行渗透测试；他们也可能未经授权进行网络或托管在 AWS 环境中的 Web 应用程序的某些渗透测试区域。

在目标组织向渗透测试团队提供免责卡之前，需要明确了解范围。如果需要添加或删除渗透测试范围内的内容，那么应该进行更正，并列在免责卡上。

## 潜在损害

这是我们许多人不喜欢讨论的话题，或者至少在讨论时感到非常不安：系统可能在渗透测试期间被损坏或关闭的可能性。当要求对生产或实时系统进行渗透测试时，如果系统崩溃将导致巨大的收入损失，这尤其具有挑战性。渗透测试团队和客户组织必须制定一项紧急响应计划，以防不幸发生故障。此外，应该有一种解决方案，可以启动一个模仿生产环境的测试系统。

在对 AWS 进行渗透测试时，我们可以建议我们的客户创建一个模仿生产环境的单独的私人 VPC，并且只允许渗透测试团队访问。这样做可以让渗透测试团队实时测试系统，而不会对实时系统造成任何伤害。

## 了解数据分类

我们想知道在渗透测试期间存储在环境中的数据类型。如果有信用卡数据、社会安全号码和其他敏感数据，那么需要有一份说明，说明在渗透测试期间可能会看到数据。当然，如果发现明文存储的敏感数据应该加密，渗透测试团队需要立即通知他们的客户。

在本章中，我们已经学到了很多关于有影响力的攻击，也了解了一些法律问题。现在，让我们讨论另一个问题，我们需要了解并注意 - 压力测试。

# 压力测试

围绕着亚马逊客户计划使用某种类型的高容量测试来测试其系统、网络和产品的可靠性和耐久性建立了政策。在这种情况下，客户通常希望确保托管在 EC2 实例上的 Web 服务器能够承受大量的流量。压力测试，有时也称为负载测试或游戏测试，还可以确保如果流量对 Web 服务器造成了太大的压力，流量将被负载均衡器重定向。有关负载均衡的高级视图，请参阅*图 11.4*。

## 为什么要进行压力测试？

如前所述，我们进行压力测试是为了确保目标环境能够承受在系统生产期间可能预期的大量流量。

重要说明

生产服务器通常可以在网络上访问，并确保来自合法和非法来源的大量流量。

负载测试，或者压力测试，本质上是一种保证政策，让您放心了解您的 AWS 环境的可用性 - 确保您的网站或应用程序不会崩溃！如果某些东西，特别是在生产中，出现故障，可能会导致收入损失，公司与客户之间的信任丧失，或者员工与公司之间的信任关系丧失。

现在我们了解了压力测试的影响 - 在某种意义上，我们也了解了如果不进行压力测试会有什么影响 - 让我们讨论如何在 AWS 环境中进行压力测试。

## 授权压力测试

要获得在 AWS 环境中执行压力测试的授权，您需要向 AWS 提交一个接收表格。虽然大多数客户网络不在指导方针范围内，但检查是必不可少的 - 毕竟，不进行环境压力测试可能会导致更大的问题！

虽然 AWS 在提供资源方面做得很好，以防止与高流量相关的任何问题，但客户可以向 AWS 员工发送电子邮件，以确定他们的网络是否应该接受负载测试，以及应该对测试施加多少负载。

如果有疑虑，客户应该将查询发送至`aws-security-simulated-event@amazon.com`。一旦确认收到电子邮件，客户对其网络的担忧将需要在一个接收表格上填写，并且他们必须授权 AWS 评估他们的环境，以分析是否需要进行压力测试。

压力测试的同意将基于风险和相关系统的影响。建议客户说明潜在的高流量可能对实时系统产生的影响。如果授权进行压力测试，建议备用站点准备就绪，以防生产系统未能通过负载测试。生产系统未能通过负载测试将导致系统下线，客户无法访问。

另一个保持一致备份的好方法是在内部网络上拥有生产系统的开发模型或测试模型。这个复制的实时系统可以用来测试新功能，并且可以在外部和内部渗透测试期间作为目标，而不是针对生产站点。如果生产站点的测试系统不可用，强烈建议拥有一个！

现在我们更了解压力测试以及如何使用它来评估我们自己的系统，让我们开始总结本章并继续前进到下一章。

# 总结

在本章中，我们讨论了在渗透测试期间要注意的事项，并了解了 DoS、DDoS 和洪水攻击的更多细节。正如我们所了解的，这些攻击可能会产生极大影响，并违反 AWS 政策。我们还了解了如何避免法律问题以及如何减轻渗透测试期间可能出现的任何潜在法律问题。我们通过讨论压力测试以及 AWS 客户可以做些什么来了解他们的环境是否应该接受负载平衡测试来结束了本章。

在下一章，也是最后一章中，我们将探讨一些其他项目，可以帮助加强我们的 AWS 方法论。

# 进一步阅读

+   AWS 渗透测试：[`aws.amazon.com/security/penetration-testing/`](https://aws.amazon.com/security/penetration-testing/)

+   什么是 DDoS 和 DoS？[`aws.amazon.com/shield/ddos-attack-protection/`](https://aws.amazon.com/shield/ddos-attack-protection/)

+   压力测试：[`aws.amazon.com/ec2/testing/`](https://aws.amazon.com/ec2/testing/)
