# 第七章：*第七章*：评估和渗透 Lambda 服务

Lambda 服务运行代码，稍后可以根据需要在 Lambda 环境内响应事件和其他任务。这些事件和任务是发生在 AWS 环境内的任何事情-HTTP 请求、对 S3 存储桶的修改，以及例如新的 EC2 实例被启动。这使得 Lambda 在为组织设置和扩展网络及其服务时成为一个重要的服务。然而，Lambda 确实存在一些问题，比如对访问 Lambda 的限制较弱，可以执行未经授权的操作的易受攻击的函数，以及允许发生利用的 Lambda 策略内建规则。

本章将重点介绍 Lambda 中的漏洞发现如何导致利用服务以及发现内部流程和对象。

在本章中，我们将涵盖以下主题：

+   理解和设置 Lambda 服务

+   深入了解 Lambda

+   理解错误配置

+   使用 Lambda 进行反向 shell 弹出

# 技术要求

本章中使用的代码可在以下链接找到：[`github.com/PacktPublishing/AWS-Penetration-Testing/tree/master/Chapter%207:%20Assessing%20and%20Pentesting%20Lambda%20Services`](https://github.com/PacktPublishing/AWS-Penetration-Testing/tree/master/Chapter%207:%20Assessing%20and%20Pentesting%20Lambda%20Services)。

你还需要在具有公共 DNS 名称的 EC2 实例上安装 Kali Linux。

查看以下视频以查看代码的实际操作：[`bit.ly/35XHn7Q`](https://bit.ly/35XHn7Q)

# 理解和设置 Lambda 服务

欢迎来到 Lambda，在这里您的代码将在一个易于运行和管理的服务器上执行。Lambda 对于公司来说是简化运维和开发人员工作的绝佳方式，因为 Lambda 可以大幅度扩展和自动化基础架构。它允许代码仅在需要执行时执行，并可以帮助自动化其他服务，这样您就不必担心所有的维护工作！

让我们看看如何设置 Lambda 函数！

## 创建 Lambda 函数

Lambda 函数很像 Python 函数，因为它们执行其中构建的代码，而不是在外部执行。在 Python 中，这就是我们所谓的**内部**和**全局**语法。内部语法是在函数内部构建的代码，只能在函数内部运行，而全局语法可以在函数外部运行。Lambda 函数在函数内部运行所有内容。这些函数用于自动化、扩展和处理中间的所有事情。虽然我们不打算讨论使用 Lambda 函数的各种原因，但您可以在亚马逊上找到大量关于 Lambda 可能性的资源。要了解更多信息，请查看 AWS 关于 AWS Lambda 的广泛信息资源：[`docs.aws.amazon.com/lambda/latest/dg/welcome.html`](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html)。

让我们重新登录到 AWS 控制台，并将 Lambda 仪表板快捷方式固定到我们的主仪表板上。将 Lambda 函数图标固定在那里将使我们更容易地引用 Lambda 部分，因为我们在定位 Lambda 时不必浏览所有服务。

以下步骤帮助我们创建 Lambda 函数：

1.  转到 AWS 控制台并搜索`Lambda`：![图 7.1-将 Lambda 固定到 AWS 控制台](img/Figure_7.01_B15630.jpg)

图 7.1-将 Lambda 固定到 AWS 控制台

1.  一旦您有了 Lambda 的快捷方式，就可以点击它；让我们开始制作一个可以测试的函数。当您进入 Lambda 仪表板时，点击`testFunction`。**Runtime**选项将使用**Python 3.6**，这将是我们编写代码的环境：

![图 7.2-从头创建 Lambda 函数](img/Figure_7.02_B15630.jpg)

图 7.2-从头创建 Lambda 函数

完成后，您将看到可以保存和“测试”函数的位置。虽然查看函数配置管理器中的部分很重要，但现在我们不会太担心这个，因为它与我们正在做的事情关系不大。重要的是，我们了解在 AWS 控制台中如何设置 Lambda 的位置和方式-就像我们刚刚做的那样，并且在本章中将会更多地进行。

重要提示

有关 Lambda 的更多信息，请查看 AWS 文档：[`docs.aws.amazon.com/lex/latest/dg/gs-bp-create-lambda-function.html`](https://docs.aws.amazon.com/lex/latest/dg/gs-bp-create-lambda-function.html)。

让我们在下一节中进一步了解这些知识，并开始研究安全工程师和渗透测试人员如何使用某些技术来发现 Lambda 中的配置错误。

# 深入研究 Lambda

现在我们已经简要介绍了 Lambda 是什么，以及如何设置我们自己的 Lambda 服务，是时候开始研究 Lambda 的一些安全问题了。在实际的渗透测试过程中，您可能会遇到其中一些问题。在 AWS 方面，我作为渗透测试人员看到的最重要的问题之一是与 Lambda 相关的策略问题。策略是限制和允许访问资源的东西，类似于我们在*第四章**，利用 S3 存储桶*中所看到的。在本节中，我们将使用相同的*方法论*做一些事情，但我们将研究 Lambda 的配置错误。

重要提示

您将开始注意到，虽然本书中每一章的目标都不同，但方法论基本上是相同的，因为我们使用相同的步骤从目标中提取结果。

让我们开始向前迈进，学习更多的概念，并在 Lambda 中开始构建一些东西。让我们首先创建一个与 S3 配合工作的 Lambda 函数。

## 创建一个与 S3 兼容的 Lambda 函数

在本节中，我们将继续构建。了解 Lambda 服务及其功能是非常重要的。在这种情况下，它能够链接在渗透测试过程中可能成为潜在**枢纽**点的服务。

重要提示

枢纽是在获得访问权限后在环境中进行横向移动的过程。

我们要做的是开始研究 Lambda 和 S3 如何协同工作，然后我们可以看一些配置错误，如果不正确地进行缓解可能会导致一些问题。在我们利用系统之前，了解系统是如何创建的是至关重要的。这样做可以让我们能够采取“实践”方法来缓解这些问题，也有助于我们了解如何在各种服务之间进行流程中断，比如 S3 和 Lambda。

这是您可以期待的内容：

1.  **创建一个 S3 存储桶**：此存储桶将与 Lambda 函数关联。

1.  **创建一个 Lambda 函数**：Lambda 函数将作为 S3 存储桶的触发器进行集成。

1.  **将函数与 S3 集成**。

1.  **开始探索**我们从渗透测试的角度创建的东西。

现在让我们开始吧！按照以下步骤进行：

1.  首先，我们将使用 AWS 命令行创建我们的 S3 存储桶，并通过从 AWS 控制台查看它来验证我们的存储桶是否已创建-这是我认为的最佳实践。确保您随身携带您的 AWS ID 和 AWS 账户的 AWS 密钥。一旦您获得了您的凭据，使用`aws configure`命令登录到您的 AWS 环境。

重要提示

如果您需要帮助找到您的密钥，这是一个很好的参考资料，您可以使用它进行帮助：[`aws.amazon.com/blogs/security/how-to-find-update-access-keys-password-mfa-aws-management-console/`](https://aws.amazon.com/blogs/security/how-to-find-update-access-keys-password-mfa-aws-management-console/)。

1.  既然您已经进入环境，让我们开始创建一个存储桶！使用命令行，使用以下命令创建一个我们将存储在 AWS 环境中的存储桶：

```
$ aws s3api create-bucket --bucket pentestawslambda --region us-west-2 --create-bucket-configuration LocationConstraint=us-west-2
```

重要说明

您需要为存储桶名称使用自己独特的命名方案。此外，如果您不指定区域，它将默认放置在**美国东部**区域。

1.  完成使用命令行创建存储桶后，请登录到 AWS 控制台并验证存储桶是否已创建。我们可以通过检查 S3 存储桶仪表板来验证这一点：

![图 7.3–为 Lambda 创建的 S3 存储桶](img/Figure_7.03_B15630.jpg)

图 7.3–为 Lambda 创建的 S3 存储桶

现在我们已经设置好了我们的存储桶，是时候继续并创建另一个 Lambda 函数，我们可以通过触发器将我们的新存储桶连接到其中。这个存储桶将与我们创建的第一个 Lambda 函数有所不同，但现在您已经知道了设置 Lambda 函数的基本方法。

让我们从创建一个新函数并将其命名为`s3lambda`开始。请记住，您只能使用数字和小写字母！对于**Runtime**，请选择当前版本的 Python。在这个示例中，我们使用的是 Python 3.8。在点击**创建函数**之前，我们确实需要对我们的 Lambda 函数进行一些其他操作。

现在我们需要创建一个基本的权限角色，这将与我们的 Lambda 函数关联。要做到这一点，请按照以下步骤：

1.  点击`s3_pentesting_lambda`

--**策略模板**：**Amazon S3 对象只读权限**和**AWS Config 规则权限**：

![图 7.4–为 S3 创建一个新函数](img/Figure_7.04_B15630.jpg)

图 7.4–为 S3 创建一个新函数

1.  然后，我们需要继续在 Lambda 函数中**创建一个触发器**。这个函数是由 Lambda 环境中发生的事情触发的。点击**添加触发器**开始，并选择**S3**链接我们创建的名为**pentestawslambda**的存储桶并保存：

![图 7.5–创建一个 S3 触发器](img/Figure_7.05_B15630.jpg)

图 7.5–创建一个 S3 触发器

干得好–我们已经创建了一个与触发器关联的新 Lambda 函数！重要的是要理解 Lambda 可以链接到其他环境，因为在真正的渗透测试中可能会遇到它。如果发现与其他服务连接的易受攻击的 Lambda 函数，请确保详细说明问题以及易受攻击的 Lambda 函数可能使其他服务变得更脆弱。

说到由配置错误导致的漏洞，让我们继续讨论 Lambda 中的配置错误。

# 了解配置错误

发现弱策略中的配置错误是渗透测试 AWS 服务（如 Lambda 和 S3）中更重要的部分之一。由于安全性已经“内置”在服务中，Lambda 中出现的许多问题是由于用户端的配置错误造成的。这并不意味着不会犯错误，也不意味着 Lambda 内部可能存在固有缺陷；然而，为了论证，我们将关注它的配置。

对于 Lambda 策略，**配置错误**发生在某个属性以“宽松”的方式设置时。 “宽松”一词意味着策略允许的内容超出了预期。这些策略是允许未经授权的个人查看未经其查看的信息，或者更糟糕的是，允许恶意向量查看和外泄数据的原因。

`列出`、`读取`、`写入`、`权限管理`或`标记`。在策略的操作中标有`"*"`的操作意味着任何人都可以在服务上执行操作，这是绝对不好的！

那么，是什么造成了这些宽松的策略，我们如何在 Lambda 中找到它们？这就是我们将要发现的。此外，我们将通过使用内置在 AWS CLI 中的工具来做到这一点。

首先，我们将开始查看我们使用 S3 创建的存储桶。回想一下，我们在创建 Lambda 函数并将其与存储桶集成时设置了一些相当“宽松”的权限。让我们看看它是如何轻松快速地升级到不被预期的情况的。

重要说明

在评估 Lambda 函数时，我们将进行 Lambda 和 S3 安全检查。

继续前进，让我们查询我们创建的 Lambda 函数的策略。这将为我们列出 Lambda 函数的属性：

```
$ aws lambda get-policy --function-name s3lambda --region us-west-2
{
    "Policy": "{\"Version\":\"2012-10-17\",\"Id\":\"default\",\"Statement\":[{\"Sid\":\"lambda-74fa4b03-e053-47e0-bdee-0288118c1b3e\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"s3.amazonaws.com\"},\"Action\":\"lambda:InvokeFunction\",\"Resource\":\"arn:aws:lambda:us-west-2:030316125638:function:s3lambda\",\"Condition\":{\"StringEquals\":{\"AWS:SourceAccount\":\"030316125638\"},\"ArnLike\":{\"AWS:SourceArn\":\"arn:aws:s3:::pentestawslambda\"}}}]}",
    "RevisionId": "692f71fd-40d2-40f6-99b0-42c4e1d7a353"
}
```

如您所见，策略的布局非常简单明了。但是，如果您仔细观察，您会注意到有关此函数的一些有趣之处。在继续之前，让我们仔细看看这个函数。如果我们在渗透测试中拉取了类似于这个策略的东西，我们会得出以下结论：

+   允许**调用**函数的“允许”操作是允许的。虽然这很好，但我们通常不希望任何人都能这样做。允许任何人调用可能会在以后造成重大问题，因为如果有人成功入侵内部 AWS 网络，他们可能会继续运行 Lambda 函数。

+   我们还在策略中看到了`pentestawslambda` S3 存储桶。虽然这更多是信息性的，但它让我们知道了 S3 存储桶的完整 URL。攻击者可以使用这些信息来了解更多关于 S3 存储桶，或者发现可能存在于该环境中的更多存储桶。因此，IAM 策略等访问控制对于只允许那些需要知道的人能够访问 AWS 环境中的服务至关重要。

现在我们对如何渗透测试 Lambda 以及要注意的事项有了更多了解，让我们采取不同的方法，看看如何在 Lambda 环境中获得持久性访问。

# 使用 Lambda 弹出反向 shell

本章的最后一部分涵盖了我最喜欢的渗透测试部分之一。本节将指导我们设置一个易受攻击的 Lambda 函数，然后使用该函数在我们的渗透测试机器上启动反向连接。对于本节，我们需要使用以下内容：

+   Kali Linux 在具有公共 DNS 名称的 EC2 实例上

+   一个 Lambda 函数

重要说明

确保您正在使用具有公共 DNS 的 EC2 实例。 Lambda 函数将需要连接到该公共 DNS。

## 反向 shell 的酷炫之处

获取“shell”是渗透测试中最有成就感的部分之一。能够获得反向 shell 意味着您成功利用了目标并在该机器上获得了持久性（持久性是指在该机器上的终端连接）。但它不仅仅是一个连接；它还突显了被测试环境中的问题。例如，调用网络的服务器可能允许各种通常看不到的出站连接。这使得反向 shell 可以传送到公共网络。

### 渗透测试的 shell？

客户可能希望您测试其安全性的监控和检测。创建一个易受攻击的 Lambda 函数，使其在网络内部和外部进行调用，是测试公司监控实践和解决方案的绝佳方式，同时还可以与 Lambda 一起玩得开心。

获取 shell 远不止于*仅仅*获取 shell-它测试监控、防火墙规则和一般安全姿态。在渗透测试期间，如果您能够使用易受攻击的 Lambda 函数在网络外部获得反向 shell，可以假定网络内部的其他漏洞可能使用相同的路径呼叫网络外部。

现在我们更了解反向 shell，让我们看看如何设置一个易受攻击的 Lambda 函数，可以向我们回拨并允许远程访问 Lambda 环境。

重要说明

在继续之前，有必要知道 Lambda 按毫秒计费。如果您不断运行 Lambda 函数，将对其收费。

是时候使用 shell 了！

## 道德黑客游戏计划

现在让我们获取我们的 shell，现在我们对 shell 及其对渗透测试的影响有了一些了解。在实际执行之前，我们将看一下即将发生的事件顺序。在执行攻击路径时，事先制定游戏计划可能是一个好的做法：

1.  启动一个带有公共 DNS 的 EC2 实例。

1.  创建一个有漏洞的 Lambda 函数，将回调到公共 DNS。

1.  在 EC2 实例上启动一个监听器。

1.  测试并运行有漏洞的 Lambda 函数。

1.  获取一个 shell。

### 获取一个 shell

现在我们有了一个游戏计划，让我们继续并启动我们之前创建的 EC2 实例。一旦它运行起来，继续登录到我们的 Lambda 仪表板。现在让我们看看如何通过以下步骤继续执行：

1.  从这里开始，我们将点击**创建函数**按钮开始：![图 7.6 - 创建另一个函数](img/Figure_7.06_B15630.jpg)

图 7.6 - 创建另一个函数

1.  登录后，创建一个名为`LambdaShell`的新函数，并确保选择**Python 2.7**。我们创建的角色将适用于此示例：![图 7.7 - 为反向 shell 创建函数](img/Figure_7.07_B15630.jpg)

图 7.7 - 为反向 shell 创建函数

1.  现在是时候开始设置我们的函数，以创建与 EC2 实例的反向连接。我设置了一个 GitHub 存储库，我们可以从中拉取代码：[`github.com/PacktPublishing/AWS-Penetration-Testing/blob/master/Chapter%207:%20Assessing%20and%20Pentesting%20Lambda%20Services/Lambda_Shell.txt`](https://github.com/PacktPublishing/AWS-Penetration-Testing/blob/master/Chapter%207:%20Assessing%20and%20Pentesting%20Lambda%20Services/Lambda_Shell.txt)。

您放入的代码应该如下所示：

```
lambda_handler that will execute a connection from the Lambda function to our attacker machine. Note that, when we call s.connect, we need to put our public DNS in the code where it says hostname. Once the function is executed, it will initiate a connection back to our machine and execute a Bash shell on the target Lambda function.Make sure that you designate a **port** to use and that the **hostname** is set to the public DNS name of your attacker machine on your EC2 instance. You can see what the public DNS name is by looking at the description for your Kali EC2 instance, which can be found on the EC2 dashboard.
```

1.  接下来，我们需要确保函数不会太快超时。默认情况下，函数应该在大约 3 秒后超时。我们需要建立持久性，所以可以将超时设置为大约`5`分钟 - 如果需要，可以设置更长时间：

重要提示

Lambda 函数允许的最长时间为`15`分钟。

![图 7.8 - 设置 shell 超时](img/Figure_7.08_B15630.jpg)

图 7.8 - 设置 shell 超时

1.  接下来，您需要 SSH 到您的 Kali 机器，并设置一个`su -`命令，在每个命令之前切换到`sudo`，因为您将以 root 帐户运行。

1.  下一个命令设置了我们将用于**监听**来自目标**Lambda 服务**的传入连接的**netcat**监听器：

```
$ nc -lvnp 1337
```

1.  我们应该让我们的监听器待命，准备好测试我们的功能。现在是我们获得反向 shell 并在 Lambda 环境中获得一些持久性的时候了。要执行，请点击右上角的**测试**按钮。您将看到一个显示**配置测试事件**的窗口 - 继续点击**创建**，然后再次点击**测试**。请注意，在点击**测试**之前，您将获得一个具有三个键的事件模板。将它们保留为默认值：![图 7.9 - 在执行函数之前配置测试事件](img/Figure_7.09_B15630.jpg)

图 7.9 - 在执行函数之前配置测试事件

1.  点击**测试**按钮后，您将看到函数在仪表板中运行。现在回到您在 Kali 机器上的终端。您将在 Lambda 实例上收到一个反向连接！随时在您的 shell 中运行一些 Linux 命令：

![图 7.10 - 获取反向 shell](img/Figure_7.10_B15630.jpg)

图 7.10 - 获取反向 shell

看吧！我们可以始终访问 Lambda 环境！虽然这是一个很酷的有趣的例子，但我们需要了解一些潜在的问题，以及为什么在渗透测试期间我们会记录这些。假设我们正在测试 Lambda 环境的弱策略。策略不应该允许渗透测试人员执行超出 Lambda 环境的调用 - 记住，我们去了一个公共 DNS，这意味着我们走出了 VPC！

好的，所以我们之前在 AWS 控制台的 GUI 中完成了所有这些操作，这很有趣也很酷。让我们快速看一下更实用的方法 - 使用 AWS CLI。我们将假设凭据已被泄露，并且该函数已经准备好供我们使用。

## 使用 AWS CLI 调用

现在我们的函数已经在环境中，让我们看看如何只使用托管在我们的公共 EC2 实例上的 Kali Linux 机器来实现持久性。首先，确保您通过 SSH 登录到 Kali，并通过在命令的末尾加上`&`来在后台运行`netcat`。在后台运行命令可以让您仍然使用终端：

```
$ nc -lvp 1337 &
```

现在你的监听器已经在后台设置好并准备就绪。在执行连接之前，我们需要配置到 AWS 环境。在终端中键入`aws configure`，确保使用我们在之前章节中使用的 ID 和密钥。一旦设置到环境中，运行以下命令来启动 shell：

```
$ aws lambda invoke --function-name <<Lambda ARN>> --invocation-type RequestResponse outfile.txt --region <<aws region>>
```

重要提示

您可能需要在您的 Kali 实例上安装 AWS CLI。要安装 AWS CLI，请运行以下命令：`$ apt-get install awscli -y`。

正如你所看到的，在 Lambda 中获取 shell 可能很有趣，但对于毫无戒心的企业来说也可能很危险。对抗这种情况的一个很好的方法是在网络中部署监控解决方案 - 诸如网络预防和检测系统之类的设备，这些设备具有检测网络中的异常流量的出口规则，以及检查进入的数据包的入口规则。在 AWS 方面，**CloudTrail**是在尝试检测与 AWS 环境之间的流量时使用的一个很好的资源。

在本书中我们已经谈论了很多关于 Metasploit，现在让我们看看如何在 Lambda 中使用 Metasploit。我们将看看如何利用 Metasploit 中的处理程序来捕获会话。

重要提示

会话是在 Metasploit 中被挂钩的连接。

## 使用 Metasploit 和 Lambda 玩得开心

现在我们了解了如何使用 Python 和 Lambda 创建 shell 脚本，让我们看看如何使用 Metasploit 来获得类似的结果！在这个练习中，我们可以使用之前的相同有效载荷；但是，如果您重新启动了实例或者使用了不同的 EC2，您可能需要更改您的实例 DNS 名称。

在开始之前，让我们讨论一下我们将要做什么；记住，最好在执行计划之前制定计划，即使这个计划很小！例如，我们需要使用`netcat`建立连接。我们在设置 Lambda 函数的反向 shell 时学习了`netcat`。

由于我们之前在*第三章**，探索渗透测试和 AWS*中使用过 Metasploit，所以不需要讨论 Metasploit 或如何启动它。但是，我们需要确保使用正确的有效载荷。以下步骤将展示如何使用 Python 有效载荷设置处理程序，以捕获我们的脆弱 Lambda 函数的连接。

启动 Metasploit 并输入以下命令开始设置处理程序：

```
$ use exploit/multi/handler 
$ set payload python/meterpreter/reverse_tcp
$ set lhost <<EC2 instance DNS>>
$ set lport 1337
$ run 
```

一旦您开始运行处理程序，您的处理程序将进入`netcat`工作，除了我们使用 Meterpreter 来解释我们的 shell 和`netcat`连接中使用的默认 Bash shell 之外。Meterpreter shell 比`netcat`连接更强大，因为它们提供了大量的模块，您可以在 Meterpreter shell 中加载这些模块。我们将在*第九章**，使用 Metasploit 进行真实渗透测试和更多内容*中了解更多。

现在我们的监听器正在运行，回到您的易受攻击的 Lambda 函数并测试它，尝试连接到您的 Meterpreter 监听器。如果一切顺利，您将拥有一个分段器，然后是一个会话。您的会话是与目标的交互式 shell：

![图 7.11-通过 Meterpreter 获取反向 shell](img/Figure_7.11_B15630.jpg)

图 7.11-通过 Meterpreter 获取反向 shell

现在，在我们的 Lambda 实例上通过 Meterpreter 拥有了一个交互式 shell。如果此 Lambda 实例正在连接其他资源，则可能存在转向的可能性-但是在本示例中，我们不会过多担心这一点。在*第九章**，使用 Metasploit 进行真实渗透测试和更多内容*中将更多地涉及转向。目前，可以随意移动您的 shell，尝试不同的有效载荷，甚至扩展您的环境，看看您还能做些什么！

在书的这一部分中做得很好！本章着重介绍了一些在渗透测试中使用的新技术，您还学会了如何在 Lambda 上获取反向 shell！

# 摘要

在本章中，我们看了如何在 AWS 中创建 Lambda 函数以及它们的功能。我们还研究了 Lambda 的易受攻击问题以及这些问题可能给未能隔离这些问题的组织带来的漏洞。创建反向 shell 有助于我们了解如果易受攻击的 Lambda 函数出现在环境中会出现什么严重问题。

在下一章中，我们将开始研究如何攻击 AWS API，并查看它们如何处理请求，以及讨论用于保护它们的技术。

# 进一步阅读

+   交互式 Lambda shell：[`www.lambdashell.com/`](http://www.lambdashell.com/)

+   Metasploit 处理程序：[`www.rapid7.com/db/modules/exploit/multi/handler`](https://www.rapid7.com/db/modules/exploit/multi/handler)
