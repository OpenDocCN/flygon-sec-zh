# 第八章：评估 AWS API Gateway

AWS API Gateway 充当了可以托管各种类型数据的应用程序的门户。它们托管的数据各不相同；然而，有一点是一样的，即一些数据可能被未经授权的人员视为有吸引力 - 例如 S3 存储桶的位置或过于宽松的标头。本章将讨论 AWS API Gateway 是什么，以及您如何学习使用开源工具检查 API 调用和操纵 API 调用。

了解 AWS API 的工作原理将使我们的思维模式从 Linux 终端扩展到浏览器，并了解 Web 服务的基础知识以及如何与其交互。在阅读本章的过程中，请记住，其中的许多技术也可以评估 AWS 中的所有 Web 应用程序。本章旨在让您全面了解 AWS API 以及如何通过操纵 API 调用来评估 Web 应用程序。

在本章中，我们将涵盖以下主题：

+   探索和配置 AWS API

+   使用 AWS 创建我们的第一个 API

+   使用 Burp Suite 入门

+   使用 Burp Suite 检查流量

+   操纵 API 调用

# 技术要求

+   Burp Suite: [`portswigger.net/burp/communitydownload`](https://portswigger.net/burp/communitydownload)

查看以下视频以查看代码的实际操作：[`bit.ly/3kPr2sb`](https://bit.ly/3kPr2sb)

# 探索和配置 AWS API

您是否曾经想过信息是如何从您的计算机发送到网站或该网站的后端服务器的？通常情况下，您的请求是从浏览器发送的，然后通过称为**应用程序编程接口**（**API**）的东西进行。API 是一个接口，用于允许其他应用程序或主机与一个中心点进行交互。在这种情况下，API 是中心点，而应用程序将是我们在 AWS 中与之交互的服务。

那么，这对于 AWS 意味着什么，我们将如何通过本书来使用它？首先，我们需要了解亚马逊 API 的基本术语以及亚马逊 API 网关如何管理服务。我们将通过查看 AWS 环境中 API 的高级视图来了解这一点，然后学习如何拦截和操纵 API 请求，就像在现实的渗透测试中一样。

AWS API Gateway 是一个托管服务，提供了一个**前门**，允许您访问各种 AWS 服务上的应用程序和数据。网关处理涉及接受和处理 API 请求的所有任务。API 还在身份验证和授权控制中发挥关键作用，这在安全方面起着至关重要的作用。如果有人能够绕过身份验证和授权机制，他们将能够直接访问被攻击的服务或资源。

在我们开始查看 API 的高级地图以及它们如何与我们的 AWS 环境配合工作之前，我们需要了解 AWS 提到的两种 API 类型。我们将讨论的两种 API 是**RESTful APIs**和**WebSocket APIs**。

## RESTful APIs

REST 实际上是**REpresentational State Transfer**的首字母缩写。RESTful API 设计使我们能够进行所谓的无状态调用或无状态请求。这种无状态请求允许在发生故障时重新部署调用，并且在需要时也可以进行扩展。这个功能使得 RESTful API 在云应用中相当受欢迎，比如 AWS，因为无状态 API 的扩展可以很容易地与敏捷扩展的云环境集成。由于它们的敏捷性，RESTful API 可以根据流量负载快速进行调用和更改，而不会变得不堪重负。

重要提示

关于 API 的信息远远超出了本书中的材料。如果您想了解更多关于 RESTful API 的信息，请查看 AWS 文档：[`docs.aws.amazon.com/apigateway/api-reference/`](https://docs.aws.amazon.com/apigateway/api-reference/)。

现在我们对 RESTful API 有了更多的了解，让我们简要提一下另一种类型的 API：WebSocket API。

## WebSocket API

WebSocket API 网关是集成了各种路由和各种服务（如 Lambda 函数和 HTTP 端点）的集合。WebSocket API 是双向的，并确保终端客户端可以将流量发送到服务并从服务发送通信回客户端。

重要提示

双向基本上意味着流量可以在两个不同的方向上运行。

由于它们的多功能性和双向功能，WebSocket API 通常用于运行实时流媒体频道的应用程序，例如游戏、华尔街使用的金融交易平台和聊天应用程序 - 其中一些您可能用来与朋友和家人交谈！

现在我们已经了解了 API 是什么以及它们是如何工作的，我希望我们开始更多地应用一些实际的知识来帮助将所有内容完整地连接起来。然而，在我们开始之前，让我们快速地看一下 API 在 AWS 中如何工作，并与虚拟私有云（VPC）和 EC2 实例进行交互的高级概述。

## API 地图概述

本节将简要说明 API 如何与 VPC 中的 Lambda 函数和 EC2 实例配合工作的高级视图。运行 API 并将其与各种服务集成的优势在于可以通过 Web 流量门户（在本例中为 API）扩展多个服务，并从 API 中集中记录所有内容。正如前面提到的，API 允许快速高效地进行扩展 - 因此将它们作为访问多个服务的主要门户将使您能够构建更多从一个中央 API 查询的服务。

现在让我们看一个简单的解决方案，创建一个允许您访问 Lambda 函数和 EC2 实例的 API。在这个例子中，我们不担心服务在做什么。我们更关心的是理解流量如何从 Amazon API 网关流向服务，以及从服务返回到 API。

查看以下插图，以帮助您了解与 AWS 服务一起使用 API 的过程：

![图 8.1 - AWS API 网关图](img/Figure_8.01_B15630.jpg)

图 8.1 - AWS API 网关图

从图表中可以看出，外部用户正在尝试通过 API 访问服务。请记住，API 使用 Web 请求调用来发布和检索信息。 **Amazon API Gateway** 根据用户的请求向 **Lambda 函数** 或 **EC2 实例** 发出调用。然后服务将数据发送回外部用户。这完成了用户和服务之间的流量流动。

重要提示

在本章后面的部分中，我们将更多地了解 Web 请求在操作 API 调用时的情况。

现在我们对 API 是什么以及它如何与 AWS 服务配合工作有了很好的理解，让我们继续制作我们自己的 API。

# 使用 AWS 创建我们的第一个 API

本节将简要但简洁地介绍如何在 AWS 中设置自己的 API。我们不会担心将任何服务连接到它 - 我们将在以后的练习中检查流量并将调用传递到 API 时再进行连接。

以下是指导您创建一个可以在本章中使用的 API 的说明。要开始，请登录 AWS 控制台并按照以下步骤操作：

1.  在 AWS 控制台的主菜单中的搜索栏中搜索`api`服务：![图 8.2 - 搜索 api](img/Figure_8.02_B15630.jpg)

图 8.2 - 搜索 api

1.  接下来，您将获得一个 API 列表可供选择。选择**REST API**并点击**构建**：![图 8.3 – 构建 API](img/Figure_8.03_B15630.jpg)

图 8.3 – 构建 API

1.  现在您需要配置 API。确保选择`PentestPacktAWS`。您可以随意命名您的 API，但请确保记住名称。提供描述是可选的，但是是一个好习惯，特别是当您开始构建更多的 API 时 - 它将帮助您记住每个 API 的目的：![图 8.4 – 命名 API](img/Figure_8.04_B15630.jpg)

图 8.4 – 命名 API

1.  输入完所有信息后，点击**创建 API**完成。

点击**创建 API**后，您将进入 API 的主要仪表板。这是我们将在本章后面配置 API 的地方。现在，可以随意熟悉面板。

现在我们已经学会了如何创建 API，下一个合乎逻辑的步骤是了解我们将用来评估 API 的工具。本章的下一部分将重点介绍一种名为 Burp Suite 的流行网络工具。

# 开始使用 Burp Suite

本章的这一部分将讨论本书尚未使用的工具。我们将使用的工具是一种代理工具，它允许我们对 Web 应用程序进行安全测试，在我们的情况下，它将使我们能够拦截发送到和从我们的 AWS API 目标的请求。这意味着 Burp Suite 将使我们完全控制通过我们的 Web 浏览器发送的请求，使我们能够操纵对 API 的调用。

重要提示

代理是在发送到目标之前检查和分析流量的服务器或服务。

拦截 API 的调用允许我们查看诸如令牌、会话和其他可能能够被更改以使 API 接受不应该接受的调用的参数。这是漏洞赏金猎人和网络应用程序渗透测试人员常用的技术。

重要提示

漏洞赏金猎人是一名自由渗透测试人员，与公司合作测试其网站上的漏洞。这些漏洞是通过第三方服务报告的，称为漏洞赏金计划。在这里了解更多关于漏洞赏金计划：[`whatis.techtarget.com/definition/bug-bounty-program`](https://whatis.techtarget.com/definition/bug-bounty-program)。

在接下来的部分中，我们将登录到本地的 Kali Linux 机器，并启动 Burp Suite 并将其配置到我们的 Web 浏览器。一旦设置好，我们将拦截一些不同的请求并检查各种 Web 请求，以更多地了解如何使用该工具。

## 配置 Burp Suite

现在我们更了解 Burp Suite 是什么，让我们继续实际动手并开始使用该应用程序。在开始之前，您需要在 VirtualBox 中启动本地的 Kali Linux 机器。一旦机器启动并运行，登录到 Kali Linux 机器。

登录后，使用以下步骤启动 Burp Suite：

1.  启动终端并输入`burpsuite`。

1.  一旦打开 Burp Suite，您需要选择**临时项目**：![图 8.5 – 新的 Burp 项目](img/Figure_8.05_B15630.jpg)

图 8.5 – 新的 Burp 项目

1.  选择**使用 Burp 默认值**：![图 8.6 – 使用 Burp 默认值](img/Figure_8.06_B15630.jpg)

图 8.6 – 使用 Burp 默认值

1.  接下来，转到**代理**选项卡，并找到**选项**部分：![图 8.7 – 配置接口](img/Figure_8.07_B15630.jpg)

图 8.7 – 配置接口

1.  您需要确保将接口配置为本地地址`127.0.0.1`，并将端口设置为`8080`。Burp Suite 默认已配置好，但是如果不是这样 - 您可以配置 Burp Suite 以满足上一个截图的规格。

很好，现在我们已经设置好了 Burp Suite 绑定到我们的本地主机的`8080`端口。这意味着通过我们的本地主机发送到`8080`端口的任何流量都将被 Burp Suite 捕获。

我们还没有完成，现在我们需要配置我们的浏览器，以便将流量通过我们分配的本地主机上的指定端口。

要开始，请在您的 Kali Linux 机器中打开 Firefox：

1.  打开终端，输入`firefox`并按下**Enter**。

1.  接下来，点击浏览器右上角的选项，选择**首选项**：![图 8.8 - 浏览器配置](img/Figure_8.08_B15630.jpg)

图 8.8 - 浏览器配置

1.  接下来，在**首选项**部分的搜索栏中键入`代理`。点击**设置...**继续：![图 8.9 - 配置 web 代理](img/Figure_8.09_B15630.jpg)

图 8.9 - 配置 web 代理

1.  确保`8080`。确保选择**为所有协议使用此代理服务器**。这将允许加密流量通过。完成后点击**确定**：

![图 8.10 - 设置代理参数](img/Figure_8.10_B15630.jpg)

图 8.10 - 设置代理参数

干得好，您已成功配置浏览器以与 Burp Suite 配合使用。从现在开始，我们将开始使用 Burp Suite 拦截本章剩余部分的 web 请求。但是，在开始之前，我们需要在浏览器上安装 Burp Suite 证书。重要的是，我们有能力拦截流量，以便我们可以看到通过我们的浏览器传输的未加密和加密流量。

要安装 Burp Suite 证书，请按照以下步骤进行：

1.  在配置好并运行 Burp Suite 后，在浏览器中输入以下网址：

[`burp`](http://burp)

1.  您将在右上角看到一个横幅，上面写着**CA 证书**。点击它：![图 8.11 - Burp 证书](img/Figure_8.11_B15630.jpg)

图 8.11 - Burp 证书

1.  保存文件。

1.  返回到`证书`。点击**查看证书...**：![图 8.12 - 查看证书](img/Figure_8.12_B15630.jpg)

图 8.12 - 查看证书

1.  接下来，您将看到**证书管理器**。在这里，您需要导入我们刚刚从 Burp Suite 下载的证书。要做到这一点，点击**导入...**：![图 8.13 - 导入证书](img/Figure_8.13_B15630.jpg)

图 8.13 - 导入证书

1.  导入我们刚刚下载的`cacert.der`文件。

1.  勾选**信任 CA 以识别网站**和**信任 CA 以识别电子邮件用户**。完成后点击**确定**：

![图 8.14 - 导入证书继续](img/Figure_8.14_B15630.jpg)

图 8.14 - 导入证书继续

就是这样！现在我们正式准备拦截一些 web 请求！在本书中或现实生活中使用 Burp Suite 时，请确保在使用前打开代理，在使用后关闭代理！如果不关闭代理，可能会在使用 web 浏览器时遇到一些问题。

重要提示

如果您仍然在使用 Burp Suite 应用程序时遇到问题，请查看帮助指南以解决常见问题：[`portswigger.net/burp/documentation/desktop/getting-started/proxy-troubleshooting`](https://portswigger.net/burp/documentation/desktop/getting-started/proxy-troubleshooting)。

# 使用 Burp Suite 检查流量

接下来的部分将介绍如何检查我们刚刚创建的 REST API 的流量。使用 Burp Suite 检查流量对于网络渗透测试和 web 应用程序渗透测试至关重要，因为它允许我们查看特定连接上的所有通信。虽然我们不会担心网络拦截，但我们将使用许多在 web 应用程序渗透测试中使用的相同技术。

在我们开始检查流量之前，我们需要确保在开始之前进行一些快速的清理工作。我们需要确保我们也部署了我们的 AWS API 网关，这样我们才能学习如何拦截来自 REST API 的流量。

## 部署 API 网关

要开始，请重新登录 AWS 控制台并转到本章开头创建的 API：

![图 8.15 – 选择我们的 API](img/Figure_8.15_B15630.jpg)

图 8.15 – 选择我们的 API

点击 API 以访问网关开始。

一旦您进入 AWS API 的主配置屏幕，您需要选择**操作**。这将弹出一个菜单，其中有创建方法、删除 API 的选项，最重要的是创建方法和部署 API 的选项。以下步骤将帮助您完成部署 API 的指导：

1.  点击**操作**：![图 8.16 – 选择操作](img/Figure_8.16_B15630.jpg)

图 8.16 – 选择操作

1.  选择**创建方法**。

1.  选择**ANY**作为操作。

1.  选择**模拟**作为集成类型：![图 8.17 – 创建模拟方法](img/Figure_8.17_B15630.jpg)

图 8.17 – 创建模拟方法

1.  点击**保存**。

很好，现在我们有一个可以用来调用 API 的方法。既然我们有了一个方法，我们可以继续部署我们的 API 并使其可访问。接下来的步骤将帮助我们部署 API：

1.  点击**操作**。

1.  接下来，选择**部署 API**：![图 8.18 – 部署 API](img/Figure_8.18_B15630.jpg)

图 8.18 – 部署 API

1.  选择**[新阶段]**作为**部署阶段**。

1.  对于阶段名称，使用**prod**：![图 8.19 – 配置阶段名称](img/Figure_8.19_B15630.jpg)

图 8.19 – 配置阶段名称

1.  最后，点击**部署**。

点击**部署**后，您会注意到在您的 AWS API 仪表板顶部会有一个横幅。横幅上会显示**调用 URL**。您应该看到一个网址，看起来像以下截图中的样子：

![图 8.20 – API 横幅](img/Figure_8.20_B15630.jpg)

图 8.20 – API 横幅

该网址是您新部署的 AWS API 的网址，将用于测试下一节中拦截流量。请注意，您的 API 地址将与此示例中的网址不同。

接下来，让我们继续拦截我们新部署的 AWS API 上的一些流量。

## 实际操作拦截 API 调用

现在是一些有趣的、实际操作的内容。现在我们将从清理部分转移到一些实际操作的练习，以帮助您使用 Burp Suite。在继续之前，请确保您已经配置了 Burp Suite 和您的浏览器以拦截 Web 流量。如果需要复习，请参考*配置 Burp Suite*部分。

使用正确配置的 Burp Suite 和您的 Web 浏览器，让我们开始吧：

1.  打开您的浏览器，将 API 网址放入地址栏并点击*Enter*。查看前一节的*步骤 5*，以了解如何**调用 URL**的提醒。

1.  您的 Burp Suite 应用程序应该弹出一个**拦截**窗口：![图 8.21 – GET 请求](img/Figure_8.21_B15630.jpg)

图 8.21 – GET 请求

1.  这里发生的是我们正在拦截主机和服务器之间的通话。注意`GET`参数后面跟着`/prod`。这意味着我们正在尝试检索`prod`目录。

1.  继续，点击**转发**将请求发送到服务器：![图 8.22 – 转发请求后的 Web 浏览器](img/Figure_8.22_B15630.jpg)

图 8.22 – 转发请求后的 Web 浏览器

1.  如您所见，我们有一个空白屏幕 – 这完全没问题。因为页面呈现为空白，没有**未找到**横幅，我们知道 URL 有效。

我们现在成功地拦截了主机机器和 AWS API 之间的数据包。虽然这可能看起来很基础，但在我们开始操作 API 调用之前，我们必须了解 Burp Suite 拦截 Web 流量的基础知识。如果我们跳过了解如何设置我们的环境并理解基本的拦截，我们就无法真正理解正在发生的确切过程。

接下来，我们将继续进行本章的最后一部分。我们将学习更多关于 HTTP 方法的知识，并通过构建我们迄今所学的一切来学习如何操作 API 调用。

# 操作 API 调用

在开始之前，我们需要了解可以用来操作 API 调用的基本 HTTP 方法。HTTP 请求方法本质上是您想要在目标 API 上执行的操作。通常称为 HTTP 动词，这些方法可以允许我们向目标资源放置数据和检索数据或信息。下一部分将简要介绍这些方法。

`GET`方法从特定地址请求资源。使用`GET`的请求应该只检索数据。`HEAD`方法要求一个等同于`GET`请求的确认，只是没有确认主体。`DELETE`方法用于删除指定的资源。`POST`方法用于向目标资源提交数据 - 通常，您会看到`POST`方法用于发布数据并引起问题。`PUT`方法用于在目标服务器上放置数据。

现在我们了解了 HTTP 方法是什么以及它们是如何工作的，让我们看看它们的实际应用。对于下一个示例，我们将运行一个练习，通过操作调用一个易受攻击的 S3 API。如果您需要复习如何创建 S3 存储桶，请参考*第四章**，利用 S3 存储桶*。

重要提示

要了解有关为 S3 创建 API 的更多信息，请参考此资源：[`aws.amazon.com/s3/features/access-points/`](https://aws.amazon.com/s3/features/access-points/)。您需要在其中创建一个自己的测试文件夹的存储桶，以执行下一个练习。

## 玩转修改 HTTP 方法

对于下一部分，我们将通过 AWS API 来定位一个 S3 存储桶。存储桶位于[`awspublicpackt.s3.amazonaws.com/`](https://awspublicpackt.s3.amazonaws.com/)。让我们继续在 Burp Suite 中拦截它：

1.  使用 Burp Suite 和已配置为拦截 Web 流量的浏览器，在 URL 栏中输入地址：![图 8.23 - Burp 请求](img/Figure_8.23_B15630.jpg)

图 8.23 - Burp 请求

1.  如您所见，我们正在基于`host`参数拦截 API 调用。我们正在使用`GET`方法，这意味着我们正在检索资源。点击**前进**继续：![图 8.24 - 查看存储桶对象和密钥](img/Figure_8.24_B15630.jpg)

图 8.24 - 查看存储桶对象和密钥

1.  如您所见，有一个名为`TestAPI.txt`的目录。接下来，让我们继续拦截`test`目录，并查看是否可以查看文本文件：![图 8.25 - 检索 TestAPI.txt](img/Figure_8.25_B15630.jpg)

图 8.25 - 检索 TestAPI.txt

1.  点击**前进**：![图 8.26 - TestAPI.txt 的输出](img/Figure_8.26_B15630.jpg)

图 8.26 - TestAPI.txt 的输出

1.  请注意，文本文件的内容正在显示。这意味着我们有读取权限。接下来，让我们看看是否可以通过操作 API 在存储桶中放置一个对象。让我们使用`PUT`方法将`HackedAPI.txt`测试文件放入`i love pentesting`数据到文本文件中：![图 8.27 - 通过操作 API 调用放置数据](img/Figure_8.27_B15630.jpg)

图 8.27 - 通过操作 API 调用放置数据

1.  现在，为了确认我们已经将数据放在目标上，我们可以在终端中使用`curl`命令来检查并查看数据是否已存储。我们使用以下命令来验证数据是否已放入 S3 存储桶：

```
$ curl https://awspublicpackt.s3.amazonaws.com/test/Hacked.txt
```

我们看到以下输出：

![图 8.28 – 成功的数据上传](img/Figure_8.28_B15630.jpg)

图 8.28 – 成功的数据上传

1.  正如我们所看到的，通过操纵 API 中的调用，我们已成功将数据放入了 S3 存储桶。接下来，让我们看看是否可以删除`/test`合法资源。

正如您所看到的，我们能够通过操纵 HTTP 请求中的方法来操纵我们的主机和资源之间的调用。根据我们刚刚进行的练习，我们能够通过操纵 HTTP 调用来读取和写入资源的数据。这是非常危险的，因为如果被发现，攻击者可能会留下恶意软件或窃取敏感信息。非常重要的是要建立适当的访问控制，以确保资源不会被留下不安全。

现在让我们继续，结束本章，并开始着手下一部分的内容，*第九章**，使用 Metasploit 和更多进行真实的渗透测试！*

# 摘要

在本章中，我们了解了与 AWS 中的 API 和网关相关的 Web 流量和 Web 请求。我们学会了部署简单的 API 网关，还学会了使用评估 API 和网关的重要工具–Burp Suite。我们进行了一个有趣的练习，演示了如何使用 Burp Suite 来操纵 HTTP 请求，并提到了留下 API 易受攻击的危险。有了这些知识，您现在可以使用本章学到的方法对基于 Web 的应用程序和服务进行攻击和评估。

在下一章中，我们将通过更多的实践经验来进一步了解 AWS。这是本书中最长的一章，将让您建立新的环境并根据场景进行利用，最终教会您 AWS 渗透测试的技术部分和相关流程。

# 进一步阅读

+   漏洞赏金计划列表：[`www.bugcrowd.com/bug-bounty-list/`](https://www.bugcrowd.com/bug-bounty-list/)

+   WebSocket API: [`docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-websocket-api.html`](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-websocket-api.html)

+   从轮询到推送：使用 Amazon API Gateway REST API 和 WebSockets 转换 API：[`aws.amazon.com/blogs/compute/from-poll-to-push-transform-apis-using-amazon-api-gateway-rest-apis-and-websockets/`](https://aws.amazon.com/blogs/compute/from-poll-to-push-transform-apis-using-amazon-api-gateway-rest-apis-and-websockets/)
