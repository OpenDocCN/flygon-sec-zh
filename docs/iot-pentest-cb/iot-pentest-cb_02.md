# 第二章：物联网威胁建模

在本章中，我们将涵盖以下配方：

+   熟悉威胁建模概念

+   威胁建模设备的解剖学

+   威胁建模固件

+   威胁建模物联网 Web 应用

+   威胁建模物联网移动应用

+   威胁建模物联网设备硬件

+   威胁建模物联网无线通信

# 介绍

无论您具有软件开发背景还是系统和网络背景，您可能都熟悉各自领域内的攻击面或向量。攻击面指的是设备可以通过输入源受到威胁的多种方式。这个输入源可以是通过硬件、软件或无线方式。一般来说，设备包含的攻击面越多，被威胁的可能性就越高。攻击面是物联网设备的入口点。有时，这些入口点被物联网设备或应用程序本身信任。发现的每个攻击面都将有相关的风险、可能性和影响。实质上，攻击面是可能对设备产生负面影响的威胁，使其执行意外操作。为了发现每个攻击面，需要在测试之前或软件编写之前考虑理论使用案例。这个练习被称为威胁建模。

本章将讨论威胁建模的基本原则以及它如何帮助我们利用物联网设备中的缺陷。将执行有关如何对固件、Web 应用程序、移动应用程序、设备硬件和无线通信进行基本威胁建模的配方，以帮助您正确入门。

虽然本章的配方将为您介绍威胁建模，但关于这个主题已经有几本书写成。如果需要补充阅读以理解威胁建模的概念，务必阅读有关威胁建模的书籍或参考第三方来源。

# 熟悉威胁建模概念

威胁建模或多或少与软件开发相关，是在软件设计阶段之后但在软件部署之前进行的一种练习。这些练习通常在软件开发、系统、网络和安全团队中进行，这些团队会在主要软件发布时绘制完整的端到端数据流图或数据流和网络图，以确定如何使用安全控制和对策。这些图可以在白板上物理绘制，也可以通过诸如微软免费的威胁建模工具和 Web 应用程序（例如[`draw.io`](https://draw.io/)）等软件工具绘制，这些工具有许多模板图表可用于各种用途。其核心思想是将设备的所有功能和特性映射到其相关的技术依赖关系上。威胁模型的格式如何绘制取决于公司或个人。请记住，威胁模型在逐步更新文档时可以变得非常细化，因为随着功能的增加以及对某种技术的更多了解，威胁也会发生变化。

一旦绘制出物联网设备的攻击面，就必须使用诸如 STRIDE 之类的方法来识别威胁使用案例，这将在后面讨论。这些威胁将需要使用评级系统进行评级，以确定发现威胁的风险。根据行业，有几种威胁评级系统；然而，最常见的是 DREAD 和**通用漏洞评分系统**（**CVSS**）。

CVSS 提供了一个更精细的评级系统，其中包括 3 组中的 14 个评分区域：基本、临时和环境。这三个组中的每一个都细分为包括基本的六个、临时的三个和环境的五个子区域。CVSS 对于向供应商报告漏洞可能非常有用，但对于威胁建模目的可能不太直观。要了解有关 CVSS 的更多信息，请访问[`www.first.org/cvss/user-guide`](https://www.first.org/cvss/user-guide)。

DREAD 评级系统代表以下内容：

+   **损害潜力**：如果被利用，损害有多大？

+   **可重现性**：攻击有多容易重现？

+   **可利用性**：攻击有多容易？

+   **受影响用户**：大约有多少用户受到影响？

+   **可发现性**：漏洞有多容易被发现？

DREAD 具有从 1 到 3 的风险评级系统。1 是低风险，2 是中等风险，3 是高风险。

以下表格描述了每个评级类别的每个评级数字：

|  | **评级** | **高（3）** | **中（2）** | **低（1）** |
| --- | --- | --- | --- | --- |
| **D** | 损害潜力 | 可以破坏所有安全控制并获得完全信任，接管整个物联网生态系统。 | 可能泄露敏感信息。 | 可能泄露敏感信息。 |
| **R** | 可重现性 | 攻击总是可重现的。 | 攻击只能在定时窗口或特定条件内重现。 | 即使有关漏洞的具体信息，也很难重现攻击。 |
| **E** | 可利用性 | 新手攻击者可以执行攻击。 | 熟练的攻击者可以重复进行攻击。 | 允许具有深入知识的熟练攻击者执行攻击。 |
| **A** | 受影响用户 | 所有用户，默认配置，所有设备。 | 影响一些用户，一些设备和自定义配置。 | 通过模糊功能影响少部分用户和/或设备。 |
| **D** | 可发现性 | 攻击解释可以很容易在出版物中找到。 | 影响很少使用的功能，攻击者需要非常有创造力才能发现其恶意用途。 | 是模糊的，攻击者不太可能发现利用漏洞的方法。 |

STRIDE 模型将威胁分为六类，以便提出问题来发现可能的威胁。这六种威胁类别源自缩写 STRIDE，描述如下：

+   **欺骗身份**：欺骗是试图通过使用虚假身份来获取系统访问权限。这可以通过使用窃取的用户凭据或虚假 IP 地址来实现。在攻击者成功以合法用户或主机身份获得访问权限后，可以开始提升权限或滥用授权。

+   **篡改数据**：篡改是未经授权的数据修改，例如在两台计算机之间流动时。

+   **否认**：否认是用户（合法或非法）否认他们执行特定操作或交易的能力。如果没有充分的审计，否认攻击很难证明。

+   **信息泄露**：信息泄露是私人数据的意外暴露。例如，用户查看他或她未被授权打开的表格或文件的内容，或者监视通过网络以纯文本传递的数据。信息泄露漏洞的一些例子包括使用隐藏的表单字段，嵌入包含数据库连接字符串和连接详细信息的网页注释，以及弱异常处理可能导致内部系统级详细信息被泄露给客户端。攻击者可以利用这些信息中的任何信息。

+   **拒绝服务**：拒绝服务是使系统或应用程序不可用的过程。例如，拒绝服务攻击可能通过向服务器发送请求以消耗所有可用系统资源或通过传递格式错误的输入数据来使应用程序进程崩溃来实现。

+   **权限提升**：权限提升是指具有有限权限的用户假定特权用户的身份以获得对应用程序的特权访问。例如，具有有限权限的攻击者可能提升他或她的特权级别，以破坏并控制高度特权和受信任的进程或帐户。

有关使用 STRIDE 的更多详细信息，请参阅以下链接：

[`msdn.microsoft.com/en-us/library/ee823878(v=cs.20).aspx`](https://msdn.microsoft.com/en-us/library/ee823878(v=cs.20).aspx) [`msdn.microsoft.com/en-us/library/ff648641.aspx`](https://msdn.microsoft.com/en-us/library/ff648641.aspx)

微软提供的一种很好的威胁建模方法使用了一个多步骤的过程来确定新应用程序或系统引入的威胁的严重程度。威胁建模过程的步骤如下图所示：

![](img/ed0ffd64-8085-4b47-b865-5cf8067b086b.png)

有关微软威胁建模过程的更多阅读，请参阅以下链接：

[`msdn.microsoft.com/en-us/library/ff648644.aspx`](https://msdn.microsoft.com/en-us/library/ff648644.aspx)

我们将应用 STRIDE 和 DREAD 来从黑盒的角度进行威胁建模练习，并在每个步骤中分解物联网设备的组件。在开始任何类型的安全测试时，最好先进行威胁建模，以确保测试的覆盖范围已经到位。想象所有潜在的威胁可能性并将它们分类作为一种大脑锻炼也是很有趣的。

# 准备工作

为了在本章中逐步进行威胁建模，我们将利用微软免费的威胁建模工具和从 [`draw.io`](https://draw.io/) 绘制的图表。在撰写本文时，可以从 [`www.microsoft.com/en-us/download/details.aspx?id=49168`](https://www.microsoft.com/en-us/download/details.aspx?id=49168) 下载微软的威胁建模工具 2016。

# 如何做...

在这个步骤中，我们将使用微软的威胁建模工具，因为使用它可以很容易地绘制网络图表：

1.  启动微软的威胁建模工具 2016\. 选择“创建模型”选项：

![](img/b865a51c-3a5a-48ed-ade5-d1b933660e30.png)

1.  熟悉工具提供的 Stencils，以展示设备、传输通信以及输入和输出的信任边界。微软在工具下载时提供了不同 Stencils 和选项的用户指南，尽管不是必需阅读：

截至 2016 年版的微软威胁建模工具，可以创建自定义模板和 Stencils 以更准确地相关威胁。

![](img/a09af89d-24b2-4be3-8192-c0896586f372.png)

1.  每个 Stencil 属性都可以根据设备、网络或应用程序进行修改：

![](img/77b68beb-07ce-4c88-bff2-89f52a0a459d.png)

1.  在这个阶段，我们通常会从高层次识别物联网系统的资产，并在通过研究或逆向工程获得更多了解设备的知识后，再对感兴趣的领域进行深入研究。资产的识别可以以表格格式或通过可视化头脑风暴来书写。以下表格显示了资产的基本清单和每个资产的简要描述：

| **ID** | **资产** | **描述** |
| --- | --- | --- |
| 1 | 门铃 | 智能门铃监视运动，向用户发出警报，并通过应用程序提供实时摄像头视频。数据存储在门铃本身以及应用程序界面上。如果用户在网络中本地查看摄像头视频，门铃可以通过 P2P 与 SIP/RTP 连接，或者连接到使用 STUN/TURN 服务器的应用程序，以无需打开路由器端口即可访问摄像头视频。所有数据都传输到路由器以进行远程访问。 |
| 2 | LED 灯泡 | LED 灯泡通过 Zigbee 传输数据到物联网中心，以便通过 Wi-Fi 进行通信。LED 灯泡可以通过物联网中心或应用程序界面进行控制。 |
| 3 | 移动应用程序 | 移动应用程序控制网络中的各种设备。这些移动应用程序可以直接由设备制造商或物联网中心供应商创建。设备配置数据和密钥可能存储在移动应用程序中。数据通过 API 或 Web 服务传输到设备或后端系统。 |
| 4 | 物联网中心 | 物联网中心将所有协议聚合到一个设备中，以便进行简化管理。用户可以通过物联网中心的应用程序界面控制设备。物联网中心可以通过无线连接到路由器，也可以通过以太网插入连接。物联网中心存储配置数据，并可能将数据外部发送到后端系统进行处理。 |
| 5 | 路由器 | 所有网络通信都由路由器处理。路由器可以阻止外部访问设备，也可以让流量通过。 |

1.  以下图示展示了一个智能家居环境的概述图，其中包括智能门铃、LED 灯泡、移动应用程序和物联网中心：

![](img/260726cf-3398-41ae-9d64-57657b46c7a6.png)

所描述的示例步骤只是威胁建模练习的开始。我们讨论了下载微软的威胁模型工具，并熟悉了图形符号及其相关属性。然后，我们开始识别智能家居环境的资产，并根据研究或逆向工程形式提供简要描述。接下来，给出了一个示例架构图，以可视化识别的资产。我们的下一步将是威胁建模的核心，将帮助分解 IoT 系统的每个部分，以帮助识别攻击点、方法和如果 IoT 系统的一部分被利用的影响。与安全的许多方面一样，您对计划测试的平台越熟悉，被攻击的可能性就越高。

# 威胁建模物联网设备的解剖学

2016 年，我们目睹了由 IP 摄像头和数字视频录像机（DVR）组成的大规模 IoT 设备的大规模利用，这导致了有史以来最大的分布式拒绝服务（DDoS）。这次 DDoS 是由于供应商的疏忽造成的，这本可以通过基本的威胁模型练习来防止。考虑到这些类型的设备在互联网上的普遍存在以及它们对互联网的风险，我们将进行威胁建模练习，并走过连接的 DVR IP 摄像头安全系统的威胁建模过程。这些连接的安全系统可以通过电子商务网站以及许多电子商店以相对较低的价格购买。连接的 DVR 是 IoT 系统的一个很好的例子，因为它们包含许多进入设备的入口，以便查看摄像头视频，并可以连接到第三方提供商以利用远程查看而无需在您的网络上打开端口。从黑盒的角度收集有关 IoT 设备及其应用程序的详细信息可能有些棘手。然而，可能有很多在线产品资源可用于帮助进行这项练习。

# 如何做...

要开始威胁建模连接的 DVR，我们将遵循前面提到的微软多步骤威胁建模方法。

# 步骤 1 - 识别资产

记录 DVR 的所有资产，以了解在时间利益上更可能的攻击焦点。如果我们能够识别包含公共漏洞的资产，那么在利用 DVR 系统时，这将节省我们时间。通过阅读盒子背面和用户手册来安装设备时，以下表格描述了我们对 DVR 资产的了解：

| **ID** | **资产** | **描述** |
| --- | --- | --- |
| 1 | DVR | DVR 包含多个摄像头通道，可查看实时源，回放以前的源，录制视频和拍摄摄像头图片。DVR 可以连接到 IP 摄像头或有线 BNC 电缆摄像头。支持多种已知的网络协议和专有协议，如 TCP/IP，PPPoE，DHCP，Hik-connect Cloud P2P，DNS，DDNS，NTP，SADP，SMTP，NFS，iSCSI，UPnP 和 HTTPS。DVR 具有连接到多个应用程序接口查看摄像头源的能力。 |
| 2 | 摄像头 | 视频流由启用的 IP 摄像头和/或 BNC 电缆摄像头捕获，数据直接传输到 DVR 或通过无线方式传输。 |
| 3 | 固件 | 通过固件控制各种摄像头功能和配置选项。 |
| 4 | Web 应用 | DVR 包含一个本地 Web 服务器，可以通过在 Web 浏览器中访问 IP 地址来访问。要通过本地 Web 应用程序查看视频源，必须使用支持的浏览器下载插件。在配置设备时，设备可以通过供应商的云 SaaS 平台查看视频源。需要单独的用户名和密码才能启用供应商的云 SaaS 平台。SaaS 平台为第三方添加了额外的共享功能，并可以访问同一所有者可能购买的其他 DVR。 |
| 5 | 移动应用 | 可用于配置各种设置以及远程查看和保存视频源的 Android 和 iOS 应用程序。所有移动应用程序的流量都通过供应商的 API 发送到移动设备的网络连接。移动应用程序连接到供应商的云环境以渲染摄像头源。需要用户名和密码才能通过移动应用程序访问摄像头系统。 |
| 6 | 厚应用 | 可以安装 Windows 和 OS X 安装程序来查看摄像头源并配置各种设置。 |
| 7 | 设备硬件 | DVR 硬件包含多个 VGA 和 HDMI 视频输出。设备通过以太网电缆连接到本地网络。对于存储，设备具有一个 SATA 连接器，可容纳高达 6TB 的硬盘。 |
| 8 | 无线通信 | DVR 通过 BNC 连接器或 IP 连接到摄像头。不使用无线通信；但是，所有移动应用程序的流量都通过无线通信传输。 |

# 步骤 2 - 创建物联网设备架构概述

创建架构概述有助于可视化我们如何攻击 DVR 以错误使用系统。在创建物联网设备架构概述时，我们的目标是记录 DVR 的功能及其应用程序以及从我们已经收集或在过程中学到的数据中的物理架构。我们希望发现 DVR 设计和实施中的缺陷。这还包括识别不同的技术。让我们分解如何创建架构概述为三个任务：

+   记录 DVR 功能和特性

+   创建一个详细的 DVR 生态系统的架构图

+   识别正在使用的技术

要开始记录 DVR 功能和特性，让我们创建一些用例。

**用例 1**：用户通过本地 Web 应用程序在其本地网络中查看摄像头源

1.  用户安装 DVR 和摄像头。

1.  用户创建一个用户。

1.  用户配置 DVR 和摄像头设置。

1.  用户然后将以太网连接到 DVR 以进行网络连接。

1.  用户记录 DVR IP 地址。

1.  用户然后安装供应商提供的插件和软件。

1.  用户通过 Web 浏览器登录 DVR。

1.  用户选择适当的摄像头查看其视频。

**用例 2**：用户通过移动应用程序远程查看摄像头视频

1.  用户配置平台访问供应商 SaaS 的设置。

1.  用户下载并安装 Android 或 iOS 应用程序。

1.  用户在安装时为供应商的 SaaS 应用程序创建一个单独的用户。

1.  用户登录移动应用程序。

1.  用户使用移动应用程序在 DVR 下扫描条形码进行供应商验证。

1.  用户选择适当的摄像头查看其视频。

前述列出的用例的以下架构图提供了 DVR 生态系统组件的详细信息：

![](img/e248e594-8362-4aab-9edc-655bb2c52245.png)

一旦绘制了架构图，就需要识别和检查不同的技术。某些操作系统、协议和低级库具有固有的漏洞。重要的是记录所使用的技术，以进一步分析和定义可能的威胁案例：

| **技术** | **详情** |
| --- | --- |
| DVR | 嵌入式 Linux 3.10.0；通过 HTTP 和 TCP/IP 通信；自定义 Web 服务器（DNVRS-Webs）；内部和外部存储选项。 |
| 无线（Wi-Fi）路由器 | 2.4 GHz Wi-Fi；100 米范围。 |
| 移动应用程序 | Android 和 iOS 应用程序连接到第三方服务，用于查看摄像头视频。数据可以选择在设备上本地存储图片和用户凭据。 |
| 通信协议：HTTP | 默认情况下查看摄像头视频时使用的明文协议。 |
| 通信协议：HTTPS | 查看摄像头视频时进行加密通信，但需要在通过 Web 界面生成 SSL 证书后手动配置。 |
| 通信协议：802.11 Wi-Fi | IP 摄像头和 DVR 之间通信的 RF 协议。 |
| 通信协议：RTSP | 用于将摄像头视频流式传输到应用程序的网络协议。 |

# 第 3 步 - 分解物联网设备

接下来，我们将分析应用程序和协议数据流通过 DVR 环境，以找到设备或客户端应用程序的易受攻击的入口点。我们将寻找可能具有更高特权访问的位置，并记录每个可能的入口点。一个危害 DVR 机密性和完整性的入口点将使我们作为攻击者占据上风。

这些入口点将根据所使用的平台、技术和协议而变化，但在本节中，我们将保持在较高水平。还要检查技术和功能之间的各种信任边界。一旦分解 DVR 架构完成，您应该对攻击面有更好的了解，以及数据可能如何被威胁。

以下图表是分解物联网 DVR 环境数据流的示例：

![](img/a43ea0b8-4241-4fd7-aaad-f9877d0d02b1.png)

在映射数据流并完成后，进行入口点的文档记录：

| **DVR 入口点** |  |  |
| --- | --- | --- |
| **＃** | **入口点** | **描述** |
| 1 | 嵌入式 Web 应用程序 | 嵌入式 Web 应用程序提供了一个界面，用于查看摄像头视频并对摄像头细节、配置以及用于监控的网络细节进行更改，如 SNMP。嵌入式 Web 应用程序使用 SOAP/XML Web 服务通过 HTTP 进行传输通信，但可以通过在配置菜单中创建自签名证书来使用 HTTPS。为了查看摄像头视频，需要下载一个可执行文件，在可执行文件中，需要在 Internet Explorer 中安装一个 ActiveX 插件。注意：**Internet Explorer**（IE）之外的浏览器无法查看摄像头视频。 |
| 2 | 供应商 Web 应用 | DVR 与供应商拥有的 STUN/TURN 服务器建立连接，以便在不打开路由器端口的情况下流式传输摄像头视频。供应商应用仅通过 HTTPS 可用，并使用 Web 套接字进行通信。 |
| 3 | DVR | DVR 连接到多个 Web 应用程序和移动应用程序。嵌入式 Web 应用程序是 DVR 本身的服务器，供应商的 SaaS 应用程序连接到 DVR。同样，供应商有一个可用的移动应用程序，但也有另一个原始制造商为 DVR 提供的第三方移动应用程序（通过代理发现）。DVR 还通过硬件外围设备和主 PCB 进行输入。 |
| 4 | 固件 | DVR 利用固件来控制设备，但可能只能通过供应商技术支持（根据文档）获得。嵌入式 Web 服务器利用固件进行管理操作。 |
| 5 | 摄像头 | 可以通过将其 IP 地址添加到 DVR 配置页面来将摄像头添加到 DVR。摄像头也可以通过手动插入具有 BNC 连接器的摄像头来添加。 |
| 6 | 移动应用程序 | 可以下载多个移动应用程序。每个移动应用程序都可以对 DVR 和摄像头进行配置更改。使用移动应用程序需要凭据。所有流量都被传送到供应商环境以查看摄像头详情和视频。 |
| 7 | 无线通信 | 移动应用程序的通信流量通过无线技术进行，可以是 802.11 或蜂窝网络（4G）。 |

# 步骤 4 - 辨识威胁

在这个阶段，我们已经绘制出了 DVR 系统的数据流，并确定了入口点。现在我们必须确定每个入口点的风险，因为它涉及用户、网络和应用程序，以及编写应用程序代码的供应商。从攻击者的角度来看，我们希望确定影响网络、应用程序和主机的威胁，这些威胁可能是可利用的，并造成以下影响：

+   影响使用这个特定 DVR 系统的大量用户

+   妥协供应商基础设施以引发大规模利用

+   妥协 DVR 以对用户构成隐私风险

+   妥协 DVR 以对 DVR 所有者构成安全风险

为了帮助辨识威胁并对其进行分类，让我们将 STRIDE 模型应用于我们的 DVR 物联网系统。在下表中，我们将添加一些威胁类型，以代替物联网特定问题。这张表并不是详尽无遗的，但应该有助于思考可能影响整体 DVR 环境的威胁时提供一些想法：

| **威胁类型** | **分析** |
| --- | --- |
| 冒充身份 | 检查系统中与冒充 DVR 身份相关的威胁，以及攻击者克服设备之间自动信任关系的能力。寻找允许设备或用户在 DVR 配置过程中操纵信任关系的入口点。分析 DVR 应用程序接口的身份验证和授权功能。检查 DVR 应用程序通信是否具有伪造请求的能力。 |
| 数据篡改 | 检查 DVR 应用程序和设备之间的消息通信。识别 DVR 中提供数据篡改机会的点，包括数据收集、处理、传输和存储的环节。尝试篡改固件和移动应用程序配置，执行未经授权的操作。 |
| 否认 | 辨识允许进行非法操作而无需记录能力的攻击入口点。禁用 Web 和移动应用程序的跟踪功能。 |
| 信息泄露 | 模糊应用程序参数以影响应用程序错误披露。识别所有明文通信。检查 DVR API 通信的 HTTP 响应头以获取版本信息。识别所有 API 端点和应用程序后端使用的技术。检查应用程序数据存储中是否存在明文文件中的意外数据泄露。 |
| 拒绝服务 | 执行诸如忘记密码之类的功能，以确定是否可能锁定用户。测试每个 DVR 应用程序界面中的帐户锁定策略。检查 DVR 网络服务的吞吐量，以了解攻击可能如何抵御相关的 DoS 攻击。检查消息结构（例如，数据总线）、数据结构、变量和 DVR 组件中使用的 API 的不当使用，并确定是否存在漏洞，使恶意摄像头可以淹没合法摄像头或兼容的 DVR 设备的传输。 |
| 特权提升 | 检查 DVR 提供的管理功能。创建较低的应用程序用户并测试管理访问。识别 DVR 应用程序和操作系统中无法将管理功能与用户级功能分隔开的弱点。识别 DVR 节点所采用的身份验证方法的弱点，以便设计适当的身份验证控件到系统中。 |
| 物理安全绕过 | 检查 DVR 及其摄像头提供的物理保护机制，以识别可能允许管理控制台访问的弱点。 |
| 供应链问题 | 了解组成 DVR 系统的各种技术组件及其来源（例如，ODM、硬件制造商、OEM 等）。跟踪与 DVR 硬件和软件组件相关的任何技术层面的漏洞。 |

或者，我们可以简单地列出高层次的威胁，然后在本章后面，我们将深入研究每个组件的威胁。一些威胁可能是未知的或完全理论的，因为我们可能没有所有的见解，但重要的是要进行头脑风暴。为了更好地识别威胁，可以与伙伴配对或与其他人一起进行小组练习，他们正在攻击您感兴趣的特定物联网系统。以下是我们 DVR 系统的高级威胁的示例，攻击者可能执行的：

+   远程接管 DVR 系统

+   未经授权远程查看摄像头视频（间谍）

+   关闭摄像头录制回放功能

+   跟踪个人

+   根据情报收集闯入周围区域

+   在 DVR 上安装恶意软件

+   获得物理访问并破坏录音

+   用请求超载 DVR 以阻止使用

+   窃听 DVR 通信

# 第 5 步 - 记录威胁

接下来，我们将记录我们在第 4 步中识别的一些威胁用例，包括描述、威胁目标、攻击技术和可能存在的任何对策。

# 威胁＃1

| **威胁描述** | **攻击者可能远程接管 DVR 系统** |
| --- | --- |
| 威胁目标 | DVR 客户、DVR 网络进程、DVR 应用程序。 |
| 攻击技术 | 攻击者拦截无线通信，API 通信和/或网络协议通信以获取凭据或会话 cookie。攻击者可以通过欺骗用户访问其 DVR，通过欺骗用户界面或利用应用程序漏洞使用跨站点请求伪造（CSRF）添加用户帐户。 |
| 对策 | 如果尝试登录失败或同时发送太多请求，DVR 将锁定用户 30 分钟。 |

# 威胁＃2

| **威胁描述** | **攻击者可能未经授权远程查看摄像头视频** |
| --- | --- |
| 威胁目标 | DVR 客户、协议和应用程序。 |
| 攻击技术 | 获取凭据或 API 调用以在未经身份验证的情况下查看摄像头。攻击者可以获取会话标识符以劫持会话，从而实现远程查看摄像头视频。攻击者可以通过社会工程学诱使用户访问其 DVR 视频。攻击者可以利用易受攻击的明文 RTSP 流使用诸如 Cameradar（[`hub.docker.com/r/ullaakut/cameradar/`](https://hub.docker.com/r/ullaakut/cameradar/)）之类的工具访问视频源。 |
| 对策 | 强制执行多因素身份验证，并使用加密的 RTSP 或 SRTP 流。 |

# 威胁＃3

| **威胁描述** | **攻击者可能关闭录制回放功能** |
| --- | --- |
| 威胁目标 | DVR 客户。 |
| 攻击技术 | 攻击者可以物理访问 DVR 系统以应用更改。攻击者可以通过社会工程使用户访问其 DVR。 |
| 对策 | 对敏感功能进行身份验证，以及多因素身份验证。 |

# 步骤 6 - 对威胁进行评级

既然我们已经确定并记录了 DVR 的威胁，让我们使用 DREAD 评级系统对威胁进行评级，以及它们可能的影响。在本章的前面，我们介绍了 DREAD 评级系统，但需要注意的是，还有其他可用的评级系统。DREAD 中每个字母的评级值范围为高 3，中 2，低 1。

对于 DREAD，最终风险是使用以下评级进行排名的：

| **风险评级** | **结果** |
| --- | --- |
| 高 | 12-15 |
| 中等 | 8-11 |
| 低 | 5-7 |

我们的 DVR 系统中威胁案例的威胁评级示例如下：

| **威胁风险评级：攻击者可能未经授权远程查看摄像头视频** |  |
| --- | --- |
| **项目** | **分数** |
| 损害潜力 | 3 |
| 可重现性 | 2 |
| 可利用性 | 3 |
| 受影响的用户 | 2 |
| 可发现性 | 3 |
| **风险评级分数：高** | **13** |

最初，对整体 DVR 系统进行威胁建模可能会更加困难，因为需要考虑所有不同的组件的威胁案例。尽管如此，一旦完成，您将已记录了许多潜在的高风险漏洞，以便进行测试时专注于重点。这将使得在测试物联网系统时更容易优先处理漏洞。

# 威胁建模固件

在上一节中，我们对 DVR 系统进行了威胁建模，并对一个威胁案例进行了评级，这有助于优先处理要测试的漏洞。在本节中，我们将对相同的 DVR 系统的固件进行威胁建模。

# 准备工作

在这个练习中，我们将使用免费的[`draw.io`](https://draw.io/)在线图表软件来帮助演示固件内的图表关系。这个工具是一个 Chrome 应用，与 Google Drive 或 GitHub 等第三方服务进行存储。我们可以绘制重叠的关系和流程，这在 Microsoft 工具中是不可能的。任何能够有效绘制目标设备或软件的架构及其相应关系的工具都可以。

要开始绘制图表，请执行以下步骤：

1.  选择创建新图表。

1.  选择软件设计。

1.  选择部署图表模板，如下面的屏幕截图所示：

![](img/c5cbb192-eb79-4d45-b76d-f1701e66bb3c.png)

1.  删除模板中所有未使用的图表，只留下一个矩形用于固件及其内部组件。

1.  将资产拖放到图表中以显示它们的关系。

# 如何做...

对于固件，我们可以通过设备包装、基本端口扫描或各种在线资源来确定正在运行的操作系统的类型。我们应该对嵌入式物联网设备上的固件功能有一个大致的了解，如第一章中所讨论的。本节不会像前面的内容那样详细，但我们仍然希望确定我们对固件的所有了解，并绘制其组件以确定测试的潜在威胁。我们将合并一些威胁建模步骤以简洁起见。

# 步骤 1 - 确定资产

根据我们对固件和 DVR 提供的服务的了解，让我们使用以下表格来记录一些固件资产：

| **ID** | **资产** | **描述** |
| --- | --- | --- |
| 1 | Web 服务器 | 固件为本地 Web 应用提供服务，用于查看摄像头视频和管理摄像头。 |
| 2 | SSH | DVR 在端口 22 上监听 shell 访问。 |
| 3 | RTSP | 摄像头视频流使用 RTSP 进行查看。 |
| 4 | UPnP | UPnP 可用于管理设备的配置。 |
| 5 | DNS | 本地 DNS 服务器用于远程查看。 |

# 步骤 2 和 3 - 创建架构概述和分解

我们大致了解了固件组件和可能使用的库，这些库与 DVR 的服务相关。可以绘制以下概述图，显示设备、固件内容以及文件系统之间的关系：

![](img/988a8d59-07dc-4dba-925d-510deda23155.png)

# 步骤 4 - 识别威胁

现在让我们根据我们的图表和对固件内容的了解来记录威胁。请记住，在这个阶段我们还没有对固件图像进行反汇编或定位。图表的内容是基于 DVR 宣传的服务和在线文档的假设。以下是攻击者可能利用的固件的可能威胁：

+   在网络服务上执行远程代码执行

+   获得对文件系统的管理员访问权并攻击局域网

+   拦截网络通信

+   通过 SSH 访问文件系统资源

+   控制 DNS 以将流量重定向到受害者网络/计算机

+   访问 Web 配置和固件中可能的秘密

+   在 DVR 上安装恶意固件或应用程序

+   跟踪用户活动

+   篡改摄像头视频流和内容

+   篡改审计日志

+   变砖 DVR

+   阻止所有网络连接到 DVR

# 步骤 5 - 记录威胁

接下来，我们将挑选几个威胁案例，并记录它们的描述、威胁目标、攻击技术和可能存在的任何对策，以便评估它们的风险。

# 威胁＃1

| **威胁描述** | **攻击者可以在网络服务上执行远程代码执行** |
| --- | --- |
| 威胁目标 | DVR 固件。 |
| 攻击技术 | 攻击者发现 DVR API 通信中的漏洞。 |
| 对策 | DVR 在其 API 中设置了速率限制保护。 |

# 威胁＃2

| **威胁描述** | **攻击者可能获得对文件系统的管理员访问权并攻击局域网** |
| --- | --- |
| 威胁目标 | DVR 固件。 |
| 攻击技术 | 攻击者可以通过 SSH 或 Telnet 启用对控制台的访问。攻击者可以发现缓冲区溢出以访问文件系统内容并利用后期利用技术。攻击者发现 DVR 使用的库中的已知漏洞。 |
| 对策 | DVR 强制执行自动更新功能，防止启用易受攻击的库和服务。 |

# 威胁＃3

| **威胁描述** | **攻击者可能在 DVR 上安装恶意固件或应用程序** |
| --- | --- |
| 威胁目标 | DVR 固件。 |
| 攻击技术 | 攻击者可以在固件更新时加载恶意固件。 |
| 对策 | DVR 应该对其固件图像进行签名，并在重启时进行验证。 |

# 步骤 6 - 对威胁进行评级

就像我们在上一个步骤中所做的那样，我们需要使用 DREAD 对每个可能的威胁进行评分。使用以下表格，我们将选择一个威胁并找出其风险评级：

| **威胁风险评级：攻击者可能获得对文件系统的管理员访问权并攻击局域网** |  |
| --- | --- |
| **项目** | **得分** |
| 损害潜力 | 3 |
| 可重现性 | 2 |
| 利用性 | 2 |
| 受影响的用户 | 3 |
| 可发现性 | 2 |
| **风险评分：高** | **12** |

大多数嵌入式设备操作系统通常以 root 或管理员身份运行。这意味着通过设备固件可能被利用的任何漏洞都应该给您所需的最高访问权限。没有必要进行特权升级。更受监管的行业可能会推迟，但如果您正在测试消费者设备，固件很可能已经以 root 身份运行。

# 对物联网 Web 应用程序进行威胁建模

在为我们的 DVR 进行威胁建模练习时，我们将继续分解其 Web 应用程序。我们的 DVR 包含两种类型的 Web 应用程序。一个 Web 应用程序是嵌入式的，从 DVR 本身运行。第二个 Web 应用程序是供应商提供的用于远程访问 DVR 及其摄像头视频的 SaaS 应用程序。

SaaS 应用程序访问局域网中的嵌入式 DVR。我们对在 DVR 上本地运行的嵌入式 Web 应用程序有更清晰的了解，而对供应商 SaaS 应用程序了解较少。在本章的前面，我们提到了供应商 Web 应用程序使用的一些技术，但目前没有其他信息。我们将从绘制嵌入式 Web 应用程序的架构开始，并在威胁部分涉及供应商 SaaS 应用程序，而不是绘制其未知的架构。

# 如何做…

此时，我们应该对如何从头到尾进行威胁建模有一个很好的想法。考虑到这一点，我们将跳过威胁建模过程中的一些步骤，转向一些更重要的方面。

# 第 1 步：创建架构概述和分解

正如前面提到的，我们将绘制我们对嵌入式 Web 应用程序的了解，并致力于识别和评估其架构数据流中的威胁。以下图表说明了嵌入式 Web 应用程序的一些基本功能：

![](img/5367bbce-0460-4cd4-b5ca-d7a6e8b033be.png)

应用程序的流程很简单，因为流量只停留在局域网中，不会到达面向公众的流量。识别嵌入式应用程序的威胁不应该太困难。

# 第 2 步：识别威胁

由于嵌入式 Web 应用程序内的数据流具有简单性质，记录威胁应该很容易，尽管我们将添加一些额外的情景以考虑供应商 SaaS Web 应用程序。

攻击者可以利用 DVR 嵌入式 Web 应用程序和/或供应商 SaaS 应用程序来执行以下操作：

+   劫持用户会话以查看摄像头视频和配置

+   窃听 API 调用

+   通过命令注入漏洞执行操作系统命令

+   暴露敏感用户详细信息

+   通过 SQL 注入转储数据库内容

+   执行任意脚本

+   访问其他用户账户

+   伪造已登录用户账户下的请求（CSRF）

+   修改 DVR 设置以将流量重定向到未经授权的用户或网络

+   跟踪用户

+   暴露摄像头回放视频

+   删除摄像头回放视频

+   利用供应商环境的 Web 或应用程序服务器中的漏洞

+   防止合法用户访问

# 第 3 步：记录威胁

接下来，我们将选择类似于以前的案例的威胁案例，并记录它们的威胁案例描述、威胁目标、攻击技术和可能存在的任何对策，以评估它们各自的风险。

# 威胁＃1

| **威胁描述** | **攻击者可能通过命令注入漏洞执行操作系统命令** |
| --- | --- |
| 威胁目标 | 嵌入式和供应商 Web 应用程序。 |
| 攻击技术 | 攻击者发现 DVR 和供应商 API 通信中的漏洞，因为输入验证不严格。攻击者创建在应用程序上下文中运行的代码。攻击者通过将自定义代码注入应用程序来访问后端系统。 |
| 对策 | 应用程序执行输入验证和上下文输出编码。 |

# 威胁＃2

| **威胁描述** | **攻击者可能伪造已登录用户账户下的请求（CSRF）** |
| --- | --- |
| 威胁目标 | 嵌入式和供应商 Web 应用程序。 |
| 攻击技术 | 攻击者识别了一个易受攻击的 HTML 表单，并创建了代码来伪造已登录用户的请求更改。这些更改可能包括向第三方添加或共享用户账户。 |
| 对策 | 为改变应用程序状态的敏感 HTML 表单实施反 CSRF 令牌。 |

# 威胁＃3

| **威胁描述** | **攻击者可能通过 SQL 注入转储数据库内容** |
| --- | --- |
| 威胁目标 | 供应商 Web 应用程序。 |
| 攻击技术 | 攻击者将 SQL 命令附加或连接到用于查询数据库的易受攻击参数。 |
| 对策 | 应验证用户输入，并对查询进行参数化或使用存储过程来访问数据库。 |

# 步骤 4：评估威胁

使用以下表格，我们将选择一个威胁并找出其风险评级：

| **威胁风险评级：攻击者可能通过 SQL 注入转储数据库内容** |  |
| --- | --- |
| **项目** | **分数** |
| 损害潜力 | 3 |
| 可重现性 | 3 |
| 可利用性 | 2 |
| 受影响的用户：3 |
| 可发现性 | 2 |
| **风险评级分数：高** | **13** |

显然，利用供应商的 SaaS 应用程序中的漏洞会有更大的回报，因为有大量用户的详细信息和额外的功能可用。但是，重要的是要在法律范围内并获得授权后进行测试。针对嵌入式 Web 应用程序可能一开始并不会有太大的回报，但一旦对设备在线使用进行了调查并发现了可远程利用的漏洞，就肯定是可能的。

# 威胁建模 IoT 移动应用程序

在我们的下一个威胁建模练习中，我们将检查 DVR 系统的 IoT 移动应用程序。这个 DVR 系统（像许多其他 IoT 系统一样）由经销商和不同的 OEM 开发了几个可用的移动应用程序。为了演示目的，我们将只对一个 Android 和一个 iOS 应用程序进行威胁建模。

# 如何做…

由于我们已经从以前的配方中创建了大部分数据流图，我们将继续使用相同的 Microsoft 威胁建模工具进行此配方。

# 步骤 1：创建架构概述和分解

与我们上几个配方类似，我们将立即创建一个包含移动应用程序所有已知资产的数据流图。以下是移动应用程序的数据流图：

![](img/0ba5ad59-60d4-49f0-96c6-4666befa3cb7.png)

我们可以看到应用程序每次都会联系第三方供应商的云环境，以查看帐户详细信息和摄像头回放。当用户与 DVR 处于同一网络时也会发生这种情况。远程访问 DVR 需要用户名和密码，这也存储在移动设备中。在这一点上，我们不知道在与供应商后端系统通信时如何存储或发送这些数据。这引出了我们的下一步，识别威胁。

# 步骤 2：识别威胁

攻击者可以利用移动应用程序执行以下操作：

+   窃听 API 调用

+   访问移动设备上的本地资源

+   暴露敏感用户详细信息

+   在移动设备上以明文查找所有用户的敏感信息

+   通过 SQL(ite)注入转储数据库内容

+   通过 WebView JavaScript 接口执行任意脚本

+   访问其他用户帐户

+   跟踪供应商云环境中的用户

+   暴露存储在设备上的摄像头回放

+   删除摄像头回放

+   更改用户信息

+   添加用户以共享摄像头而无需授权

+   创建不会过期的长期会话以持久访问

+   拍摄屏幕截图并发送给第三方

# 步骤 3：记录威胁

接下来，我们将选择与以前的配方类似的威胁案例，并对其进行评分。

# 威胁＃1

| **威胁描述** | **攻击者可能访问移动设备上的本地资源** |
| --- | --- |
| 威胁目标 | 移动应用程序。 |
| 攻击技术 | 攻击者发现 API 通信中的漏洞，从而使 WebView 暴露给 JavaScript 桥接以访问本地对象。攻击者利用 SQL 注入在移动设备上本地执行 SQLite 调用，以附加数据库并创建具有访问本地资源权限的文件。 |
| 对策 | 应用程序在 WebView 中禁用 JavaScript 或白名单接受脚本。应用程序验证用户输入并禁止执行动态查询。 |

# 威胁 #2

| **威胁描述** | **攻击者可能在移动设备上以明文形式找到所有用户的敏感信息** |
| --- | --- |
| 威胁目标 | 移动应用。 |
| 攻击技术 | 攻击者在运行时监视文件存储，并发现从供应商云同步到移动设备的数据，暴露了敏感信息。 |
| 对策 | 只应存储设备上所需的数据。 |

# 威胁 #3

| **威胁描述** | **攻击者可能未经授权添加用户共享摄像头** |
| --- | --- |
| 威胁目标 | 移动应用。 |
| 攻击技术 | 攻击者创建 CSRF 请求发送给受害者，自动添加用户进行共享。 |
| 对策 | 使用反 CSRF 令牌。 |

# 步骤 4：评估威胁

使用以下表格，我们将选择一个威胁并找出其风险评分：

| **威胁风险评估：攻击者可能访问移动设备上的本地资源** |
| --- |
| **项目** | **分数** |
| 损害潜力 | 3 |
| 可重现性 | 2 |
| 可利用性 | 1 |
| 受影响用户 | 1 |
| 可发现性 | 2 |
| **风险评分：中等** | **9** |

在移动领域，常见的威胁涉及数据及其存储和传输方式。因此，除非利用影响了大量用户或许多用户的数据被暴露，否则移动漏洞的风险相对较低。在应用程序测试期间，移动漏洞很少会导致服务器或移动设备上的 shell。

# 威胁建模物联网设备硬件

现在是时候分析我们目标 DVR 的硬件威胁了。大多数消费级 DVR 都很容易打开和拆解，以检查它们的各种输入以及外围设备。这是因为需要扩展存储空间，或者仅仅是因为它们不像生产**硬件安全模块**（HSM）那样设计成重型设备，后者具有防篡改保护措施。

# 如何做到...

在这个练习中，我们使用[`draw.io`](https://draw.io)图表来帮助我们展示硬件输入。

# 步骤 1：创建架构概述和分解

以下是 DVR 硬件的示意图：

![](img/3e84dc12-c798-4bb5-9794-aedbeee14068.png)

根据图像描述，DVR 上有八个用于摄像头的 BNC 连接器，两个 USB 端口，一个以太网端口，一个电源端口，一个 VGA 和一个面向 DVR 外部的 HDMI 端口。DVR 内部有各种芯片，其中一个是 EEPROM，可能在 PCB 板上有 UART 的输入。

# 步骤 2：识别威胁

攻击者可以利用 DVR 硬件输入来执行以下操作：

+   通过 UART 访问控制台

+   在 EEPROM 中转储秘钥

+   利用 USB 堆栈中的漏洞到 DVR

+   连接恶意 USB 设备导致损坏

+   短接 DVR 电源输入

+   使 DVR 引导加载程序进入控制台访问

+   通过 USB 安装恶意软件

# 步骤 3：记录威胁

接下来，我们将挑选类似于之前的案例，并记录它们以评估各自的风险：

# 威胁 #1

| **威胁描述** | **攻击者可能通过 UART 访问控制台** |
| --- | --- |
| 威胁目标 | UART。 |
| 攻击技术 | 攻击设备的 PCB 板上的 UART 标头。 |
| 对策 | UART 访问受密码保护。UART 访问被另一芯片阻止。 |

# 威胁 #2

| **威胁描述** | **攻击者可能在 EEPROM 中转储秘钥** |
| --- | --- |
| 威胁目标 | EEPROM。 |
| 攻击技术 | 攻击者在 EEPROM 顶部附加 SOIC 夹子以读取其内容。 |
| 对策 | 防止在 EEPROM 中存储敏感数据。 |

# 威胁 #3

| **威胁描述** | **攻击者可能会使 DVR 引导加载程序进入控制台访问** |
| --- | --- |
| 威胁目标 | EEPROM。 |
| 攻击技术 | 攻击者中断引导加载程序的时间以访问控制台。 |
| 对策 | 实施故障保护或篡改保护。 |

# 步骤 4：评估威胁

使用以下表格，我们将选择一个威胁并找出其风险评级：

| **威胁风险评级：攻击者可能通过 UART 访问控制台** |
| --- |
| **项目** | **分数** |
| 损害潜力 | 3 |
| 可重现性 | 3 |
| 可利用性 | 2 |
| 受影响的用户 | 1 |
| 可发现性 | 2 |
| **风险评级分数：高** | **11** |

# 物联网无线电通信威胁建模

转向无线/无线通信，我们的 DVR 在无线通信方面并没有太多的活动，除了从客户端应用程序或摄像头传输到 DVR 的数据。大多数物联网设备和环境在不同频率上使用不同协议进行广播。幸运的是，我们只需要担心 Wi-Fi 和蜂窝供应商进入 DVR 的入口。

# 如何做…

对于我们的无线电通信威胁建模练习，我们可以简单地更新先前绘制的图表，以反映设备和应用程序内发生的无线电通信。

# 步骤 1：创建架构概述和分解

DVR 系统内无线通信使用的架构概述示例如下：

![](img/3fa2ea24-b3d1-4357-adf9-7caa0de6c52d.png)

正如您可能已经注意到的那样，无线通信仅限于用户通过客户端设备（如浏览器和应用程序）访问 DVR 以及可选的无线 IP 摄像头。还要注意的是，我们的图表已经迭代，因为通过先前的威胁模型已经获得了有关 DVR 的更多信息。

# 步骤 2：识别威胁

攻击者可以利用无线通信来做以下事情：

+   从长距离访问 DVR 网络

+   窃听 DVR 无线通信

+   干扰 DVR 通信

+   从 DVR 中移除 IP 摄像头

+   建立一个虚假接入点来连接摄像头

+   窃听手机通信

+   为**全球移动通信系统**（**GSM**）建立一个虚假基站

+   伪造客户端应用程序请求

+   添加虚假 IP 摄像头

+   通过恶意客户端应用程序访问 DVR 系统

# 步骤 3：记录威胁

接下来，我们将挑选类似于我们在以前的案例中所做的威胁，并记录它们以评估其各自的风险：

# 威胁＃1

| **威胁描述** | **攻击者可能从长距离访问 DVR 网络** |
| --- | --- |
| 威胁目标 | 无线。 |
| 攻击技术 | 攻击者利用中间人技术或窃取无线客户端的用户会话，从任何给定的客户端应用程序中利用无线通信。 |
| 对策 | 应实施授权设备并列入白名单。 |

# 威胁＃2

| **威胁描述** | **攻击者可能干扰 DVR 通信** |
| --- | --- |
| 威胁目标 | 无线。 |
| 攻击技术 | 攻击者识别从 IP 摄像头或客户端设备传输到 DVR 的流量，以便以 DVR 无法消耗的速率重放流量。 |
| 对策 | 应实施防干扰保护或在给定阈值内阻止恶意 IP 地址。 |

# 威胁＃3

| **威胁描述** | **攻击者可能添加虚假 IP 摄像头** |
| --- | --- |
| 威胁目标 | 无线。 |
| 攻击技术 | 攻击者模拟一个包含恶意固件的 IP 摄像头添加到网络中。 |
| 对策 | 应实施来自 DVR 的客户端验证。 |

# 步骤 4：评估威胁

使用以下表格，我们将选择一个威胁并找出其风险评级：

| **威胁风险评级：攻击者可能从长距离访问 DVR 网络** |
| --- |
| **项目** | **分数** |
| 损害潜力 | 3 |
| 可重现性 | 2 |
| 可利用性 | 3 |
| 受影响的用户 | 1 |
| 可发现性 | 3 |
| **风险评级分数：高** | **12** |

DVR 环境中的无线威胁可以使用常见的无线中间人技术，相当简单。其他威胁，如添加假 IP 摄像头，可能会更加困难，对于寻求更大影响的攻击者来说可能不值得。
