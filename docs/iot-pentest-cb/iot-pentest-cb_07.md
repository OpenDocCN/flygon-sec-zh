# 无线电黑客

在本章中，我们将涵盖以下内容：

+   熟悉 SDR

+   SDR 工具的实践

+   理解和利用 ZigBee

+   深入了解 Z-Wave

+   理解和利用 BLE

# 介绍

几乎所有当前物联网设备与其他设备进行交互以交换信息并采取行动。了解物联网设备使用的无线协议以及影响它们的安全问题对于有效地对物联网设备进行渗透测试至关重要。

无线通信或无线电简单地是通过空气这种通信介质使用电磁波从源到目的地传输数据的一种方式。无线电信号是在常见设备中使用的信号，如微波、光和红外线；只是在每种情况下，信号的波长和频率不同。在无线通信的情况下，需要传输的数据首先通过电势差转换为电信号，然后由载波波传输，最后在另一端解调以获取源发送的实际数据。我们不会详细讨论电磁概念以及如何从数据生成电信号，因为这超出了本章的范围。

物联网设备使用各种无线通信协议，从蜂窝到 Wi-Fi 不等，取决于产品要求和设备制造商的偏好。不可能在单一章节或书籍中涵盖所有各种无线通信协议，但是，我们将专注于整体渗透测试方法论，并涵盖两种最常见的协议——ZigBee 和蓝牙低功耗（BLE）。

不同的无线协议有各自的目的和优缺点。它们每个都在指定的频率（或频率范围）上运行，并且需要不同的渗透测试硬件和软件设置，以便能够分析该通信协议的数据包。

在进入各个协议之前，我们将深入研究软件定义无线电（SDR），这是无线电逆向和物联网设备黑客的最重要概念之一。我们还将熟悉各种基础概念，以便更好地理解无线电黑客和 SDR。

# 熟悉 SDR

SDR 是一种极其有用的技术，我们可以通过它改变给定无线电设备的用途。正如其名称所示，这种情况下的无线电是软件定义的，这意味着无线电的功能或操作可以根据我们的需求进行更改和修改。这与传统无线电不同，传统无线电设备根据其硬件设计只能服务于单一目的。

这为我们打开了大量机会，因为我们可以开始使用 SDR，并不断重新定位以满足我们的各种需求。重新定位在这里简单地意味着，假设我们正在分析 FM 频谱，我们可以让设备来做，如果以后我们想要分析 433 MHz 的物联网设备发送的数据，我们可以使用同一设备来捕获数据，处理数据，并提取其中发送的文本。

到目前为止，你应该对 SDR 是什么以及它可以服务于什么目的有一个相当好的理解。在进行实际的 SDR 实践和分析不同事物之前，在本节中，我们将熟悉一些基本概念和术语，这些术语可能在你深入研究无线电黑客和 SDR 时会遇到。

# 无线电中的关键术语

让我们快速了解一些你在 SDR 中经常遇到的术语。

一个简单的无线电系统将包括几个组件，如发送器、接收器、载波波和介质。这些组件基本上就是您所期望的。发送器是发送信号的组件，由传输介质传输到接收器。

在大多数实际情况下，需要发送的数据波会与载波波调制，然后发送到接收器，接收器会解调调制波以恢复原始数据波。

有许多调制类型，如频率调制、幅度调制和相位调制。此外，还有许多数字调制技术，如**开关键控**（**OOK**）、**相移键控**（**PSK**）、**频移键控**（**FSK**）和**幅度键控**（**ASK**）。

在使用无线电系统时，您将遇到一些常见术语，如下所示：

+   **波长**：在无线电术语中，这意味着波形中两个连续波峰（高点）或两个连续波谷（低点）之间的距离。

+   **频率**：顾名思义，指事件发生的频率。

+   **增益**：这是新处理信号的信噪比与原始信号的信噪比之间的比率。

+   **滤波器**：这可以从无线电信号中去除不必要或不需要的组件。它可以是各种类型，如高通滤波器（只允许超过一定阈值的信号通过滤波器）、低通滤波器（只允许低于一定阈值的信号通过滤波器）和带通滤波器（只允许在给定频率范围内的信号通过滤波器）。

+   **采样**：这涉及将连续信号转换为具有多个独立值的离散时间信号。如预期的那样，如果采样率不正确，信号将显得不完整或失真，并可能导致不正确的计算。

+   **奈奎斯特定理**：在这种情况下，如果采样频率至少是信号带宽的两倍，任何信号都可以用离散样本表示。

+   **模数转换器**（**ADC**）/**数模转换器**（**DAC**）：这将模拟信号转换为数字信号，反之亦然。

现在我们对各种无线电术语有了很好的理解，让我们开始看一些工具，用这些工具我们可以玩 SDR 并将其用于安全研究目的。

# 使用 SDR 工具

在本节中，我们将介绍用于 SDR 和无线电信号分析的最常用工具。我们将从最基本的工具开始，然后使用它来从无线电数据包中提取更多信息。

# 做好准备

要进行基于 SDR 的安全研究，需要以下工具：

+   硬件：

+   RTL-SDR

+   软件：

+   GQRX

+   GNU Radio 伴侣

要安装这些工具，以下存储库具有最佳的构建说明。

确保构建 GNU Radio 伴侣，而不是从`apt-get`安装，以获得更好的 SDR 工作体验。

SDR 安全研究也取决于您系统的性能。确保为您执行这些任务的虚拟机分配了足够的 RAM。如果可能的话，使用 Ubuntu 实例作为主机以获得最佳体验。

# 如何做...

RTL-SDR 是 SDR 世界中最好的设备之一。它最初是一种带有 Realtek 芯片组的电视调谐器，可用于许多基于无线电的活动。这些设备的频率各不相同，通常在 22 MHz-1.7 GHz 范围内。

# 分析 FM

1.  为了开始 SDR，我们将首先使用 RTL-SDR 查看频谱。这将让我们更好地理解一切是如何运作的，并开始对基于 SDR 的设备进行侦察。

1.  为此，将你的 RTL-SDR 插入系统。如果你正在使用虚拟机，请确保 RTL-SDR 连接到你的虚拟机。

1.  接下来，打开 GQRX 并在初始启动菜单中选择 RTL-SDR 设备。在这里，你可以看到我们有不同的部分：

![](img/027bbb50-5d18-4f1e-a62b-56449c9dced2.png)

在顶部部分，你可以使用上下箭头键或输入你想要调谐 RTL-SDR 的频率。

在频率部分之后，我们有频谱部分。在这里，你可以看到哪些频率最活跃，当你使用基于无线电的物联网设备时，也可以注意到它们的尖峰。我们稍后会更深入地讨论这个问题。

接下来是瀑布部分，显示了活动与时间的关系。这意味着你可以看到几秒前哪个频率有通信活动。

在右侧部分，我们有接收器选项、输入控制和 FFT 设置，这些是各种配置，将帮助你更好地分析你的数据。然而，为了简单起见，我们不会详细介绍它们。所有的窗格都可以根据需要进行修改和定制。

在这个第一个练习中，我们将通过调谐到一个当地的 FM 电台并在 GQRX 中接收音频来听取其中的内容。

1.  为此，让我们首先将模式更改为宽 FM 立体声，如下截图所示：

![](img/570c9f3a-51c8-42b7-8890-52817095fd02.png)

1.  一旦你做到了，将频率更改为你当地的 FM 电台频率范围如下：

![](img/b6cc2a9b-2a29-4907-9ffc-f4ef01626c35.png)

1.  一旦你点击捕获按钮，你将能够看到一个频谱，在多个地方有尖峰。这些尖峰代表了那个频率范围的活动：

![](img/f5f840e8-92ac-4671-9c54-99cf71b3e28c.png)

如果你调谐到一个有效的 FM 电台后现在从扬声器中听到声音，你将能够在那个频率听到 FM 广播。

# RTL-SDR 用于 GSM 分析

你也可以使用 RTL-SDR 进行许多其他用途。其中一个用途是进行蜂窝分析，如下所示。我们将使用 RTL-SDR 来查找各种手机用户的确切位置详细信息。然后可以使用单向天线来增加范围并收集大量信息。

1.  为此，启动`grgsm_livemon`，可以从[`github.com/ptrkrysik/gr-gsm/`](https://github.com/ptrkrysik/gr-gsm/)下载。如下截图所示启动它：

![](img/5d6531f4-0b80-45a4-bca7-9aa853fe7652.png)

1.  这将打开一个`grgsm_livemon`的屏幕，允许你改变增益和频率以查看频谱：

![](img/bd7bd4f6-e65f-4110-99b5-8900f0a9dd66.png)

那么我们如何得到在蜂窝网络上发生活动的频率。为此，我们将使用一个叫做 Kalibrate 的实用工具，它是一个 GSM 频率识别器，可以从[`github.com/ttsou/kalibrate`](https://github.com/ttsou/kalibrate)获取。

1.  一旦你有了 Kalibrate，指定要扫描的频段——在这种情况下，我们正在扫描 GSM900 并设置增益为 40.0 dB：

![](img/95314674-b781-4ebd-87c9-3f608d57b628.png)

1.  它告诉我们在 956.4 MHz + 9.829 kHz 有大量的流量。让我们启动 GQRX，看看这个频率，如下截图所示：

![](img/0cac46df-fff1-4ff8-a86f-d78dc0605ac5.png)

1.  果然，在确定的频率上确实有很多活动。现在我们已经得到了想要观察的频率，让我们回到 GRGSM，设置这个频率，并进一步分析：

![](img/d79d9f0f-4333-49e0-97cc-72d7ee7022b1.png)

1.  我们也可以在 Gr-gsm 中看到相同类型的流量。现在，为了进一步分析，我们需要在 Wireshark 上查看环回`lo`接口上的流量。正如预期的那样，我们能够在这里看到一些有趣的信息。应用`gsmtap`过滤器以过滤出对我们相关的消息：

![](img/bc323f6c-f768-4e7c-8568-f7bd3ef17ad5.jpg)

1.  正如你所看到的，我们已经使用**移动国家代码**（**MCC**）、**移动网络代码**（**MNC**）和**位置区域代码**（**LAC**）确定了这部手机的位置，现在我们可以使用 CellidFinder 等实用程序在地图上找到手机最近的基站：

![](img/8ee447dc-547c-4467-b49e-62742e780745.png)

这就是你可以使用 RTL-SDR 进行各种不同目的的方法，以及分析从正常 FM 到飞行交通甚至到蜂窝交通的许多事物。

# 使用 GNU Radio

现在，在以前的情况下，一切都只是关于查看频率和分析它，然而，并不是太深入。如果我们有一个传输原始无线电流量的物联网设备，并且我们想要了解幕后发生了什么，并找出它实际传输了什么数据，该怎么办。

为此，我们将使用一个名为 GNU Radio-companion 的实用程序，它允许我们构建无线电块以处理各种无线电信号。在这个实用程序中，你可以选择一个输入源（如 RTL-SDR 源、Osmocom 源、HackRF 源和信号发生器），并在其上应用无线电块，最后将输出存储在原始 wav 文件中或在图表中绘制出来。

在这个练习中，我们正在研究一个气象站，我们将使用 RTL-SDR 源捕获数据，然后执行解调和时钟恢复，以找到气象站实际发送的数据。

要找出设备操作的频率，我们可以使用 GQRX，并在它传输数据时寻找频率峰值。另一个选择是寻找 FCC ID——制造商在美国销售设备所需的标准——它执行重要的放射性。这些信息通常位于设备的标签之一上。

一旦我们有了 FCC ID，我们可以去`fccid.io`并输入`FCC-ID`，这将向我们显示设备正在使用的确切频率：

![](img/698a2181-2933-4bbc-aa4b-c465c0f1b881.png)

既然我们知道了频率，让我们去 GNU Radio-companion 并创建一个处理来自气象站的数据的工作流程。我们不会深入研究 GNU Radio-companion 及其各种属性，但我们强烈建议您自行探索，并尝试使用各种其他无线电捕获。

以下是我们要添加的块：

+   **Osmocom 源**：这可以帮助你从 RTL-SDR 获取无线电数据包，并将它们传递给以下块。

+   **复杂到 Mag²**：这可以帮助你将复杂数据类型转换为实数，不考虑诸如相位角之类的对我们目前不重要的事物。

+   **乘以常数**：这可以帮助你增加接收到的输出数据的强度，因为原始数据可能极低。5 或 10 的值会很好。

+   **文件接收器**：这可以帮助你将输出放入一个文件中，然后可以在 audacity 中进行分析。

![](img/9fe5f846-5cfe-4aec-926b-a9a3741aeb69.png)

双击 Osmocom 源以更改其属性，并设置我们之前确定的频率。

还要双击 Wav 文件接收器并给它一个输出文件名。

现在我们准备运行这个。一旦我们运行这个，我们将有一个名为`monitor.wav`的新文件。将文件作为原始文件导入 audacity。在这一步，这看起来像是 OOK；我们需要将这些数据转换为可理解的实际数据。其中一种方法是让较短的脉冲间隔表示数字零，较长的脉冲间隔表示数字一。这也显示在以下截图中：

![](img/4cef0e57-aa81-4f65-8cd4-1b3976005b29.png)

如果我们进一步分析数据，现在可以看到气象站发送的确切数据，包括温度和湿度数据：

![](img/b818cbd7-a1f9-48cc-b1a2-64c9598f7f1c.png)

# 还有更多...

还有许多围绕 RTL-SDR 和整体 SDR 黑客技术构建的其他实用程序，可以用于许多目的。例如，ADS-B 项目允许您实时跟踪飞行，RTL-433 用于处理 433 MHz 信号，还有其他实用程序可用于利用诸如钥匙扣之类的东西。

# 理解和利用 ZigBee

ZigBee 是物联网设备中常用的无线协议之一，因为它能够形成网状网络并以低功耗和资源消耗执行操作。它已经在许多垂直领域中得到应用，包括智能家居、工业控制系统（ICS）、智能建筑控制等。在大多数国家，它在 2.4 GHz 运行，在美国和澳大利亚是 902 到 928 MHz，在欧洲是 868 到 868.6 MHz。

在本节中，我们将研究 ZigBee，看看我们如何识别周围的 ZigBee 设备，并嗅探和重放流量以识别安全问题。

# 准备工作

要使用 ZigBee，需要以下设置：

+   **硬件**：Atmel RzRaven USB Stick 刷入了 KillerBee 固件

+   **软件**：KillerBee

安装 KillerBee 非常简单，可以按照官方 GitHub 存储库上的说明进行操作，链接在这里[`github.com/riverloopsec/killerbee`](https://github.com/riverloopsec/killerbee)。

完成设置后，将 RzUSB 棒插入系统。您应该能够看到 LED 呈琥珀色发光。如果颜色是蓝色，这意味着您的 RzUSB 棒未刷入 KillerBee 固件。我们不会详细介绍刷写固件的说明-因为它在 GitHub 存储库中有很好的文档，并且有许多在线商店可以购买预刷写了 KillerBee 固件的 RzRaven。

# 如何做到...

以下是我们如何开始分析我们周围的 ZigBee 设备并最终使用 RzRaven 和 KillerBee 实用程序嗅探 ZigBee 流量的步骤。

1.  我们将执行的第一步是查看周围的 ZigBee 设备。可以使用`zbid`实用程序来完成，如下图所示：

![](img/6d1f581f-6c5a-457d-a409-9b01d0e9b41a.png)

1.  我们还将以下程序刷入了 Arduino。该程序告诉 Arduino 与通过引脚 2 和 3 连接的 XBee 进行交互，并通过 XBee 发送消息`5e87bb4a6cdef053fde67ea9711d51f3`。XBee 发送此流量的通道基于给定 XBee 的编程方式。如果您想要编程自己的 XBee 并指定通道，可以使用实用程序 XCTU：

```
#include <SoftwareSerial.h> 

 int a = 0; 
SoftwareSerial mySerial(2, 3);  

 void setup() { 
Serial.begin(2400); 
} 

void loop() { 
Serial.println("5e87bb4a6cdef053fde67ea9711d51f3"); 
Serial.println(a); 
a++; 
} 
```

1.  接下来，我们将 Xbee 和 Arduino 放入 Xbee Shield 中，这与下图所示的情况类似：

![](img/c7caa28e-2466-4443-a812-afb7ea431c61.png)

1.  打开盾牌并运行`Zbstumbler`，如下图所示：

![](img/6c4a07eb-2633-464b-a298-4aabcb6c0b24.png)

正如我们所看到的，我们能够看到在通道 12 上广播的设备。

1.  下一步是嗅探通道 12 上的流量，看看它是否包含任何敏感信息。为此，我们将使用`zbwireshark`实用程序，使用以下语法显示的语法，它将自动在指定语法中的通道上打开 Wireshark 进行 ZigBee 嗅探：

```
sudo ./zbwireshark -c 12
```

1.  正如预期的那样，我们将能够在 Wireshark 中看到所有流量，如下面的屏幕截图所示，以及我们在 Arduino 中编程的敏感字符串：

![](img/fd9456e5-8143-4e84-905c-ac498bc55e9e.png)

# 还有更多...

您还可以执行其他攻击，例如使用 KillerBee 工具套件中的 Zbreplay 等实用程序修改捕获的流量后进行重放攻击。

# 深入了解 Z-Wave

Z-Wave 是无线传感器网络和家庭自动化中的流行协议之一，在美国的频率是 908.42 MHz，在欧洲是 868.42 MHz。Z-Wave 就像 ZigBee 一样支持网状网络，这使其免受节点故障等问题的影响。

它由 Sigma Systems 开发，与 ZigBee 和其他协议相比，它是一个封闭的协议。这也是安全社区对 Z-Wave 的安全研究倡议相对较少的原因之一，与其他流行的物联网协议相比。还有一些项目，如 OpenZWave 提供开源替代方案；然而，它们仍处于非常早期的阶段。

就像典型的无线通信协议一样，Z-Wave 设备遭受相同一组安全问题的影响。 Z-Wave 设备中最常见的漏洞之一是通信中缺乏加密，这使其容易受到敏感信息明文传输和基于重放的攻击的影响。然而，还要注意的是，诸如 Z-Wave 中的 S2 安全等项目大大增加了设备中 Z-Wave 实现的安全性，此外还保护免受针对密钥交换和设备认证的攻击。

# 如何做…

对 Z-Wave 进行攻击的一种流行框架是 EZ-Wave（[`github.com/AFITWiSec/EZ-Wave`](https://github.com/AFITWiSec/EZ-Wave)）由*Joe Hall*和*Ben Ramsey*开发，它使用 Hack RF 硬件对 Z-Wave 协议进行攻击。

EZ-Wave 工具包包括三个工具，如下所示：

+   设备发现和枚举-EZStumbler

+   对已识别设备进行侦察-EZRecon

+   利用-EZFingerprint

评估 Z-Wave 协议的一种方法是捕获传输中的数据包，并查找明文传输的敏感信息：

![](img/cd4a557a-930c-4fd0-bb0d-dac8983b8bc0.png)

使用所有前述的构建模块，我们的最终流程图如下所示：

![](img/576c7c52-8e9c-4887-a4ab-1a38159dc83c.png)

图像来源：http://oldsmokingjoe.blogspot.in/2016/04/z-wave-protocol-analysis-using-ez-wave.html。

完成后，我们可以选择重放数据包，或者根据我们想要实现的目标修改然后重放。另一类针对 Z-Wave 系统的攻击是从网络中分离/取消配对 Z-Wave 设备节点的攻击，欺骗攻击，干扰和拒绝服务攻击等。

# 理解和利用 BLE

BLE 或蓝牙低功耗是许多智能设备中最常见的平台之一，从智能家居到医疗设备工具，甚至健身追踪器和可穿戴设备都有。 BLE 日益受欢迎的原因之一是我们今天使用的几乎所有智能手机都支持 BLE，因此更容易与基于 BLE 的物联网设备进行交互。

BLE 设计用于资源和功耗受限的设备，BLE 通过提供短暂的远程无线连接有效解决了这个问题，从而显著节省了电池消耗。

BLE 最初是在蓝牙 4.0 规范中引入的，专注于需要极低功耗通信模式的设备，BLE 声称可以在单个纽扣电池上持续几个月到几年。

基于其当前连接和操作阶段，BLE 设备可以以四种不同的模式运行：

+   **中心设备和外围设备**：在这种分类中，扫描广告数据包并发起连接的设备称为中心设备，而广告自己进行连接的设备称为外围设备。一个例子是智能手机作为中心设备，健身追踪器作为外围设备。

+   **广播器和观察者**：顾名思义，广播器是一个广播数据的设备，而观察者是一个扫描广告数据包的设备。然而，与以前的分类类型相比，这里的主要区别是广播器是不可连接的，观察者不能发起连接。例如，一个连续发射温度数据的天气站是一个广播器，而接收广播并在屏幕上显示的显示器是一个观察者。

BLE 由 40 个不同的通道组成——3 个广告通道和 37 个数据通道，如下图所示：

![](img/ead3bba8-fc27-4e0e-842e-b8bd8cfdcf93.png)

来源：http://www.connectblue.com/press/articles/shaping-the-wireless-future-with-low-energy-applications-and-systems/

BLE 还执行频率跳频扩频，这意味着它在每个事件上不断改变通道。然而，在接下来的部分中我们将要使用的工具将能够跟踪设备通过跳频，并能够嗅探 BLE 通信的数据。

为了更好地准备好自己，了解蓝牙低功耗的基本概念，这是 BLE 堆栈的外观：

![](img/e4496114-6634-4e2a-8166-f60a868dc25a.png)

图片来源：http://www.embetronicx.com/

如您所见，这里有三个主要层：**应用程序**、**主机**和**控制器**。此外，**主机**和**控制器**通过所谓的**主机控制器接口**（**HCI**）进行交互。

**控制器**包含**链路层**（**LL**）和**LE 物理层**（**PHY**）。物理层负责信号调制和解调的主要任务，并在连接期间计算设备的跳频模式。链路层负责管理许多任务，包括设备的蓝牙地址、加密和连接初始化，以及处理广告数据包。

**主机**层包含我们在 BLE 开发中将直接使用的一些最重要的东西。这些包括**通用访问配置文件**（**GAP**）和**通用属性配置文件**（**GATT**）。

GAP 负责控制大部分广告和连接初始化，以及定义通信中各种设备的角色。

GATT 直接位于 ATT 之上，ATT 负责主/从之间的数据交换，并执行一些操作，如读取、写入和错误处理。GATT 在 ATT 之上添加了一个整体的数据组织层，使其更易于理解。在 GATT 中，整个数据按照给定的图表进行分类：

![](img/6f57e9d2-ac6e-4989-9cbb-203323bac8fc.png)

从上图可以看出，整体数据组织成最低层的**特征**，其中包含**值**和**描述符**。一个例子是每分钟心跳和其值存储在特征中。特征还有一个唯一的 UUID，可以从蓝牙**特殊兴趣组**（**SIG**）数据库中引用，该数据库位于[`www.bluetooth.com/specifications/gatt/characteristics`](https://www.bluetooth.com/specifications/gatt/characteristics)。

接下来，各种相似的特征被封装在服务中。服务的一个例子是`心率服务`，其中包含各种特征，如每分钟心跳、不规则心跳和恐慌发作。服务还有一个 16 位 UUID，可以从蓝牙 SIG 服务 UUID 数据库中引用，该数据库位于[`www.bluetooth.com/specifications/gatt/services`](https://www.bluetooth.com/specifications/gatt/services)。

接下来，整个服务都包含在一个**配置文件**中，这可以是一个通用配置文件，例如心脏健康配置文件，其中包含各种服务，如`heart-rate-service`和`heart-oxygen-service`。

如前所述，在嗅探期间，我们的目标是找到正在读取和写入的特征值。这些特征通常被称为**句柄**，一旦我们捕获到流量，就会看到这些句柄。

接下来，BLE 堆栈的另一个重要组件是 L2CAP。L2CAP 代表逻辑链路控制和适配协议，主要负责从其他层获取数据并将数据封装在适当的 BLE 数据包结构中。

这就是我们开始 BLE 利用所需要知道的全部。现在，让我们开始动手吧。

# 准备工作

要开始进行 BLE 利用，我们需要以下工具：

+   软件：

+   Blue Hydra 或 HCI Utils

+   Ubertooth utils

+   Gattacker

+   硬件：

+   BLE 适配器插头

+   Ubertooth 或类似的 BLE 嗅探器

在处理 BLE 时，我们的方法是首先找出目标设备的地址，同时在执行目标 BLE 设备的操作时嗅探该特定地址的流量。

这将使我们能够找到正在设备上写入以执行某个操作的特定 BLE 句柄。为了更好地了解 BLE 句柄是什么，它们只是对 BLE 特征具有的各种属性的引用。

在本节中，我们将确保我们已经正确设置了一切，如下所示。

确保蓝牙适配器插头连接到您的虚拟机，并且您能够看到`hci`接口，如下截图所示：

![](img/2ba5963d-506f-4a75-b767-2547224d0417.png)

接下来，从它们的官方 GitHub 存储库安装以下工具：

+   Blue Hydra（用于对 BLE 设备进行初始侦察）：[`github.com/pwnieexpress/blue_hydra`](https://github.com/pwnieexpress/blue_hydra)

+   Ubertooth Utils（用于对我们的 BLE 设备执行嗅探和数据包捕获）[`github.com/greatscottgadgets/ubertooth`](https://github.com/greatscottgadgets/ubertooth)

+   Wireshark（数据包分析工具，也兼容 BLE）[`www.wireshark.org/download.html`](https://www.wireshark.org/download.html)

一旦您安装和配置了所有这些，我们就准备好开始与周围的 BLE 设备进行交互了。

# 如何做...

1.  我们要做的第一件事是与我们周围的 BLE 设备进行交互，查看周围所有设备并找到它们的蓝牙地址。可以使用以下命令完成：

```
sudo hcitool lescan 
```

1.  这使用 Hcitool 的`lescan`（低功耗扫描）功能来查找附近所有 BLE 广告，如下截图所示：

![](img/0db4993d-ecc5-41b0-984c-4bfd38de884f.png)

如您所见，我们能够识别出我们周围的许多设备以及它们的地址。接下来，我们可以使用 Ubertooth 来嗅探给定设备的流量，如下所示。

Ubertooth One 是由*Michael Ossman*的 GreatScottGadgets 开发的设备，用于评估蓝牙设备的安全性。它由 CC2400 2.4 GHz 射频收发器和带有 USB 端口的 NXP LPC1756 微控制器组成。

对于我们作为安全研究人员和渗透测试人员，它可以帮助识别诸如明文数据传输之类的安全问题，还可以识别在网络通信期间正在被写入和读取的句柄。

1.  要使用 Ubertooth 嗅探从给定设备后面的连接，请使用以下语法：

```
sudo ubertooth-btle -f -t [address] -c [capture-output]

```

1.  用设备的地址替换`[address]`，这是我们在上一步骤中识别的设备的地址。

`[capture-output]`可以是文件，也可以是管道，以便进行主动流量拦截。

让我们使用`/tmp/pipe`作为捕获接口，其中一个管道的一端从 Ubertooth 获取输入数据，另一个管道的另一端在 Wireshark 中显示数据。

1.  要做到这一点，打开另一个终端窗口，输入 mkfifo `/tmp/pipe`。完成后，转到 Wireshark | 捕获接口 | 管理接口 | 新接口 | 管道，并添加值`/tmp/pipe`并保存接口。

1.  接下来，在 Wireshark 中开始嗅探`/tmp/pipe`接口，这是您刚刚创建的。根据您执行的操作和目标设备，您将能够在 Wireshark 中看到 BLE 流量显示，如下面的屏幕截图所示：

![](img/49e2fa34-64cb-409a-b61b-b99733d53d88.png)

在前面的屏幕截图中，我们还应用了一个过滤器`btl2cap.cid==0x004`，以确保我们获得具有有用数据的数据包。正如您在图像中也可以看到的，我们收到了许多读/写请求，以及句柄的详细信息和写入该特定句柄的值。在这种情况下，句柄 0x0037 和值 1 对应于解锁基于 BLE 的智能锁。

现在我们知道为了执行特定操作而写入句柄的值是什么，我们可以自己写入该特定句柄，而无需 Ubertooth。为此，我们将使用 BLE 适配器和一个名为`gatttool`的实用程序。

1.  要做到这一点，启动`gatttool`，如下所示，以及使用`-b`和`-I`标志提供蓝牙地址并指定在交互模式下打开：

```
sudo gatttool -b [Bluetooth-address] -I 
[gatttool prompt] connect 

```

1.  接下来，我们在这里需要做的就是向目标设备发送写请求，指定我们要写入句柄的值，如下面的屏幕截图所示：

![](img/9c233db9-2548-42cc-b0dd-693406dd2ad4.png)

这已经解锁了智能锁，因为智能锁检测到句柄`0x0037`现在具有值`01`，这与智能锁解锁的状态相关。

这就是您可以与基于 BLE 的物联网设备进行交互，找出哪些句柄正在被写入，然后自己写入这些句柄的方法。

1.  您还可以通过查看所有服务的所有值来查看设备的其他属性，如下面的屏幕截图所示：

![](img/d6b20658-7c73-4558-84a7-0ed9256ff595.png)

1.  这也可以用于特征，如下面的屏幕截图所示：

![](img/ab8644cf-8f85-4823-8441-5cd24cf6ad3d.png)

# 还有更多...

要有效地嗅探 BLE 流量，重要的是要识别可能在任何三个广告信道上进行广告的设备。为此，重要的是要设置三个 Ubertooth 而不是一个。

此外，您可以尝试一些其他工具：

+   **btlejuice**：如果您想要使用 Web GUI 界面对 BLE 流量进行中间人攻击，这是一个方便的工具

+   **Gattacker**：这类似于`btlejuice`，但没有 GUI

+   **BLEah**：这是一个 BLE 信息收集工具
