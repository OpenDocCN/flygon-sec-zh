# 第六章：物联网设备黑客

在本章中，我们将涵盖以下主题：

+   硬件利用与软件利用

+   硬件黑客方法论

+   硬件侦察技术

+   电子学 101

+   识别总线和接口

+   嵌入式设备的串行接口

+   NAND 故障

+   JTAG 调试和利用

# 介绍

任何**物联网**（**IoT**）解决方案的关键中心组件是嵌入式设备。它是与物理环境互动并与网络端点和周围其他设备通信的设备。了解如何利用这些硬件设备对于进行物联网渗透测试非常关键。

在物联网解决方案中使用的设备类型可能因产品而异。在某些情况下，它可能是一个网关，允许各种设备与其互动，同时与网络端点通信，或者它可能是一个医疗设备实用程序，其唯一目的是从患者的身体收集数据并在智能手机上显示。

然而，存在某些特定的安全问题，可能会影响任何给定的硬件设备，无论其类别如何。这就是我们将在本章中关注的内容-深入了解各种物联网设备安全问题，如何识别它们以及如何利用它们，无论设备类型如何。但是，在我们进行实际的硬件利用之前，让我们看看硬件利用与传统软件利用有何不同。

# 硬件利用与软件利用

硬件利用与软件利用之间的差异非常显著，最重要的是，要找到硬件的漏洞和利用，你需要拥有物理设备。这意味着除非你拥有两个或更多的设备，否则要有效地对物联网设备的硬件进行渗透测试是相当复杂的。

增加与硬件安全工作复杂性的另一个因素是围绕硬件安全公开可用的资源量。例如，在你正在评估的软件的情况下，你可能会发现软件正在使用的某个组件中存在现有的漏洞或者是你正在使用的软件类型中发现的常见漏洞的机会。这并不意味着硬件利用更加困难，只是意味着如果你刚开始，由于缺乏给定组件的深入的与安全相关的信息，你可能会发现硬件利用相对于以前的软件利用经验更加复杂。

在基于硬件的漏洞方面，还有一件事需要注意的是，它们相对更难修补，在某些情况下，甚至无法在不完全更换设备的情况下修补。这意味着如果硬件设备本身存在关键的安全问题，制造商唯一的选择就是召回设备并用更安全的设备替换它们。

最后，对于我们作为渗透测试人员来说，最显著的区别之一是，对于硬件利用，我们需要一些硬件工具和设备来有效地评估和利用最终设备的安全性。

然而，不要感到沮丧，因为我们将涵盖许多硬件利用的工具和技术，这将让你迅速进入硬件黑客的世界。

# 硬件黑客方法论

硬件黑客方法论涉及的步骤如下：

+   信息收集和侦察

+   对设备进行外部和内部分析

+   识别通信接口

+   使用硬件通信技术获取数据

+   使用硬件利用方法的软件利用

+   后门设置（可选）

让我们逐个深入了解每一个步骤。

# 信息收集和侦察

嵌入式设备黑客方法论的第一步是尽可能收集关于我们正在处理的目标的信息。现在这可能听起来很简单，但在嵌入式设备的情况下，这可能比我们想象的要复杂一些。关于目标设备的信息通常是有限的-至少从一个非常高层次的视角来看-考虑到为了获得有关设备的相关信息，我们将需要访问物理设备本身。

但即使在这之前，渗透测试人员可以通过多种方式收集有关给定目标设备的更多信息。这些包括公开可用的来源或客户提供的文档，或通过其他资源。

在这个阶段可能相关的一些信息包括：

+   嵌入式设备基于什么？

+   它运行的操作系统

+   设备支持哪些外部外围设备？

+   设备使用了什么样的芯片组件？

+   关于设备使用的存储和内存的详细信息

+   关于设备的任何其他相关技术信息

一旦我们获得了这些信息，我们就可以进入下一步，即使用外部和内部分析来分析设备。

# 设备的外部和内部分析

一旦你从上一步获得了信息，下一步就是开始与设备本身进行交互。在这里，目标是从攻击者的角度查看设备，并通过视觉检查-包括外部和内部-尽可能多地识别信息。

外部分析非常直接，可以通过查看设备并找出所有你能看到的各种组件来进行。在这里，你可能会问自己以下问题：

+   设备的各种接口选项是什么-它是否有任何 USB 端口、SD 卡插槽或以太网端口？

+   设备是如何供电的-通过电池、PPoE 还是适配器？

+   设备上有标签吗？如果有，它们包含什么样的信息？

一旦我们完成了外部分析，下一步就是进行设备的内部分析。这需要你打开设备，查看**印刷电路板**（**PCB**）。在这一步中，我们将识别设备中的各种芯片组件，查阅它们的数据表，并了解每个特定组件的功能，以及记录从数据表中找到的各种信息。

在这个阶段，我也喜欢绘制各种组件之间的基本连接的框图，以便更清楚地了解整个设备的内部情况。

# 识别通信接口

一旦我们查看了 PCB 并找到了关于整个电路和其中涉及的各种组件的足够信息，下一步就是寻找与设备进行接口的所有可能选项。

在某些情况下，它可能非常明显并且直接摆在你面前，而在其他情况下，可能更难以识别，可能分散在整个电路板上，或者在某些情况下，你将不得不直接连接到给定芯片组件的引脚上。

# 使用硬件通信技术获取数据

一旦我们确定了正在使用的通信协议/接口，我们可以使用一组特定的工具来通过给定的协议与目标设备通信，并与目标交互或读/写信息到给定的芯片。

根据受审查的接口，我们将使用不同的技术来连接并获取有用的渗透测试数据。一些常见的接口包括 UART、JTAG、SPI、I2C 和 1-Wire。

# 使用硬件开发方法进行软件开发利用

一旦我们通过给定的硬件接口访问了目标设备，下一步将是通过硬件利用执行各种软件利用技术。这包括执行诸如转储固件、在给定的内存区域写入新内容、对运行进程进行修改等操作。

正如你现在可能已经了解的那样，大多数利用硬件技术的攻击将使你获得对敏感资源的访问，然后可以以多种方式进行利用。

现在我们对整体硬件渗透测试方法论有了了解，让我们深入了解如何对硬件设备进行侦察。

# 硬件侦察技术

除了视觉外部分析之外，侦察包括两个步骤-打开设备并查看各种芯片的存在，并从其数据表中获取信息。

让我们逐一深入了解。

# 打开设备

硬件侦察过程的第一步是打开设备。这个过程的复杂性取决于你所使用的设备，可以从非常简单到非常复杂不等。

在一些设备中，你会发现螺丝隐藏在腿部的橡胶垫下，而在其他情况下，它们会大部分暴露出来，而在其他情况下，两个不同的部分可能会被焊在一起。

根据设备的组装方式，使用适当的工具拆卸不同的部分。建议在整个硬件利用过程中携带一套好的螺丝刀，因为不同的设备会使用许多不同种类的螺丝。

# 查看各种芯片的存在

一旦你打开了设备，下一步是查看 PCB 并识别所有各种芯片的存在。使用 USB 显微镜或智能手机的手电筒来读取芯片的标签，同时倾斜芯片。建议使用支架，可以在读取各种芯片的名称时稳定地固定设备。

一旦你弄清楚了芯片的名称，就去谷歌搜索它的制造商，然后加上型号和“数据表”这个词。这也是我们将在本章后面做的事情。

一旦你有了数据表，你可以利用其中的信息来找出目标芯片的各种属性，包括引脚布局，在硬件利用过程中这将非常有用。

现在我们知道如何对目标设备进行侦察，我们可以继续深入硬件利用。为了确保我们非常了解我们的目标，并确保我们的攻击成功，我们需要更好地了解电子学，这将使我们在进行利用时更容易理解。

# 电子学 101

正如前面提到的，电子学是要理解的最重要的事情之一，如果你想进行硬件黑客攻击。你可能能够在不了解电子学的情况下捕捉一些低悬漏洞；然而，要擅长这个领域，你需要了解设备上发生了什么，以及如何利用给定的组件。在本节中，我们将介绍一些电子学的基本概念，这将帮助你在开始研究嵌入式设备内部时获得更多的信心和理解。

这对你来说可能看起来非常基础；然而，把这一节当作你将在后面的章节和实际生活中所看到的东西的一个复习，当你开始使用嵌入式设备时。

# 电阻

电阻器是电子元件，它们阻碍电流流动，或者更深层次地说，阻碍电子的流动。电阻器，用*R*表示，是被动元件，这意味着它们根本不产生任何电力，而是通过散热的方式降低电压和电流。

电阻的单位是欧姆（Ω），电阻通常使用碳或金属线制造。你还会发现电阻器被编码颜色，以帮助传达它们提供的电阻值。

这就是电阻器的样子：

![](img/c2aac831-cac2-4e0b-a47a-f4c01b8de34c.jpg)

现在你知道了电阻器是什么，值得注意的是，电阻器可能有两种不同的类别-固定和可变。顾名思义，固定电阻器的电阻是固定的，不能改变，而在可变电阻器中，电阻可以使用某些技术进行变化。可变电阻器最流行的例子之一是**电位器**。

# 电压

在电子学中，电压简单地是两个不同测量点之间的电势能差。在大多数情况下，用来测量给定点电压的参考点是**地**（**GND**），或者电池或电源的负极。举个现实生活中的例子，如果你使用了一个 9V 电池，这意味着两点之间的电势差为 9 伏特。

为了更深入地了解，让我们假设在导体的两端，比如铜线，你有大量的电子（负电荷），在另一端你有质子（正电荷）。这意味着这两点之间的电势存在差异，最终导致电流的流动。

为了测量电压，我们使用一种叫做**电压表**的设备，它告诉我们它连接的两点之间的电势差。例如，9V 电池的正极电压为+9V，负极电压为-9V。

# 电流

正如我们在前面的情景中讨论的，电流流动（在前述情况下是因为介质是铜导体）当两端的电压存在差异时，它将继续流动，直到两侧的电子和质子数量相等。

电流可以是**交流**（**AC**）或**直流**（**DC**），这意味着如果电流以恒定速率流动，比如在电池中，它将是直流，而如果它是交变的或随时间变化的，它就是交流。例如，在美国，从电源插座获得的默认电力是 120V 和 60Hz 的交流电。

电流以**安培**（**A**）为单位进行测量，并在方程和公式中用字母*I*表示。用于测量电流的设备称为**安培表**。

你可能会认为这三个组件-电流、电压和电阻似乎是相互依赖的。总结一下，电压引起电流流动，电阻阻碍电流流动。

这种关系就是著名的**欧姆定律**，它规定*电流（I）=电压（V）/电阻（R）*。

这也证实了电流与电压成正比，与电阻成反比的事实。

# 电容器

电容器是几乎所有嵌入式设备中最常见的组件之一。顾名思义，它们的主要任务之一是以电荷的形式储存能量。

电容器内部有两个带有相反电荷的板，当连接到电源时，它们储存电荷。电容器的其他用途包括作为滤波器，减少影响设备上其他芯片的电噪声，分离交流和直流组件（交流耦合）等。

电容的单位是法拉，用*F*表示，可以使用以下公式计算：

*C=Q/V*

这里，*C*是电容，*Q*是电荷，*V*是电压。

所有前述值都以法拉第（*F*）、库仑（*C*）和伏特（*V*）为标准单位进行测量。

# 晶体管

晶体管是电子元件，通过充当开关和放大器来发挥多种作用。

作为放大器，它可以接收小电流并放大它以产生更大的输出电流。其中一个例子是麦克风连接到扬声器，麦克风接收到小声音输入并放大后通过扬声器输出更大的声音。

同样地，作为开关，它可以接收小电流输入并用它来允许更大的电流流动，从而激活新的电流流动。

这是晶体管的外观：

![](img/9d3cb606-5a66-4cc3-ada1-dddb67fc54b7.png)

以下是 NPN 晶体管（另一种类型是 PNP，箭头指向基）的示意图：

![](img/6295c4b8-4e43-426e-8d6a-8f054feff39c.png)

# 存储器类型

嵌入式设备中一些最重要的组件与数据存储有关，可以被设备用于多种目的。这是您可以找到固件和应用程序编程接口（API）密钥等内容的地方。嵌入式设备中的三种主要存储器类型及其细分如下：

+   随机存取存储器（RAM）

+   静态随机存取存储器（SRAM）

+   动态随机存取存储器（DRAM）

+   只读存储器（ROM）

+   可编程只读存储器（PROM）

+   可擦可编程只读存储器（EPROM）

+   混合

+   可擦可编程只读存储器（EEPROM）

+   闪存

各种存储器类型的区分是基于一些因素，如存储数据的能力，存储数据的时间，数据如何被擦除和重写，以及重写数据的过程是什么样的。

例如，SRAM 只在接收到电源供应时保存数据，而 DRAM 将每个数据位存储在单独的电容器中。此外，由于 DRAM 具有刷新周期（因为电容器最终会被放电），因此 SRAM 相对于 DRAM 来说速度更快。

同样地，根据数据可以被写入的次数，ROM 被分类为 PROM 或 EPROM。对于 PROM，一旦写入数据就无法修改，而在 EPROM 中，数据可以通过紫外线（UV）射线擦除，紫外线可以通过一个小窗口到达芯片，通过重置芯片并将其带到初始状态来擦除芯片。

然而，我们将遇到的两种最重要的存储器类型是 EEPROM 和 Flash，或者基于读取、写入和擦除周期的差异而言的 NOR 和 NAND Flash-取决于是否可以一次在整个块上执行操作（Flash），以及是否需要一次在单个位上执行操作（EEPROM）。

# 串行和并行通信

现在我们对一些电子元件有了基本的了解，让我们进入嵌入式设备中使用的不同种类的通信介质。

嵌入式设备中的数据通信方法有串行和并行通信。顾名思义，串行通信按顺序逐位发送数据。这意味着如果要传输 8 位，它将一个接一个地发送，只有当所有 8 位都接收到时，数据传输才完成。

然而，在并行通信的情况下，多个位将同时传输，因此使数据传输过程比其串行对应物更快。

您可能会认为并行通信会更好，并且由于数据传输速率更快，它会被广泛使用。然而，这并不是事实，因为我们没有考虑并行通信在电路板上所需的实际空间。

嵌入式设备的物理空间非常有限。因此，在数据传输方面，更快并不总是更好的选择，尤其是考虑到并行数据传输需要比串行数据传输更多的数据线。

一些并行数据传输通信的示例是 PCI 和 ATA，而串行通信是使用 USB、UART 和 SPI 进行的。

在本书中，我们将重点关注串行通信介质，因为它们在您将遇到的所有硬件设备中都是最常见的。

# 还有更多...

此时您还可以执行的一项工作是查看任何给定嵌入式设备的电路板，并尝试识别涉及的各种组件以及它们使用的通信机制是什么样的。

# 识别总线和接口

现在我们对嵌入式设备中的不同组件有了很好的了解，让我们看看如何识别设备中存在的不同总线和接口。

为此，第一步是打开设备并查看 PCB。请注意，在本节中，我们只关心识别特定引脚、标头或芯片的用途，而不是实际连接到它，这是我们将在下一节中介绍的内容。

如何做...我们将首先寻找 UART，这是黑客最喜欢用来访问设备的接口之一。我们将首先查看 UART 的内部结构，然后是如何识别引脚排列，最后是如何连接到目标设备。

# UART 识别

在嵌入式设备中，我们首先要寻找的是**通用异步收发器**（**UART**）接口。UART 是嵌入式设备中最常见的通信协议之一。UART 基本上将其接收到的并行数据转换为串行数据流，这样更容易进行交互。

由于这里的另一个重点是减少线路的数量，因此在 UART 通信中没有时钟。相反，UART 依赖于**波特率**，即数据传输速率。UART 通信中的两个不同组件将同意指定的波特率，以确保数据以正确的格式接收。

此外，在 UART 通信中，还会添加另一个称为**奇偶校验位**的位，以便进行错误检测。因此，典型的 UART 通信顺序如下：

+   **起始位**：表示这是 UART 通信的开始。

+   **数据位**：这是需要传输的实际数据。

+   奇偶校验位：这用于错误检测。

+   **停止位**：用于指示 UART 数据流的结束。

如果您想自己尝试并了解 UART 数据流，可以使用逻辑分析仪并连接到 UART 端口（我们将在稍后识别），然后在逻辑分析仪软件中查看结果。可以使用的一种流行的逻辑分析仪是 Salae Logic，它有 8 通道和 16 通道两种选项。

以下屏幕截图显示了逻辑分析仪中数据的样子：

![](img/4a6075de-45dc-4f32-be02-5b5e948b0ecd.png)

让我们继续看看实际设备中的 UART 端口是什么样子。以下是一些已在设备中识别出的 UART 端口的示例。请注意，要进行 UART 通信，两个引脚是必不可少的-发送（Tx）和接收（Rx）。此外，在大多数情况下，您还会发现另外两个引脚用于地线（GND）和 Vcc：

![](img/8eac5a14-3ba3-49d9-b16f-2ba15691ae9e.png)

如您在上图中所见，有四个相邻的引脚，这在这种情况下是 UART 引脚。在关于获取和接口化串行通信的下一节中，我们将看看如何识别确切的引脚布局-哪些引脚对应于 Tx、Rx 和 GND，并且还要接口化这些引脚/端口以访问设备。

# SPI 和 I2C 的识别

SPI 和 I2C 的识别类似于我们刚刚在 UART 通信识别中看到的。识别正在使用的通信协议是 SPI 还是 I2C 的一种方法是使用逻辑分析仪，并查看在通信中传输的各种位。

SPI 和 I2C 都属于串行通信，主要用于 Flash 和 EEPROM。正确识别正在使用的确切协议以及更多细节的一种方法是查看芯片名称并从数据表中获取信息。

以下是 SPI 闪存芯片的外观：

![](img/a0c2764c-d27e-40aa-a613-e7d51d3c2bf9.png)

图片来源：[`cdn-shop.adafruit.com/1200x900/1564-00.jpg`](https://cdn-shop.adafruit.com/1200x900/1564-00.jpg)

上图中的闪存芯片标签为 Winbond W25Q80BV，这意味着现在我们可以查阅其数据表并识别其各种属性-即使不知道它是 SPI 闪存芯片。

如果我们搜索芯片编号，我们将得到以下结果：

![](img/fcba91d3-d9cc-49e1-ba1f-e59791a60444.png)

让我们继续打开搜索结果中找到的任何数据表 PDF。在数据表的开头，我们将找到以下内容：

![](img/8d76b63c-e7db-4511-ac16-7aeaf2b278d5.png)

这意味着我们的芯片是一颗带有 8MB 存储空间的 SPI 闪存芯片。随着我们在数据表中的进一步了解，我们还发现了其引脚布局，如下截图所示，告诉我们给定 SPI 闪存芯片的确切引脚布局：

![](img/b8f9c959-1bdf-46b8-9b0e-7e961068da02.png)

因此，我们已经能够正确识别芯片的用途、其属性以及其引脚布局。

有了这些信息，我们可以使用 Attify Badge 连接到 SPI 闪存芯片，这是一种用于处理各种硬件协议和标准（如 UART、JTAG、SPI 和 I2C）的工具。或者，您也可以使用 FTDI MPSSE 电缆。

将**数据输出**（**DO**）和**数据输入**（**DI**）分别连接到 Attify Badge 的 MOSI 和 MISO，或者，如果您使用 FTDI 电缆，则芯片的 DI 连接到电缆的 DO（黄色），芯片的 DO 连接到电缆的 DI（绿色）。此外，还将电缆的 Vcc、GND、WP 和 CS 连接到芯片上的相同引脚。

下图中的表格将帮助您在此阶段进行连接：

![](img/8190c765-09ec-4302-a59a-84cd0aea9ba0.png)

连接完成后，我们只需从位于[`github.com/devttys0/libmpsse`](https://github.com/devttys0/libmpsse)的 LibMPSSE 库中运行`spiflash.py`实用程序。以下截图也显示了这一点：

![](img/0a0d4fb8-9c0c-4dfc-a71c-0ab86c27b599.png)

上述语法中的大小是从闪存芯片的数据表中获取的，并且闪存芯片的整个内容被放入名为`new.bin`的文件中。

因此，现在您可以查看 SPI 闪存芯片，找出其引脚布局，并从中转储数据，这可能是固件、硬编码密钥或其他敏感信息，具体取决于您正在使用的设备。

# JTAG 识别

为了识别设备上有趣的暴露接口，我们将寻找的最后一件事是**联合测试动作组**（**JTAG**）。

与以前的针床测试相比，JTAG 是一种更简化的测试引脚和调试引脚的方式。它使设备开发人员和测试人员能够确保设备上各个芯片中的每个引脚都能够按预期功能、互连和正常运行。

对于渗透测试人员来说，JTAG 有很多用途，从使我们能够读/写数据，甚至调试运行中的进程，到修改程序执行流程。

当我们寻找 JTAG 时，最重要的四个焊盘是**测试数据输入**（**TDI**）、**测试数据输出**（**TDO**）、**测试时钟**（**TCK**）和**测试模式选择**（**TMS**）。然而，在识别这些单独的焊盘之前，我们必须首先确定设备上 JTAG 头部的位置。

为了简化事情，JTAG 有几种标准接口选项，如 13 针、14 针、20 针等。以下是一些真实设备中 JTAG 接口的图像：

![](img/a571cc13-8bb0-4fd7-99c0-224c36bd5d79.png)

图像来源：https://www.dd-wrt.com/wiki/images/thumb/9/99/DLINK-DIR632_Board.png/500px-DLINK-DIR632_Board.png

以下是 Experia v8 Box 上的 JTAG 接口，带有焊接的 JTAG 头部：

![](img/e5f1935f-f04b-41bd-8ca6-17c5f62c3b78.png)

图像来源：http://www.alfredklomp.com/technology/experia-v8/

这里还要注意的一点是，即使你可能能够在标准的头部格式中找到 JTAG，但在一些真实设备中，你会发现 JTAG 焊盘分散在整个电路板上，而不是集中在一个位置。在这种情况下，你需要在焊盘上焊接排针/跳线，并将它们连接到 JTAGulator 上，以便确定它们是否是 JTAG 焊盘，以及哪个焊盘对应于哪个 JTAG 焊盘。

# 还有更多...

+   除了之前提到的接口和协议，你的目标设备可能还使用许多其他硬件通信协议。一些其他流行的通信技术包括 CAN、PCI、1-Wire 等。建议你研究更多的硬件通信协议，以更广泛地了解你可以分析协议的方式。

# 嵌入式设备的串行接口

由于我们已经在前一节中介绍了 UART 的基础知识，让我们直接进入如何与 UART 接口进行交互。

# 做好准备

一旦连接好，我们将看看如何在设备上找到 UART 焊盘后如何识别这些焊盘。

我们要找的四个焊盘如下：

+   Tx

+   Rx

+   GND

+   Vcc

为此，我们将使用**万用表**，它可以测量电压和电流，因此既可以作为电压表又可以作为电流表，因此得名为万用表。

以下是万用表的外观。按照以下图像所示连接探针：

![](img/f061597a-b724-4541-a1e5-c3ea6437dfd7.png)

# 如何操作...

连接好后，让我们继续找到不同的 UART 焊盘，就像下面的步骤描述的那样。

1.  确保万用表上的指针指向扬声器符号，就像下面的图像中所示的那样：

![](img/b06d22e4-8cd9-4ac9-a6a5-9caa1e456c1c.png)

确保你的设备已关闭。将黑色探针放在一个接地表面上——这可以是设备上的任何金属表面。

1.  将红色探针分别放在你认为是 UART 的四个焊盘上。再用其他焊盘重复此操作，直到听到蜂鸣声。

1.  你听到蜂鸣声的地方是设备上的 GND 焊盘。这个测试也被称为连续性测试，因为我们刚刚检查了两个 GND 焊盘之间的连续性——一个已知的和一个未知的。

既然我们已经确定了 GND 焊盘，让我们继续确定其他剩下的焊盘。

1.  将万用表指针放到 V - 20 位置，因为现在我们要测量电压。将黑色探针放在 GND 上，将红色探针移动到 UART 的其他焊盘上（除了 GND）。

在此阶段，重新启动设备并打开它。在您看到恒定高电压的引脚处是我们的 Vcc 引脚。

1.  接下来，再次重新启动设备，并测量除了在前面步骤中确定的 Vcc 和 GND 之外的其他引脚与 GND 之间的电压。由于在启动过程中最初进行的大量数据传输，您将在最初的 10-15 秒内注意到其中一个引脚上电压值的巨大波动。这个引脚将是我们的 Tx 引脚。

1.  Rx 可以通过在整个过程中具有最低电压波动和最低整体值的引脚来确定。

因此，我们已经确定了 UART 通信所需的所有引脚-Tx 和 Rx，以及 GND 和 Vcc。

1.  一旦您确定了设备的引脚布局，下一步将是将设备的 UART 引脚连接到 Attify Badge。在这里，您也可以使用其他设备代替 Attify Badge，例如 USB-TTL 或 Adafruit FT232H。

在这一点上，我们将关注 Attify Badge 上的引脚 D0 和 D1，分别对应于发送和接收。

目标设备的**发送**（**Tx**）将连接到 Attify Badge 的 Rx（D0），并且目标设备的 Rx 将连接到 Attify Badge 的 Tx（D1）。IP 摄像头的 GND 将连接到 Attify Badge 的 GND。

一旦我们完成了所有连接，下一步就是找出设备运行的波特率。将 Attify Badge 连接到系统并启动目标设备。

要识别波特率，我们将使用[`github.com/devttys0/baudrate/blob/master/baudrate.py`](https://github.com/devttys0/baudrate/blob/master/baudrate.py)上可用的`baudrate.py`实用程序。

1.  这可以通过以下命令运行：

```
sudo python baudrate.py
```

1.  一旦您进入波特率、屏幕，您可以使用上下箭头键切换波特率。在波特率处，如果您能够看到可读字符，那就是您目标设备的正确波特率。它应该看起来像以下屏幕截图：

![](img/a58f2f84-6507-4277-b250-cfd6e0db41b7.png)

1.  接下来，按下*Ctrl* + *C*，这将使用已识别的设置将您带到 minicom 实用程序。在这里按下*Enter*将授予您 shell 访问权限，前提是您的目标设备具有基于 UART 的 shell：

![](img/b6fd8d08-8df1-4b6c-9b30-58929f0a3a49.png)

因此，我们能够利用暴露的 UART 接口，找出引脚和接口，并最终获得 root shell。

# 另请参阅

+   现在您已经可以访问目标设备的 UART 接口，还可以执行其他利用技术，例如后门和通过**微不足道的文件传输协议**（**TFTP**）转储整个文件系统。但是，这将因设备而异，并取决于您在已经受到攻击的设备上拥有的当前特权。

# NAND 故障

您可以在嵌入式设备上执行的另一件事情是利用基于故障的攻击来绕过安全措施（例如 UART 控制台上没有 root shell）。 

# 准备就绪

故障，顾名思义，是一种在您正在使用的系统中引入故障的方法。这可以通过多种方式完成，有专门的书籍和研究论文专门讨论这个主题。

现在，我们将简要介绍基于故障的攻击概述。这样做的目的是能够访问引导加载程序，这将允许我们更改敏感参数，例如启动参数，我们可以定义自己的参数，告诉系统启动 UART 控制台并带有登录提示/ shell 或以单用户模式启动系统，绕过身份验证。

# 如何做...

1.  我们将在这里看一下的故障称为**NAND 故障**，在这种故障中，我们将把设备的 NAND 闪存的一个 I/O 引脚短接到 GND 引脚。请注意，这种短接必须在引导加载程序启动并内核即将启动的那一刻执行。

因此，如果短接成功，内核将无法启动，从而导致您陷入默认的引导加载程序提示，使您能够更改引导加载程序参数。

1.  举个例子，通过在启动参数中添加`single`，您将能够登录到单用户模式，从而绕过某些系统上的身份验证要求。这也在下面的屏幕截图中显示：

![](img/fc3295d7-d0ed-4124-ad13-1a57b0c43016.png)

图像来源：http://console-cowboys.blogspot.com/2013/01/swann-song-dvr-insecurity.html

1.  类似地，在 Wink Hub 上执行相同的 NAND 故障将导致陷入引导加载程序（由`Exploitee.rs`团队发现），您可以更改参数，如下面的屏幕截图所示：

![](img/36dc0849-e954-4ec8-816c-f2570c056ed4.png)

1.  修改引导参数后，您将能够在下一次引导时通过 UART 访问根 shell，如下面的屏幕截图所示：

![](img/e2c2773f-5ddc-47bb-aab9-dce2f3da4455.png)

图像来源：http://www.brettlischalk.com/assets/WinkHack/WinkRootShell.png

# 另请参阅

NAND 故障是利用故障攻击的技术之一。然而，您也可以使用电源和电压故障技术来执行诸如绕过加密等操作。

以下是一些其他有用的资源：

+   [`www2.cs.arizona.edu/~collberg/Teaching/466-566/2012/Resources/presentations/2012/topic1-final/report.pdf`](https://www2.cs.arizona.edu/~collberg/Teaching/466-566/2012/Resources/presentations/2012/topic1-final/report.pdf)

+   [`www.cl.cam.ac.uk/~sps32/ECRYPT2011_1.pdf`](https://www.cl.cam.ac.uk/~sps32/ECRYPT2011_1.pdf)

+   [`www.blackhat.com/docs/eu-15/materials/eu-15-Giller-Implementing-Electrical-Glitching-Attacks.pdf`](https://www.blackhat.com/docs/eu-15/materials/eu-15-Giller-Implementing-Electrical-Glitching-Attacks.pdf)

# JTAG 调试和利用

现在我们已经介绍了硬件设备上的各种利用技术，是时候介绍一种最重要的妥协设备的方法-JTAG 了。我们已经看到了 JTAG 是什么，JTAG 引脚通常是什么样子。

# 准备就绪

让我们开始识别给定目标设备上的 JTAG 引脚。为此，我们将使用 JTAGulator，这是由*Joe Grande*制作的硬件工具，用于识别 JTAG 引脚。

# 如何做到...

一旦您将所有 JTAGulator 通道连接到目标设备上预期的 JTAG 引脚，另外连接 GND 到 GND。

1.  使用以下代码启动屏幕：

```
sudo screen /dev/ttyUSB0 115200 
```

1.  然后，您将获得一个 JTAGulator 提示，如下面的屏幕截图所示：

![](img/d2dbcf43-e00d-454e-b5a9-f6420da6a08a.png)

1.  我们要做的第一件事是设置目标设备的电压，在当前情况下是 3.3。要做到这一点，只需在屏幕上输入`V`，然后输入`3.3`，如下面的屏幕截图所示：

![](img/bca14d5f-2b80-419d-b111-fb0a303d5508.png)

1.  设置目标电压后，我们可以通过按下*B*来运行一个旁路扫描，以找出当前连接中的 JTAG 引脚。

![](img/a8d393cf-f317-4ead-b8cb-a44647eb262c.png)

正如您所看到的，JTAGulator 能够识别 JTAG 引脚，并告诉我们各个引脚对应的是什么。

1.  现在我们已经确定了引脚布局，下一步是将引脚布局连接到 Attify Badge（或 FTDI C232HM MPSSE 电缆），如下所示：

1.  目标的 TDI 连接到 Attify Badge（或 FTDI 电缆的黄色）的 D1（TDI）

1.  目标的 TDO 连接到 Attify Badge（或 FTDI 电缆的绿色）的 D2（TDO）

1.  目标的 TMS 连接到 Attify Badge（或 FTDI 电缆的棕色）的 D3（TMS）

1.  目标的 TCK 连接到 Attify Badge（或 FTDI 电缆的橙色）的 D0（TCK）

1.  一旦您完成了所需的连接，下一步就是使用 Attify Badge（或 FTDI C232HM MPSSE 电缆）的配置文件以及目标设备的芯片运行 OpenOCD。配置文件可以在安装后从`OpenOCD`目录中获取，并位于`openocd/tcl/target`。

1.  OpenOCD 可以按照以下截图所示运行：

![](img/ba0145d1-6b71-450e-8049-bf31a89c68fc.png)

1.  正如您所看到的，OpenOCD 已经识别出链中的两个设备，并且还在端口`4444`上启用了 Telnet，我们现在可以连接到该端口，如下截图所示：

![](img/2dce679f-6465-47d2-b18d-15a826d1e49b.png)

在这一步，您可以执行各种 OpenOCD 命令，以及针对您的特定芯片的命令，以便妥协设备。

# 另请参阅

通过使用`mdw`命令从给定内存位置读取数据，您可以利用通过 JTAG 访问设备的能力做一些事情，如下所示：

![](img/b6c226f3-a33f-4f3d-b158-9c9fe9fb65cb.png)

另一个例子是通过连接到端口`3333`上运行的实例，使用我们在前几章学到的技能来连接到 GDB 以调试运行中的进程，并进行 ARM/MIPS 利用。
