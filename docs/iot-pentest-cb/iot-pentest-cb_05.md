# 利用物联网移动应用程序

在本章中，我们将介绍以下内容：

+   获取物联网移动应用程序

+   反编译 Android 应用程序

+   解密 iOS 应用程序

+   使用 MobSF 进行静态分析

+   使用 idb 分析 iOS 数据存储

+   分析 Android 数据存储

+   执行动态分析测试

在消费者和一些商业的物联网设备中，通常会配备一个移动应用程序来实现某种目的。例如，移动应用程序可能会向车队管理基础设施的服务器报告分析数据，或者该应用程序可能被授予委托控制启动汽车发动机。在每种情况下，数据很可能存储在移动应用程序中，并且可以被操纵以执行意外的操作。为了开始发现漏洞并逆向工程移动应用程序，可以将第三章中讨论的类似方法应用于移动空间。首先必须获取应用程序；之后，可以对应用程序进行静态分析、动态分析，并在适用的情况下重新打包。本章将帮助评估物联网移动应用程序，以便利用在该领域发现的常见漏洞。

# 介绍

在移动应用程序安全测试中，有一个四阶段的方法论，可以按以下方式分类：

+   **应用程序映射**：应用程序映射涉及应用程序的逻辑和业务功能。将应用程序映射视为收集有关应用程序的信息，以便在下一阶段使用。

+   **客户端攻击**：客户端攻击涉及存储在应用程序中的数据以及如何从客户端进行操纵。

+   **网络攻击**：网络攻击涉及网络层的问题，如 SSL/TLS 或 XMPP 协议数据。

+   **服务器攻击**：服务器攻击适用于 API 漏洞和后端服务器配置错误，这些问题是由 API 测试揭示的。

如果通过白盒或黑盒视角进行测试，这种方法可能会有所不同。从白盒和黑盒测试视角都相关的是**移动应用程序安全验证标准**（**MASVS**）。MASVS 旨在建立所需的安全要求框架，以设计、开发和测试 iOS 和 Android 移动应用程序（[`www.owasp.org/images/f/fe/MASVS_v0.9.3.pdf`](https://www.owasp.org/images/f/fe/MASVS_v0.9.3.pdf)）。此外，已经确定了影响 Android 和 iOS 应用程序的常见漏洞的趋势和模式，并将其转化为一个检查表，以配合 MASVS，测试人员和开发人员在评估应用程序时可以遵循该检查表（[`www.owasp.org/images/1/1b/Mobile_App_Security_Checklist_0.9.3.xlsx`](https://www.owasp.org/images/1/1b/Mobile_App_Security_Checklist_0.9.3.xlsx)）。该检查表还包含到 OWASP 的移动测试指南的链接，该指南仍在进行中，但已经处于成熟阶段。MASVS 和检查表指出了许多潜在的漏洞和缓解要求。物联网空间中一些最常见的漏洞包括：

+   硬编码的敏感值

+   冗长的日志记录

+   会话管理漏洞

+   敏感数据的缓存

+   不安全的数据存储

+   数据泄露

+   API 通信

这些常见的漏洞可能是由于应用程序的类型（原生或混合）而产生，但也可能是由于糟糕的编码实践引入的。在本章中，将演示许多常见漏洞在两个移动平台上的情况。虽然本书不涵盖这些方法和检查表，但在攻击物联网移动应用时，使用它们作为参考是个好主意。为了简单起见，我们将选择静态分析移动应用的路径，然后逐步向运行时动态分析移动应用。要开始，我们需要目标应用的二进制文件来开始测试物联网移动应用的过程。

虽然在本章中我们将更加强调静态和动态测试，但也有运行时分析测试，包括对目标应用进行插装和断点设置。

# 获取物联网移动应用

评估物联网设备的移动应用的第一步是获取并安装目标平台的应用。通常，如果物联网设备有一个安卓应用，也会有一个 iOS 应用。要安装安卓应用，使用 Google Play 商店，它也会分享有关应用的基本信息。对于 iOS 应用，使用苹果的 App Store 来安装应用到 iDevice。然而，原始应用程序二进制文件并不是公开的，也无法通过 Play 商店或 App Store 获得。应用程序二进制文件或包被称为安卓包或 APK，以及 iOS 的**iOS App Store Package Archive**（IPA）。如果你是从白盒的角度测试应用，这些二进制文件将会直接提供给你，无需探索获取应用程序二进制文件的方法。如果你是出于研究目的从黑盒的角度测试，你可能会想知道我们将如何获取应用程序二进制文件。

# 如何做...

在接下来的步骤中，我们将讨论获取安卓和 iOS 应用的方法。

1.  安卓有很多第三方应用商店可以用来下载 APK 文件。但是，在使用这些第三方应用商店时需要考虑一些注意事项。有时，应用商店没有更新的应用版本，或者根本就是错误的应用。在安装 Play 商店版本之前，验证应用的哈希值、版本和内容是很重要的。一些第三方应用商店声称有你要找的应用，但最终却被伪装成需要不必要权限的间谍软件应用。从第三方应用商店下载安卓应用的一个很酷的地方是能够下载应用的旧版本以及它们的历史发布说明。选择一个第三方应用商店，比如[`apps.evozi.com`](https://apps.evozi.com)和[`apkpure.com/`](https://apkpure.com/)，搜索目标安卓应用，并按照以下截图中的步骤下载 APK 文件：

![](img/2eb46de1-b127-4060-a5eb-c7ee9b29d7e3.png)

下一张截图显示了从[`app.evozi.com`](https://app.evozi.com)下载 Subaru 应用程序：

![](img/d730a5cd-9ca5-4bdc-b7a5-0c8cacca4bdd.png)

1.  对于 iOS 来说，从黑盒的角度获取 IPA 文件要困难得多。与安卓相比，没有类似的第三方应用商店可供选择。这是因为苹果的 FairPlay DRM 加密了 iOS 应用。没有必要的工具，这是一个挑战。在接下来的教程中，将介绍解密 iOS 应用的步骤。如果你专注于 iOS 测试，可以直接跳到*解密 iOS 应用*的教程。

# 反编译安卓应用

有了目标 IoT 应用程序和下载的 APK 文件，现在可以对应用程序进行反编译以查看其内容。对于 Android 应用程序，这个任务可以在几分钟内完成。稍后，将更详细地介绍静态分析应用程序的自动化测试技术。反编译应用程序是逆向工程应用程序以操纵其功能的第一步。应用程序也可以在修改后重新编译和打包，但这超出了我们的范围。

# 准备工作

要反编译 Android 应用程序，我们将使用 Enjarify 和 JD-GUI。Enjarify 将 Dalvik 字节码转换为 Java 字节码，然后使用 JD-GUI 进一步分析。JD-GUI 是一个用于查看 Java 代码的 Java 反编译器。这两个工具都包含在附带的虚拟机中：

+   Enjarify 可以通过 GitHub 存储库下载：[`github.com/google/enjarify`](https://github.com/google/enjarify)。

Enjarify 确实需要 Python 3 作为依赖项。

+   JD-GUI 可以通过 GitHub 存储库获得：[`github.com/java-decompiler/jd-gui/releases`](https://github.com/java-decompiler/jd-gui/releases)。

# 如何做...

1.  首先，输入 Enjarify 文件夹路径，并将 Enjarify 指向目标 APK。在这种情况下，APK 与 Enjarify 在同一个目录中：

```
$ bash enjarify.sh com.subaru.telematics.app.remote.apk 
Using python3 as Python interpreter
1000 classes processed
2000 classes processed
Output written to com.subaru.telematics.app.remote-enjarify.jar
2813 classes translated successfully, 0 classes had errors
```

1.  打开 JD-GUI 并拖动 Enjarify 创建的 JAR 文件：

![](img/2a53fc0b-6e22-4dbd-aa77-6655fd55895a.png)

1.  现在可以阅读和理解 Java 类，以进行进一步的分析。例如，可以搜索使用`rawQuery`保存数据到 SQLite 的实例，以便识别 SQL 注入，如下面的屏幕截图所示。其他关键字，如`*keys*`，`execSQL`或`*password*`，也是常见的搜索词：

![](img/c2fd41df-c00f-4543-aee4-9765bc6e1bc5.png)

1.  这种技术已经被用来定位硬编码的秘密，比如嵌入在**消费电子展**（**CES**）移动应用程序中的 iBeacons 值，用于寻宝比赛（[`www.ibeacon.com/the-beacons-at-ces-were-hacked/`](http://www.ibeacon.com/the-beacons-at-ces-were-hacked/)）：

![](img/f9625703-ddff-4420-9883-8de21bf07271.png)

1.  使用硬编码的信标发布在 CES 的移动应用程序中，每个人都可以玩，而不需要在拉斯维加斯。简单，对吧？拥有 Java 伪代码比阅读 smali/baksmali 代码要容易得多。如果应用程序使用了混淆形式，或者应用程序使用了 C/C++，情况可能并非总是如此，但这是特定于应用程序的。将获得对应用程序功能的额外理解，这可以通过运行时或动态分析进行测试和验证。

# 另请参阅

+   OWASP 的移动安全测试指南提供了有关反向工程 Android 应用程序和篡改技术的更多详细信息（[`github.com/OWASP/owasp-mstg/blob/master/Document/0x05b-Basic-Security_Testing.md`](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x05b-Basic-Security_Testing.md)和[`github.com/OWASP/owasp-mstg/blob/master/Document/0x05c-Reverse-Engineering-and-Tampering.md`](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x05c-Reverse-Engineering-and-Tampering.md)）。

# 解密 iOS 应用程序

由于 iOS 应用程序由苹果的 FairPlay DRM 加密，因此无法通过第三方应用商店下载未加密的版本。要查看 iOS 应用程序的内容，必须首先对其进行解密和提取。尽管可以直接从 iTunes 下载加密的 IPA 文件，但是使用 otool、lldb 和 dd 等工具手动解密应用程序是一个手动过程。幸运的是，使用一个名为 Clutch2 的工具已经自动化了这个过程。

Dumpdecrypted 是另一个工具，可以用来将解密的 iOS 应用程序转储到文件中，但本章不会使用。Dumpdecrypted 可以在存储库中找到：[`github.com/stefanesser/dumpdecrypted`](https://github.com/stefanesser/dumpdecrypted)。

# 准备工作

对于这个步骤，将使用 otool，它包含在 XCode 的命令行工具中。可以通过在 OS X 终端中执行以下命令来安装 XCode 命令行工具：

```
$ xcode-select -install

```

Clutch2 将用于解密应用程序。可以通过 GitHub 存储库[`github.com/KJCracks/Clutch`](https://github.com/KJCracks/Clutch)下载 Clutch2，也可以通过 Cydia 在越狱设备上安装 Clutch 2.0，方法是添加[`cydia.iphonecake.com`](http://cydia.iphonecake.com)作为源，并搜索 Clutch 2.0，如下屏幕截图所示：

![](img/ace9bd7b-8fdd-442d-baa2-5b1109a7f707.png)

# 如何做到这一点...

1.  要找出应用程序是否加密，必须将 IPA 文件重命名为 ZIP 文件，并且必须在重命名的提取文件夹内找到应用程序二进制文件。例如，对应用程序二进制文件运行以下命令，而不是对 IPA 文件运行，以检查应用程序是否加密。如果`cryptid`的值为`1`，则表示应用程序已加密：

```
$ mv MySubaru.ipa MySubaru.zip
$unzip MySubaru.zip
$cd Payload/MySubaru.app/
$ otool -l MySubaru | grep -A 4 cryptid
 cryptid 1
 cryptid 1

```

现在已经确定应用程序已加密。手动解密应用程序超出了范围，但是可以利用`Clutch2`自动化应用程序解密过程。运行`Clutch2`而不带任何参数时，将列出所有已安装的应用程序：

```
# Clutch2 
Installed apps:
1:   SUBARU STARLINK <com.subaru-global.infotainment.gen2>

```

1.  接下来，使用`-d`标志和选择数字来转储要解密的应用程序。在这种情况下，要解密和转储的应用程序是编号为一的应用程序：

```
# Clutch2 -d 1
Now dumping com.subaru-global.infotainment.gen2

DEBUG | ClutchBundle.m:-[ClutchBundle prepareForDump] [Line 30] | preparing for dump
<Redacted>
DUMP | <ARMDumper: 0x14695030> armv7 <STARLINK> ASLR slide: 0x4f000
Finished dumping binary <STARLINK> armv7 with result: 1
DONE: /private/var/mobile/Documents/Dumped/com.subaru-global.infotainment.gen2-iOS6.1-(Clutch-2.0 RC4).ipa
DEBUG | FinalizeDumpOperation.m:__30-[FinalizeDumpOperation start]_block_invoke_2 [Line 60] | ending the thread bye bye
Finished dumping com.subaru-global.infotainment.gen2 in 35.2 seconds
```

1.  应用程序现在已解密。使用`scp`将解密的应用程序从 iDevice 传输到主机计算机，方法如下：

```
# scp -v '/private/var/mobile/Documents/Dumped/com.subaru-global.infotainment.gen2-iOS6.1-(Clutch-2.0 RC4).ipa' Tester@<HostIPAddress>:~/ 
```

1.  将解密后的 IPA 文件重命名为 ZIP，类似于之前练习中用来验证应用程序是否加密的步骤：

```
$ mv com.subaru-global.infotainment.gen2-iOS6.1-\(Clutch-2.0\ RC4\).ipa com.subaru-global.infotainment.gen2-iOS6.1-\(Clutch-2.0\ RC4\).zip 
Unzip the folder and a new "Payload" directory will be created.  
$ unzip com.subaru-global.infotainment.gen2-iOS6.1-\(Clutch-2.0\ RC4\).zip 
```

1.  切换到`Payload/STARLINK.app`目录，该目录包含应用程序二进制文件：

```
$ cd Payload/STARLINK.app/ 
$ ls -lah STARLINK  
-rwxrwxrwx  1 Tester  staff    30M Jun  7 17:50 STARLINK 
```

1.  可以使用诸如 Hopper 之类的工具对应用程序二进制文件的内容进行反汇编以进行进一步分析。还可以使用`class-dump`转储类信息，并通过反汇编器进行进一步分析。例如，可以通过 Hopper 执行以下屏幕截图中所示的方式来检查应用程序的`saveCredentialsToKeychain`类中存储凭据的方式：

![](img/dd3a0aad-01a7-418b-bc91-63691a2c4483.png)

通过对应用程序的类和方法有额外的了解，可以通过动态或运行时分析来操纵和测试应用程序的功能。动态测试将在本章后面进行介绍。

# 另请参阅

+   OWASP 的移动安全测试指南提供了有关转储加密 iOS 应用程序的详细信息（[`github.com/OWASP/owasp-mstg/blob/master/Document/0x06b-Basic-Security-Testing.md`](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x06b-Basic-Security-Testing.md)）。

# 使用 MobSF 进行静态分析

鉴于已获取了 Android 和 iOS 的应用程序二进制文件，我们可以使用自动化技术进行进一步分析。一个非常好的开源 Python 工具，可以用于 Android 和 iOS 的是**移动安全框架**（**MobSF**）。MobSF 可以为我们自动化执行多项功能和能力，特别是对于 Android 应用程序。本步骤将演示 MobSF 对 Android 和 iOS 的自动静态分析功能。静态分析通常需要访问源代码，但是反编译 Android 和 iOS 应用程序可以为我们提供接近原始源代码的伪代码形式。

# 准备工作

MobSF 包含在附带的虚拟机中，版本为 0.9.5.2 beta。MobSF 不断更新，可以通过[`github.com/MobSF/Mobile-Security-Framework-MobSF`](https://github.com/MobSF/Mobile-Security-Framework-MobSF)下载。确保已安装 MobSF 文档中列出的所有依赖项。

确保已获取目标 APK 和解密的 iOS IPA 应用程序。MobSF 不会自动解密 iOS 应用程序。MobSF 需要解密的 IPA 文件来分析应用程序，而不是应用程序 Payload 中的解密二进制文件，当将 IPA 文件重命名为 ZIP 时，MobSF 会自动执行此步骤（MobSF 是开源的，可以修改为使用原始二进制文件而不是 IPA）。Clutch2 可以在 iOS 设备上使用`-d`标志转储 IPA 文件。

# 如何做...

1.  要启动 MobSF，请在终端中运行以下命令：

```
$ python manage.py runserver

```

1.  MobSF 的 Web-UI 应该出现在您的浏览器中，地址为`127.0.0.1:8000`，如下截图所示：

![](img/1b32c84f-ba07-4933-a4f9-43377b2b857d.png)

# Android 静态分析

1.  首先，我们将分析一个 Android 应用程序。将目标 APK 拖放到 MobSF 的 Web 界面上，MobSF 将自动反编译并分析应用程序的内容。在此界面中，列出了核心 Android 组件（活动、服务、接收器和提供者），以及有关应用程序的元数据。

MobSF 允许灵活使用不同的 Java 反编译器和 Dex 到 JAR 转换器。查看`MobSF/settings.py`配置文件，了解如何修改这些设置。

![](img/b7888a1a-ae09-4d1c-8b13-26ee0ba6e904.png)

1.  随着您向下滚动，MobSF 会分析应用程序权限、Android API 使用情况、可浏览的活动等许多其他静态分析功能，这些功能可能会有所帮助。我们将查看的区域，可能是最有帮助的，是代码分析子部分。在这里，MobSF 慷慨地标记了糟糕的编码实践以及潜在的易受攻击的代码片段：

![](img/0437d8b1-95f5-42c3-8f1d-05479667f732.png)

1.  其中一个最方便的部分是查找文件可能包含硬编码的敏感信息，如用户名、密码、密钥等。以下是 MobSF 标记的可能在应用程序中包含硬编码数据的 Java 类的示例：

![](img/28f49cae-7706-44ac-8f87-3c273e93a0ce.png)

1.  在移动应用程序中，很常见找到硬编码的 OAuth `client_secret`值和云提供商 API 帐户凭据。在本章的前面部分，已经给出了 CES 的硬编码 iBeacons 的类似示例。当选择其中一个标记的 Java 类时，将显示 Java 伪代码，其中演示了硬编码的值，如下截图所示：

2016 年，三星成为了在其 SmartThings 移动应用程序中硬编码他们的`client_secret`的受害者，使攻击者能够获得访问门锁的令牌。有关此事件的更多详细信息可以在以下论文中找到：

[`web.eecs.umich.edu/~earlence/assets/papers/smartthings_sp16.pdf`](https://web.eecs.umich.edu/~earlence/assets/papers/smartthings_sp16.pdf)。

![](img/8d8def19-06a8-4471-aaf5-3f040d48f0aa.png)

1.  使用 MobSF，测试 Android 应用程序变得轻而易举。另一方面，iOS 应用程序并不像 MobSF 提供的 Android 静态分析那样简单明了。

# iOS 静态分析

1.  MobSF 确实提供了有关 iOS 应用程序的静态分析的有用功能。与 Android 一样，解密后的 iOS IPA 可以拖放到 MobSF 的 Web 界面上。然后，MobSF 将 IPA 重命名为 ZIP，提取内容，分析 plist 文件，检查应用程序请求的权限，并从应用程序中转储类信息，等等。下面的截图显示了一旦解密的 iOS IPA 被拖放到 MobSF 后的着陆页面。MobSF 提供了三个主要选项，包括查看`Info.plist`、字符串和类转储：

![](img/5eb678a5-2323-450f-89d6-3d801f6ca1a8.png)

确保您在 MobSF 的设置文件`MobSF/settings.py`中调整`class-dump-z`路径，并查找`CLASSDUMPZ_BINARY`。在我的情况下，`class-dump-z`的路径是`/opt/iOSOpenDev/bin/class-dump-z`，但是使用常规的`class-dump`也应该可以，以及`/opt/iOSOpenDev/bin/class-dump`。

1.  您将要查看的第一个地方是`Info.plist`文件。`Info.plist`文件包含有关应用程序的基本信息，例如权限、IPC URL 方案和 MobSF 在其界面中提取的应用程序传输安全设置。以下截图显示了 MobSF 中的`Info.plist`文件：

![](img/08df2252-fa06-40dc-aff0-fc0d95bf9a22.png)

1.  接下来，选择字符串按钮，显示二进制中的字符串，如下截图所示：

![](img/e5fed86c-20d0-4f43-b7b0-90105c8d3fd5.png)

1.  请注意，有一个 CONSUMERSECRET 作为字符串，这也在 Android 应用程序中发现。通常，如果应用程序的一个版本包含硬编码值，另一个版本可能也包含。我们将在一会儿验证这一点，在查看 MobSF 为我们转储的类信息之后。单击“查看类转储”以列出应用程序的类详细信息。如果您已正确设置了类转储二进制设置，应该会打开一个单独的选项卡并显示类，如下截图所示：

![](img/d494ad51-aa46-4a96-afa4-5b8cdb7cc824.png)

1.  有了可用的类细节，我们可以确定要分析的应用程序中的功能。例如，我们可以在类似 Hopper 的反汇编器中搜索要分析的类中的密码字符串。以下截图显示了正在使用的类`addBasicAuthenticationHeaderWithUsername`：

![](img/cc6d3c21-8cfb-4089-9b3d-4cc3219f1c6c.png)

1.  `addBasicAuthenticationHeaderWithUsername`可以在 Hopper 中进一步分析，查看其伪代码如下。只需在字符串选项卡中搜索类`addBasicAuthenticationHeaderWithUsername`以查看其内容：

![](img/c5317fd1-ab95-4ed5-9b1d-11fc19f824c9.png)

查看字符串选项卡中的类内容

1.  由于我们在 Hopper 中并且已经在之前的步骤中找到了 CONSUMERSECRET，我们可以搜索此字符串以检查它是否也在 iOS 应用程序中硬编码。以下是显示与 Android 应用程序相同的硬编码值的截图。其中一个硬编码的秘密值以 c4d5 结尾，在截图中被突出显示：

![](img/3ac75df2-1dfb-4481-8853-49a68f5d336c.png)

硬编码的秘密值

1.  在定位应用程序中这些硬编码值时，常见的下一步测试是通过动态分析验证它们的影响。动态分析测试将在本章后面进行介绍。

# 还有更多...

在本节中，我们涵盖了 Android 和 iOS 应用的静态分析。我们没有涵盖运行时分析测试，这需要在应用执行期间挂钩应用程序类和函数。根据您愿意在测试移动应用上花费多少时间和精力，这可能并不总是在您的范围之内。运行时分析非常适用于验证客户端安全控件，例如绕过 PIN 码锁定屏幕或暴力破解登录。OWASP 测试指南提供了 Android 和 iOS 的运行时分析技术的详细信息。访问以下链接获取更多信息：

+   **Android**: [`github.com/OWASP/owasp-mstg/blob/master/Document/0x05c-Reverse-Engineering-and-Tampering.md`](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x05c-Reverse-Engineering-and-Tampering.md)

+   **iOS**: [`github.com/OWASP/owasp-mstg/blob/master/Document/0x06c-Reverse-Engineering-and-Tampering.md`](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x06c-Reverse-Engineering-and-Tampering.md)

# 使用 idb 分析 iOS 数据存储

不幸的是，iOS 开发人员倾向于忽略苹果提供的数据存储 API 控制。这导致数据通过明文数据库（包括 realm DBs）、plist 文件（属性列表）、缓存、键盘和其他存储位置泄漏。有时，应用程序使用的混合框架会鼓励这种行为以提高应用程序性能，但未列出安全后果。根据混合框架和自定义模块的不同，可能需要插件来清除缓存等位置，这增加了开发人员的复杂性。本节将帮助您分析 IoT iOS 应用程序的数据存储。

# 准备工作

对于这个示例，需要一个已经越狱的 iDevice，以及一个名为 idb 的免费工具。Idb 是一个在 OS X 上运行的免费工具，Ubuntu 用于简化常见的 iOS 应用程序安全评估任务。它目前已安装在附带的虚拟机中，但也可以通过访问 idb 的网页[`www.idbtool.com/`](http://www.idbtool.com/)手动安装。如果您使用**gem**来管理 Ruby，可以使用`gem install idb`来安装 idb。

在撰写本文时，idb 不支持 iOS 10 应用程序。

要查看 SQLite 数据库条目，请下载并安装 sqlitebrowser，网址为[`sqlitebrowser.org`](http://sqlitebrowser.org)。SQLite 浏览器也已包含在为本书提供的虚拟机中。

# 如何操作...

1.  从终端启动 idb，只需执行`idb`，用户界面将出现：

![](img/e892dd5c-2e9c-4caf-a668-54d0fea38072.png)

1.  接下来，选择连接到 USB/SSH 设备：

![](img/46387dad-6125-4d60-8c77-2815f950d044.png)

1.  如果这是您第一次使用 idb，那么需要在越狱设备上安装几个软件包，如果 idb 可以通过 USB 或 SSH 访问设备，它将自行安装这些软件包。这些软件包列在以下屏幕截图中。

越狱 iDevices 的默认用户名和密码是 alpine。

![](img/825424a3-190e-4933-83f0-a090d178671f.png)

1.  如果所有所需的软件包都已安装，请从应用程序选择菜单中选择一个应用程序。在这种情况下，选择了 com.skybell.doorbell：

![](img/ed716c17-98c5-4abf-a59c-fe286ec911d6.png)

1.  选择了 SkyBell 应用程序后，我们现在可以专注于应用程序内容以及应用程序如何存储数据。有几个功能可用于自动化 iOS 应用程序评估任务，但是在本演示中将分析存储。要分析应用程序的数据存储，请选择 Storage 选项卡，选择 plists 选项卡，然后按刷新按钮：

![](img/181efd97-80c8-4cd7-8fdf-2c64fa1acea6.png)

1.  有许多文件出现，但很多对我们的目的不相关。最初要考虑分析的文件是应用程序包目录中的`Info.plist`文件，以及应用程序在运行时创建的任何偏好文件。在这种情况下，偏好文件被列为 com.skybell.doorbell.plist。我们想要在清晰的 plist 文件中寻找的是关于公司本身或用户的任何个人或敏感数据。如果我们双击打开偏好文件，我们将看到存储在未受保护存储中的 OAuth`access_tokens`和`refresh_tokens`（CVE-2017-6082）。这些明文令牌可以在以下屏幕截图中看到。通常，`access_tokens`持久存在以提高用户体验，这样每次打开应用程序时都不需要登录：

![](img/e3f324dc-7fc1-46c5-afd7-08fe75d98b68.png)

1.  当会话令牌以明文形式存在时，数据很可能没有在多个区域安全存储。在磁盘上寻找存储的敏感数据的常见区域是应用程序启动时在应用程序的`data`目录中生成的任何类型的数据库或文件。Idb 有能力分析这些区域。我们将查看 Cache.db 选项卡，看看我们找到了什么。

导航到 Cache.dbs 选项卡，选择刷新按钮，并双击打开 Cache.db 条目：

![](img/34802275-4b2c-4b57-8d6a-5e5bdee0c3d4.png)

1.  如下截图所示，此 SQLite 数据库中有许多表：

![](img/db223886-7e3f-4934-bdc7-1b2d3036488a.png)

1.  这些表包含可以视为文本的 BLOB 数据。事实证明，该应用程序缓存了所有请求和响应，其中包括个人详细信息和令牌数据（CVE-2017-6084）：

![](img/f1823557-28d2-4ffe-a4de-b17e369bcf8c.png)

可以通过指定编辑器路径来利用自定义 SQLite 外部编辑器，例如通过 idb 的设置（例如，`~/.idb/settings.yml`）。

攻击者可以在启用了自动备份设置的情况下，将受害者的手机插入 iTunes，从而窃取这些数据。攻击者需要插入一个测试 iDevice 并将其恢复到受害者的备份。另一种技术是使用诸如 iFunbox 之类的工具，该工具可以访问非越狱设备的文件系统（[`www.i-funbox.com/`](http://www.i-funbox.com/)）。在这一点上，攻击者可以外部传输应用的`Cache.db`，plist 和 SQLite 数据库，以获取会话令牌和其他个人账户信息的访问权限。在这种情况下，攻击者可以查看视频门铃的视频源，并通过调整运动设置或将视频源共享到外部账户来更改其配置。

有了这些知识，可以在不代理连接的情况下查看会话管理控件和 API 数据。可以根据前述的移动应用程序安全检查表来分析会话过期和随机化测试。可以修改`plist`文件或`Cache.db`中的数据，并将其上传回设备，以观察应用程序与这些文件的信任关系。

# 还有更多...

还可以分析其他未在本节中涵盖的数据存储位置。未讨论的项目包括钥匙链、本地存储、领域数据库、日志、BinaryCookies 等许多其他存储位置。请查看 OWASP 的移动安全测试指南，了解有关在 iOS 应用程序中测试数据存储弱点的技术的更多详细信息：[`github.com/OWASP/owasp-mstg/blob/master/Document/0x06d-Testing-Data-Storage.md`](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x06d-Testing-Data-Storage.md)。

# 另请参阅

+   要了解有关 idb 功能的更多信息，请查看 idb 提供的文档 [`www.idbtool.com/documentation/`](http://www.idbtool.com/documentation/)。

# 分析 Android 数据存储

在运行时，有几种测试 Android 数据存储的方法。提供了免费和商业的 Android 测试发行版，以帮助自动查看和修改常见的数据存储文件位置。在手动方法中，我们希望在应用程序运行时分析以下常见的存储位置：

+   `/data/data/<package_name>/`

+   `/data/data/<package_name>/databases`

+   `/data/data/<package_name>/shared_prefs`

+   `/data/data<package_name>/files/<dbfilename>.realm`

+   需要一个 Realm 浏览器（[`itunes.apple.com/us/app/realm-browser/id1007457278?`](https://itunes.apple.com/us/app/realm-browser/id1007457278?)）

+   `/data/data/<package name>/app_webview/`

+   Cookies

+   本地存储

+   Web 数据

+   `/sdcard/Android/data/<package_name>`

在 Android 中，应用程序的文件结构不会改变，这使得手动分析更加容易。这个步骤将帮助您分析 IoT Android 应用程序的数据存储。

# 准备就绪

此步骤需要以下物品：

+   一个已 root 的 Android 设备（启用了 USB 调试）或一个已 root 的 Android 模拟器。

+   **Android 调试桥**（**ADB**）：ADB 可在附带的虚拟机中使用，也可以通过 URL [`developer.android.com/studio/releases/platform-tools.html`](https://developer.android.com/studio/releases/platform-tools.html) 手动安装。

# 如何做...

1.  确保使用以下命令连接了测试 Android 设备或模拟器：

```
# adb devices
List of devices attached 
0a84ca7c device

```

1.  连接到测试 Android 设备的控制台，并使用以下 ADB 命令切换到 root 用户：

```
# adb shell
shell@flo:/ $ su
root@flo:/ #
```

1.  更改目标应用程序的目录如下：

```
# cd data/data/com.skybell.app/
# ls -al
    drwxrwx--x u0_a92   u0_a92            2017-06-23 14:59 app_7122720ab47b4f6c8ad99ba61f521dd2515d6767-01b7-49e5-8273-c8d11b0f331d
    drwxrwx--x u0_a92   u0_a92            2017-01-30 18:46 cache
    drwxrwx--x u0_a92   u0_a92            2017-01-17 16:41 files
    lrwxrwxrwx install  install           2017-06-23 14:58 lib -> /data/app/com.skybell.app-1/lib/arm
    drwxrwx--x u0_a92   u0_a92            2017-01-17 16:41 no_backup
    drwxrwx--x u0_a92   u0_a92            2017-06-23 15:31 shared_prefs

```

1.  首先，浏览到`shared_prefs`目录，列出每个文件，并查看可用的首选项文件，如下面的屏幕截图所示：

![](img/8f2bec1c-8ba3-4d5c-b0a5-e18fb387ce90.png)

似乎存在特殊的编码；应用程序正在运行字符串，这些字符串可能与登录凭据有关，但它确实显示了帐户的用户名。

1.  接下来，我们将检查`com.skybell.app.networking.oauth.oauth_shared_preferences_key.xml`文件，如下面的屏幕截图所示：

![](img/8b771c3f-4d52-4278-a78f-0f5560af21bc.png)

1.  我们的帐户 OAuth 令牌似乎以明文存储，类似于我们在 iOS 应用程序中看到的情况。有一个可用的`files`目录，其中可能有可以查看的 Realm 数据库文件。更改到`files`目录并列出文件，如下面的屏幕截图所示：

![](img/7773cad1-5c5c-4cd3-a32c-b27ea8c65f40.png)

1.  应用程序似乎使用了一个 Realm 数据库。注意 Realm 数据库所在的目录，并使用以下`adb`命令将文件拉到您的主机计算机：

```
adb pull data/data/com.skybell.app/files/default.realm /path/to/store/realdb

```

在撰写本文时，Realm 数据库只能在使用 App Store 中提供的 Real Browser 的 OS X 计算机上查看。有非官方的 Real Browser 适用于 Android 和 iOS，需要从源代码构建。有关 Realm 数据库的更多详细信息，请访问[`news.realm.io/news/realm-browser-tutorial/`](http://news.realm.io/news/realm-browser-tutorial/)。

1.  双击`default.realm`文件，将在 Real Browser 中打开 Realm 数据库，如下面的屏幕截图所示：

![](img/3241e3d0-e5dd-4aca-a55f-436d179d16b1.png)

DeviceRecord 模型说明了门铃的名称和状态，即在线或离线，而 DeviceRecordActivity 模型列出了事件、它们的时间戳和事件的缩略图。这是一种数据泄露，可以通过将 Android 设备备份到计算机并像 iPhone 一样还原，或者通过启用 ADB 后以与通过 ADB 相同的方式提取数据。不幸的是，此应用程序在`AndroidManifest.xml`中没有标记`[android:allowBackup=false]`，这本来可以减轻这个特定问题，但在这种情况下，存储会使客户面临风险或涉及隐私问题，这仍然是不良做法。

# 另请参阅

+   请查看 OWASP 的移动安全测试指南，了解有关测试 Android 应用程序中数据存储弱点的技术的更多详细信息：[`github.com/OWASP/owasp-mstg/blob/master/Document/0x05d-Testing-Data-Storage.md`](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x05d-Testing-Data-Storage.md)。

# 执行动态分析测试

在这个阶段，我们已经静态分析并评估了示例 IoT 移动应用程序中数据的存储方式。我们还没有查看应用程序和服务器之间发送的 API 流量。在运行时查看和篡改应用程序通信被称为**动态分析**。动态分析测试侧重于评估应用程序在执行过程中的情况。动态分析既在移动平台层进行，也针对移动应用程序的后端服务和 API 进行，其中可以分析请求和响应。在本示例中，我们将为 iOS 设置动态分析测试环境，并为您介绍一些测试用例。

# 做好准备

对于此示例，将使用 Burp Suite 和/或 OWASP ZAP 来观察应用程序通信。还需要访问 iDevice 和 Android 设备来执行此示例。iDevice 和 Android 设备不必经过越狱或 root，这是查看应用程序通信的好方法。尽管这些步骤适用于两种移动平台，但本示例中的示例仅适用于 iOS。

# 如何做...

1.  与配置 Web 应用程序测试环境类似，需要在您的越狱设备上安装 ZAP 和 Burp Suite 的 CA 证书以代理`HTTPS`请求。这可以通过调整移动设备的 Wi-Fi 代理设置来实现，以指向您的 Burp Suite 侦听器的 IP 和端口，如以下截图所示：

![](img/364d88e0-e9af-471c-b9e7-1a11bc332c70.png)

以下截图显示了如何配置 iOS 设备的代理设置，以指向您的 Burp 代理侦听器。在这种情况下，我的 Burp 代理正在监听 IP 地址`192.168.2.183`和端口`8080`：

![](img/76abc6a0-33f7-419c-8429-80f31bc76dd8.png)

1.  接下来，通过导航到 Burp 的 IP 和端口，并使用`/cert`作为 URL 路径，将 Burp 的 CA 证书添加到设备。在这种情况下，Burp 的地址是`http://192.168.2.183:8080/cert`，如下图所示：

![](img/e04fb789-ca33-4229-b092-722e8a43993e.png)

1.  执行后，iOS 将询问您是否要安装 Burp 的 CA 证书配置文件，如下图所示。选择安装，`HTTPS`流量现在可以由 Burp Suite 分析。

![](img/22528c5a-ea59-4d64-99f0-e5fca8a637a0.png)

以下截图显示了从我们的移动设备通过 Burp 套件代理的`HTTPS`请求。

![](img/447e7e83-93aa-4351-b4ca-c5e9fdd5b778.png)

通过 Burp 套件代理的 HTTPS 请求

1.  类似的步骤也可以用于 Android 设备。我们将演示如何设置 ZAP 的 CA 证书。首先，通过导航到工具|选项|动态 SSL 证书来导出 ZAP 的证书。将证书保存在方便的位置，以便传输到 Android 设备：

![](img/7b4d937b-ea2e-4abf-96cd-cab8cbbd01e9.png)

1.  `ZAPCert`需要下载到 Android 设备上。有几种方法可以帮助满足此要求。一个快速方便的文件传输技巧是使用 Python 的`SimpleHTTPServer`。如果您使用的是基于 Nix 的操作系统，请从证书所在的目录运行以下命令：

```
$ python -m SimpleHTTPServer 1111
```

1.  Python web 服务器现在将在端口`1111`上运行。在您的 Android 设备上，打开浏览器并导航到您的监听 Web 服务器。在这种情况下，地址是`http://192.168.2.186:1111`，如下图所示：

![](img/765aa81c-0620-4a2a-bee6-86f718f7f53e.png)

1.  将证书下载到 Android 设备。在 Android 设备上，导航到设置|安全|从存储安装，然后下载文件夹应该出现，如下图所示：

![](img/ab5204a9-abe8-4053-b931-7209b075b804.png)

1.  选择 ZAP 的证书，并按照以下截图中所示命名证书：

![](img/7de4d427-54e3-4e62-8a4a-45f609d3182e.png)

1.  转到您的无线设置，并修改代理设置以匹配您的 ZAP 代理侦听器：

![](img/900ce53b-7395-4648-86c5-ab9bfca16c0b.png)

1.  导航到目标 IoT 移动应用程序，并观察`HTTPS`请求和响应填充 ZAP 的历史选项卡：

![](img/22118096-fa90-4f4b-9ff3-e8ec2cb7f068.png)

1.  Android 和 iDevice 都已设置为代理应用程序的请求和响应。通过这种访问，可以对参数进行模糊处理以进行注入漏洞测试（如果已经获得授权），并且可以测试应用程序的业务逻辑漏洞。例如，在查看来自我们目标门铃的视频时代理请求和响应，我们注意到`access_token`作为`GET`请求中的 URL 参数发送到视频的 MP4 文件（CVE-2017-6085）。将此`GET`请求复制到剪贴板并粘贴到浏览器中，即可访问下载 MP4 视频，无需用户名或密码，如下图所示：

![](img/781c9f74-c2e0-4171-bb21-c18aa0b1e266.png)

无需用户名或密码即可下载 MP4 视频

1.  然后将请求复制到我们的剪贴板：

![](img/4ffcdef1-0033-4793-924c-ecb50e821ebf.png)

1.  将 URL 粘贴到浏览器中，并观察视频门铃事件的自动下载到您的本地计算机：

![](img/b7822852-d7b4-43fd-8d40-54cb243ce21d.png)

一旦在浏览器中请求复制的 URL，浏览器应自动询问在本地计算机上保存下载视频的位置：

![](img/af1ad43b-205a-417a-b162-b10d2d974443.png)

现在视频已经以`.mp4`的格式下载，并且可以像以下截图中所示查看：

![](img/4c6763e7-c6c6-4fe7-b938-db8e0782430e.png)

1.  请记住，我们没有输入任何用户名或密码来下载和观看这个视频。这表明门铃制造商对用户的访问控制存在问题，并且可能还表明产品中存在其他漏洞。对于视频门铃来说，在没有凭据的情况下访问视频源存在安全和隐私风险。仅在这一发现中就可以识别出几个漏洞，包括将会话令牌作为`GET`请求发送、令牌过期不足以及访问控制不足。攻击者可以通过社会工程或 MITM 技术获取必要的`access_token`。可以通过外部用户帐户执行额外的访问控制测试用例以跟进此发现。

# 另请参阅

+   对于一些 Android 应用程序，MobSF 具有在模拟器、虚拟机甚至物理设备内执行动态测试的能力。对于 Android 应用程序的动态测试还包括测试意图和活动。MobSF 的维基中列出了一些注意事项（[`github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/2.-Configure-MobSF-Dynamic-Analysis-Environment-in-your-Android-Device-or-VM`](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/2.-Configure-MobSF-Dynamic-Analysis-Environment-in-your-Android-Device-or-VM)）。如果您正在测试的应用程序需要访问硬件，比如相机或无线协议（即蓝牙、ZigBee 或 Z-Wave），建议您使用物理设备并进行手动测试。

+   要了解有关 Android 和 iOS 应用程序安全测试的更多信息，请访问 OWASP 的移动安全测试指南：[`github.com/OWASP/owasp-mstg/`](https://github.com/OWASP/owasp-mstg/)。
