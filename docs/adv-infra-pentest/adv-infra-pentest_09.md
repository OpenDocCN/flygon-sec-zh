# 第九章：VoIP 利用

**IP 电话**（**VoIP**）正在将商业通信推向新的效率和生产力水平。基于 VoIP 的系统每天都面临安全风险。尽管许多公司都在关注 VoIP 的服务质量，但他们忽视了 VoIP 基础设施的安全方面，使其容易受到危险攻击。本章将使用逐步指导解决大多数 VoIP 安全问题。

在本章中，我们将涵盖以下主题：

+   VoIP 协议

+   VoIP 攻击

+   VoLTE 攻击

+   如何防御 VoIP 攻击

# VoIP 基础知识

为了学习如何对 VoIP 进行渗透测试，我们需要清楚地了解 VoIP 基础设施的实际运作方式。我们将剖析 VoIP 协议，以便后来学习如何攻击 VoIP 系统。以下各小节是一些使语音和视频通信成为可能的知名标准。让我们逐一探讨它们。

# H.323

H.323 是由**国际电信联盟标准化部门**（**ITU-T**）引入的 IP 标准。正如你所看到的，这个标准化机构使用字母来定义基于许多标准的范围，列在这里：

+   **H**：用于音频视觉和多媒体系统

+   **G**：用于传输系统和媒体

+   **Q**：用于交换和信令

+   **T**：用于远程服务的终端

H.323 是最古老的基于数据包的通信系统协议之一。因此，这个协议是稳定的。当前版本是 v6。它被许多供应商在许多产品中广泛使用，如思科呼叫管理器、NetMeeting 和 RadVision。

H.323 使用许多类型的设备：

+   **终端：**这些是用户设备，如 IP 电话和视频会议系统。

+   **多点控制单元：**由两个逻辑组件组成——**多点控制器**（**MC**）和**多点处理器**（**MP**）。它们的作用是管理多点会议。

+   **网关控制器：**这是可选的。网关控制器提供一些额外的服务，如用户认证和地址解析。

H.323 堆栈基于以下组件：

+   IPv4 网络层

+   用户数据报协议层

+   实时协议

+   信令协议

+   呼叫前设置

+   视频编解码器

+   音频编解码器

+   数据

以下图表说明了 H.323 堆栈的不同组件：

![](img/00273.jpeg)

# Skinny 呼叫控制协议

**Skinny 呼叫控制协议**（**SCCP**），由 Selsius 开发，是思科专有的协议。它被称为 skinny 是因为它是一种轻量级协议，用于 IP 电话和呼叫管理器的通信。这种通信使用以下不同类型的消息：

+   **0001**：`RegisterMessage`

+   **0002**：`IPportMessage`

+   **0081**：`RegisterAckMessage`

这些消息遵循以下格式：

![](img/00274.jpeg)

以下截图是从使用 Wireshark 的 Skinny 捕获中获取的，从 Wireshark 网站下载：

![](img/00275.jpeg)

# RTP/RTCP

**实时协议**（**RTP**）是一种传输协议，特别是基于 RFC 3550 的**UDP**。它用于实时多媒体应用程序和端到端实时数据流传输。为了实现这一点，例如，视频经历了许多步骤：

1.  编码

1.  封包

1.  传输控制

1.  重组

1.  解码

![](img/00276.jpeg)

尽管 RTP 被指定用于传输媒体流，但还有另一个与 RTP 一起工作的协议，称为**实时控制协议**（**RTCP**）。这个协议与 RTP 并行工作，监视传输并确保**服务质量**（**QoS**）。RTCP 的目的是检查在过程中是否有数据包丢失。

# 安全实时传输协议

**安全实时传输协议（SRTP）**是基于 RFC3711 的应用协议。SRTP 提供了增强的安全功能；因此，它通过使用密钥流进行异或运算来加密 RTP 从而保护 RTP。所使用的算法是 AES，主密钥称为 SRTP MKI。下图说明了普通 RTP 包和安全 RTP 包之间的区别。Auth 字段包含消息认证码。这些技术提供了反重放机制来保证语音流量的完整性：

![](img/00277.jpeg)

# H.248 和媒体网关控制协议

**媒体网关控制协议**（**MGCP**）是由思科开发的协议。MGCP 的目标是处理信号和会话管理。它是媒体网关控制器和媒体网关之间的通信机制。因此，控制是集中的。换句话说，控制器与许多媒体网关进行通信。控制器还监督终端并在其区域注册新终端。H.248 也像 H.323 一样，是一个基于 ITU 的协议。它是 MGCP 的增强版本。正如你在图表中看到的，MGCP 是一种主从协议：

![](img/00278.jpeg)

# 会话初始协议

**会话初始协议**（**SIP**）是基于 RFC 3261 协议的会话管理协议。它可以在 **UDP** 和 **TCP** 上运行，也支持 **TLS**。它比 H323 更具可扩展性。SIP 在以下五个步骤中处理呼叫：

1.  用户位置

1.  用户可用性

1.  用户能力

1.  会话建立

1.  会话管理

要开始 SIP 操作，用户需要进行注册：

![](img/00279.jpeg)

以下图表描述了建立两个用户代理客户端之间连接所需的步骤：

![](img/00280.jpeg)

SIP 请求类似于 HTTP 请求。它们的格式如下：

`METHOD URI SIP/X.X`

`头部: XXX`

这里，方法是请求类型，我们有以下六种方法：

+   注册

+   邀请

+   ACK

+   取消

+   选项

+   再见

SIP 回复请求需要以下格式：

`SIP/X.X  <状态代码> 描述`

`头部: XXX`

+   **URI**: 文件标识

+   **SIP/X.X**: SIP 版本

+   **头部**: 这包含了有关接收者的信息（To, From, Call-ID 是一些 SIP 头部字段）

以下是可能的状态代码：

+   `1xx`: 信息

+   `2xx`: 成功

+   `3xx`: 重定向

+   `4xx`: 失败

+   `5xx`: 服务器错误

+   `6xx`: 全局失败

# VoIP 开发

现在，在对 VoIP 中发挥重要作用的主要协议有了清晰的理解之后，是时候学习如何渗透 VoIP 基础设施了。与任何其他渗透测试一样，要利用 VoIP 基础设施，我们需要按照一系列步骤进行战略性操作。

在攻击任何基础设施之前，我们已经了解到我们需要在利用之前进行足迹、扫描和枚举，这正是我们将要对 VoIP 进行的操作。为了进行 VoIP 信息收集，我们需要尽可能收集有关目标的有用信息。首先，你可以在网上进行简单的搜索。例如，招聘公告可能是一个有价值的信息来源。例如，以下工作描述让攻击者对 VoIP 有了一个大致的了解：

![](img/00281.jpeg)

之后，攻击者可以搜索可能存在的漏洞来尝试利用特定系统。搜索电话号码也可能是一个明智的举措，以了解目标的语音信箱，因为每个供应商都有一个默认的语音信箱。如果管理员没有更改它，收听语音信箱可以让你了解目标。如果你想查看一些默认语音信箱，请查看 [`www.hackingvoip.com/voicemail.html`](http://www.hackingvoip.com/voicemail.html)。这是一个学习 VoIP 黑客攻击的绝佳资源。

谷歌黑客是一种搜索信息和在线门户的神奇技术。我们在前几章中讨论了使用 Dorks 进行谷歌黑客。以下演示是这个谷歌 Dork 的输出——在 URL 中：网络配置 Cisco：

![](img/00282.jpeg)

你可以使用 `Shodan.io` 搜索引擎找到连接的 VoIP 设备：

![](img/00283.jpeg)

VoIP 设备通常连接到互联网。因此，它们可以被外部人员访问。它们可以通过其 Web 界面暴露出来；这就是为什么有时候留下安装文件暴露出来可能是危险的，因为使用搜索引擎可能会导致对门户进行索引。以下截图是从在线 Asterisk 管理门户获取的：

![](img/00284.gif)

这个截图是从一个暴露的网站的配置页面获取的，使用一个简单的搜索引擎查询：

![](img/00285.jpeg)

从攻击者的角度收集有关目标的有价值信息后，我们通常应该执行扫描。在这个阶段进行扫描是必要的，使用前几章讨论的扫描技术。进行主机发现和 Nmap 扫描是扫描基础设施以搜索 VoIP 设备的好方法。

扫描可以带领我们发现 VoIP 服务。例如，我们在 Nmap 中看到了`-sV`选项来检查服务。在 VoIP 中，如果端口`2000`是开放的，那么它是 Cisco CallManager，因为 SCCP 协议使用该端口作为默认端口，或者如果有一个 UDP`5060`端口，那么它是 SIP。

`-O` Nmap 选项对于识别正在运行的操作系统可能是有用的，因为有很多 VoIP 设备正在运行特定的操作系统，比如 Cisco 嵌入式系统。

现在你知道该怎么做了。在足迹和扫描之后，我们需要枚举目标。正如你所看到的，当利用基础设施时，我们通常遵循相同的方法论步骤。

横幅抓取是枚举中众所周知的技术，枚举 VoIP 基础设施的第一步是开始横幅抓取。为了做到这一点，使用 Netcat 实用程序将有助于您轻松地抓取横幅，或者您可以简单地使用名为横幅的 Nmap 脚本：

```
nmap -sV --script=banner <target>
```

![](img/00286.jpeg)

对于特定的供应商，有很多枚举工具可以使用；EnumIAX 就是其中之一。它是 Kali Linux 中的一个内置枚举工具，用于暴力破解 Inter-Asterisk Exchange 协议的用户名：

![](img/00287.jpeg)

**自动企业枚举器**（**ACE**）是 Kali Linux 中的另一个内置枚举工具：

![](img/00288.jpeg)

`svmap` 是 Kali Linux 中的一个内置工具，用于识别 SIP 设备。输入 `svmap -h`，你将得到这个神奇工具的所有可用选项：

![](img/00289.jpeg)

# VoIP 攻击

到目前为止，你已经学会了执行 VoIP 足迹、扫描和枚举所需的技能。让我们来发现主要的 VoIP 攻击。VoIP 面临来自不同攻击向量的多重威胁。

# 拒绝服务

**拒绝服务**（**DoS**）是对网络可用性的威胁。这种攻击在前几章中已经讨论过。对于 VoIP 来说，DoS 也可能是危险的，因为确保通话的可用性对现代组织至关重要。现在不仅是可用性，通话的清晰度也是当今的必需品。为了监控 VoIP 的 QoS，你可以使用许多工具；其中之一是 CiscoWorks QoS Policy Manager 4.1：

![](img/00290.jpeg)

为了衡量 VoIP 的质量，有一些评分系统，比如**平均意见分**（**MOS**）或基于几个参数（抖动、延迟和丢包）的 R 值。平均意见分的分数范围从 1 到 5（差到非常清晰），R 值的分数范围从 1 到 100（差到非常清晰）。以下截图是从 Wireshark 网站下载的 RTP 数据包分析中获取的：

![](img/00291.jpeg)

你还可以分析 RTP 抖动图：

![](img/00292.jpeg)

VoIP 基础设施可以受到经典的 DoS 攻击。我们之前看到了其中一些：

+   Smurf 洪水攻击

+   TCP SYN 洪水攻击

+   UDP 洪水攻击

DoS 攻击工具之一是`iaxflood`。它在 Kali Linux 中可用于执行 DoS 攻击。**IAX**代表**Inter-Asterisk Exchange**。

打开 Kali 终端，输入`iaxflood <Source IP> <Destination IP> <Number of packets>`：

![](img/00293.jpeg)

VoIP 基础设施不仅可以受到先前的攻击，攻击者还可以使用模糊工具执行数据包分片和格式错误数据包来攻击基础设施。

# 窃听

**窃听**是最严重的 VoIP 攻击之一。它让攻击者接管您的隐私，包括您的通话。有许多窃听技术；例如，攻击者可以嗅探 TFTP 配置文件的网络，而这些文件包含密码。以下截图描述了对 TFTP 捕获的分析：

![](img/00294.jpeg)

此外，攻击者可以收集电话号码并构建有效的电话号码数据库，记录所有的呼入和呼出电话。窃听并不止于此，攻击者可以录制您的通话，甚至知道您正在使用**双音多频**（**DTMF**）输入什么。您可以使用此链接[`www.polar-electric.com/DTMF/`](http://www.polar-electric.com/DTMF/)上的 DTMF 解码器/编码器：

![](img/00295.jpeg)

**错误配置的互联网电话上的语音**（**VOMIT**）是一个将 Cisco IP 电话对话转换为 WAV 文件的实用程序。您可以从其官方网站[`vomit.xtdnet.nl/`](http://vomit.xtdnet.nl/)下载它：

![](img/00296.jpeg)

# SIP 攻击

另一种攻击技术是 SIP 伪装。我们可以执行两种类型的 SIP 伪装。从攻击者的角度来看，我们可以实现以下内容：

+   **Rogue SIP B2BUA**：在这种攻击技术中，攻击者模仿 SIP B2BUA：

![](img/00297.jpeg)

+   **SIP 伪装为代理**：在这里，攻击者模仿 SIP 代理：

![](img/00298.jpeg)

# SIP 注册劫持

**SIP 注册劫持**是一个严重的 VoIP 安全问题。我们之前看到，在建立 SIP 会话之前，有一个注册步骤。注册可以被攻击者劫持。在 SIP 注册劫持攻击期间，攻击者通过拒绝服务（DoS）禁用正常用户，然后简单地发送带有自己 IP 地址的注册请求，而不是该用户的 IP 地址，因为在 SIP 中，消息是明文传输的，所以 SIP 不确保信令消息的完整性：

![](img/00299.jpeg)

如果您是 Metasploit 爱好者，可以尝试许多其他 SIP 模块。通过输入`msfconsole`打开 Metasploit 控制台，并使用`search SIP:`搜索 SIP 模块。

![](img/00300.jpeg)

要使用特定的 SIP 模块，只需输入`use <module>`。以下界面是 SIP 模块使用的示例：

![](img/00301.jpeg)

# 互联网电话的垃圾邮件

**互联网电话的垃圾邮件**（**SPIT**），有时被称为**语音垃圾邮件**，类似于电子邮件垃圾邮件，但它影响 VoIP。要执行 SPIT 攻击，可以使用名为**spitter**的生成工具。

# 嵌入恶意软件

**恶意软件**是 VoIP 基础设施的主要威胁。您不安全的 VoIP 终端可能会受到不同类型的恶意软件的攻击，如蠕虫和 VoIP 僵尸网络。

软电话也是攻击者的一个高度可能的目标。如果攻击者破坏了您的软电话，可能非常危险，因为如果攻击者利用它，他们可以破坏您的 VoIP 网络。恶意软件不是针对 VoIP 终端的唯一威胁。VoIP 固件是黑客的潜在攻击向量。固件黑客可能导致电话被破坏。

# Viproy - VoIP 渗透测试工具包

**Viproy VoIP 渗透测试工具包（v4）**是一个 VoIP 和统一通信服务渗透测试工具，由 Fatih Ozavci 在 2014 年 Black Hat Arsenal USA 上展示：

![](img/00302.jpeg)

要下载此项目，请从其官方存储库克隆它，[`github.com/fozavci/viproy-voipkit:`](https://github.com/fozavci/viproy-voipkit)

# git clone https://github.com/fozavci/viproy-voipkit.

以下项目包含许多模块，用于测试 SIP 和 Skinny 协议：

![](img/00303.gif)

要使用它们，将`lib`，`modules`和`data`文件夹复制到系统中`Metasploit`文件夹中。

# VoLTE 利用

**Voice over LTE** (**VoLTE**) 在 4G 网络上传输语音。其通话质量比其他 VoIP 变体更高，而且提供更好的覆盖范围。VoLTE 以及其他语音技术都面临来自攻击者的各种威胁。让我们开始探索 VoLTE 的基础知识，以便后来学习如何攻击它。**长期演进** (**LTE**) 由 **第三代合作伙伴计划** (**3GPP**) 在 2014 年开发。它是一个基于 IP 的分组交换网络。它使用两种模式——**时分双工** (**TDD**) 和 **频分双工** (**FDD**)。LTE 架构由以下三个主要组件组成：

+   **用户设备** (**UE**)

+   **演进的 UMTS 地面无线电接入网络** (**E-UTRAN**).

+   **演进分组核心** (**EPC**)

![](img/00304.jpeg)

# VoLTE 攻击

VoLTE 已被一些电信公司采用，如 AT&T 和 T-Mobile。许多研究都集中在试图利用 VoLTE 中涉及的通信协议。Sreepriya Chalakkal 的一篇研究论文介绍了针对 VoLTE 的几种攻击。以下是一些攻击：

+   嗅探 VoLTE 接口

+   GSM SIM 中的暴露密钥

+   用户位置操纵

+   漫游信息操纵

+   侧信道攻击

# SiGploit – 电信信令利用框架

SiGploit 是一个安全框架，可帮助电信安全专业人员增强移动网络基础设施。要测试该项目，请从[`github.com/SigPloiter/SigPloit:`](https://github.com/SigPloiter/SigPloit)克隆它

```
# git clone https://github.com/SigPloiter/SigPloit
```

![](img/00305.gif)

要使用该工具，请转到`bin`目录并运行`SiGsploit.py`脚本：

![](img/00306.gif)

# 摘要

在本章中，我们演示了如何利用 VoIP 基础设施。我们首先研究了 VoIP 中涉及的核心协议。然后，我们探讨了主要的 VoIP 攻击以及如何防御它们，以及渗透测试人员最常用的工具和实用程序。我们以概述一些针对 VoLTE 的最新攻击结束了本章。
