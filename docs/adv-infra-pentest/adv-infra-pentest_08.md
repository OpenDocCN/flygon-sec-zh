# 第八章：VLAN 利用

交换在任何现代网络中都是至关重要的组件。本章将带您进行学习体验，我们将在一方面发现如何对第 2 层进行攻击，另一方面将学习如何防御这些攻击。了解如何保护第 2 层是必要的，因为网络安全的强弱取决于最薄弱的一层。在我们的情况下，最薄弱的一层是第 2 层。损害它可能导致对堆栈中的其他层进行损害。在本章中，我们将涵盖以下主题：

+   交换基础知识

+   MAC 攻击

+   动态主机配置协议（DHCP）攻击

+   虚拟局域网（VLAN）攻击

# 网络中的交换

交换是数据链路层（OSI 模型中的第 2 层）设备。它们的主要目标是通过接收交换数据包并将其转发到目标设备来连接网络设备。交换是连接设备的有效解决方案，尽管如果我们想要连接大量的终端设备（计算机，电话等）和节点，它并不实用。节点是从源到目的地传递信息而不修改信息或数据的实体；一组节点称为通信网络，如下图所示：

![](img/00242.gif)

在交换中，有三种不同的技术：

+   电路交换：这是发送方和接收方之间的固定通道，专用通道称为**电路**。一旦建立连接，即使电路没有完全使用，其他设备也不能使用通道，直到确定连接。这种类型的交换广泛用于电话网络。在电路交换期间，我们有以下三个步骤：通道建立，数据传输和连接确定。电路交换有两种类型：

+   频分复用（FDM）：复用是将许多信号合并成一个信号的过程。FDM 是一种操作，其中信道在不重叠的频率下进行划分。以下图示了 FDM 过程：

![](img/00243.gif)

+   +   时分复用（TDM）：这是另一种复用操作，但它使用时间段而不是频率。这种操作比 FDM 更灵活和高效，如下图所示：

![](img/00244.gif)

+   分组交换：在这种交换技术中，数据以特定格式称为**分组**进行交换和转发。数据包由以下元素组成，如下图所示：

+   数据：传输的信息

+   头部：包含目的地地址

+   尾部（可选）：一般来说，这包含一些信息，以指示数据包的结束；有时，它用于错误检查：

![](img/00245.gif)

在传输中，来自不同终端系统的数据包将进行复用；数据包也称为**数据报**。

+   消息交换：有时也称为存储-转发交换。在这种技术中，所有终端系统都接收消息，存储它，并将其转发到下一个设备。

# 局域网交换

在局域网中使用的接入方法是基于 IEEE 802.3 标准的以太网连接。我们根据连接带宽（10 Mbps（以太网），100 Mbps（快速以太网）或 1,000 Mbps（千兆以太网））有不同类型。以太网为您提供了从不同的以太网传输物理设备中进行选择，例如双绞线和光纤。

用于阻止设备同时发送信息的算法称为**载波监听多路访问/冲突检测**（CSMA/CD）。如下图所示，两个主机不能同时发送信息：

![](img/00246.jpeg)

在以太网连接中，数据的流量由**媒体访问控制**（**MAC**）地址确定。这个地址是一个独特的 48 位序列号。它由**组织唯一标识符**（**OUI**）和供应商分配的地址组成，如下所示。它以十六进制格式表示：

![](img/00247.gif)

在第 2 层的传输可以分为三种主要的数据传输方法：

+   **单播**：这是从特定网络设备到另一个特定设备的传输模式。换句话说，这是一对一的传输模式。

+   **多播**：在多播操作中，单个设备向多个网络设备发送数据。这是一种一对多的传输模式，其中设备向特定组发送数据。

+   **广播**：这种传输模式类似于多播，但在广播操作中，网络设备向所有其他设备发送数据。在广播中，设备使用`FF-FF-FF-FF-FF-FF` MAC 地址（最高可能的 MAC 地址）。

以下图示说明了三种传输模式之间的区别：

![](img/00248.jpeg)

在 LAN 交换中，我们有以下三种技术：

+   **存储转发交换**：在存储转发交换中，交换机将所有帧存储在内存中，并在计算**循环冗余检查**（**CRC**）后检查错误。如果根据帧中的位数存在错误，帧将被拒绝，否则将被转发，如下所示：

![](img/00249.jpeg)

+   **切换式交换**：在切换式交换中，交换机仅存储目标 MAC 地址并将其与其 MAC 表进行比较。这种技术比前一种技术更快，因为它只处理前 6 个字节：

![](img/00250.jpeg)

+   **碎片免费交换**：这种交换技术结合了前两种交换模式。它是一种混合交换技术。它类似于切换式交换，但是不是检查前 6 个字节，而是检查前 64 个字节，因为为了检测冲突，我们需要检查前 64 个字节。

# MAC 攻击

MAC 地址是具有两个分配部分的唯一标识符——OUI 由 IEEE 分配，后 24 位由制造商分配。这些地址存储在一个称为**内容可寻址存储器**（**CAM**）的表中。这个表有固定的大小。CAM 在操作后存储有关 MAC 地址的信息，如下图所示：

![](img/00251.jpeg)

在这种情况下，最初 CAM 包含两个地址及其端口信息。要从**主机 A**发送流量到**主机 B**，CAM 表中应包含有关**主机 B**的信息，但在此演示中并非如此。因此**主机 A**向所有主机发送 ARP 请求。主机发送有关其 MAC 地址和端口的信息。现在**主机 A**有关**主机 B**的信息并将其存储在 CAM 表中，如图所示：

![](img/00252.jpeg)

最后，CAM 表包含有关主机的所有必需信息，包括目标主机。因此，从**主机 A**到**主机 B**的流量应正常运行：

![](img/00253.jpeg)

攻击者可以利用 CAM 表执行恶意活动。可以进行一种称为 CAM 溢出的攻击。换句话说，攻击者通过利用 CAM 表大小的最大限制来溢出 CAM 表。有许多可用的工具，其中之一是**macof**。假设 CAM 表已满载有所有信息。攻击者可以使用 macof 向交换机发送随机源 MAC 地址（每分钟最多 155,000 个 MAC 条目）来淹没交换机：

![](img/00254.jpeg)

或者简单地使用`macof -i eth1 2> /dev/null`。为了防御 MAC 淹没，您需要使用端口安全限制接口上的 MAC 地址数量，如下图所示：

![](img/00255.jpeg)

# 媒体访问控制安全

为了保护您的网络免受数据链路层攻击并提供总以太网链路安全，您可以使用**媒体访问控制安全**（**MACsec**），它基于 802.1 AE 标准。MACsec 就像网络层的 IPsec 一样，它使用逐跳加密（GCM-AES-128）和网络节点之间的**MACsec 密钥协商**（**MKA**）来提供完整性和保密性保护。因此，它加密了所有以太网数据包，但不会触及源和目的 MAC 地址。交换机到交换机模式下的 MACsec 与交换机到主机模式不同。第一个称为下行 MACsec，其中主机经过 802.1x 认证过程。第二个称为上行 MACsec。它可以在交换机上手动配置，也可以使用远程 RADIUS 服务器动态配置。以下图表显示了通信是加密的：

![](img/00256.jpeg)

# DHCP 攻击

DHCP 是基于 RFC 2131 的网络层协议，它使得可以动态分配 IP 地址给主机。为了为特定主机分配 IP 地址，需要以下四个必需的步骤：

+   DHCP 发现

+   DHCP 提供

+   DHCP 请求

+   DHCP 确认

![](img/00257.jpeg)

# DHCP 饥饿

在本章中，我们讨论了第 2 层攻击；我打赌你想知道为什么我们谈论了一个网络层协议（在我们的例子中是 DHCP）。答案很简单。攻击者可以执行我们所谓的 DHCP 饥饿攻击。攻击者使用伪造的 MAC 地址广播 DHCP 请求；这种攻击利用了 DHCP 服务器的地址空间。这种攻击可以使用简单的工具来完成，比如*gobbler*。

# Rogue DHCP 服务器

Rogue DHCP 服务器（可以是家用路由器或调制解调器）是攻击者在网络中实施的服务器，用于执行中间人攻击或嗅探网络流量。这种恶意服务器的实施让攻击者收集大量信息，包括 DNS 服务器信息和默认网关。为了防御 DHCP 攻击，您需要使用 DHCP 监听，这是一个用于识别响应 DHCP 请求端口的交换机功能。

# ARP 攻击

**地址解析协议**（**ARP**）是根据 RFC 826 标准将 IP 地址与其关联的 MAC 地址进行映射的协议。ARP 在许多操作系统中实现，包括 Linux。

您可以使用`arp`命令进行检查：

![](img/00258.jpeg)

攻击者可以利用其缓存执行中间人攻击，使用诸如 Ettercap 之类的工具：

![](img/00259.jpeg)

如果您已经使用 Kali Linux，还可以使用`dsniff`实用程序：

![](img/00260.jpeg)

攻击者可以利用 ARP 协议的 IP/MAC 匹配能力将其 MAC 地址与合法 IP 地址进行映射。如果您使用 Kali Linux，可以直接从主菜单中使用它。

为了防御 ARP 攻击，最好使用动态 ARP 检查，检查数据包是否与绑定表条目匹配，否则数据包将被丢弃；但首先需要配置 DHCP 监听。

这是正常的 ARP 操作：

![](img/00261.jpeg)

这是 ARP 欺骗攻击的示例：

![](img/00262.jpeg)

# VLAN 攻击

VLAN 是在同一广播域中对网络设备进行逻辑分组。这种逻辑分离在许多情况下非常有益。例如，如果我们有不同的地理位置，使用 VLAN 可能是将网络设备分组的好方法，即使它们在不同的地方，但它们就像一个广播域一样。这张图解说明了经典的交换架构；每个特定的企业部门都有一个特定的交换机：

![](img/00263.jpeg)

以下图示了实施 VLAN 的有益结果。我们可以为许多不同的部门配置交换机：

![](img/00264.jpeg)

交换操作发生在第 2 层，但当我们使用 VLAN 时，我们需要一个路由器（第 3 层）通过名为**VLAN 间路由**的操作使 VLAN 相互通信。VLAN 干线连接是需要的，通过为每个帧打上 VLAN ID，这是一个在 0 到 4095 之间的数字，来识别 VLAN。在这里，使用了干线协商，得益于**动态干线协议**（**DTP**）：

![](img/00265.jpeg)

当交换机和路由器支持 VLAN 时，可以实现 VLAN。这意味着它们支持干线协议，如**交换机间链路**（**ISL**），这是 Cisco 专有的，以及 IEEE 802.1q。如果交换机支持干线，它被称为**受管交换机**。

# VLAN 的类型

有许多种类型的 VLAN。其中两种如下：

+   **本地 VLAN 或未标记的 VLAN**：如果主机向交换机端口发送流量而没有指定 VLAN ID，则流量将被分配给未标记的 VLAN

+   **标记的 VLAN**：当数据包被标记为 VLAN ID 时使用

# VLAN 配置

要在交换机上配置 VLAN，您需要遵循这个配置：

![](img/00266.gif)

+   第一个 VLAN：

```
switch#configure terminal
switch(config)#vlan 10
switch(config-vlan)#exit
switch(config)#
```

+   第二个 VLAN：

```
switch#configure terminal
switch(config)#vlan 20
switch(config-vlan)#exit
switch(config)#
```

+   分配端口：

```
switch#configure terminal
switch(config)#interface FastEthernet 0/1
switch(config-if)#switchport mode access
switch(config-if)#switchport access vlan 10
 switch#configure terminal
switch(config)#interface range FastEthernet 0/2 - 8
switch(config-if-range)#switchport mode access
switch(config-if-range)#switchport access vlan 10
```

# VLAN 跳跃攻击

VLAN 跳跃攻击基于 DTP。DTP 的主要作用是自动配置 802.1q 或 ISL 干线：

![](img/00267.jpeg)

# 交换机欺骗

在这种攻击中，攻击者通过模拟 ISL 或 802.1q 并与 DTP 进行信令来模拟交换机。因此，它看起来像一个带干线端口的交换机，因此它将可以访问所有的 VLAN。

# VLAN 双标记

这种攻击有时被称为双 802.1q 封装攻击，它是通过发送 802.1q 双封装帧来完成的。一般来说，交换机一次只执行一次解封操作。因此，它们将剥离第一个并发送第二个。这种攻击只有在攻击和目标在同一个 VLAN 上时才可能发生，即使干线端口关闭：

![](img/00268.jpeg)

# 私有 VLAN 攻击

我们在前面的部分中看到，VLAN 将 LAN 划分为广播域。**私有 VLAN**（**PVLAN**）也是 VLAN 的子域，有隔离的子域，如子 VLAN。

VLAN 需要一个第 3 层设备，如路由器，来相互通信，PVLAN 也需要路由器来通信，但主机仍然在同一个 IP 子网中。我们有三个 PVLAN 端口：

+   **混杂（P）**：连接到路由器

+   **隔离（I）**：连接到主机

+   **社区（C）**：连接到其他社区端口

攻击者可以通过发送带有他们的 IP 和 MAC 地址以及目标 IP 地址的帧来攻击 PVLANs：

![](img/00269.jpeg)

# 生成树协议攻击

**生成树协议**（**STP**）是由 Radia Perlman 于 1985 年开发的，用于解决以太网环路的问题，但在深入研究 STP 之前，让我们回到这个问题的根本原因。如果广播风暴发生，您将失去网络可用性。当以太网环路发生时，就会发生这种情况。举个简单的例子，在下图中，我们有三个连接的交换机。如果一个交换机向其他两个交换机发送广播，它们将通过所有端口接收并转发它，因为它们找不到地址。此外，它们将进入一个重复的循环，称为**广播风暴**：

![](img/00270.jpeg)

这样，STP 似乎解决了这个网络问题，通过阻塞冗余路径，得益于基于 IEEE 802.1d 标准的**生成树算法**（**STA**），它确保两个站点之间只有一条路径可用：

![](img/00271.jpeg)

但是在使用 STP 时要阻塞哪些端口呢？在 STP 中，有五种类型的端口：

+   **学习端口**：这个端口学习 MAC 地址但不转发帧

+   **监听端口**：这个端口不学习 MAC 地址或转发它们

+   **丢弃端口**：这个端口不转发数据

+   **转发端口**：这个端口学习 MAC 地址并转发数据

+   **禁用端口**：这个端口不需要解释

以下工作流描述了 STP 中端口的各个阶段：

![](img/00272.gif)

STP 执行以下三个步骤以实现其目标：

+   **根桥选举**：交换机并不是非常智能的设备。因此，默认情况下，网络中的每个交换机都声称自己是根桥，即控制拓扑的主要交换机。为了选择根桥，所有交换机发送它们的**桥 ID**（**BID**），这是桥优先级和 MAC 地址之间的 8 个字节的组合；默认情况下，它是 32,768。具有最小 BID 的交换机被选为根桥。

+   选择根端口：这个选择是基于一个简单的选择标准，即最低成本的**桥接协议数据单元**（**BPDU**）。因此，接收到最低 BPDU 的端口将成为根端口。

+   **选择指定端口**：指定端口是其他交换机端口（已阻塞）。

# 攻击 STP

攻击者可以利用 STP 来攻击网络。其中一种黑客技术是在干线端口实施一个虚假交换机，并通过配置这个虚假交换机并赋予它最低的 ID 来操纵生成树优先级，从而成为根桥。因此，所有流量将通过这个交换机传输，然后它将嗅探所有流量或重定向流量。

为了防御 STP 攻击，您需要在所有未指定为根端口的交换机端口上启用根守卫：

```
Switch1(config)# interface gigabitethernet 0/1
Switch1(config-if)# spanning-tree guard root
```

# 总结

本章是关于如何利用第 2 层漏洞来妥协网络的有用解释。下一章将是一个深入的学习体验，解释如何利用 VoIP 系统。
