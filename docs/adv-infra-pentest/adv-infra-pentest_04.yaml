- en: Active Directory Exploitation
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 活动目录利用
- en: In the previous chapter, we explored how to exploit an organization's networks.
    We went from networking fundamentals to discovering the latest attacking methodologies.
    This chapter is your next step to gaining more knowledge about securing another
    important technical system for every modern company, which is Active Directory.
    We will take you to another level of experience following a well-designed plan
    to obtain the required skills to defend another environment.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，我们探讨了如何利用组织的网络。我们从网络基础知识到发现最新的攻击方法。本章是您获取有关保护现代公司另一个重要技术系统的更多知识的下一步，即活动目录的下一步。我们将带您进入另一个层次的经验，按照一个精心设计的计划获取保护另一个环境所需的技能。
- en: 'The following topics will be covered in this chapter:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下主题：
- en: Learning Active Directory and Kerberos concepts
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 学习活动目录和凯伯罗斯的概念
- en: An overview of various Active Directory attacks
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 各种活动目录攻击的概述
- en: Learning what defensive measures are effective and how they mitigate current
    attacks
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 学习哪些防御措施是有效的，以及它们如何缓解当前的攻击
- en: Active Directory
  id: totrans-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 活动目录
- en: A directory is a book that lists individuals or organizations including details,
    such as names, addresses, and emails, in a sorted way, generally alphabetically
    or by theme. In other words, a directory contains stored and structured objects
    to ease the access and the manipulation of these objects. In a small-scale organization,
    if you need a file, you need to know in what server the file resides and its full
    path. This works in small environments, but it is not practical in medium- and
    large-scale companies. Thus, locating a file using that way could be a real challenge.
    The problem doesn't stop there, as we know every user could have many access credentials,
    such as passwords, which makes it difficult to manage all the credentials, if
    the number is high. That is why the need arose for a directory service to locate
    resources without knowing the full location. The following graph illustrates an
    example of an hierarchical directory
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 目录是一本按字母顺序或主题排序的列出个人或组织的书，包括姓名、地址和电子邮件等详细信息。换句话说，目录包含存储和结构化的对象，以便轻松访问和操作这些对象。在小规模组织中，如果您需要一个文件，您需要知道文件存储在哪个服务器上以及其完整路径。这在小型环境中有效，但在中大型公司中并不实用。因此，使用这种方式定位文件可能是一个真正的挑战。问题并不止于此，因为我们知道每个用户可能有许多访问凭据，如密码，这使得管理所有凭据变得困难，如果数量很大的话。这就是为什么需要一个目录服务来定位资源而不知道完整位置的原因。以下图表说明了一个分层目录的示例。
- en: '![](img/00097.jpeg)'
  id: totrans-8
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00097.jpeg)'
- en: Microsoft Active Directory provides a directory service for managing and solving
    these challenges. It comes with many other features and capabilities. Nowadays,
    Active Directory plays an important role in many modern organizations and institutions.
    Communication is a critical aspect for business, and a directory service is a
    wise choice because it acts as a single container point for all the required information.
    Active Directory is based on a client/server architecture. The following graph
    show an example of Active directory users.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 微软活动目录提供了一个用于管理和解决这些挑战的目录服务。它还具有许多其他功能和能力。如今，活动目录在许多现代组织和机构中扮演着重要角色。沟通对于业务来说是一个关键的方面，而目录服务是一个明智的选择，因为它作为所有所需信息的单一容器点。活动目录基于客户端/服务器架构。以下图表显示了活动目录用户的一个示例。
- en: '![](img/00098.jpeg)'
  id: totrans-10
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00098.jpeg)'
- en: 'Active Directory consists of the following four components:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 活动目录由以下四个组件组成：
- en: '**Active Directory forest**: This is an Active Directory instance that acts
    like a top-level container'
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 活动目录森林：这是一个充当顶级容器的活动目录实例
- en: '**Active Directory domains**: This is the collection of administratively defined
    objects'
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 活动目录域：这是管理定义的对象的集合
- en: '**Active Directory units**: You use these container objects to arrange other
    objects in a manner that supports your administrative purposes'
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 活动目录单元：您可以使用这些容器对象来以支持您的管理目的的方式排列其他对象
- en: '**Sites**: These are the containers of the objects'
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 站点：这些是对象的容器
- en: 'This illustration shows an example of Active Directory forests and trees:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 这个插图显示了活动目录森林和树的一个示例：
- en: '![](img/00099.jpeg)'
  id: totrans-17
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00099.jpeg)'
- en: Single Sign-On
  id: totrans-18
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 单点登录
- en: '**Single Sign-On** (**SSO**) is a central approach generally represented by
    an authentication server that allows many systems to authenticate in a productive
    way, without the need to remember different passwords. This mechanism also improves
    developers'' productivity by providing a single authentication point, so they
    won’t worry about that part and they can focus on more important tasks. The SSO
    solution is great, but as discussed in the previous chapters, a single point is
    an attractive target for attackers.  The following graph shows how Single sign-on
    is simplifying authentication.'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 单点登录（SSO）是一种集中的方法，通常由认证服务器代表，允许许多系统以高效的方式进行身份验证，无需记住不同的密码。这种机制还通过提供单一的身份验证点来提高开发人员的生产力，因此他们不必担心这一部分，可以专注于更重要的任务。SSO解决方案很棒，但正如前几章讨论的那样，单一点是攻击者的一个有吸引力的目标。以下图表显示了单点登录是如何简化身份验证的。
- en: '![](img/00100.jpeg)'
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00100.jpeg)'
- en: Kerberos authentication
  id: totrans-21
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 凯伯罗斯身份验证
- en: 'Kerberos is an authentication protocol under RFC 1510, integrated in Windows
    operating systems from the beginning of this millennium. It was developed by the
    **Massachusetts Institute of Technology** (**MIT**) under the Athena Project.
    You can check it and test it via its official website, [http://www.kerberos.org](http://www.kerberos.org).
    The Kerberos environment contains three parts: the client, the server, and the
    **Key Distribution Center** (**KDC**), as shown in the following figure. It provides
    identity-based on a key distribution model, presented by Needham and Schroeder:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: Kerberos是RFC 1510下的认证协议，从本世纪初起就集成在Windows操作系统中。它是由**麻省理工学院**（**MIT**）在Athena项目下开发的。您可以通过其官方网站[http://www.kerberos.org](http://www.kerberos.org)进行检查和测试。Kerberos环境包含三个部分：客户端、服务器和**密钥分发中心**（**KDC**），如下图所示。它提供了基于身份的密钥分发模型，由Needham和Schroeder提出：
- en: '![](img/00101.jpeg)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00101.jpeg)'
- en: 'Kerberos needs the following five steps to proceed:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: Kerberos需要以下五个步骤才能进行：
- en: Authentication is requested from the authentication server, KDC
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 需要从认证服务器KDC请求认证
- en: KDC sends back a session encrypted with the sender’s secret key, in addition
    to the ticket-granting encrypted with a ticket-granting service
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: KDC发送一个使用发送者的秘密密钥加密的会话，以及一个使用票据授予服务加密的票据授予
- en: The receiver then decrypts the session and requests permission from the ticket-granting
    service
  id: totrans-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后接收者解密会话并从票据授予服务请求权限
- en: If the session is valid, the ticket-granting service sends a client/server session
    to grant access to the resource, in addition to a service ticket encrypted with
    the resource key
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果会话有效，票据授予服务将发送一个客户端/服务器会话以授予对资源的访问权限，以及一个使用资源密钥加密的服务票据
- en: The resource validates the session and grants access to the client
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 资源验证会话并授予客户访问权限
- en: 'Kerberos provides a great authentication solution, but it stores keys as plain
    texts, which represents a huge threat for the organization. In fact, if an attacker
    could access the KDC, they would compromise all the keys. The following graph
    show the different steps of Kerberos operation:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: Kerberos提供了一个很好的认证解决方案，但它将密钥以明文形式存储，这对组织构成了巨大的威胁。事实上，如果攻击者能够访问KDC，他们将会破坏所有密钥。以下图表显示了Kerberos操作的不同步骤：
- en: '![](img/00102.jpeg)'
  id: totrans-31
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00102.jpeg)'
- en: Lightweight Directory Access Protocol
  id: totrans-32
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 轻量级目录访问协议
- en: Active Directory uses **Lightweight Directory Access Protocol** (**LDAP**) as
    an access protocol, which relies on the TCP/IP stack. The LDAP supports Kerberos
    authentication.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: Active Directory使用**轻量级目录访问协议**（**LDAP**）作为访问协议，依赖于TCP/IP协议栈。LDAP支持Kerberos认证。
- en: This protocol uses an inverted-tree hierarchical structure, so every entry has
    a defined position. This structure is called the **Directory Information Tree** (**DIT**).
    The **Distinguished Name** (**DN**) represents the full path of the entry.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 该协议使用倒置树层次结构，因此每个条目都有一个定义的位置。这种结构称为**目录信息树**（**DIT**）。**Distinguished Name**（**DN**）表示条目的完整路径。
- en: 'The following diagram represents the different interaction between the users
    (**Common Name** (**CN**)). Filter groups are restricted to some applications:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 以下图表表示用户（**通用名称**（**CN**））之间的不同交互。过滤组被限制在一些应用程序中：
- en: '![](img/00103.jpeg)'
  id: totrans-36
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00103.jpeg)'
- en: PowerShell and Active Directory
  id: totrans-37
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: PowerShell和Active Directory
- en: 'PowerShell is an automated framework that provides system administrators with
    many capabilities to perform tasks. It supports the scripting language. Every
    command in the script is called a **cmdlet**. You can build your own cmdlets using
    the .NET programming language. An explanation is given here:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell是一个自动化框架，为系统管理员提供了许多执行任务的能力。它支持脚本语言。脚本中的每个命令都被称为**cmdlet**。您可以使用.NET编程语言构建自己的cmdlet。这里给出了一个解释：
- en: '![](img/00104.jpeg)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00104.jpeg)'
- en: 'To check out a forest, you can use the `get-adforest` cmdlet, as shown:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看一个森林，您可以使用`get-adforest` cmdlet，如下所示：
- en: '![](img/00105.jpeg)'
  id: totrans-41
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00105.jpeg)'
- en: 'To check all the commands type: `Get-Command`, as shown:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 要检查所有命令，请输入：`Get-Command`，如下所示：
- en: '![](img/00106.jpeg)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00106.jpeg)'
- en: 'To check the domains, you can use** `Get-ADDomain`**, as shown:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 要检查域，您可以使用**`Get-ADDomain`**，如下所示：
- en: '![](img/00107.jpeg)'
  id: totrans-45
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00107.jpeg)'
- en: 'To check the trust of the forest, you need to use `get-adtrust`, as shown:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 要检查森林的信任，您需要使用`get-adtrust`，如下所示：
- en: '![](img/00108.jpeg)'
  id: totrans-47
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00108.jpeg)'
- en: '`get-aduser` is used to get a specified user, as shown:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: '`get-aduser`用于获取指定用户，如下所示：'
- en: '![](img/00109.jpeg)'
  id: totrans-49
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00109.jpeg)'
- en: 'PowerShell is used as an attack platform in many cases for the following reasons:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell在许多情况下被用作攻击平台，原因如下：
- en: It runs code in memory without touching disk
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在内存中运行代码而不触及磁盘
- en: It downloads and executes code from another system
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它从另一个系统下载并执行代码
- en: It interfaces with .NET and Windows APIs
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它与.NET和Windows API进行交互
- en: Most organizations are not watching PowerShell activity
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 大多数组织都没有监视PowerShell活动。
- en: '`CMD.exe` is commonly blocked, though not PowerShell'
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`CMD.exe`通常被阻止，尽管PowerShell没有被阻止'
- en: Active Directory attacks
  id: totrans-56
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Active Directory攻击
- en: Active Directory is a high-profile target for attackers. Because of its common
    architecture (single point), it is a targeted system. There are many Active Directory
    attacks. It is a complex system, so the following subsections will discuss different
    types of attacks from different attacking vectors.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: Active Directory是攻击者的高调目标。由于其常见的架构（单一点），它是一个被攻击的系统。有许多Active Directory攻击。它是一个复杂的系统，因此以下小节将讨论来自不同攻击向量的不同类型的攻击。
- en: PowerView
  id: totrans-58
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: PowerView
- en: Reconnaissance is a crucial step in information security. PowerView is an amazing
    recon tool – it is a domain-network situational awareness tool. You can grab it
    from [https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1).
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 侦察是信息安全中至关重要的一步。PowerView是一个令人惊叹的侦察工具-它是一个域网络态势感知工具。您可以从[https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)获取它。
- en: 'As usual, clone the project or simply download it as a `.zip` file, as shown:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 像往常一样，克隆项目或简单地将其下载为`.zip`文件，如下所示：
- en: '[PRE0]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '![](img/00110.jpeg)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00110.jpeg)'
- en: 'PowerView will give you the ability to perform many reconnaissance tasks, as
    follows:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: PowerView将使您能够执行许多侦察任务，如下所示：
- en: '**Users**: `Get-NetUser`'
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**用户**：`Get-NetUser`'
- en: '**Groups**: `Get-NetGroup`'
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**组**：`Get-NetGroup`'
- en: '**Sessions**: `Get-NetSession`'
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**会话**：`Get-NetSession`'
- en: '**GPO locations**: `Find-GPOLocation`'
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**GPO位置**：`Find-GPOLocation`'
- en: '**Active Directory objects**: `Set-ADObject`'
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Active Directory对象**：`Set-ADObject`'
- en: '**Forests**: `Get-NetForest`'
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Forests**：`Get-NetForest`'
- en: Kerberos attacks
  id: totrans-70
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Kerberos攻击
- en: Kerberos is a high-profile target for attackers, as discussed in the previous
    section. But before diving deep into Kerberos attacks, let's discover some PowerShell
    capabilities.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 如前几节所讨论的，Kerberos是攻击者的高价值目标。但在深入研究Kerberos攻击之前，让我们先了解一些PowerShell的功能。
- en: '`get-adrootdse`: It is used to get the objects of root, as shown:'
  id: totrans-72
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`get-adrootdse`：用于获取根对象，如下所示：'
- en: '![](img/00111.jpeg)'
  id: totrans-73
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00111.jpeg)'
- en: '`get-adforest`: It is used to check Active Directory forests, as shown:'
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`get-adforest`：用于检查Active Directory forests，如图所示：'
- en: '![](img/00112.jpeg)'
  id: totrans-75
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00112.jpeg)'
- en: '`get-domaincontroller`: Lists the domain controllers, as shown:'
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`get-domaincontroller`：列出域控制器，如图所示：'
- en: '![](img/00113.jpeg)'
  id: totrans-77
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00113.jpeg)'
- en: 'To get Active Directory computers, use `get-adcomputer`, as shown:'
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要获取Active Directory计算机，请使用`get-adcomputer`，如图所示：
- en: '![](img/00114.jpeg)'
  id: totrans-79
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00114.jpeg)'
- en: '`get-adgroupmemberb`: To get members of an AD group members, as shown:'
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`get-adgroupmemberb`：获取AD组成员，如图所示：'
- en: '![](img/00115.jpeg)'
  id: totrans-81
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00115.jpeg)'
- en: 'Before diving into Active Directory attack techniques, let''s discover some
    of PowerShell''s capabilities as an offensive platform. To do that, we will take
    PowerShell Empire as a demonstration because it is a great tool for creating agents
    to compromise systems:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在深入研究Active Directory攻击技术之前，让我们先了解PowerShell作为攻击平台的一些功能。为此，我们将以PowerShell Empire作为演示，因为它是一个创建代理以妥协系统的绝佳工具：
- en: '[PRE1]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Navigate to `cd Empire/setup` and run the `./install.sh` script:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 导航到`cd Empire/setup`并运行`./install.sh`脚本：
- en: '![](img/00116.gif)'
  id: totrans-85
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00116.gif)'
- en: 'Wait a moment for the installation to finish:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 等待安装完成：
- en: '![](img/00117.gif)'
  id: totrans-87
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00117.gif)'
- en: 'Voila! You are now ready to use PowerShell Empire:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您已经准备好使用PowerShell Empire了：
- en: '![](img/00118.gif)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00118.gif)'
- en: 'If you want to generate an agent, you just need to type `usemodule external/generate_agent`:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想生成一个代理，只需输入`usemodule external/generate_agent`：
- en: '![](img/00119.gif)'
  id: totrans-91
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00119.gif)'
- en: Kerberos TGS service ticket offline cracking (Kerberoast)
  id: totrans-92
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Kerberos TGS服务票证离线破解（Kerberoast）
- en: As discussed in previous sections, Kerberos uses tickets to authenticate, thanks
    to a trusted third party based on symmetric-key cryptography. One of the most
    common attacks is Kerberos TGS service ticket offline cracking, also known as
    Kerberoast. With this technique, the attacker exploits the fact that most service
    account passwords have the same length as the domain password. In other words,
    you don't need to brute force both passwords because most service accounts don’t
    have passwords set to expire. To mitigate this attack, you need to ensure that
    the service account passwords are longer than 25 characters. These are the steps
    of the Ticket-Granting *Service* (*TGS*)
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 如前几节所讨论的，Kerberos使用票证进行身份验证，这得益于基于对称密钥密码学的受信任的第三方。最常见的攻击之一是Kerberos TGS服务票证离线破解，也称为Kerberoast。使用这种技术，攻击者利用了大多数服务账户密码与域密码长度相同的事实。换句话说，您不需要暴力破解两个密码，因为大多数服务账户的密码不会过期。为了减轻这种攻击，您需要确保服务账户密码长度超过25个字符。这些是TGS的步骤
- en: '![](img/00120.jpeg)'
  id: totrans-94
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00120.jpeg)'
- en: SPN scanning
  id: totrans-95
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: SPN扫描
- en: '**Service Principal Names** (**SPNs**) represent an instance of a specific
    discoverable service, such as HTTP, LDAP, and SQL. They are used by Kerberos to
    connect a service with a service account. You can scan these services without
    performing a port scanning because SPNs could be represented like this, for example, `MSSQLSvc/<domain>:3170`
    (`3170` is the port number).'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '**服务主体名称**（**SPNs**）表示特定可发现服务的实例，例如HTTP、LDAP和SQL。它们由Kerberos用于将服务与服务账户连接起来。您可以扫描这些服务，而无需执行端口扫描，因为SPNs可以表示为例如`MSSQLSvc/<domain>:3170`（`3170`是端口号）。'
- en: If you want to check all the SPN services using Microsoft’s built-in tool, you
    just need to type `setspn -Q */*`.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 如果要使用Microsoft内置工具检查所有SPN服务，只需输入`setspn -Q */*`。
- en: '![](img/00121.jpeg)'
  id: totrans-98
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00121.jpeg)'
- en: To retrieve an AD ticket, type: `> $ticket = Get-TGSCipher -SPN <SPN_service_Here>`.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 要检索AD票证，请输入：`> $ticket = Get-TGSCipher -SPN <SPN_service_Here>`。
- en: 'To crack the ticket, you can use john the ripper, which is a well-known password
    cracking utility, shown here:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 要破解票证，您可以使用约翰·里帕，这是一个众所周知的密码破解实用程序，如图所示：
- en: '![](img/00122.jpeg)'
  id: totrans-101
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00122.jpeg)'
- en: Passwords in SYSVOL and group policy preferences
  id: totrans-102
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: SYSVOL和组策略首选项中的密码
- en: This attack is much simpler than the previous attack. To escalate from domain
    user to domain admin, the attacker just needs to search the domain SYSVOL DFS
    share for XML files. SYSVOL is the domain-wide share in Active Directory to which
    all authenticated users have read access.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 这种攻击比以前的攻击简单得多。要从域用户升级为域管理员，攻击者只需搜索域SYSVOL DFS共享中的XML文件。SYSVOL是Active Directory中的域范围共享，所有经过身份验证的用户都可以读取。
- en: 14-068 Kerberos vulnerability on a domain controller
  id: totrans-104
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14-068 Kerberos漏洞在域控制器上
- en: 'To exploit the MS14-068 Kerberos vulnerability, you can use a Python script
    called **PyKEK**, the Kerberos exploitation kit to inject the TGT into memory,
    as shown. Clone the python script from this GitHub repository [https://github.com/bidord/pykek](https://github.com/bidord/pykek):'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 要利用MS14-068 Kerberos漏洞，您可以使用一个名为**PyKEK**的Python脚本，即Kerberos利用工具包，将TGT注入内存，如图所示。从GitHub存储库克隆python脚本[https://github.com/bidord/pykek](https://github.com/bidord/pykek)：
- en: '![](img/00123.gif)'
  id: totrans-106
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00123.gif)'
- en: 'Now, you are able to use the script following this format:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您可以使用以下格式的脚本：
- en: '[PRE2]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Dumping all domain credentials with Mimikatz
  id: totrans-109
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用Mimikatz转储所有域凭据
- en: 'Dumping credentials is a classic technique in information security. Dumping
    domain credentials is one of the well-known Active Directory techniques. This
    technique could be done with the help of a powerful utility named **Mimikatz**,
    which is developed by Benjamin Delpy. You can download it from its official GitHub
    repository [https://github.com/gentilkiwi/mimikatz](https://github.com/gentilkiwi/mimikatz):'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 转储凭据是信息安全中的一种经典技术。转储域凭据是众所周知的Active Directory技术之一。可以借助一个名为**Mimikatz**的强大实用程序来实现这一技术，该实用程序由Benjamin
    Delpy开发。您可以从其官方GitHub存储库[https://github.com/gentilkiwi/mimikatz](https://github.com/gentilkiwi/mimikatz)下载。
- en: '![](img/00124.jpeg)'
  id: totrans-111
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00124.jpeg)'
- en: 'To build Mimikatz, you need to build it using Visual Studio. In my case, I
    am using Visual Studio 2015 Professional. If you want to use the binary directly,
    download it from [https://github.com/gentilkiwi/mimikatz/releases/tag/2.1.1-20171203](https://github.com/gentilkiwi/mimikatz/releases/tag/2.1.1-20171203):'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 要构建Mimikatz，您需要使用Visual Studio进行构建。在我的情况下，我使用的是Visual Studio 2015专业版。如果您想直接使用二进制文件，请从[https://github.com/gentilkiwi/mimikatz/releases/tag/2.1.1-20171203](https://github.com/gentilkiwi/mimikatz/releases/tag/2.1.1-20171203)下载：
- en: '![](img/00125.jpeg)'
  id: totrans-113
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00125.jpeg)'
- en: 'The following screenshot shows the main interface of Mimikatz:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 以下截图显示了Mimikatz的主界面：
- en: '![](img/00126.jpeg)'
  id: totrans-115
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00126.jpeg)'
- en: Now, let's discover some Mimikatz commands and utilities.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们发现一些Mimikatz命令和实用程序。
- en: '`CRYPTO::Certificates`: List and check certificates, as shown:'
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`CRYPTO::Certificates`：列出和检查证书，如下所示：'
- en: '![](img/00127.jpeg)'
  id: totrans-118
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00127.jpeg)'
- en: '`SEKURLSA::Ekeys`: Checks Kerberos encryption keys ([https://adsecurity.org/?page_id=1821#SEKURLSAEkeys](https://adsecurity.org/?page_id=1821#SEKURLSAEkeys))'
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`SEKURLSA::Ekeys`：检查Kerberos加密密钥（[https://adsecurity.org/?page_id=1821#SEKURLSAEkeys](https://adsecurity.org/?page_id=1821#SEKURLSAEkeys)）'
- en: '`PRIVILEGE::Debug`: Checks Debug rights'
  id: totrans-120
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PRIVILEGE::Debug`：检查调试权限'
- en: '`TOKEN::List`: Checks all the system tokens, as shown:'
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`TOKEN::List`：检查所有系统令牌，如下所示：'
- en: '![](img/00128.jpeg)'
  id: totrans-122
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00128.jpeg)'
- en: '`TOKEN::Elevate`: Check domain admin, as shown:'
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`TOKEN::Elevate`：检查域管理员，如下所示：'
- en: '![](img/00129.jpeg)'
  id: totrans-124
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00129.jpeg)'
- en: '`TOKEN::Elevate/domainadmin`: To impersonate a token with domain admin credentials:'
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`TOKEN::Elevate/domainadmin`：模拟具有域管理员凭据的令牌：'
- en: '![](img/00130.jpeg)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00130.jpeg)'
- en: Pass the credential
  id: totrans-127
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 传递凭据
- en: 'Pass the credential is a simple and easy technique to discover an NTLM hashed
    password, without the pain of cracking it using a great deal of computing power.
    Although Windows doesn''t support passing the hash via networks, you can try **Pass-the-Ticket** (**PtT**)
    technique as a penetration tester, which is the process of grabbing a ticket and
    using it in a non-legitimate way. This graph show the NTLM authentication flow:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 传递凭据是一种简单易行的技术，可以发现NTLM散列密码，而无需使用大量计算资源进行破解。尽管Windows不支持通过网络传递散列，但您可以作为渗透测试人员尝试**Pass-the-Ticket**（**PtT**）技术，这是获取票证并以非合法方式使用它的过程。此图显示了NTLM身份验证流程：
- en: '![](img/00131.jpeg)'
  id: totrans-129
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00131.jpeg)'
- en: Dumping LSASS memory with Task Manager (get domain admin credentials)
  id: totrans-130
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用任务管理器转储LSASS内存（获取域管理员凭据）
- en: 'Memory dumping is a classic technique to recover some hidden information, including
    passwords and credentials. One of the Active Directory techniques is dumping LSASS
    memory using the Task Manager. Mimikatz has great capabilities, such as the features
    discussed before; one of them is dumping LSASS memory from the `LSASS.dmp` file,
    as shown:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 内存转储是一种经典技术，用于恢复一些隐藏的信息，包括密码和凭据。其中一种Active Directory技术是使用任务管理器转储LSASS内存。 Mimikatz具有很强的功能，比如前面讨论过的功能之一是从`LSASS.dmp`文件中转储LSASS内存，如下所示：
- en: '![](img/00132.jpeg)'
  id: totrans-132
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00132.jpeg)'
- en: 'If the operation succeeds, you will receive this message:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，您将收到此消息：
- en: '![](img/00133.gif)'
  id: totrans-134
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00133.gif)'
- en: Dumping Active Directory domain credentials from an NTDS.dit file
  id: totrans-135
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 从NTDS.dit文件中转储Active Directory域凭据
- en: 'Another dumping technique that threatens Active Directory environments is dumping
    credentials from an `NTDS.dit` file (Active Directory data is stored in the `NTDS.dit`).
    The Active Directory credentials can be extracted using a Python script called `secretdump.py`.
    It is built into the Kali Linux environment, or you can download it from this
    link ;[https://github.com/CoreSecurity/impacket](https://github.com/CoreSecurity/impacket):'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 威胁Active Directory环境的另一种转储技术是从`NTDS.dit`文件中转储凭据（Active Directory数据存储在`NTDS.dit`中）。可以使用名为`secretdump.py`的Python脚本提取Active
    Directory凭据。它内置于Kali Linux环境中，或者您可以从此链接下载：[https://github.com/CoreSecurity/impacket](https://github.com/CoreSecurity/impacket)：
- en: '[PRE3]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '![](img/00134.gif)'
  id: totrans-138
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00134.gif)'
- en: 'You can find the script in the `examples` folder, in addition to many other
    useful scripts:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在`examples`文件夹中找到该脚本，以及许多其他有用的脚本：
- en: '![](img/00135.gif)'
  id: totrans-140
  prefs: []
  type: TYPE_IMG
  zh: '![](img/00135.gif)'
- en: 'To retrieve the data, type:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 要检索数据，请键入：
- en: '[PRE4]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Summary
  id: totrans-143
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: This chapter discussed the most common real-world Active Directory threats.
    We went from the basic terminology and components of an Active Directory to discovering
    the latest Active Directory attacks, and the steps required to defend them. The
    next chapter will explore the world of Docker. You will learn how to build secured
    Dockerized environments.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 本章讨论了最常见的现实世界Active Directory威胁。我们从Active Directory的基本术语和组件开始，了解了最新的Active Directory攻击以及防御所需的步骤。下一章将探索Docker的世界。您将学习如何构建安全的Docker化环境。
