# 路由和路由器的漏洞

路由器是每个现代组织中的主要设备。在一个互联世界中，路由是交换信息的支柱，我们知道宝贵的信息每天都是攻击者的目标。本章将带您进行一个学习体验，从探索路由操作开始，并指导您通过利用路由协议和路由器的现实演示。

在这一章中，您将发现以下内容：

+   路由基础知识

+   利用路由协议——RIP、OSPF、EIGRP 和 BGP

+   利用现代路由器

+   如何防御三层攻击

# 路由基础知识

在前几章中，我们讨论了交换机。路由器和交换机都需要转发信息。即使有一些三层交换机，交换机也在第 2 层工作。路由器在第 3 层运行，即**网络层**：

![](img/00342.jpeg)

为了交换信息，路由器使用 IP 地址。它们维护着一个路由表。在路由方面，我们有两个不同的类别：

+   **静态路由**：在静态路由中，所有路由都由网络管理员手动设置。对于网络较小且不需要多余路由更新的情况来说，这是一个不错的决定，但当链接中断时会出现问题。

+   **动态路由**：在动态路由中，路由器从邻居那里快速学习网络拓扑，即使链接中断，但网络流量大于静态路由。因此，可能会发生网络开销。

路由可以进一步分类为有类和无类路由：

+   **有类路由**：您不能在路由更新中发送子网掩码。在网络中，我们有五个 IP 类：

| **类别** | **第一个范围** | **默认子网掩码** |
| --- | --- | --- |
| A | 1 – 126 | `255.0.0.0` |
| B | 128 – 191 | `255.255.0.0` |
| C | 192 – 223 | `255.255.255.0` |
| D | 224 – 239 | 多播 |
| E | 240 – 254 | 实验用途 |

+   **无类路由**：您可以在路由更新中发送子网掩码

为了在互联网上传输信息，路由器协议用于从一个网络到另一个网络进行信息路由。然而，我们需要区分两个不同的术语：路由协议和路由协议。路由协议用于从源到目的地路由信息，而路由协议是携带信息的有效载荷。换句话说，路由协议确定路径，更新路由表，并路由路由协议。有许多路由协议，例如以下：

+   **互联网协议** (**IP**)

+   **Internetwork Packet eXchange** (**IPX**):

![](img/00343.gif)

路由器使用各种算法来选择路由信息的路径，以提供高效、可靠、快速收敛和简单的数据交换。路由协议根据许多参数来完成这项工作：

+   带宽

+   延迟

+   成本

+   可靠性

+   跳数

+   **最大传输单元** (**MTU**)

以下表格描述了一些基于其度量标准的路由协议。我们将在后面更详细地讨论每个路由协议。我们使用这个表格来更好地理解如何选择路由协议：

| **路由协议** | **度量标准 ** |
| --- | --- |
| EIGRP | 带宽、延迟、负载、可靠性和 MTU  |
| RIPv2 | 跳数  |
| OSPF | 成本（带宽越高，成本越低）    |

根据上述度量标准，路由协议可以分为三大类：

+   **距离矢量协议**：当路由器在特定时间段内向其邻居发送其路由表时使用

+   **链路状态协议**：它们维护网络的整体图像；它们只交换路由更改

+   **混合协议**：它们是链路状态协议和距离矢量协议的组合

以下是路由中重要的术语：

+   **自治系统（AS）**：AS 是由共同实体或路由策略管理的一组网络设备

+   **内部网关协议（IGP）**：在使用 IGP 时，路由器在自治系统内与共享相同路由协议的其他路由器交换信息

+   **外部网关协议（EGP）**：如果需要从一个网络移动到另一个网络，例如互联网，需要在不同自治系统之间使用 EGP：

![](img/00344.jpeg)

# 利用路由协议

在本节中，我们将探讨许多路由协议以及如何利用它们的每一个，并学习保护您的网络所需的防御措施。

# 路由信息协议

**路由信息协议**（**RIP**）v1 是一种距离矢量协议。它每 30 秒发送一次路由表。RIP 使用跳数作为决策度量。这是一个旧协议，它在其第一个版本 RIPv1 中不能超过 15 跳。为了到达目的地，RIP 使用跳数最少的路径，但这并不那么有效，因为在某些情况下，有许多跳数更多但带宽更好的路径。例如，在以下网络中使用 RIPv1 时，流量将通过**路由 1**转发，甚至**路由 2**具有更大的带宽：

![](img/00345.jpeg)

在 RIPv1 的后继版本中考虑了许多修订。RIPv2 是 RIPv1 的增强版本。尽管 RIP 是一个分类路由协议，但 RIPv2 是无类别的，这意味着它在每个路由条目中包括掩码。因此，它支持**可变长度子网掩码**（**VLSM**）。RIPv2 还提供了一个简单的身份验证机制，因此只有在检查其真实性后，路由器才接受来自邻居路由器的数据包。还添加了一个标签，这是区分通过 RIP 学习的路由和其他协议的其他路由的附加信息。所有这些增强都很好，但跳数仍然是一个存在的问题，而在 RIPv2 中，可达跳数的最大值为 15。

要在路由器上配置 RIP，只需进入 RIP 配置模式：

```
Router(config)#router rip Router(config-router)#network <IP Address here>
```

在 RIP 操作和距离矢量路由中，可能会发生路由环路。路由环路发生在数据包在路由器之间反复传输时。这种环路可能会使网络失效。

为了防止路由环路，我们可以使用许多方法：

+   **分割地平线**：防止路由器将数据包发送回从中学习到该数据包的接口

+   **路由毒化**：这可以防止将数据包发送到网络中已经失效的路由

+   **毒性逆转**：通知邻居网关网关不再连接

+   **保持计时器**：设置为允许路由器在路由离线时恢复而不更新其路由表

+   **触发更新**：当度量值发生变化时发送部分更新

# RIPv1 反射 DDoS

RIPv1，正如我之前提到的，是一个旧的路由协议，但攻击者重新使用了它。例如，在 2015 年，Akamai 的 Prolexic 安全工程和研究团队（PLXsert）的研究人员发现了一次巨大的 DDoS 攻击，峰值达到 12.9 Gbps。攻击者使用了放大和反射的 DDoS 攻击。在这次攻击中，黑客制作了一个正常的 RIPv1 请求查询，并使用了伪造的 IP 地址，与目标相同。为了防御这种类型的攻击，建议使用 RIPv2 而不是旧版本。此外，您需要使用访问列表并阻止来自端口`520`的 UDP 数据包。

# 开放最短路径优先

**开放最短路径优先**（**OSPF**）是基于 RFC 1247 的开放标准链路状态协议。在 OSPF 操作中，路由器使用**链路状态广告**（**LSA**）向同一区域中的所有路由器发送信息。路由器使用**最短路径优先**（**SPF**）算法计算路径。这个算法有时被称为迪杰斯特拉算法。它需要很大的处理能力。OSPF 还支持 VLSM。

为了更好地管理，OSPF 使用分层拓扑结构。OSPF 由一个名为**区域 0**的骨干组成，连接其他较小的区域。当发生变化时，路由器会收到通知，获取 LSA 的副本，并更新**链路状态数据库**（**LSDB**）：

![](img/00346.jpeg)

在深入了解 OSPF 工作原理之前，让我们先看一些重要的路由器术语：

+   **内部路由器：**所有 OSPF 接口都属于同一个区域

+   **骨干路由器：**至少属于相同的区域 0 的接口

+   **自治系统边界路由器（ASBR）：**这连接自治系统

+   **指定路由器（DR）：**这维护子网的数据库

+   **区域边界路由器（ABR）：**至少一个 OSPF 接口属于区域 0，而另一个 OSPF 接口不属于区域 0

+   **备用指定路由器（BDR）：**这为指定路由器提供冗余：

![](img/00347.jpeg)

有三个 OSPF 表：

+   **邻居表：**这提供了关于邻居的信息

+   **拓扑表：**这提供了关于网络上路由的信息

+   **路由表：**这被认为是转发信息

以下过程描述了 OSPF 的工作原理：

1.  每个 OSPF 路由器通过将最高 IP 分配给环回接口来选择其路由器 ID（用于标识的 IP 地址）。如果不是这种情况（逻辑接口未定义），则将选择物理接口的最高 IP 地址作为路由器 ID。

1.  两个路由器向多播地址`224.0.0.5`发送 Hello 数据包。

1.  如果数据包具有相同的 Hello 间隔、死亡间隔和区域编号，则将形成邻居邻接

1.  路由器发送数据库描述数据包。具有最高路由器 ID 的路由器将成为主路由器，并开始数据库数据包交换。

1.  其中一个路由器从另一个路由器请求 LSA。

# OSPF 攻击

在过去的几年里，许多研究表明，使用 OSPF 的路由器容易受到各种类型的攻击。这是一个严重的问题，因为 OSPF 是许多自治系统中最常用的协议，包括许多企业。让我们了解一些针对 OSPF 协议的攻击。

# 伪装 LSA

这种攻击利用 RFC 2328 中的条件来检查两个 LSA 实例是否相同，基于三个标准：序列号、校验和值和年龄。因此，攻击者可以使用这些字段广告虚假 LSA，但在下一个有效实例中，因为路由器将 LSA 视为重复的，它将忽略它。

要执行伪装 LSA 攻击，请按照以下步骤：

1.  攻击者发送了一个伪造的 LSA

1.  攻击者发送了一个带有前面讨论过的相同三个字段的伪装 LSA

1.  路由器 1 发送了一个反击 LSA，路由器 2 会收到，但不会更新 LSA 数据库，而接收到的 LSA 是相同的。

1.  路由器 2 触发另一个反击

![](img/00348.jpeg)

# MaxAge LSAs

攻击者试图修改 LSA 的 MaxAge 以毒害路由表，向网络发送 LSA 洪泛，并甚至使网络流量陷入黑洞。为了防御 MaxAge LSAs，请确保反击陷阱可用。

# 远程虚假邻接

在远程虚假邻接攻击中，攻击者扮演路由器的角色，并利用路由器可以成功完成邻接设置的事实。通过启用 TTL 安全功能，可以避免这种攻击：

![](img/00349.jpeg)

# Seq++攻击

当攻击者滥用路由器并发送 LSAs 虚假信息和一个比当前序列号更高的序列号来妨害路由器时，就会发生 seq++攻击。为了防御这种攻击，可以使用反击陷阱。

# 持续中毒

CVE 2013-0149 中提到了持续中毒，并迫使路由器根据虚假 LSA 计算路由。

# 防御

还有许多其他防御机制可以避免 OSPF 攻击；以下是一些防御层：

+   **仅过境网络：**这些配置路由器以抑制后缀：

```
(config-router)#prefix-suppression
```

+   **使用隐藏接口**：有时被称为无编号接口：

```
(config-if)#ip unnumbered Ethernet 0
```

+   **启用 TTL 安全**：

```
(config-if)# Ip ospf ttl-security
```

+   **启用 MD5 加密支持**：

```
(config-if)# Ip Ospf message-digest-key 1 md5 ab$c1
```

+   反欺骗入口过滤：通过确保流量来自受信任的来源，阻止恶意流量

+   链路状态数据库校验和：这确保了 OSPF LSDB 的一致性

# 内部网关路由协议

内部网关路由协议（IGRP）是一种分类距离矢量路由协议。与 RIP 一样，IGRP 中的路由决策基于贝尔曼-福特算法，使用跳数。它不是一个开放标准。这是 Cisco 专有的。最大支持跳数为 255，默认值为 100。因此，对于大型公司来说，它比 RIP 更具可扩展性。而且，它易于配置：

```
Router(config)# router igrp <AS NUM HERE> Router(config-router)# network < NeT ID Here >
```

IGRP 在同一个自治系统中每 90 秒定期发送信息。这个计时器被称为**更新计时器**。如果更新时间超过 270 秒（无效计时器），那么它将无效，并且如果超过 360 秒（刷新计时器），它将从路由表中删除。IGRP 不支持认证，它的数据包可以被伪造。

# 增强内部网关路由协议

增强内部网关路由协议（EIGRP）是 IGRP 的增强版本。它使用双算法。路由器使用**Hello**请求与邻居建立连接，同时有五种消息类型（hello，update，ack，query 和 reply）。以下图表显示了 EIGRP 的工作原理：

![](img/00350.jpeg)

EIGRP 维护以下三个表：

+   **邻居表**

+   **拓扑表**

+   **路由表**

EIGRP 使用以下公式计算成本以选择路由：

*度量=带宽+延迟*

虽然 IGRP 不支持认证，但 EIGRP 增加了两个主要的安全功能——明文和 MD5 认证形式。如果未设置 MD5 认证，数据包很容易被嗅探。

# 边界网关协议

**边界网关协议**（BGP）基本上是互联网的工作原理。它是一种高度可扩展的路由协议，其当前版本基于 RFC 4271。它将信息存储在**路由信息库**（RIB）中。

如果您的公司需要连接到互联网服务提供商，可以选择多种可能性之一：

+   单主连接

+   双主连接：

![](img/00351.jpeg)

您还可以使用多种类型的连接连接到多个服务提供商：

+   **单个多宿主**：

![](img/00352.jpeg)

+   **双多宿主**：

![](img/00353.jpeg)

# BGP 攻击

BGP 是许多攻击的目标。让我们发现一些 BGP 威胁：

+   **虚假更新和前缀劫持**：这种攻击，有时被称为 BGP 劫持，发生在一个自治系统将流量路由到被劫持的自治系统时。

+   去聚合：在这种攻击中，一个地址块被划分为更具体的块和前缀。

+   **矛盾的广告**：在这种攻击中，攻击者将流量重定向到另一个自治系统。

+   **不稳定性**：当 BGP 会话反复超时时发生此攻击

# 利用路由器

之前，我们看到了如何利用路由协议。现在是时候学习如何利用现代路由器了。

# 路由器组件

像每个主要的网络设备一样，路由器由许多内部组件组成：

+   **CPU**：执行系统操作

+   **RAM**：用于存储指令

+   **ROM**：包含引导指令

+   闪存：包含 IOS

+   **NVRAM**：包含启动配置文件：

![](img/00354.gif)

# 路由器引导过程

为了引导，每个主要的路由器都经历多个步骤：

1.  首先，路由器执行 POST。

1.  它加载引导程序。

1.  它定位并加载操作系统。

1.  您可以选择进入设置模式或加载配置文件：

![](img/00355.gif)

# 路由器攻击

你已经了解了路由协议的威胁，现在我们将讨论针对路由器的攻击；即使硬件也面临许多具有挑战性的威胁：

+   DDoS 攻击

+   中间人攻击

+   路由器固件攻击

# 路由器利用框架

Routersploit 框架是一个用于利用路由器嵌入式系统的开源工具。您可以像往常一样使用`git clone`命令从此链接克隆它：

```
#git clone https://github.com/reverse-shell/routersploit
```

在使用之前，您需要安装一些依赖项，如`python-pip`：

![](img/00356.jpeg)

从 GitHub 克隆存储库到您的本地机器：

![](img/00357.jpeg)

克隆后，您可以在 CLI 中运行脚本来运行它：

```
# ./rsf.py
```

![](img/00358.jpeg)

要检查扫描仪，请键入以下内容：

```
# show scanners
```

![](img/00359.jpeg)

要检查凭据，请使用此命令：

```
# show creds
```

![](img/00360.jpeg)

# 摘要

本章是学习如何利用路由协议和路由器的完整指南。它在向您介绍路由协议的基础知识之后展示了真实世界的攻击技术。通过阅读本章，您已经获得了执行二层和三层攻击所需的知识，并具备了保护现代公司网络的正确思维和工具。在下一章中，我们将扩展我们的知识。此外，您还将学习如何保护物联网项目。
