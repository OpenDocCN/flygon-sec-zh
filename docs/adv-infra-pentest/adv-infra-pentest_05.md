# 第五章：Docker 开发

在学习了如何利用和保护 Active Directory 之后，让我们继续我们的旅程。本章将带您了解 Docker 容器的不同方面。在本章中，我们将从安装和配置 Docker 到利用它的基础知识。您还将通过学习如何构建完整的渗透测试实验室来一窥 Docker 容器的威力。

本章将涵盖以下主题：

+   Docker 威胁

+   Docker 突破

+   构建 Docker 渗透测试实验室

# Docker 基础知识

Docker 凭借其功能和有前途的服务在现代组织中迅速传播开来。这是一个开源项目，采用 Apache 2.0 许可证，允许开发人员打包他们的应用程序，而不必担心依赖问题，这在现代应用程序开发中产生了巨大影响。自 2013 年 3 月开发以来，它使开发人员能够专注于他们的产品，而不是浪费时间解决库问题。因此，Docker 的三个主要原则是：开发、交付和运行。这三个术语解释了 Docker 的主要概念。开发人员只需开发他们的应用程序，Docker 将处理其余部分，换句话说。它允许他们交付应用程序并在任何系统中部署它们。有关容器管理服务的更多信息，请访问项目官方网站[www.docker.com](http://www.docker.com)，如下所示：

![](img/00136.jpeg)

# 虚拟化

在深入探讨 Docker 的魔力之前，让我们回到过去，发现这一切是如何发生的以及为什么会发生。正如他们所说，需求是发明之母，许多年前技术人员面临着一个巨大的问题，被称为**冰山问题**；他们注意到组织只使用了其总技术资源的 30%。因此，提出了对资源进行优化的新方法的需求。这就是虚拟化这个术语出现的时候。虚拟化是基于将大规模资源分解为小资源的原理。这不仅是管理资源的好方法，而且隔离方法增加了一层保护，除了许多其他优点，例如：

+   降低成本（一个硬件上的多个主机）

+   简单管理

+   将资源分隔为逻辑上的独立虚拟机

要实现所有这些，需要一种名为虚拟机监视程序的软件。它是一种管理所有虚拟化方面的软件。它位于硬件和软件之间。虚拟机监视程序的基本作用是通过为操作系统分配所需的资源来管理资源。虚拟机监视程序有两种主要类型：

+   **类型 1**：这种类型的虚拟机监视程序直接在硬件的裸金属上运行，例如 VMware ESXi 和 Xen

+   **类型 2**：这种类型的虚拟机监视程序在操作系统上运行，例如 VMware Workstation 和 Sun VirtualBox

以下图表说明了两种类型的虚拟机监视程序之间的区别：

![](img/00137.jpeg)

# 云计算

近年来，云计算取得了惊人的增长。这种计算范式基于资源池，为客户提供可伸缩性和一长串的服务。它降低了成本，客户只支付他们使用的部分，提供电费或其他服务。换句话说，你按需付费。这种托管计算基础设施提供了不同的本地环境和服务，如存储、网络、应用程序、服务器和其他现代组织中所需的许多服务。我们可以将云计算模型分为以下三种模型：

+   **软件即服务**（**SaaS**）：客户可以访问托管在云中的最终用户应用程序

+   **平台即服务**（**PaaS**）：客户可以访问运行时环境和处理平台

+   基础设施即服务（IaaS）：客户可以访问虚拟化基础设施，包括服务器、存储和网络

以下图表简要描述了不同的模型：

![](img/00138.jpeg)

当我们谈论云计算时，组织可以从三种类型的云计算中受益：

+   公共云

+   私有云

+   混合云

# 云计算安全挑战

云中托管的信息是恶意攻击者的一个吸引人的目标。这就是为什么了解云安全问题并知道如何解决它们至关重要。根据 2017 年的云安全报告，超过 35 万名信息安全专业人员认为数据保护是采用云计算的头号关注点。在涉及云计算时，窃取敏感信息确实是一个严重的问题。从 2018 年开始，根据欧盟《通用数据保护条例》（GDPR），欧洲公司将面临对内部数据流的限制，并且如果他们不遵守新规定可能会被罚款数百万美元。加密始终是保护敏感云数据的一个很好的解决方案。弱身份验证和缺乏良好的身份管理是最大的云威胁之一。应该采用双因素身份验证机制，使黑客攻击变得更加困难。

# Docker 容器

Docker 容器是一种虚拟化形式，但开发人员不需要创建整个虚拟机，而是需要创建容器。换句话说，Docker 容器是没有创建虚拟机的麻烦的小型虚拟机。以下图表显示了虚拟机和 Docker 容器之间的区别：

![](img/00139.jpeg)

部署 Docker 容器将使开发人员能够降低成本，同时提供轻量级和可扩展的环境。

现在，让我们回到现在。要安装 Docker，我们将使用 Ubuntu 16.04（也可以使用 Kali Linux）机器进行演示。

首先，为官方 Docker 存储库添加 GPG 密钥：

```
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```

![](img/00140.jpeg)

将 Docker 存储库添加到 APT 源：

```
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" sudo apt-get update
```

![](img/00141.jpeg)

最后，安装 Docker：

```
sudo apt-get install -y docker-ce
```

![](img/00142.jpeg)

要检查 Docker 守护程序，可以使用`systemct1`命令：

```
sudo systemctl status docker
```

![](img/00143.jpeg)

有关 Docker 的更多信息，只需键入：

```
sudo docker info
```

![](img/00144.jpeg)

要获取 Docker 版本，请使用以下命令：

```
 sudo docker version
```

![](img/00145.jpeg)

典型的 Docker 命令格式是：

```
docker [option] [command] [arguments]
```

Docker 容器基于一组参数和文件系统的镜像。要检查 Docker 容器中的所有镜像，请键入：

```
 docker images
```

要运行一个镜像，使用`run`命令：

```
docker run <Image_Here>
```

Docker 还具有许多其他令人惊叹的功能。您可以使用 Docker 命令进行检查。以下是一些 Docker 命令：

+   `create`：创建新容器

+   `cp`：复制文件

+   `exec`：在容器中执行命令

+   `kill`：杀死正在运行的容器

+   `network`：检查 Docker 网络

+   `ps`：列出容器

+   `build`：基于 Dockerfile 构建容器

您可以通过键入`sudo docker`来检查所有可用命令：

![](img/00146.jpeg)

Dockerfile 是一个包含有关所需镜像的环境、文件和命令信息的文本文件。您可以使用任何普通文本编辑器进行编辑。以下是 elasticsearch（elasticsearch 是一个分布式 RESTful 搜索和分析引擎）的 Dockerfile 示例：

![](img/00147.jpeg)

要从 Dockerfile 构建镜像，请键入：

```
sudo docker build -t <image>
```

在演示中，我正在使用 Microsoft Azure 云平台。您可以从这里访问 Azure 官方网站[www.azure.com](https://azure.microsoft.com/en-us/?v=18.01)。因此，要构建一个镜像，我创建了一个 Azure 容器注册表并登录：

![](img/00148.jpeg)

单击“新建”并创建新的 Azure 容器注册表：

![](img/00149.jpeg)

要登录，我使用了`login`命令：

![](img/00150.jpeg)

为了检查我们是否成功部署了环境，我使用了`pull`命令，该命令从注册表中拉取图像或存储库，这是默认的 Microsoft Azure 图像：

```
docker pull microsoft/aci-helloworld
```

![](img/00151.jpeg)

要运行一个 Docker 镜像的实例容器，我们需要使用`run`命令。

要列出所有可用的容器，请使用`ps`命令：

```
sudo docker ps
```

![](img/00152.jpeg)

还有许多其他有用的容器命令，例如：

+   `top`：容器内的进程

+   `stop`：停止容器

+   `rm`：删除容器

+   `stats`：有关容器的统计信息

+   `pause`：暂停容器

Docker 容器基于以下工作流程的生命周期：

![](img/00153.jpeg)

# Docker 利用

您已经学会了如何安装和配置 Docker 容器。作为渗透测试人员，您需要了解 Docker 系统可能存在的安全问题和潜在威胁。根据 ClusterHQ 在 2015 年的数据，超过 60%的企业对 Docker 生产环境中的容器安全问题更为关注。Docker 容器面临许多安全问题。为此，渗透测试人员应考虑以下常见容器安全挑战和向量：

+   内核利用

+   **拒绝服务**（**DoS**）

+   容器越狱

+   被感染的镜像

+   数据窃取

# 内核利用

Docker 容器正在服务器上运行，但请记住有一个内核**。**实际上，所有进程共享相同的内核**。** Docker 具有许多功能，例如：

+   `chown`：更改任何文件的所有权

+   `fowner`：绕过需要进程 UID 和文件 UID 相同的操作的权限检查

+   `kill`：向非根进程发送终止信号

+   `setgid`：操纵进程 GID 和 GID 列表

+   `setuid`：操纵进程 UID

+   `net_raw`：允许使用原始和数据包套接字

要检查可用的功能，可以使用`pscap`命令。在此之前，您需要确保已安装`libcap-ng-utils`依赖项：

```
sudo apt-get install libcap-ng-utils
```

![](img/00154.jpeg)

**设置用户 ID**（**SUID**）在执行时和**设置组 ID**（**SGID**）在执行时在第二章中已经讨论过，*高级 Linux 利用*。它们是代表访问权限的两个术语。它们允许用户以与其所有者相同的权限执行二进制文件。这两个执行可能会被攻击者利用。这就是为什么您需要配置 Dockerfile 以禁用`setuid`权限。

要丢弃一个功能，使用选项：`--cap-drop =`。

例如，如果您想要丢弃`setgid`功能，可以运行以下命令：

```
docker run -d --cap-drop= mknod sudo docker run  --cap-drop=mknod  -t -i --volumes-from kali-data kali
```

![](img/00155.jpeg)

如果您想放弃所有功能，并且只想运行`setfcap`，请使用以下命令：

```
sudo docker run  --cap-drop=all --cap-add=setfcap  -t -i --volumes-from kali-data kali
```

作为安全措施，您需要通过修改 Dockerfile 来禁用`setuid`权限：

```
RUN find / -perm +6000 -type  f -exec chmod a-s {} \; \ || true
```

# DoS 和资源滥用

DoS 对 Docker 平台构成严重威胁。 Docker 面临许多 DoS 威胁，例如：

+   **待处理信号**

+   **Posix 消息队列**

+   **最大用户进程**

+   **最大文件**

为了防御这些攻击，我们需要：

+   使用`-m`选项分配内存限制：

```
docker run  -d -m  512m  <Image_Name>
```

+   使用`-c`选项限制 CPU 份额（默认为 1,024）：

```
docker run  -d -c  512  <Image_Name></strong>
```

Linux 内核中的另一个功能是使用`cgroups`（控制组）和`--cpu-set-cpus`标志来限制访问进程。您可以通过查看以下插图来更清楚地了解。

![](img/00156.jpeg)

# Docker 越狱

Docker 突破是绕过 Docker 容器的隔离层，转向主机并以授权方式访问信息的操作，以及试图获取更高权限（特权升级）的过程。Docker 突破可以通过一些不同的攻击向量来实现。第一个向量是之前讨论过的威胁：内核漏洞。滥用特权是另一种 Docker 突破技术。攻击者可以使用**容器间通信**（**icc**），允许容器相互通信。为了保护 Docker，你需要将 `-icc` 标志设置为 `false`，并配置 `iptables`：

```
docker -d --icc=false --iptables
```

Docker 在内核和容器之间扮演中间件角色。作为安全措施，它列入了内核调用的黑名单，但在 2015 年，有一个利用了一个未被阻止的内核调用 `CAP_DAC_READ_SEARCH` 的漏洞被提出，允许攻击者突破 Docker 隔离并潜入容器。这段代码被命名为 *the shocker*，并被作为突破演示进行了展示。你可以从这个 [`github.com/gabrtv/shocker`](https://github.com/gabrtv/shocker) 存储库克隆它的概念证明：

```
sudo git clone https://github.com/gabrtv/shocker
```

要测试利用漏洞，你只需要使用 `docker run` 命令：

```
root@Demo:~# docker run gabrtv/shocker
```

Docker 依赖于一个名为 Docker 守护程序的守护程序。它需要 root 权限。不受信任的用户构成严重威胁。为了获得 root 访问权限，攻击者可以使用 Docker 守护程序特权升级 Metasploit 模块：

```
msf > use exploit/linux/local/docker_daemon_privilege_escalation msf exploit(docker_daemon_privilege_escalation) > show targets ...targets... msf exploit(docker_daemon_privilege_escalation) > set TARGET <target-id> msf exploit(docker_daemon_privilege_escalation) > show options ...show and set options... msf exploit(docker_daemon_privilege_escalation) > exploit
```

# 被感染的镜像

在 Docker Hub 上，有超过 100,000 个预构建的容器和镜像。镜像是 Docker 容器的重要组成部分。实际上，容器是基于镜像构建的。这就是为什么你需要确认 Docker 镜像的真实性。镜像在互联网上随处可见，因此检查 Docker 镜像是必须的，因为你不希望在基础设施上运行任意程序。要验证 Docker 镜像，使用 `pull` 命令来验证镜像是否已签名。换句话说，如果拉取成功，则镜像已经验证。此外，确保你的设置与 `DOCKER_CONTENT_TRUST=1` 匹配。

# 数据库密码和数据窃取

在使用 Docker 时，你将每天处理密码和凭据。敏感信息和密码通常对攻击者非常有吸引力。此外，通过添加 `--read-only` 选项将文件系统设置为只读是一个明智的决定：

```
docker run --read-only  kali
```

# Docker bench security

Docker 提供了一个重要的脚本，名为 *Docker bench security*。它非常有用，可以收集和报告信息、警告和通过简单输出传递消息。你可以从其官方 GitHub 存储库 [`github.com/docker/docker-bench-security:`](https://github.com/docker/docker-bench-security) 克隆 bench：

```
sudo git clone https://github.com/docker/docker-bench-security
```

运行脚本，它将检查 Docker，感谢预定义的最佳实践。基本上，它基于 CIS Docker 社区版基准 v1.1.0：

```
./docker-bench-security.sh
```

![](img/00157.jpeg)

# 使用 Clair 进行 Docker 漏洞静态分析

Clair 是一个用于静态分析 Docker 容器中漏洞的开源项目。它允许渗透测试人员识别容器中的漏洞。你可以在其官方存储库 **[`github.com/coreos/clair`](https://github.com/coreos/clair)**[.](https://github.com/coreos/clair) 找到它的官方存储库：

Clair 项目由以下七个组件组成，如图所示：

+   内容检测器

+   数据存储

+   漏洞更新程序

+   RESTful API

+   通知器

+   客户端

+   漏洞数据库

![](img/00158.jpeg)

要构建一个 Dockernized 环境，请访问官方的 QUAY 网站 [`quay.io/`](https://quay.io/)：

![](img/00159.jpeg)

用所需的信息完成你的个人资料：

![](img/00160.jpeg)

创建一个新的存储库并选择其可见性：

![](img/00161.jpeg)

选择一个指向你的存储库的链接，例如，我使用了一个 Dockerfile：

![](img/00162.jpeg)

等待直到构建操作完成：

![](img/00163.jpeg)

如果你点击构建，你会看到 Dockerfile 的内容：

![](img/00164.jpeg)

等待几分钟来完成操作：

![](img/00165.jpeg)

要使用安全扫描程序，您需要一个企业账户：

![](img/00166.jpeg)

完成配置文件后，您将能够使用 Quay 安全扫描程序检查是否存在一些常见的 Docker 漏洞：

![](img/00167.jpeg)

# 构建一个渗透测试实验室

在之前的章节中，我们发现了 Docker 容器的强大功能，并学会了如何防御 Docker 的利用技术。让我们继续学习 Docker 容器的另一个方面。在本节中，您将学习如何基于 Docker 化环境构建一个渗透测试实验室。

我们开始使用 Kali Linux 发行版进行学习，所以我们将使用相同的发行版作为演示。

首先，让我们从 GitHub 克隆一个 Kali Linux 容器文件，使用`git clone`命令：

```
git clone https://github.com/offensive-security/kali-linux-docker.git
```

![](img/00168.jpeg)

打开 Dockerfile 并添加任何额外的配置：

![](img/00169.jpeg)

例如，我添加了`metasploit-framework`：

![](img/00170.jpeg)

现在，让我们使用`build`命令构建镜像：

```
sudo docker build -t kali ~/kali-linux-docker
```

![](img/00171.jpeg)

完成`pull`操作后，文件将被提取：

![](img/00172.jpeg)

为了保持数据并使其持久化，确保您为 Kali Linux 创建一个附加卷来保存您的文件，即使在重新启动系统后也是如此：

```
sudo docker create -v /tmp --name kali-data ubuntu
```

![](img/00173.jpeg)

```
sudo docker run -t -i --volumes-from kali-data kali
```

![](img/00174.jpeg)

现在你可以看到，你在实例中：

![](img/00175.jpeg)

哇！您的实验室现在已经准备好了。例如，如果您想运行 Metasploit，只需输入`msfconsole`：

![](img/00176.jpeg)

您还可以在 Docker 化环境中运行任何其他 Kali Linux 工具。通过这样做，您将结合 Docker 的灵活性和 Kali Linux 发行版的强大功能。

# 总结

本章是一个动手学习如何安装和配置 Docker 的经验。您了解了 Docker 环境的功能以及如何保护它。您还通过构建一个渗透测试实验室发现了 Docker 的强大之处。在下一章中，我们将清楚地了解如何保护**持续集成**（**CI**）服务器。
