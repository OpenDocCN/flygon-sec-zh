# 第四章：活动目录利用

在上一章中，我们探讨了如何利用组织的网络。我们从网络基础知识到发现最新的攻击方法。本章是您获取有关保护现代公司另一个重要技术系统的更多知识的下一步，即活动目录的下一步。我们将带您进入另一个层次的经验，按照一个精心设计的计划获取保护另一个环境所需的技能。

本章将涵盖以下主题：

+   学习活动目录和凯伯罗斯的概念

+   各种活动目录攻击的概述

+   学习哪些防御措施是有效的，以及它们如何缓解当前的攻击

# 活动目录

目录是一本按字母顺序或主题排序的列出个人或组织的书，包括姓名、地址和电子邮件等详细信息。换句话说，目录包含存储和结构化的对象，以便轻松访问和操作这些对象。在小规模组织中，如果您需要一个文件，您需要知道文件存储在哪个服务器上以及其完整路径。这在小型环境中有效，但在中大型公司中并不实用。因此，使用这种方式定位文件可能是一个真正的挑战。问题并不止于此，因为我们知道每个用户可能有许多访问凭据，如密码，这使得管理所有凭据变得困难，如果数量很大的话。这就是为什么需要一个目录服务来定位资源而不知道完整位置的原因。以下图表说明了一个分层目录的示例。

![](img/00097.jpeg)

微软活动目录提供了一个用于管理和解决这些挑战的目录服务。它还具有许多其他功能和能力。如今，活动目录在许多现代组织和机构中扮演着重要角色。沟通对于业务来说是一个关键的方面，而目录服务是一个明智的选择，因为它作为所有所需信息的单一容器点。活动目录基于客户端/服务器架构。以下图表显示了活动目录用户的一个示例。

![](img/00098.jpeg)

活动目录由以下四个组件组成：

+   活动目录森林：这是一个充当顶级容器的活动目录实例

+   活动目录域：这是管理定义的对象的集合

+   活动目录单元：您可以使用这些容器对象来以支持您的管理目的的方式排列其他对象

+   站点：这些是对象的容器

这个插图显示了活动目录森林和树的一个示例：

![](img/00099.jpeg)

# 单点登录

单点登录（SSO）是一种集中的方法，通常由认证服务器代表，允许许多系统以高效的方式进行身份验证，无需记住不同的密码。这种机制还通过提供单一的身份验证点来提高开发人员的生产力，因此他们不必担心这一部分，可以专注于更重要的任务。SSO 解决方案很棒，但正如前几章讨论的那样，单一点是攻击者的一个有吸引力的目标。以下图表显示了单点登录是如何简化身份验证的。

![](img/00100.jpeg)

# 凯伯罗斯身份验证

Kerberos 是 RFC 1510 下的认证协议，从本世纪初起就集成在 Windows 操作系统中。它是由**麻省理工学院**（**MIT**）在 Athena 项目下开发的。您可以通过其官方网站[`www.kerberos.org`](http://www.kerberos.org)进行检查和测试。Kerberos 环境包含三个部分：客户端、服务器和**密钥分发中心**（**KDC**），如下图所示。它提供了基于身份的密钥分发模型，由 Needham 和 Schroeder 提出：

![](img/00101.jpeg)

Kerberos 需要以下五个步骤才能进行：

1.  需要从认证服务器 KDC 请求认证

1.  KDC 发送一个使用发送者的秘密密钥加密的会话，以及一个使用票据授予服务加密的票据授予

1.  然后接收者解密会话并从票据授予服务请求权限

1.  如果会话有效，票据授予服务将发送一个客户端/服务器会话以授予对资源的访问权限，以及一个使用资源密钥加密的服务票据

1.  资源验证会话并授予客户访问权限

Kerberos 提供了一个很好的认证解决方案，但它将密钥以明文形式存储，这对组织构成了巨大的威胁。事实上，如果攻击者能够访问 KDC，他们将会破坏所有密钥。以下图表显示了 Kerberos 操作的不同步骤：

![](img/00102.jpeg)

# 轻量级目录访问协议

Active Directory 使用**轻量级目录访问协议**（**LDAP**）作为访问协议，依赖于 TCP/IP 协议栈。LDAP 支持 Kerberos 认证。

该协议使用倒置树层次结构，因此每个条目都有一个定义的位置。这种结构称为**目录信息树**（**DIT**）。**Distinguished Name**（**DN**）表示条目的完整路径。

以下图表表示用户（**通用名称**（**CN**））之间的不同交互。过滤组被限制在一些应用程序中：

![](img/00103.jpeg)

# PowerShell 和 Active Directory

PowerShell 是一个自动化框架，为系统管理员提供了许多执行任务的能力。它支持脚本语言。脚本中的每个命令都被称为**cmdlet**。您可以使用.NET 编程语言构建自己的 cmdlet。这里给出了一个解释：

![](img/00104.jpeg)

要查看一个森林，您可以使用`get-adforest` cmdlet，如下所示：

![](img/00105.jpeg)

要检查所有命令，请输入：`Get-Command`，如下所示：

![](img/00106.jpeg)

要检查域，您可以使用**`Get-ADDomain`**，如下所示：

![](img/00107.jpeg)

要检查森林的信任，您需要使用`get-adtrust`，如下所示：

![](img/00108.jpeg)

`get-aduser`用于获取指定用户，如下所示：

![](img/00109.jpeg)

PowerShell 在许多情况下被用作攻击平台，原因如下：

+   在内存中运行代码而不触及磁盘

+   它从另一个系统下载并执行代码

+   它与.NET 和 Windows API 进行交互

+   大多数组织都没有监视 PowerShell 活动。

+   `CMD.exe`通常被阻止，尽管 PowerShell 没有被阻止

# Active Directory 攻击

Active Directory 是攻击者的高调目标。由于其常见的架构（单一点），它是一个被攻击的系统。有许多 Active Directory 攻击。它是一个复杂的系统，因此以下小节将讨论来自不同攻击向量的不同类型的攻击。

# PowerView

侦察是信息安全中至关重要的一步。PowerView 是一个令人惊叹的侦察工具-它是一个域网络态势感知工具。您可以从[`github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1`](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)获取它。

像往常一样，克隆项目或简单地将其下载为`.zip`文件，如下所示：

```
git clone https://github.com/PowerShellMafia/PowerSploit.git
```

![](img/00110.jpeg)

PowerView 将使您能够执行许多侦察任务，如下所示：

+   **用户**：`Get-NetUser`

+   **组**：`Get-NetGroup`

+   **会话**：`Get-NetSession`

+   **GPO 位置**：`Find-GPOLocation`

+   **Active Directory 对象**：`Set-ADObject`

+   **Forests**：`Get-NetForest`

# Kerberos 攻击

如前几节所讨论的，Kerberos 是攻击者的高价值目标。但在深入研究 Kerberos 攻击之前，让我们先了解一些 PowerShell 的功能。

+   `get-adrootdse`：用于获取根对象，如下所示：

![](img/00111.jpeg)

+   `get-adforest`：用于检查 Active Directory forests，如图所示：

![](img/00112.jpeg)

+   `get-domaincontroller`：列出域控制器，如图所示：

![](img/00113.jpeg)

+   要获取 Active Directory 计算机，请使用`get-adcomputer`，如图所示：

![](img/00114.jpeg)

+   `get-adgroupmemberb`：获取 AD 组成员，如图所示：

![](img/00115.jpeg)

在深入研究 Active Directory 攻击技术之前，让我们先了解 PowerShell 作为攻击平台的一些功能。为此，我们将以 PowerShell Empire 作为演示，因为它是一个创建代理以妥协系统的绝佳工具：

```
#git clone https://github.com/EmpireProject/Empire
```

导航到`cd Empire/setup`并运行`./install.sh`脚本：

![](img/00116.gif)

等待安装完成：

![](img/00117.gif)

现在，您已经准备好使用 PowerShell Empire 了：

![](img/00118.gif)

如果您想生成一个代理，只需输入`usemodule external/generate_agent`：

![](img/00119.gif)

# Kerberos TGS 服务票证离线破解（Kerberoast）

如前几节所讨论的，Kerberos 使用票证进行身份验证，这得益于基于对称密钥密码学的受信任的第三方。最常见的攻击之一是 Kerberos TGS 服务票证离线破解，也称为 Kerberoast。使用这种技术，攻击者利用了大多数服务账户密码与域密码长度相同的事实。换句话说，您不需要暴力破解两个密码，因为大多数服务账户的密码不会过期。为了减轻这种攻击，您需要确保服务账户密码长度超过 25 个字符。这些是 TGS 的步骤

![](img/00120.jpeg)

# SPN 扫描

**服务主体名称**（**SPNs**）表示特定可发现服务的实例，例如 HTTP、LDAP 和 SQL。它们由 Kerberos 用于将服务与服务账户连接起来。您可以扫描这些服务，而无需执行端口扫描，因为 SPNs 可以表示为例如`MSSQLSvc/<domain>:3170`（`3170`是端口号）。

如果要使用 Microsoft 内置工具检查所有 SPN 服务，只需输入`setspn -Q */*`。

![](img/00121.jpeg)

要检索 AD 票证，请输入：`> $ticket = Get-TGSCipher -SPN <SPN_service_Here>`。

要破解票证，您可以使用约翰·里帕，这是一个众所周知的密码破解实用程序，如图所示：

![](img/00122.jpeg)

# SYSVOL 和组策略首选项中的密码

这种攻击比以前的攻击简单得多。要从域用户升级为域管理员，攻击者只需搜索域 SYSVOL DFS 共享中的 XML 文件。SYSVOL 是 Active Directory 中的域范围共享，所有经过身份验证的用户都可以读取。

# 14-068 Kerberos 漏洞在域控制器上

要利用 MS14-068 Kerberos 漏洞，您可以使用一个名为**PyKEK**的 Python 脚本，即 Kerberos 利用工具包，将 TGT 注入内存，如图所示。从 GitHub 存储库克隆 python 脚本[`github.com/bidord/pykek`](https://github.com/bidord/pykek)：

![](img/00123.gif)

现在，您可以使用以下格式的脚本：

```
ms14-068.py -u <userName>@<domainName> -s <userSid> -d <domainControlerAddr>
```

# 使用 Mimikatz 转储所有域凭据

转储凭据是信息安全中的一种经典技术。转储域凭据是众所周知的 Active Directory 技术之一。可以借助一个名为**Mimikatz**的强大实用程序来实现这一技术，该实用程序由 Benjamin Delpy 开发。您可以从其官方 GitHub 存储库[`github.com/gentilkiwi/mimikatz`](https://github.com/gentilkiwi/mimikatz)下载。

![](img/00124.jpeg)

要构建 Mimikatz，您需要使用 Visual Studio 进行构建。在我的情况下，我使用的是 Visual Studio 2015 专业版。如果您想直接使用二进制文件，请从[`github.com/gentilkiwi/mimikatz/releases/tag/2.1.1-20171203`](https://github.com/gentilkiwi/mimikatz/releases/tag/2.1.1-20171203)下载：

![](img/00125.jpeg)

以下截图显示了 Mimikatz 的主界面：

![](img/00126.jpeg)

现在，让我们发现一些 Mimikatz 命令和实用程序。

+   `CRYPTO::Certificates`：列出和检查证书，如下所示：

![](img/00127.jpeg)

+   `SEKURLSA::Ekeys`：检查 Kerberos 加密密钥（[`adsecurity.org/?page_id=1821#SEKURLSAEkeys`](https://adsecurity.org/?page_id=1821#SEKURLSAEkeys)）

+   `PRIVILEGE::Debug`：检查调试权限

+   `TOKEN::List`：检查所有系统令牌，如下所示：

![](img/00128.jpeg)

+   `TOKEN::Elevate`：检查域管理员，如下所示：

![](img/00129.jpeg)

+   `TOKEN::Elevate/domainadmin`：模拟具有域管理员凭据的令牌：

![](img/00130.jpeg)

# 传递凭据

传递凭据是一种简单易行的技术，可以发现 NTLM 散列密码，而无需使用大量计算资源进行破解。尽管 Windows 不支持通过网络传递散列，但您可以作为渗透测试人员尝试**Pass-the-Ticket**（**PtT**）技术，这是获取票证并以非合法方式使用它的过程。此图显示了 NTLM 身份验证流程：

![](img/00131.jpeg)

# 使用任务管理器转储 LSASS 内存（获取域管理员凭据）

内存转储是一种经典技术，用于恢复一些隐藏的信息，包括密码和凭据。其中一种 Active Directory 技术是使用任务管理器转储 LSASS 内存。 Mimikatz 具有很强的功能，比如前面讨论过的功能之一是从`LSASS.dmp`文件中转储 LSASS 内存，如下所示：

![](img/00132.jpeg)

如果操作成功，您将收到此消息：

![](img/00133.gif)

# 从 NTDS.dit 文件中转储 Active Directory 域凭据

威胁 Active Directory 环境的另一种转储技术是从`NTDS.dit`文件中转储凭据（Active Directory 数据存储在`NTDS.dit`中）。可以使用名为`secretdump.py`的 Python 脚本提取 Active Directory 凭据。它内置于 Kali Linux 环境中，或者您可以从此链接下载：[`github.com/CoreSecurity/impacket`](https://github.com/CoreSecurity/impacket)：

```
#git clone https://github.com/CoreSecurity/impacket
```

![](img/00134.gif)

您可以在`examples`文件夹中找到该脚本，以及许多其他有用的脚本：

![](img/00135.gif)

要检索数据，请键入：

```
secretdump.py -system /opt/system.hive -nt 
```

# 总结

本章讨论了最常见的现实世界 Active Directory 威胁。我们从 Active Directory 的基本术语和组件开始，了解了最新的 Active Directory 攻击以及防御所需的步骤。下一章将探索 Docker 的世界。您将学习如何构建安全的 Docker 化环境。
