# 第一章。规划和确定成功的渗透测试

本章介绍了测试复杂和硬化环境所需的规划和准备工作。您将了解以下主题：

+   高级渗透测试介绍

+   如何成功地确定测试范围

+   测试之前需要发生什么

+   设定您的限制 —— 没有什么是永恒的

+   行动规划

+   使用 MagicTree 进行详细管理

+   使用 MagicTree 将结果导出为各种格式

+   使用 Dradis 进行团队数据收集和信息共享

+   在 Dradis 中创建可重用模板

# 高级渗透测试介绍

渗透测试对于确定环境的真实攻击面是必要的。它经常会与漏洞评估混淆，因此重要的是应该向客户充分解释两者之间的区别。

## 漏洞评估

漏洞评估对于发现环境中的潜在漏洞是必要的。有许多工具可用于自动化此过程，以便即使是经验不足的安全专业人员或管理员也能有效地确定其环境的安全状况。根据范围，可能还需要额外的手动测试。通常不会在正常的漏洞评估工作中全面利用系统和服务。系统通常会被枚举并评估漏洞，测试通常可以在有或没有认证的情况下进行。大多数漏洞管理和扫描解决方案提供详细的可操作报告，详细说明缓解策略，如应用缺失的补丁或更正不安全的系统配置。

## 渗透测试

渗透测试通过引入利用来扩展漏洞评估工作

### 提示

在进行渗透测试时，意外导致无意的服务拒绝或其他故障的风险比进行漏洞评估时要高。在一定程度上，这可以通过适当的规划和对测试过程中涉及的技术的充分理解来减轻。因此，渗透测试人员不断更新和完善必要的技能是很重要的。

渗透测试使企业能够了解所采用的缓解策略是否按预期运行；它基本上消除了猜测。渗透测试人员将被要求模拟攻击者可能尝试的行动，并将面临证明他们能够妥协目标关键系统的挑战。最成功的渗透测试结果是渗透测试人员能够毫无疑问地证明发现的漏洞将导致重大收入损失，除非得到妥善解决。想象一下，如果您能够向客户证明世界上几乎任何人都可以轻松访问他们最机密的信息，您将产生的影响！

渗透测试需要比漏洞分析更高的技能水平。这通常意味着渗透测试的价格将远高于漏洞分析的价格。如果您无法渗透网络，您将确保您的客户系统在您所知道的最好的情况下是安全的。如果您想晚上能够安心入睡，我建议您在验证客户安全性方面超越寻常。

## 高级渗透测试

一些环境比其他环境更安全。您将面临使用以下内容的环境：

+   有效的补丁管理程序

+   托管系统配置硬化策略

+   多层 DMZ

+   集中式安全日志管理

+   基于主机的安全控制

+   网络入侵检测或预防系统

+   无线入侵检测或预防系统

+   Web 应用程序入侵检测或预防系统

有效使用这些控制显著增加了渗透测试的难度。客户需要完全相信这些安全机制和程序能够保护其系统的完整性、机密性和可用性。他们还需要了解，有时攻击者能够入侵系统的原因是由于配置错误或设计不当的 IT 架构。

请注意，安全中没有万灵药。作为渗透测试人员，我们的职责是从问题的各个角度进行审视，并让客户意识到任何允许攻击者对其业务产生不利影响的事情。

高级渗透测试超越了标准渗透测试，利用了最新的安全研究和可用的利用方法。目标应该是证明敏感数据和系统甚至受到有针对性的攻击的保护，如果不是这样，就要确保客户得到适当的指导，了解需要做出哪些改变。

### 注意

渗透测试是对当前安全状况的快照。应该定期进行渗透测试。

许多利用方法文档不完善，使用起来很困难，并且需要实际操作经验才能有效地执行。在 DefCon 19 上，Bruce "Grymoire" Barnett 做了一个关于“欺骗性黑客”的出色演讲。在这个演讲中，他讨论了黑客如何使用许多与魔术师使用的相同技术。我相信这正是渗透测试人员必须假定的坚韧性。只有通过奉献、努力、实践和愿意探索未知领域，渗透测试人员才能模仿野外恶意黑客可能尝试的有针对性攻击类型。

通常情况下，您将需要作为团队的一部分参与这些渗透测试，并且需要知道如何使用可用的工具，使这个过程更加耐用和高效。这是今天渗透测试人员面临的又一个挑战。当您的范围限制您进行非常有限的测试时，独自工作根本不是一个选择。

在某些情况下，公司可能会使用非标准的方法来保护其数据，这会使您的工作变得更加困难。他们的安全系统的复杂性与彼此协同工作可能实际上是他们安全策略中最薄弱的环节。

### 注意

找到可利用的漏洞的可能性与被测试环境的复杂性成正比。

# 测试开始之前

在我们开始测试之前，有一些要考虑的要求。您需要确定测试的适当范围、时间框架和限制、测试类型（白盒、黑盒），以及如何处理第三方设备和 IP 空间。渗透测试执行标准（PTES）将这些范围项目列为“前期交互”阶段的一部分。我强烈建议您在此阶段查看：[`www.pentest-standard.org/index.php/Pre-engagement`](http://www.pentest-standard.org/index.php/Pre-engagement)。

### 注意

尽管本书不直接遵循 PTES，我将尝试指出 PTES 的相关部分。

## 确定范围

在准确确定测试范围之前，您需要收集尽可能多的信息。在开始测试程序之前，完全理解以下内容至关重要：

+   谁有权批准测试？

+   测试的目的是什么？

+   测试的拟议时间是多久？是否有任何限制可以进行测试的时间？

+   您的客户是否理解漏洞评估和渗透测试之间的区别？

+   您是否将与 IT 安全运营团队合作进行此测试？您是否在测试他们的有效性？

+   社会工程是否被允许？拒绝服务攻击呢？

+   您是否能够测试用于保护服务器、关键数据存储或其他需要物理访问的安全措施？例如，撬锁、冒充员工进入建筑物，或者一般地进入普通非关联人员不应该进入的区域。

+   在测试之前，您是否被允许查看网络文档或了解网络架构以加快进展？（不一定建议这样做，因为这可能会对您的发现的价值产生怀疑。大多数企业并不希望这些信息很容易被您确定。）

+   您被允许测试哪些 IP 范围？未经适当许可进行扫描和测试是违法的。在确保这些设备和范围确实属于您的客户时，务必非常谨慎，否则您可能面临法律后果。

+   公司的物理位置是什么？如果社会工程被允许，这对您作为测试人员更有价值，因为它确保您在测试时处于被授权的建筑物内。如果时间允许，您应该让客户知道您是否能够公开访问这些信息，以防他们误以为他们的位置是秘密的或难以找到的。

+   如果出现问题或者测试的初始目标已经达到，该怎么办？您是否会继续测试以找到更多条目，还是测试结束了？这部分非常关键，与客户为什么要进行渗透测试的问题有关。

+   您需要了解的法律影响，比如不同国家的系统，等等？在进行渗透测试时，不同国家的法律并不相同。

+   一旦利用了漏洞，是否需要额外的许可？这在对分段网络进行测试时很重要。客户可能不知道您可以使用内部系统作为枢纽点深入他们的网络。

+   数据库应该如何处理？您是否被允许添加记录、用户等？

此清单并非所有内容都包括在内，您可能需要根据客户的要求添加项目到清单中。大部分数据可以直接从客户那里收集，但有些需要由您的团队处理。

如果存在法律问题，建议您寻求法律建议，以确保您充分了解测试的影响。在开始测试时，最好是有太多信息而不是不够。无论如何，您都应该自行验证您收到的信息是否准确。您不希望发现您一直在访问的系统实际上并不属于客户的权限范围！

### 注意

在访问任何客户系统之前，获得适当的**书面**授权非常重要。未能这样做可能会导致法律诉讼，甚至可能入狱。要正确判断！在进行渗透测试时，您还应该考虑到错误和遗漏保险是必需的。

## 设定限制——没有什么是永恒的

如果您想成功进行渗透测试，设定适当的限制是必不可少的。您的客户需要了解所涉及的全部后果，并应该知道如果需要超出合同范围内列出的任何额外服务，可能会产生额外费用。

确保为您的服务设定明确的开始和结束日期。明确定义参与规则，并包括可能需要测试的 IP 范围、建筑物、时间等。如果不在您的参与规则文件中，就不应该进行测试。会议应该在测试开始之前预先定义，并且客户应该清楚地知道您的交付成果是什么。

### 参与规则文件

每次渗透测试都需要以所有相关方都必须具备的参与规则文件开始。这份文件至少应包括以下几项内容：

+   **适当人员的适当权限**。

+   测试的开始和结束日期。

+   将执行的测试类型。

+   测试的限制。

+   允许进行哪种类型的测试？DDOS？全面渗透？社会工程？这些问题需要详细解决。

+   可以进行侵入性测试和不引人注目的测试吗？

+   您的客户是否希望在测试后进行清理，还是这是一个阶段性环境，在测试完成后将被完全重建？

+   要测试的 IP 范围和物理位置。

+   测试结束后如何传输报告。（使用安全的传输方式！）

+   测试期间将使用哪些工具？不要局限于只使用一个特定的工具；提供主要工具集的清单可能会有益，以避免将来混淆。例如，我们将使用最新版本的 BackTrack 套件中的工具。

+   **让您的客户知道在测试期间发现的任何非法数据将如何处理：**在通知客户之前应该先联系执法部门。在进行测试之前，请确保充分了解相关法律。

+   **如何处理敏感信息：**您不应该下载敏感的客户信息；有其他方法可以证明客户的数据没有得到保护。当受监管的数据成为问题时，这一点尤为重要。

+   您团队和您测试的公司的关键员工的重要联系信息。

+   您将采取什么措施来确保客户的系统信息不会保留在测试期间使用的不安全的笔记本电脑和台式机上？在测试结束后，您是否需要正确地清除您的设备？您计划如何处理收集到的信息？是否要将其保存在某个地方以备将来测试？在开始测试之前，确保这些问题已经得到解决，而不是在测试之后。

参与规则应包含确定评估范围所需的所有细节。在起草参与规则之前，应该已经回答了所有问题，以确保在测试时不会有误解。您的团队成员在执行测试时需要随身携带一份签署的文件副本。

想象一下，您被聘请来确认客户的无线网络的安全状况，您正在私人财产的停车场上悄悄潜行，手持巨大的定向 Wi-Fi 天线和一台笔记本电脑。如果有人目睹了您的行为，他们可能会感到担忧并报警。您需要携带一些文件证明您有合法的理由在那里。这是一次非常有用的时候，您需要客户领导的联系信息！

# 行动计划

一旦开始测试，您将需要做好准备。这包括准备行动计划，所有设备和脚本都正常运行，当然还需要一些记录所有步骤和操作的机制。这将为您和其他团队成员提供一个参考。现在你可能记得绕过防火墙的步骤，但是四个月后当你面临同样的挑战时呢？做好笔记对于成功的渗透测试至关重要。

为了本书的目的，我们将回顾使用 VirtualBox 安装 BackTrack 套件的过程，这是由 Oracle 根据 GNU 通用公共许可证（GPL）提供的。这个开源虚拟化工具可以用于在 Linux、OSX 和 Windows 等平台上构建你的虚拟测试环境。

### 提示

我强烈推荐使用 BackTrack OS 进行测试。如果你对 BackTrack 不熟悉，PacktPub 最近出版了一本名为*BackTrack 4: Assuring Security by Penetration Testing*的优秀书籍。这本书将详细介绍 BackTrack 套件的各种安装方法，并全面审查其中的所有工具。如果你对渗透测试还很新，阅读这本书很可能会有所帮助。由于*Advanced Penetration Testing of Highly Secured Environments*的重点是高级攻击方法，我们不会涵盖 BackTrack 套件中的所有工具。

你也可以在 BackTrack 论坛网站上找到更多关于 BackTrack 的信息，网址为：[`www.backtrack-linux.org/forums/backtrack-5-forums/`](http://www.backtrack-linux.org/forums/backtrack-5-forums/)。BackTrack 的开发人员非常专业，并为安全社区贡献了大量时间和精力。

## 安装 VirtualBox

目前，Windows 操作系统仍然是最常见的桌面操作系统，因此我将详细介绍在 Windows 7 上安装 VirtualBox。然而，对于所有操作系统来说，安装都很简单，所以你不应该因为在你喜欢的平台上安装而退缩。

### 注意

我们在整本书中几乎使用的每个工具都是基于 Linux 或 FreeBSD 的。因为许多人将 Windows 作为他们的主要桌面操作系统，我们将提供在 Windows 7 上安装 VirtualBox 的说明。一旦你安装并运行起来，你就可以跟着进行，无论使用哪种操作系统作为虚拟测试环境的主机。

1.  访问[`www.virtualbox.org/`](http://www.virtualbox.org/)。

1.  点击页面左侧的**下载**链接。

1.  下载 Windows 主机 x86/amd64 的最新版本**VirtualBox**。

1.  开始安装（根据你的系统配置，你可能需要以管理员身份开始安装）。

1.  在初始设置窗口点击**下一步>**。

1.  确保安装位置是你想要安装程序的位置，并且选择所有要安装的选项，然后点击**下一步>**。

1.  选择你喜欢的桌面快捷方式选项，然后点击**下一步>**。

1.  如果你想使用之前选择的设置进行安装，请点击**是**。

1.  点击**安装**以继续安装。这一步可能需要一些时间，具体取决于你的系统性能。你可能会被要求安装设备软件，此时你需要点击弹出窗口中的**安装**。

### 提示

这可能会发生多次；在我的情况下，它弹出了四次，然后我的防火墙通知我请求权限将额外的网络添加到我的防火墙设置中。

1.  点击**完成**以打开 Oracle VirtualBox Manager。

你现在已经安装并运行了 VirtualBox，并且可以开始创建虚拟测试环境的第一步，以便在整本书中进行实践！

## 安装你的 BackTrack 虚拟机

### 注意

在讨论攻击和防御策略时，我们将参考这些安装说明中使用的系统和虚拟网络名称。

有两种主要方法可以将 BackTrack 安装为虚拟机。一种是使用 LiveCD ISO 像在物理机上一样安装 BackTrack；另一种是下载预先准备好的虚拟机。这是在 BackTrack-Linux.org 下载站点上看到的 VMWare 镜像选项。

我们将使用 LiveCD 进行 BackTrack 安装，因为这样可以灵活确定硬盘大小和其他设置。使用 ISO 的另一个好处是，您将知道如何将 BackTrack 安装到将来的物理机器上。如果使用整个磁盘安装，安装过程将与虚拟机安装非常相似。

BackTrack 可以在[`www.backtrack-linux.org/`](http://www.backtrack-linux.org/)下载。请务必根据 32 位或 64 位架构选择适当的 ISO 版本。如果您的主机机器上没有 64 位操作系统运行，您将无法在客户机实例上运行 64 位操作系统。如果在主机上运行 64 位操作系统，则可以选择 32 位或 64 位作为客户机操作系统。

### 注意

主机是您安装 VirtualBox 的主要操作系统。使用 VirtualBox 安装的虚拟化操作系统映像将被称为客户机。

### 为 BackTrack 准备虚拟客户机

1.  一旦获得 BackTrack ISO，就是开始的时候了。

1.  通过从**开始**菜单中选择它来启动 Oracle VM VirtualBox Manager。

1.  点击左上角的**新建**图标。

1.  在**新建虚拟机向导**屏幕上点击**下一步**按钮。

1.  您将被提示输入客户机的名称。输入`BT5_R1_Tester1`，选择**Linux**作为**操作系统**，**Linux 2.6**（**32 位**或**64 位**）作为**版本**，然后点击**下一步**。![为 BackTrack 准备虚拟客户机](img/7744_01_01.jpg)

1.  在**内存**屏幕上，您需要使用滑块选择**基本内存大小**。如果您的系统内存超过 2GB，您应该为此系统使用至少**512MB**。您仍然可以使用较少的内存来跟随示例，但可能会遇到一些系统滞后。选择完内存大小后，点击**下一步**。

1.  虚拟硬盘：确保选择了**启动盘**复选框，并且也选择了**创建新硬盘**单选按钮，然后点击**下一步**。

1.  一个新的弹出窗口将打开，应选择**VDI（VirtualBox 磁盘映像）**。点击**下一步**。

1.  在要求选择**虚拟磁盘存储详细信息**时，选择**动态分配**，然后点击**下一步**继续安装。

1.  现在是选择存储虚拟客户机文件的**位置**的时候。选择**位置**文本输入字段右侧的文件夹图标。

1.  创建并选择一个名为`APT_VirtualLab`的新文件夹，我们将在其中存储专门用于此实验室的所有客户机。确保您选择的驱动器有足够的空间来存储多个虚拟机。

1.  将虚拟磁盘的**大小**至少设置为 10 GB。我们将在整本书中广泛使用这台机器，尽管从技术上讲可能，但最好避免调整 VDI 的大小。点击**下一步**继续。![为 BackTrack 准备虚拟客户机](img/7744_01_02.jpg)

1.  验证**摘要**页面上的数据是否准确，并点击**创建**。

1.  如果一切顺利，您将再次看到 VirtualBox Manager 应用程序窗口，其中包含您的新客户机。![为 BackTrack 准备虚拟客户机](img/7744_01_03.jpg)

1.  我们希望为这台机器提供两个网络适配器。选择**BT5_R1_Tester1**，然后点击**设置**，接着点击左侧菜单栏上的**网络**选项。![为 BackTrack 准备虚拟客户机](img/7744_01_04.jpg)

1.  点击**适配器 2**，选择**启用网络适配器**复选框。

1.  **附加到：**下拉框需要设置为**内部网络**。

1.  将**名称：**文本框更改为**Vlab_1**，然后点击**确定**。

现在，您已完成了在虚拟磁盘上安装操作系统所需的准备工作。当准备其他操作系统时，这个过程并不会有太大变化，而 VirtualBox 使许多配置更改变得微不足道。有时，您可能希望调整客户机的设置以提高其性能。尝试一些设置将让您了解这个工具的强大之处。

### 注意

您可以随时更改虚拟机的设置。但是，有时您需要在更改之前关闭客户机。

### 在虚拟磁盘映像上安装 BackTrack

现在虚拟机已安装，我们准备安装 BackTrack。感谢 Backtrack-Linux.org 团队的辛勤工作，这个过程简单而不复杂。

1.  打开**VM VirtualBox Manager**，在屏幕左侧选择您的**BT5_R1_Tester1**虚拟机。单击应用程序顶部栏上的大**启动**图标以启动虚拟机实例。

1.  您的机器现在将启动。由于我们尚未选择要用于引导系统的映像，因此我们需要使用菜单选项来进行选择，这些选项将出现在初始系统初始化之前。

1.  您可能会收到一个信息窗口，解释**自动捕获键盘**选项已打开。单击**确定**按钮以继续系统初始化。

1.  **首次运行向导**只会在第一次启动虚拟机时出现。它允许您轻松选择要引导的 ISO。

1.  也可以在**虚拟机设置**的**存储**类别中添加安装媒体。

1.  单击**下一步**继续。![在虚拟磁盘映像上安装 BackTrack](img/7744_01_05.jpg)

1.  在**选择安装媒体**屏幕上，您需要单击**媒体源**栏右侧的文件夹图标。然后，您需要浏览到下载 BackTrack ISO 的文件夹，并选择它，使其显示在以下截图中。准备好后，单击**下一步**。![在虚拟磁盘映像上安装 BackTrack](img/7744_01_06.jpg)

1.  验证您的摘要信息，然后单击**开始**启动机器。如果机器在`boot:`命令处停顿，请按*Enter*，系统将继续引导。允许其完全加载 LiveCD（默认引导选项）。您可能会收到**键盘主机捕获**消息。根据需要单击**确定**。

1.  **在** `root@root:~#` **提示处**输入** `startx` **。**![在虚拟磁盘映像上安装 BackTrack](img/7744_01_07.jpg)

1.  现在，我们在虚拟机上运行了 BackTrack ISO，我们需要添加持久性，以便我们所做的更改保留下来。单击**安装 BackTrack**图标开始短暂的安装过程：![在虚拟磁盘映像上安装 BackTrack](img/7744_01_08.jpg)

1.  选择您喜欢的语言，然后单击**前进**。

1.  让安装程序知道您所在的地区。这将影响您的时间设置，并且还将有助于选择距离您更近的服务器进行更新。单击**前进**继续。

1.  选择您喜欢的键盘布局，然后单击**前进**。

1.  为了简单起见，我们将使用整个可用磁盘空间而不是手动分区。选择**擦除并使用整个磁盘**单选按钮，然后单击**前进**。

1.  单击**安装**以初始化更改。这个阶段可能需要几分钟才能完成。![在虚拟磁盘映像上安装 BackTrack](img/7744_01_09.jpg)

1.  安装完成后，您需要重新启动系统。单击**立即重启**按钮，然后卸载 ISO。您需要选择**设备** | **CD/DVD 设备** | **{您的 BackTrack ISO 映像名称}**。这将在系统重新启动之前弹出 ISO 映像。按*Enter*重新启动。![在虚拟磁盘映像上安装 BackTrack](img/7744_01_10.jpg)

# 探索 BackTrack

恭喜，您现在拥有最强大的渗透工具集之一，可以随时使用。整本书都致力于介绍 BackTrack Linux 平台中的出色工具集。这个工具包肯定会为您在实地工作中节省大量时间。

### 登录

默认安装的登录信息为：

```
bt login: root
bt password: toor

```

### 更改默认密码

登录后，我们应该尽快更改默认密码。您可以通过在提示符下输入`passwd`并用您自己的安全密码替换示例中的`1NewPassWordHere`来做到这一点。

```
root@bt:~# passwd
Enter new UNIX password: 1NewPassWordHere!
Retype new UNIX password: 1NewPassWordHere!
passwd: password updated successfully
root@bt:~# 

```

### 提示

如果您遇到屏幕分辨率问题或遇到其他小问题，您可能希望安装 VirtualBox Guest Additions。在客户机运行时，单击**设备**，然后单击**安装增强功能**以启动此安装。安装后，您需要重新启动 BackTrack。

### 更新应用程序和操作系统

您的虚拟机网络卡当前配置为允许您的 BackTrack 安装使用 NAT 访问主机系统的互联网连接。为了更新操作系统，您应该熟悉一些命令。

### 注意

如果您没有互联网连接，系统将无法更新。

需要记住的一件事是，BackTrack 基于 Ubuntu，与任何其他操作系统一样，需要打补丁以确保应用最新的安全补丁。同时，保持应用程序的最新状态也很重要，以便利用最新的测试技术和工具！

默认情况下，BackTrack 设置为仅使用 BackTrack 存储库。如果好奇，您可以查看`/etc/apt/sources.list`文件了解这些存储库是什么。

需要初始化的第一个命令是**高级打包工具（APT）**更新功能。这将同步软件包索引文件，以确保您获得有关最新软件包的信息。在安装任何软件或更新已安装的软件包之前，应始终使用更新功能。

```
# apt-get update 

```

完成此更新后，您可以初始化 apt 的升级命令。所有已安装的软件包将更新到存储库中找到的最新版本。

```
# apt-get upgrade 

```

还有另一个 apt 命令用于更新系统。`dist-upgrade`将 BackTrack 升级到最新版本。例如，如果您正在运行 BackTrack 4，并希望升级而不是下载和安装最新版本的 BackTrack 5，您可以通过输入以下命令来实现：

```
# apt-get dist-upgrade 

```

### 注意

您无需担心依赖关系；所有这些都将由`apt-get dist-upgrade`命令自动处理！

现在您的系统已经更新，是时候启动图形用户界面（在提示符下再次输入`startx`）并查看一下您的新工具包。在本书的过程中，我们将广泛使用这些工具。

### 注意

在执行`apt-get dist-upgrade`时，跟着重启可能是有益的。这适用于任何内核升级。

# 安装 OpenOffice

有时您可能需要打开电子表格来查看 IP 范围，或快速查看您的 ROE。有时，甚至可以让您的数据收集工具直接从 BackTrack 内部将数据导出到文字处理器中。如今有许多开源替代 Microsoft Word 的选择，OpenOffice 就是其中之一。它已被许多企业采用，并且可以输出各种文件格式。要从 BackTrack 内部安装 OpenOffice，只需打开终端会话并键入：

```
# apt-get update
# apt-get install openoffice.org 

```

通过按下*Y*接受下载，几秒钟后，您将成功地将一个非常强大的办公套件添加到您的 BackTrack 工具集中。

# 有效管理您的测试结果

在执行渗透测试过程中将使用各种工具。几乎所有这些工具都会产生您希望保留的输出。一个主要挑战是能够将所有这些数据合并到一个地方，以便可以轻松地将其用于通过为您提供数据的整体视图来增强测试工作，并缩短报告生成阶段。

## MagicTree 简介

MagicTree 是由 Gremwell 创建的 Java 应用程序，是一个受到积极支持的数据收集和报告工具。它使用树结构中的节点来管理您的数据。这种分层存储方法在管理主机和网络数据时特别高效。MagicTree 的真正力量在于尝试分析数据时才能释放出来。例如，在扫描大型网络时查找所有 IIS Web 服务器只需几秒钟。

除了提供出色的数据收集机制外，MagicTree 还可以根据您选择的优先级创建可操作的报告。使用 MagicTree 生成的报告是完全可定制的，并且可以轻松定制以满足您的报告要求。您甚至可以使用它将数据导出到 OpenOffice！

MagicTree 允许导入 XML 数据，并为许多流行格式提供 XSLT 转换，例如：

+   Nessus（v1 和 v2）

+   Nikto

+   Nmap

+   Burp

+   Qualys

+   Imperva Scuba

+   OpenVas

请注意，MagicTree 的开发人员是渗透测试人员。当探索 MagicTree 时，很明显他们了解测试人员每天面临的挑战。其中一个例子是他们提供的功能，允许您为该工具创建自己的 XSLT 转换。如果使用提供的转换无法导入您需要的 XML 数据，您可以自己制作！

### 启动 MagicTree

与本书中使用的大多数工具一样，这个工具已经预装在 BackTrack 5 R1 上。

从 BackTrack 启动 MagicTree，我们选择**应用程序** | **BackTrack** | **报告工具** | **证据管理** | **magictree**。在显示启动画面和许可协议后（需要接受许可协议），您将看到主应用程序工作区。

![启动 MagicTree](img/7744_01_11.jpg)

### 添加节点

要添加一个节点，按下*Ctrl+N*并在**输入**弹出框中键入`127.0.0.1`。这将在树中填充两个额外的节点。一个用于**testdata**，一个用于主机**127.0.0.1**。

在存储数据时有几种可用的节点类型。要能够有效地使用该工具，您需要熟悉各种节点类型：

+   **分支节点：**用于创建树的结构，在使用此节点类型时确保不包含空格。

+   **简单节点：**最常见的节点类型，用于存储简单数据，如 IP 地址或完全合格的域名。

+   **文本节点：**在节点内存储文本数据，可用于提供有关您的测试或希望出现在报告中的数据的信息。

+   **数据节点：**在项目文件夹中存储非图像和非 XML 附件。

+   **XML 数据节点：**存储 XML 数据。

+   **图像节点：**可以存储诸如屏幕截图或其他重要证据之类的图像。

+   **交叉引用：**创建节点之间的链接，以避免信息重复。

+   **概述节点：**用于输入测试结果和建议的缓解策略。可以链接到受影响的主机。

+   **特殊节点：**由应用程序自动创建并用于执行特定任务。不是用户创建的。

### 注意

MagicTree 将来自不同数据源的数据合并到单个节点中，以避免数据重复运行多个扫描工具对 127.0.0.1 进行扫描不会导致多个代表相同数据的节点。

### 数据收集

让我们收集一些关于 127.0.0.1 的数据。除了能够选择在 MagicTree 之外运行的工具的扫描结果之外，您还可以直接从工具内部进行扫描，并使用变量选择目标范围或主机。

在**树视图**菜单中选择**主机 127.0.0.1**节点，单击代表查询所有的**Q***按钮，并在**命令**文本字段中输入以下内容（必须单击才能激活）：

```
# nmap -vv -O -sS -A -p- P0 -oX $out.xml $host 

```

这将启动针对 127.0.0.1 的 Nmap 扫描，并将结果放入名为`$out.xml`的 XML 文件中。

![数据收集](img/7744_01_12.jpg)

我们将选择`$out.xml`，然后单击**导入**按钮，让 MagicTree 根据扫描结果自动生成我们的节点结构。

![数据收集](img/7744_01_13.jpg)

MagicTree 已导入 Nmap 的结果，并将其与我们的主机合并。看起来我们的 BackTrack 虚拟机上的**postgresql 版本 8.4.0**正在**端口 7175**上运行！

### 报告生成

现在我们有了一些结果，我们将看看简单的报告生成是如何进行的。预先安装在 BackTrack 5 R1 上的安装程序有五个 OpenOffice 预配置的报告模板，可以用作创建自己模板的参考，或者直接使用。

在菜单栏顶部，选择**报告**选项，然后选择**生成报告**。这将启动**生成报告**模板选择屏幕。使用浏览选项选择`open-ports-and-summary-of-findings-by-host.odt`，然后单击**生成报告**。几分钟后，OpenOffice 将打开自动生成的报告，列出所有主机的开放端口以及您可能遇到的任何发现。

![报告生成](img/7744_01_14.jpg)

这只是对 MagicTree 项目的简要介绍。这个工具非常强大，需要一些练习才能发挥其真正的潜力。MagicTree 提供的文档写得很好，而且经常更新。如果您主要是在非常小的团队中进行渗透测试，或者是独自一人的团队，那么 MagicTree 可能是您唯一想要的数据收集工具。

# Dradis 框架简介

Dradis 框架是一个 Rails 应用程序，可用于帮助管理渗透测试时可能发生的数据过载。通过其用户友好的基于 Web 的界面，它简化了整个测试周期中的数据收集，并在与团队成员共享数据时非常有价值。

当合并不同的数据源，例如 Nmap、Nessus，甚至 Metasploit 时，通常需要构建某种数据库，然后使用各种方法来管理导入。Dradis 有插件，可以让您只需点击几下就可以导入这些数据。Dradis 还允许您上传附件，如截图，或向数据库添加自己的注释。

### 注意

Dradis 框架可以安装在 Linux、Windows 或 OSX 上。

可以通过点击快捷菜单**应用程序** | **BackTrack** | **报告工具 | 证据管理 | Dradis**来启动 Dradis 服务器，也可以在终端中输入以下内容：

```
# cd /pentest/misc/Dradis/
# ./start.sh 

```

服务器启动后，您可以打开浏览器，输入`https://127.0.0.1:3004`，这将带您进入 Dradis 应用程序的介绍界面。

### 注意

浏览器会向您显示警告，因为证书是自签名的。将证书添加到您的异常列表中，然后继续访问该站点。您可能还想在 No Script 浏览器附加组件中选择**允许 127.0.0.1**。

您将看到“什么是 Dradis”屏幕。为了为服务器设置共享密码，您需要单击页面右上角的**返回应用程序**链接。

![Dradis 框架简介](img/7744_01_15.jpg)

Dradis 框架使用一个由所有团队成员共享的密码。在**密码**字段中输入您选择的密码。

### 注意

永远不要重复使用密码！

单击**初始化**按钮继续。这将设置新密码并接受默认的 Meta-Server 选项。

现在您可以在**登录**字段中选择一个新的用户名。用户登录字段仅用于信息目的，不会影响工作区域。在**密码**字段中输入共享服务器密码。单击**登录**按钮后，您将看到 Dradis 的主要工作区。

![Dradis 框架简介](img/7744_01_16.jpg)

我们将通过创建一个新的分支来设置我们的 Dradis 环境，以代表我们的渗透测试。这些分支允许您根据各种用户创建的标准来管理您的发现。

1.  单击应用程序窗口顶部显示的**添加分支**按钮。

1.  新的分支将准备好供您重命名。用`PracticePenTest`覆盖**分支#2**，然后按*Enter*。

1.  右键单击**PracticePenTest**，然后选择**添加子项**以开始您的层次结构。

1.  尝试一下并添加额外的文件夹。开始考虑如何安排数据以便轻松访问和管理。

这是一个项目树的示例，可以在渗透测试期间用于数据收集：

![Dradis 框架简介](img/7744_01_17.jpg)

## 导出项目模板

测试将包括一系列计划阶段和程序，这些阶段和程序在不同测试之间变化不大。为了充分利用这一事实，我们将创建一个可重复使用的模板。

选择**PracticePenTest**节点后，我们将单击顶部菜单栏中的**导出**图标。展开**项目导出**菜单后，我们看到**作为模板**选项。单击此选项将允许我们将项目模板保存到我们选择的位置，保存为`.xml`文件。

![导出项目模板](img/7744_01_18.jpg)

将文件保存到您的 BackTrack **桌面**文件夹，并保持`dradis-template.xml`的默认名称。返回到您的 Dradis Web 应用程序窗口，选择`PracticePenTest`节点，右键单击它，然后选择**删除节点**来删除它。

## 导入项目模板

`PracticePenTest`节点已经被删除，连同我们的其他数据一起。现在是我们重用它的时候了，所以我们需要导入`dradis-template.xml`文件。从菜单栏中单击**从文件导入**，然后选择**旧导入器**。从下拉菜单中选择**项目模板上传**，然后单击**上传**以完成导入序列，一旦刷新屏幕，我们现在有两个新文件夹：一个名为**已上传文件**，当然还有我们原来的**PracticePenTest**节点结构。

![导入项目模板](img/7744_01_19.jpg)

## 准备导入的样本数据

为了充分体会 Dradis 框架的价值，我们将使用一些常用于渗透和漏洞测试的工具生成一些测试结果。您们大多数人可能对这些工具有一些了解，所以我们不会深入介绍它们。

我们需要做的第一件事是，如果尚未运行**BT5_R1_Tester1**实例，则将其启动起来。一旦您已登录 BackTrack 客户机并使用`startx`启动了图形用户界面，点击顶部栏中的终端图标开始一个新的终端会话。

![为导入准备样本数据](img/7744_01_20.jpg)

### 提示

您可能已经注意到您正在以 root 用户身份运行。您将使用的许多工具需要管理员权限才能正常运行。

将目录更改为`桌面`，然后创建一个名为`testData`的新目录。这将用于存储我们将使用的少量导出。将当前工作目录更改为`/桌面/testData`。

```
# cd Desktop/
# mkdir testData
# cd testData/ 

```

现在我们将使用 Nmap 生成数据，稍后将导入到 Dradis 中：

```
nmap -vv -O -sS -A -p- P0 -oA nmapScan 127.0.0.1 

```

该命令初始化 Nmap 针对本地主机运行，并指示将结果发送到三种文件类型：XML、标准和 grepable。由于未指定目录，文件将放置在当前工作目录中。我们正在对所有端口执行非常详细的 TCP SYN 扫描，包括 OS 和版本检测，命令将所有主机视为在线。

### 导入您的 Nmap 数据

在 Dradis Web 控制台打开并加载 PracticePenTest 项目树后，选择**从文件导入，旧导入器**，然后在**从文件导入**菜单中选择**Nmap 上传**格式，并单击**选择文件：**输入字段右侧的文件夹图标。浏览到并突出显示`nmapScan.xml`文件，然后单击**打开**。

![导入您的 Nmap 数据](img/7744_01_21.jpg)

单击**上传**将完成导入。处理数据需要一些时间。处理所需的时间与您拥有的数据量成正比。

![导入您的 Nmap 数据](img/7744_01_22.jpg)

导入已将附加节点添加到我们的树中。可以通过使用鼠标左键拖动它将`127.0.0.1`扫描结果移动到**PracticePenTest**节点中的任何位置。通过将`127.0.0.1`扫描结果移动到 PracticePenTest 的逻辑层次结构中，现在可以轻松地将其与此渗透测试和其他相关数据关联起来。

![导入您的 Nmap 数据](img/7744_01_23.jpg)

## 将数据导出到 HTML

使用这种类型的集中式数据收集的一个好处是，您可以在注释上设置某些标志，以便将数据导出为 PDF、MS Word 或 HTML 格式。

Dradis 已经启动运行，我们需要选择**PracticePenTest**节点，并在项目树右侧的工作区点击**添加注释**按钮。在弹出的编辑器中输入"This **is a note**"，然后点击**保存**。这将把您的注释添加到列表中。

### 注意

这些注释对于您的渗透测试至关重要，应该经过深思熟虑并清晰地书写。避免使用只在当前上下文中有意义的注释，因为您可能需要在以后重新访问这些注释。

## Dradis 分类字段

您并不总是希望将所有内容导出到报告格式中。为了解决这个问题，Dradis 开发团队添加了**Category**字段。该字段将标记要导出到各种可用格式中的数据。在这种情况下，我们将双击**"This is a note."**右侧列出的**默认类别**文本。从下拉菜单中选择**HTMLExport ready**选项。

![Dradis 分类字段](img/7744_01_24.jpg)

要查看我们的数据，请在顶部工具栏上选择**导出**选项，然后单击**HTML 导出**。您将看到**PracticePenTest**笔记的 HTML 输出，这些笔记是项目树中**HTMLExport**类别的成员。

### 更改默认的 HTML 模板

正如您所看到的输出非常好，但是如果您想要一些更加定制化的东西呢？标准模板可以更改以定制导出的外观和感觉。以下是如何更改文档页脚的示例：

将当前工作目录更改为所选的导出插件。在这种情况下，我们将修改`html_export/template.html.erb`文件。

```
# cd /pentest/misc/dradis/server/vendor/plugins/html_export 

```

要修改`template.html.erb`，我们将使用 nano，一个非常强大且易于使用的文本编辑器。

```
# nano template.html.erb 

```

文件将显示在 Nano 文本编辑器中。如果需要参考，Nano 命令将列在应用程序底部。我们将看到组成`template.html.erb`文件的 HTML。通过在`<title><%= title %></title>`行下方的模板 HTML 中放置`<h1>您可以更改此模板以满足您的需求。</h1>`来对模板进行小修改。

```
<title><%= title %></title>
<h1>You can change this template to suite your needs.</h1>

```

使用*Ctrl+O*在 Nano 中保存更改，这将将文件写入磁盘。系统将询问您要使用的文件名；通过在键盘上按*Enter*接受默认值。

要查看您的更改生效，请返回 Dradis Web 控制台，选择**PraticePenTest**，然后单击工具栏菜单中的**导出**，然后单击**HTML 导出**。您的新模板将加载，并且您的更改将在报告导出中可见。模板非常可定制化，可以通过一些努力和 HTML 技能来实现您想要的外观和感觉。

### 提示

**请注意，MS Word 导出功能需要您安装 MS Office。**

这意味着我们无法使用 BackTrack 实例充分体验 Dradis 的功能。Word 模板可以轻松定制，包括您公司的信息，以您喜欢的格式列出数据，并向文档添加标准页脚和页眉。

由于 Dradis 非常便携，如果您需要将其导出到 MS Word，但又没有许可证来安装 BackTrack 中的 MS Office，可以在已安装 Microsoft Office 的 Windows 机器上安装 Dradis，从 BackTrack 导出 Dradis 项目，然后重新导入到 Windows 上的 Dradis 安装中。

# 摘要

在本章中，我们专注于为成功的渗透测试做好准备和规划所需的一切。我们讨论了渗透测试和漏洞评估之间的区别。

详细介绍了适当范围确定所涉及的步骤，以及确保在测试之前已收集到所有信息的必要步骤。要记住的一件事是，适当的范围确定和规划与确保您针对最新和最大的漏洞进行测试一样重要。

我们还讨论了 VirtualBox 和 BackTrack 的安装，并提供了安装 BackTrack 的 ISO 以及如何保持其更新所需的说明。除此之外，我们还提供了如何在 BackTrack 上安装 OpenOffice 的说明。

最后但同样重要的是，我们讨论了两个非常强大的工具，它们可以进行数据收集并提供报告功能。MagicTree 是一个强大的数据收集和分析工具，而 Dradis 则在集中数据收集和共享方面表现出色。

在下一章中，我们将了解各种侦察技术以及它们的必要性。其中一些包括有效使用互联网搜索引擎来查找公司和员工数据，操纵和阅读各种文件类型的元数据，以及充分利用 DNS 的功能，使渗透测试的任务更加容易。
