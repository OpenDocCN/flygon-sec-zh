# 第十一章：接受挑战-把一切都放在一起

在整本书中，我们已经讨论了各种技术和方法，通过实践、持续的研究和勤奋，可以让你从头到尾执行渗透测试。本章让你把其中一些信息付诸实践，并加以理解。

我们将在本章讨论以下内容：

+   设置实践环境

+   使用渗透测试技术从一个系统移动到另一个系统

+   一个虚构公司的例子从头到尾的渗透测试

# 情景

一个名为 NewAlts Research Labs 的虚构公司决定增加网络存在。由于他们的商业模式的性质，信息保密至关重要，任何敏感研究数据的泄露都会直接对他们的底线产生负面影响。他们的管理员已经建立了一个模拟环境，类似于他们最终想要转移到生产环境的环境。业主已要求管理员聘请外部顾问来审查环境，并告知可能存在的任何漏洞。

然后管理员委托你对模拟环境进行渗透测试，因为他已经确定他正在使用安全最佳实践，并在几个月前执行了初始的漏洞扫描，没有发现问题。他重申他正在使用提供良好支持的知名产品，并且以他的商店 100%开源为傲。

在询问网络时，你发现只有一个面向网络的服务器。这台服务器正在运行最新版本的 WordPress。唯一提到的其他服务是 SSH，他用它来在紧急情况下访问网站。在办公室时，管理员使用管理区域直接访问服务器，但这个区域无法从互联网访问，并且被防火墙隔离。服务器的 IP 地址是`192.168.10.25`。在询问环境时，管理员让你知道他们使用分段的内部网络、多个防火墙、IDS 和 WAF，并且确信这种分层防御方法足以保护核心数据网络，重要和机密的研究信息最终将被存储在那里。

你需要向管理层提供信心，如果这个设置要上线，他们的数据是受到保护的。你需要模拟一个没有先前网络知识和有限时间来执行攻击的攻击者。管理员提到他打算为服务器使用虚拟镜像，并且它们将在每天晚上关闭并恢复到原始状态。

# 设置

像往常一样，我们需要设置我们的虚拟实验室来模拟这个环境，因为我们正在执行的渗透测试纯属虚构。然而，不要认为这种努力是徒劳的；许多渗透测试人员将尝试模拟他们客户的网络，以确保他们打算使用的漏洞实际上有效且稳定，更不用说这减少了勤奋的管理员和安全专业人员检测到你的行动的可能性。根据渗透测试的类型，这可能是至关重要的。

## NewAlts Research Labs 的虚拟网络

我们将在 VirtualBox 中设置以下环境：

![NewAlts Research Labs 的虚拟网络](img/7744OS_11_01.jpg)

系统名称：**pfsense1**

+   操作系统：pfSense 2.0（FreeBSD）

+   虚拟磁盘大小：1GB

+   RAM：128

+   三个网络适配器（内部）：

+   WAN = 192.168.10.1（Int10）

+   LAN = 192.168.20.1（DMZ20）

+   OPT1 = 192.168.30.1（DEV30）

+   OPT2 = NAT（这是一个可选步骤，它允许您轻松下载和安装必要的软件包。这个适配器应尽快禁用。）

+   安装的软件包：

+   Snort（确保配置和更新）

+   Strikeback（仅在 pfSense 的 32 位版本中可用。）

+   为所有三个接口设置 DHCP 服务器。

+   允许私有 IP 通过 WAN 接口。

+   设置规则以允许从 WAN 到 LAN 的端口 22、80、443 和 3306。

+   设置规则以允许从 LAN 到 OPT1 和反向的端口 21、22、23、25、80、443。

### 提示

在构建实验室时启用 ICMP 流量可能有助于您解决问题。在开始虚构的渗透测试之前，应阻止 ICMP。

系统名称：**pfsense2**

+   操作系统：pfSense 2.0（FreeBSD）

+   虚拟磁盘大小：1 GB

+   RAM：128

+   两个网络适配器（内部）：

+   LAN= 192.168.40.2（CORE40）

+   WAN = 192.168.30.2（DEV30）

+   为核心（LAN）接口设置 DHCP

+   通过 WAN 接口允许私有 IP

+   设置规则以允许从 Core（WAN）到 Dev（LAN）适配器的所有内容

+   设置规则以允许从 Dev（LAN）到 Core（WAN）的所有内容

### 提示

如果硬盘空间有限，则尝试将 pfsense1 用作链接基础。这可以通过克隆 pfsense1 并选择链接设备来实现。选中重新初始化接口 MAC 地址的复选框。

系统名称：**WebServer**

+   操作系统：Ubuntu 10.04

+   用户：John Dow（jdow），密码：039Alts2010

+   虚拟磁盘大小：6 GB

+   RAM：最低 128 MB（建议 512 MB）

+   要安装的软件包：

+   OpenSSH

+   lamp-server^

+   WordPress（最新版本）

+   两个网络适配器（内部）：

+   eth0 = 192.168.20.100（DMZ20）

+   eth1 = 192.168.30.100（DEV30）

+   在锁定静态 IP 之前执行所有系统更新

系统名称：**DevMachine**

+   操作系统：FreeBSD-8.2-RELEASE-i386-disc1：大多数镜像路径上都有：（/pub/FreeBSD/releases/i386/ISO-IMAGES/8.2/）

+   用户：John Doe（jdoe），密码：1A2b3C4d！

+   虚拟磁盘大小：4 GB（标准安装，基本用户将适合 4 GB 或更少）

+   RAM：最低 128 MB（建议 256 MB）

+   两个网络适配器（内部）：

+   eth0 = 192.168.40.101（CORE40）

+   eth1 = 192.168.30.101（DEV30）

该系统将需要安装默认的 SSH 和 INETD（Telnet，FTP）服务器。必须为此系统上的两个适配器配置 DHCP，否则您将遇到技术困难。这可以在操作系统安装过程中完成。在所有情况下使用用户名 jdoe。

系统名称：**Kioptrix Level 1**

+   CORE40 上的 1 个网络适配器（DHCP 将分配地址）

该系统将作为最终包含公司关键基础设施的 ArchLinux 数据库服务器的占位符。管理员声称您永远不应该能够从`192.168.40.0/24`网络到达此区域。他对这一事实非常确定，以至于他在核心段放置了一个已知易受攻击的系统来证明这一点。您的目标是从`192.168.40.0/24`网络段获得 Kioptrix 机器的 root 权限。

## 其他系统修改

在整本书中，我们已经全面介绍了在 VirtualBox 环境中安装和配置操作系统（如 pfSense 和 Kioptrix），因此为了简洁起见，我们将只关注使本练习中的系统与默认安装不同的步骤。幸运的是，我们只需要担心配置 Ubuntu web 服务器。

### Web 服务器修改

名为`Webserver`的系统将需要安装并运行`lamp-server^`。如前所述，我们还需要安装和配置最新版本的 WordPress。WordPress 团队在提供社区详细的逐步安装和配置说明方面做得非常出色，可以在互联网上访问：[`codex.wordpress.org/Installing_WordPress`](http://codex.wordpress.org/Installing_WordPress)。在这一点上，使用的用户名、数据库和密码并不重要，但应该易于记住且强大。请记住，本练习中的管理员打算构建一个安全的环境。在测试此环境时，您将需要“忘记”自己知道密码和用户名是什么…

除了完全修补和更新这个系统，我们还需要设置 SSH 服务器来接受我们在 192.168.10.0/24 模拟的（互联网）连接中的 jdow 用户，一旦 WordPress、OpenSSH 和静态 IP 被配置好。

一旦 WordPress 运行起来，我们需要用以下文本替换示例页面：

```
NewAlts Development and Research center
orem eu massa commodo eleifend quis gravida tortor. Vestibulum vestibulum lacinia ultrices. Nunc rhoncus placerat dui adipiscing tincidunt. Maecenas rutrum orci ac lacus adipiscing adipiscing tempor dui consequat. Aliquam vestibulum nulla gravida est sagittis non iaculis quam egestas.Thank you for visiting the NewAlts Development and Research center where we focus on examining all sorts of rocks and minerals and hope to make your life easier and safer! As we like to say in the office: NewAlts Rocks! Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi dolor lacus, malesuada vitae sodales eu, vulputate a leo. Mauris vulputate tristique nulla, at vestibulum nisl fringilla ut. Duis a quam quis lectus rutrum cursus. Morbi volutpat lorem eu massa commodo eleifend quis gravida tortor.
Vestibulum vestibulum lacinia ultrices. Nunc rhoncus placerat dui adipiscing tincidunt. Maecenas rutrum orci ac lacus adipiscing adipiscing tempor dui consequat. Aliquam vestibulum nulla gravida est sagittis non iaculis quam egestas. Thanks again for your visit and if you run into any problems with the website please contact our website administrator at jdow@newalts.lab! . Morbi volutpat lorem eu massa commodo eleifend quis gravida tortor. Vestibulum vestibulum lacinia ultrices. Nunc rhoncus placerat dui adipiscing tincidunt. Maecenas rutrum orci ac lacus adipiscing adipiscing tempor dui consequat.

```

这将为我们提供一些在现场工作的信息。我们可以继续进行本章更有趣的部分！当浏览到我们的`WebServer`机器时，我们应该看到类似以下截图的内容：

![Web server modifications](img/7744OS_11_02.jpg)

# 挑战

实验室已经建立，连接已验证；现在是时候把整本书中获得的信息付诸实践了。挑战自己，在这个环境中从头到尾执行一次完整的渗透测试。这包括以下项目：

+   确定范围（管理员只允许你在他的 VPN 上使用两个小时）。

+   了解客户为什么要进行渗透测试。这对于真正满足用户需求至关重要。对于一些职业来说，这很容易，但对于渗透测试人员来说，情况并非总是如此。确定你的客户是想要进行渗透测试还是更接近一般性的漏洞分析。

+   规则的参与文件：

+   使用提供的信息创建一个实用的规则参与文件。

+   确定并记录 ROE 中的范围。

+   在 ROE 中巩固对测试的任何假设。

+   明确定义的目标。你需要做什么来证明成功？仅仅展示一个带有`whoami = root`的屏幕截图对大多数观众来说是不够的。

+   决定是否使用 Dradis、Magic Tree 或其他数据管理工具来管理你的结果。

+   制定你的初始测试计划。在测试之前提前知道你的初始步骤是很重要的。

+   进行侦察。

+   开始枚举并决定攻击计划。根据范围的不同，你可能能够对资源进行漏洞扫描或应用程序扫描。这将会很吵。

+   在枚举过程中，你应该收集关于可能的防火墙、IDS 或负载均衡的信息。

+   执行你的攻击计划。由于渗透测试的性质，这将因测试而异，有时甚至需要在进行中进行更改。如果某些事情不如预期那样工作，要准备好备用计划。

+   成功获取系统访问权限后，执行后利用，如果需要设置一个枢纽点深入网络架构。

+   实现渗透测试的目标。

+   清理。

+   生成你的报告。

+   安排会议与客户一起审查结果。

尽管渗透测试的“利用”阶段最具吸引力，但其他步骤对于成功的渗透测试同样重要。一定要练习并准备好每个步骤。了解渗透测试中的工具和技术非常重要，但这些将不断变化，而过程本身保持相对稳定，因此任何自动化或改进这些步骤的努力将对长远发展最有益。

祝你好运！在测试结束时，你应该能够完全控制 Kioptrix 机器。一定要仔细记录你的步骤和任何建议的更改，以使网络更安全！不要提前阅读，因为那会包含会破坏你测试的剧透。

# 步骤

希望在阅读本章的这一部分之前，你已经能够完成你的测试。它将包含示例和至少一种实现我们设定的目标的方法，即侵入我们自己网络或机器上运行的虚拟 NewAlts 开发实验室的安全。如果你的文档或获得初始目标的方法与本章描述的不同，这并不意味着它是错误的，只是不同。通过实践，渗透测试人员将开发出适合他们的技能和知识库的自己的方法。

### 注意

可能有其他方法可以达到我们的目标，而不仅仅是本章描述的方法。本章的目标是从头到尾给出渗透测试工作流程的一个示例。如果你找到了在 CORE 网络上的 Kioptrix 机器上获得 root 权限的其他方法，那就值得祝贺了！这就是渗透测试的全部意义！

## 定义范围

通过阅读情景目标和背景信息，可以清楚地定义这个特定测试的范围。

1.  我们有两个小时的时间来测试一个虚拟环境，该环境已经被制作成模拟我们的客户最终希望在生产中使用的环境。

1.  我们所知道的唯一用户是代表虚构的 NewAlts 研究与开发公司的管理员。

1.  这个网络上的信息对公司完全无害。没有特殊需要加密或小心处理第三方服务。

1.  我们的目标是完全攻破放置在 CORE 192.168.40.0/24 网络段中的 Kioptrix 机器，这个网络段无法从模拟互联网连接的 192.168.10.0/24 网络段中到达，而这将存在于生产环境中。

1.  我们可以使用我们所知的任何技术，包括社会工程、利用、拒绝服务等。天空是极限。

1.  这些系统上的任何数据或信息都不违反我们所知的任何法律，无论是州法还是联邦法。由于该网络仅用于教育目的，我们可以随心所欲。

1.  网络上的所有系统都将基于开源。

考虑到这些因素，显然挑战在于有限的时间因素。如果我们团队中有几个人，我们可以建议使用几个具有非常具体任务的测试人员并行运行，以充分利用有限的两小时测试时间。（管理员拒绝支付超过两小时的标准费率，该费率基于最多三名测试人员加入测试）。

## 确定“为什么”

尽管在这种情况下，“为什么”对我们来说已经很清楚，但我们不应变得自满。这有助于测试人员和业务方了解你的测试的真正目标，并允许你专注于使你的测试和报告与实现这一目标保持一致。

在这种情况下，管理员已经明确表示漏洞分析工具已经针对这个网络使用过，并且他已经解决了除了业务认为可以接受的问题之外的所有问题。这将因企业的风险偏好而异，根据你所处理的公司或个人的风险偏好。了解风险偏好可能有助于确定“为什么”。也许你只是测试环境，只是为了向业务部门证明他们可以放心，攻击者需要超过两个小时才能攻破他们的网络，而这恰好是他们的安全团队在他们的环境中发现任何奇怪活动所需的时间。

### 那么，这个特定测试的“为什么”是什么？

管理员明确表示，如果任何关键数据被恶意入侵者收集，将直接造成经济损失。在公司工作的科学家们并不精通技术，并将使用基本的解决方案来解决技术问题。可以肯定地说，他们将在文件服务器上存储未加密的测试文件，这些文件由多个用户共享，其中包含关键数据。在这种情况下，“为什么”的原因是担心会损失大量资金，需要有人向业务保证管理员建议的安全配置足以防止发生这种情况。

## 制定规则的参与文件

这份最关键的文件必须写得清楚，定义明确。我们现在已经获得了制定规则的所有所需信息，在进行任何测试之前必须呈交并达成一致。

### 提示

规则的参与应由具有代表您的客户的全部权限的 C 级高管签署。

规则的参与必须详细说明范围、系统、网络地址以及测试期间允许和不允许做的事情。无论您决定采用的模板或外观如何，您为应对挑战而创建的文件应至少包含以下信息：

1.  ROE 创建日期：2020 年 1 月 2 日。

1.  贵公司及任何直接参与测试的测试人员的名称和联系信息：Lee Allen。

1.  请求摘要：我们需要完全攻陷 Kioptrix 机器，该机器位于 CORE 网络段，无法从模拟生产环境中存在的 192.168.10.0/24 段的互联网连接访问。

1.  渗透测试的快速描述（以下内容摘自本书的**第一章**，*规划和范围确定成功的渗透测试*）：渗透测试使企业能够了解所采用的缓解策略是否按预期工作；它基本上消除了猜测。渗透测试人员将被要求模拟攻击者可能尝试的行动，并将被要求证明他们能够攻陷所针对的关键系统。这使企业能够了解安全控制是否按预期工作，以及是否有任何需要改进的地方。

1.  将执行的测试类型：无限制的完全攻陷渗透测试，除了时间限制。

1.  限制：2 小时时间。

1.  渗透测试的明确目标：在两小时内完全攻陷位于 CORE 网络段的 Kioptrix 机器。

1.  IP 范围：192.168.10.0/24，192.168.20.0/24，192.168.30.0/24，192.168.40.0/24。

1.  数据处理：数据被说明仅用于测试，因此不得以任何方式视为机密处理。

1.  如何处理发现可能违反州或联邦法律的数据：在通知企业或其实体之前，将事先通知相关当局。

1.  NewAlts Development 联系人及其电话号码等清单：Jon Doe。

1.  需要公司相关主管的签名：NewAlts Development CISO，CIO 或其他负责人。除非管理员能证明否，否则管理员没有足够的权限允许您测试 NewAlts Development Corporation 的资产。

## 攻击的初始计划

ROE 完成后，我们可以查看网络图并制定攻击计划。让我们审查管理员提供给我们的网络布局。

![攻击的初始计划](img/7744OS_11_03.jpg)

在这次白盒测试中，我们被提供了网络架构，以弥补我们正在测试模拟环境并受到严格时间限制的事实。我们需要确定路由器是否会允许我们从 pfSense1 到 WebServer 和 DevServer。从提供的图表中不清楚我们是否可以远程访问 Kioptrix Level 1 机器。我们的初始计划如下：

1.  对 192.168.10.1 防火墙和网关进行漏洞扫描。我们知道这一点，所以我们也可以利用它！对此图表中列出的所有系统执行相同的操作。

1.  对 192.168.20.0/24 执行网络和漏洞扫描。

1.  如果我们可以从 192.168.10.0/24 设备到达其他段，我们也将对它们执行网络和漏洞扫描。

1.  如果我们无法到达任何网络，我们将对 WebServer 应用程序执行 Web 应用程序扫描，并查看是否有任何我们可以利用的 Web 应用程序漏洞。

这个最基本的计划足以让我们开始。我们从这些步骤中收集的信息应该足以让我们进入下一步。谁知道，也许管理员是对的，设置实际上是安全的！（在这种情况下不太可能！）

### 注意

在这次测试的有限范围内，可以使用任何可用的文档手段，以便您能够向客户提供可接受的报告。

## 枚举和利用

我们首先执行行动计划中的第一步，并使用我们选择的工具扫描设备。在这种情况下，我决定使用 MagicTree。它允许我从应用程序内运行查询，并且具有即时生成报告的能力。

加载 MagicTree 并创建一个新节点，就像我们在书的第一章中所做的那样，*规划和范围确定成功的渗透测试*，并对从 192.168.10.0/24 子网可用的任何网络运行 Nmap 扫描。如果一切配置正确，您应该只能看到`192.168.20.1`和`192.168.20.0/24`网络上的`Webserver`。

![枚举和利用](img/7744OS_11_04.jpg)

在审查我们获得的数据时，我们发现这些系统上运行着一些有趣的服务，应该进行审查。让我们快速对它们进行漏洞扫描，以节省时间。我们将使用 OpenVas 执行漏洞扫描。OpenVas 包含在 BackTrack 5 R1 中，但必须在使用之前进行适当配置。有关设置 OpenVas 的说明可以在`Backtrack-linux.org`网站上找到[`www.backtrack-linux.org/wiki/index.php?title=OpenVas&oldid=756`](http://www.backtrack-linux.org/wiki/index.php?title=OpenVas&oldid=756)。

### 注意

请注意，OpenVas 配置将需要互联网连接。

在意识到扫描将花费太长时间并且会使我们超过两小时的标记后，我们决定继续进行测试计划的下一阶段，并迅速确定安装的软件已经相当更新，并且没有任何已知的漏洞适用于任何开放服务。从查看网站时，我们还注意到它是最新版本的 WordPress 的标准安装。在仔细审查网站时，我们注意到一个联系电子邮件地址。我们将这个电子邮件地址添加到我们的 MagicTree 笔记中。有很大的可能性，电子邮件名称**jdow**也用作网络登录。如果是这种情况，我们已经解决了一半的难题。也许我们可以暴力破解 Joe 的 SSH 密码。

在这一点上，我们决定尝试 SSH 服务器。根据范围，我们被允许使用任何可用的工具，这为我们打开了暴力破解密码的可能性。再次，请记住这次测试有限的时间，所以我们决定使用`cewl`从 192.168.20.100 的网站上拉取密码列表。

```
# /usr/bin/ruby1.8 /pentest/passwords/cewl/cewl.rb -e -w dict 192.168.20.100 

```

这个命令在我们当前的目录中创建一个名为`dict`的文本文件。我们可以尝试直接运行这个列表，看看这些单词是否会帮助我们暴力破解 SSH 服务器的用户名或密码。

然后，我们将该列表通过`cupp`运行，以添加一些特殊字符，连接单词，并且通常滥用该文件。完成后，我们可以通过消除许多不太可能使用的密码来节省时间，例如只有数字的密码，例如 00000001 等。如果单词列表太大，则删除其中一个选项并尝试。

![枚举和利用](img/7744OS_11_05.jpg)

通过`xhydra`使用`jdow`用户名和新生成的密码列表运行此列表，您将希望出现以下提示（在测试系统上花了 15 分钟，整个实验室都在运行；在您的系统上可能需要更长的时间，特别是因为整个实验室使用了大部分资源）：

![枚举和利用](img/7744OS_11_06.jpg)

现在我们有了一个 SSH 连接。登录到 WebServer，查看 jdow 账户的权限是什么。您会意识到我们没有安装任何软件的能力。相反，我们决定使用 WebServer 作为一个枢纽点（在这种情况下是 SSH 代理）使用 MetaSploit。首先，我们需要在 BackTrack 中设置我们的 SSH 隧道到 Webserver：

```
# ssh -D 127.0.0.1:3306 jdow@192.168.20.100 

```

这将在端口 3306 上创建我们的隧道，用于发动我们的攻击。这是使用 443 的隧道的一个示例，它将增加与网络上其他加密流量混合的额外好处。由于我们最终使用的漏洞存在一些稳定性问题，我们选择 3306 而不是 443。

![枚举和利用](img/7744OS_11_07.jpg)

登录到 Metasploit，我们设置了一个代理连接，允许我们通过 WebServer 连接使用 Metasploit。在 Metasploit 中执行以下命令，这些命令是根据 HD Moore 的邮件列表回复进行调整的。原始消息可以在以下网址找到：[`mail.metasploit.com/pipermail/framework/2010-January/005675.html`](http://https://mail.metasploit.com/pipermail/framework/2010-January/005675.html)。

```
setg Proxies SOCKS4:127.0.0.1:3306
setg LPORT 45567
setg PAYLOAD bsd/x86/shell/bind_tcp

```

这些命令将设置代理和首选有效载荷的全局变量。我们选择默认的本地端口为 45567。

作为下一步，我们需要确认确实有一个 FreeBSD 机器可用于 192.168.30.0/24 网络，正如管理员所通知的。为了做到这一点，我们可以从 Telnet 服务器进行横幅抓取，看看是否有哪种操作系统正在使用的迹象。这也可能是一个好主意，看看是否有任何来自 NMAP 扫描的信息。

使用标准的 Nmap 扫描，我们注意到我们的流量被拦截。在这一点上，我们可以使用其他扫描方法，但决定手动尝试找到最常见的端口，而不是等待代理扫描的结果，这可能会很慢。

### 注意

我们无法从这个枢纽运行标准的 SYN 扫描。有替代的扫描方法，但这超出了本章的范围。

![枚举和利用](img/7744OS_11_08.jpg)

我们碰巧知道有一个已知的 FreeBSD Telnet 漏洞，管理员似乎已经安装在这个系统上（通过我们在 WebServer 上的 SSH 会话使用 NetCat 进行确认）。我们使用`nc`来检查最常见的端口，如 80、25、21 等。在采取这种方法之前，我们首先检查是否安装了 nmap 或其他扫描程序。

![枚举和利用](img/7744OS_11_09.jpg)

让我们尝试执行已知的漏洞。目标系统很可能是脆弱的，因为这是一个相对较新的漏洞。

![枚举和利用](img/7744OS_11_10.jpg)

首先，我们在 MSF 中搜索 Telnet，然后我们在`exploit/freebsd/telnet/telnet_encrypt_keyid`上设置了我们需要的一切，并准备尝试利用漏洞。

它起作用，我们可以运行一些命令来验证我们登录的身份，以及系统连接到了什么。

![枚举和利用](img/7744OS_11_11.jpg)

注意，我们现在可以将这个系统用作攻击平台，攻击 192.168.40.0/24，这是管理员提到的 CORE 安全区域。让我们试着提升游戏账户的权限。我们切换到`/etc/`目录并运行以下命令：

```
awk -F ":" 'BEGIN{OFS = ":"} $1 == "games" {$3="0"}{$4="0"}{$7="/bin/bash"}{ print }' passwd > test 

```

复制生成的测试文件到`passwd`文件上，我们现在应该能够用那个账户登录了。注意：我们无法更改我们的游戏账户或其他任何账户的密码！默认的`pam`安全性阻止了我们进行这个本来微不足道的任务！这再次证明了作为渗透测试人员，你必须保持专注，永不放弃。如果某事不起作用，尝试做一些改变，或者改变整个方法，直到你成功为止！

幸运的是，我们以 root 身份登录到了系统，所以我们尝试`/usr/sbin/adduser`并设置一个名为 lee 的用户，密码为 lee。`awk`语句被修改后我们再次尝试：

```
# awk -F ":" 'BEGIN{OFS = ":"} $1 == "lee" {$3="0"}{$4="0"}{$7="/bin/bash"}{ print }' passwd > test
# cp test passwd

```

现在让我们转到 WebServer 上的 SSH 会话，看看我们的 lee 账户对我们有什么作用。

在下一阶段，我们必须利用我们已知的最后一个目标系统的知识。我们已经了解了它的漏洞，并且有代码（记得`10.c?`）可以在 192.168.30.101 系统上编译，以利用 192.168.40.102 系统。在这一点上，继续进行的许多方法包括简单地将`10.c`的代码复制到 vi 中，然后通过 FreeBSD 机器上的 GCC 进行编译。

![枚举和利用](img/7744OS_11_12.jpg)

一旦`10.c`被编译，我们就能够运行它并获得对 Kioptrix 一级机器的 root 访问权限。为了证明我们能够访问这台机器，我们决定更改 root 密码。这通常不是一个好主意，但根据我们的约定规则，这是完全可以接受的。我们使用`passwd`命令将 Kioptrix 机器的密码更改为`NothingIsSecure`，然后注销并断开所有连接。

我们重新连接到我们的 WebServer 机器上的 SSH，然后 SSH 登录到 DevServer：

![枚举和利用](img/7744OS_11_13.jpg)

我们随后使用新密码登录到我们的 Kioptrix 机器的 SSH，以验证我们已经实现了渗透测试的目标。

![枚举和利用](img/7744OS_11_14.jpg)

# 报告

我们已成功完成渗透测试，现在必须制作文档。您的报告应该看起来专业、有条理，并清楚解释发现的问题，还应该用非技术性的语言解释这些问题可能是如何被忽视的。重点是介绍允许您进入的原因，但也要确保指出一些工作的地方，比如在尝试为标准游戏账户添加密码时遇到的`pam`限制（在一个声称安全的环境中，这样的账户在技术上本不应该存在）。

让我们花点时间来分析我们在这次渗透测试中遇到的问题：

1.  我们能够暴力破解一个使用大写和小写字母以及数字的密码。密码也超过了八个字符，这在一个安全的环境中是相当标准的。用户绝对不应该使用基于公司名称或其他琐事的密码。如果有人有一个页面说他们喜欢足球，那么你最好相信它会出现在某人的基本单词列表中。建议在这里是将 SSH 连接限制在特定的 IP 上，或者至少要求除了简单登录外还需要证书。尽管这看起来微不足道，但许多公司继续忽视这一简单的步骤。账户锁定也是阻止暴力破解密码攻击的一种可靠方法。

1.  我们利用了一个已知的漏洞。很可能这个漏洞最终会被修补。真正的问题在于 Telnet 一开始就在运行。这是一个已知的不安全协议，以明文传输数据。在这种情况下，企业必须认为这是一个可以接受的风险，因为正在传输的数据的性质。在这里学到的教训应该是，只有关键服务应该随时运行，而且只是因为有一层安全机制并不意味着其他系统可以完全依赖这种安全机制。

1.  将一个已知的易受攻击的系统作为目标只会招来麻烦。在现实世界中，这是绝对不可接受的。通过使用这样的系统，管理员将会在一些人心中引起怀疑。他们不会明白这个系统代表了他们在启动时的“加固”服务器。解释说攻击者将有超过两个小时的时间来进行攻击，并且会安装各种恶意软件，最终帮助破解任何加固的机器。

1.  网络安全设备在适当监控和控制时是有效的。然而，它们并不是万能药。只有通过深度防御，一个上网的企业才能真正安全，即使这样，随着安全研究人员和恶意黑客发现新技术，甚至可能会有不同程度的“安全”。要记住的是，安全研究人员报告他们的发现是为了帮助保护最终用户。当安全研究人员发布有关漏洞的信息时，重要的是要记住这个漏洞并不是*新*的，它只是新公布的。安全研究人员并没有创造这个漏洞；他或她只是把它带给了那些负责纠正编码错误的人。恶意用户可能早就知道这个漏洞，甚至可能已经使用这个漏洞多年。恶意攻击者会保守他们的秘密，并最大化地利用这项技术。许多企业不理解这种区别，我们的工作就是确保他们知道真正的威胁是谁，以及为什么安全研究人员要做他们的工作。

如果你在你的模拟报告中捕捉到了所有这些以及更多内容，恭喜你！这个挑战并不代表最具挑战性的环境，但希望它能成为一个对使用修补系统、防火墙、入侵检测系统等来保护关键资产的高度安全环境进行渗透测试的良好介绍。

# 总结

在这一章中，我们首先建立了一个场景，让我们能够从头到尾模拟一个渗透测试。然后我们开始设置测试环境，然后深入到成功进行渗透测试所必需的阶段。

一旦基础知识掌握了，你就会被挑战在这个环境中进行自己的测试。希望对你来说，这既具有挑战性又令人兴奋！

我们通过提供一个可能的执行这种渗透测试的方法来完成了这一章节。有其他方法可以完成同样的任务，有些比其他方法更好。我们的目标是展示其中一种方法。在实验室中尝试不同的场景。利用它来获取你需要的技能，或者磨练你已经拥有的技能。当做工作的时候，你需要尽可能多的运气和技能，因为在这个世界上有一件事是肯定的：“任何可能出错的事情都会出错”墨菲定律。
