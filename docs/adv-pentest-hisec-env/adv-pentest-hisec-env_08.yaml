- en: Chapter 8. Bypassing Firewalls and Avoiding Detection
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第8章。绕过防火墙和避免检测
- en: The type and scope of the penetration test will determine the need for being
    stealthy during a penetration test. The reasons to avoid detection while testing
    are varied; one of the benefits would include testing the equipment that is supposedly
    protecting the network, another could be that your client would like to know just
    how long it would take the Information Technology team to respond to a targeted
    attack on the environment. Not only will you need to be wary of the administrators
    and other observers on the target network, you will also need to understand the
    automated methods of detection such as web application, network, and host-based
    intrusion detection systems that are in place to avoid triggering alerts.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 渗透测试的类型和范围将决定在渗透测试期间需要保持隐秘的需求。避免在测试期间被检测到的原因各种各样；其中一个好处可能包括测试据说保护网络的设备，另一个可能是您的客户想知道信息技术团队对环境中的有针对性攻击做出反应需要多长时间。您不仅需要警惕目标网络上的管理员和其他观察者，还需要了解自动检测方法，例如网络、基于主机的入侵检测系统，以避免触发警报。
- en: Tip
  id: totrans-2
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: When presented with the most opportune target, take the time to validate that
    it is not some sort of honeypot that has been set up to trigger alerts when abnormal
    traffic or activity is detected! No sense in walking into a trap set by a clever
    administrator. Note that if you do find a system like this it is still very important
    to ensure it is set up properly and not inadvertently allowing access to critical
    internal assets due to a configuration error!
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 当面对最有利的目标时，花时间验证一下，确保它不是一种蜜罐，当检测到异常流量或活动时会触发警报！不要走进一个聪明管理员设置的陷阱。请注意，如果您确实发现了这样的系统，仍然非常重要确保它设置正确，不要因配置错误而无意中允许访问关键内部资产！
- en: 'In this chapter, we will review the following:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将回顾以下内容：
- en: Pentesting firewalled environments
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 渗透测试防火墙环境
- en: Sliding in under the IDS
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在IDS下滑
- en: Setting up shop internally
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在内部设置店铺
- en: Reviewing network traffic
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 审查网络流量
- en: Using standard credentials
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用标准凭据
- en: Cleaning up compromised systems
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 清理被入侵的系统
- en: Lab preparation
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 实验室准备
- en: To follow along with the examples in this chapter a bit of lab preparation will
    be necessary.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 为了跟上本章的示例，需要进行一些实验室准备。
- en: Tip
  id: totrans-13
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: Throughout this book there has been a strong focus on being able to emulate
    a target network. This is critical to being able to learn and practice the latest
    and greatest techniques as the excellent minds in the security research field
    continue to surprise us with new vulnerabilities and possible attack vectors.
    This book cannot cover every possible method of testing a network, but building
    the labs is an attempt at adding long lasting value that will hopefully lead to
    a lifetime of the "hacker mentality". If you continue to build out your personal
    lab and increase the difficulty of the practice challenges that you set for yourself
    you will quickly become comfortable with testing any sort of environment.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 在整本书中，我们一直专注于能够模拟目标网络。这对于学习和实践最新和最伟大的技术至关重要，因为安全研究领域的优秀头脑继续用新的漏洞和可能的攻击向量给我们带来惊喜。本书无法涵盖测试网络的每种可能方法，但构建实验室是为了增加长期价值的尝试，希望能够导致终身的“黑客心态”。如果您继续建立自己的实验室并增加对自己设置的练习挑战的难度，您将很快就能够舒适地测试任何类型的环境。
- en: 'BackTrack, pfSense, and Ubuntu virtual machines should be configured in the
    following manner:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: BackTrack、pfSense和Ubuntu虚拟机应该以以下方式进行配置：
- en: '![Lab preparation](img/7744OS_08_01.jpg)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![实验室准备](img/7744OS_08_01.jpg)'
- en: 'Certain configuration changes need to occur:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 需要进行某些配置更改：
- en: BackTrack guest machine
  id: totrans-18
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: BackTrack客户机
- en: This machine will need to be connected to the `192.168.75.0/24` subnet. In the
    Oracle VM VirtualBox Manager console highlight the BackTrack instance and select
    the **Settings** option from the top navigation bar. Ensure that only one network
    adapter is enabled. The adapter should use the Vlan1 internal network option.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 这台机器需要连接到`192.168.75.0/24`子网。在Oracle VM VirtualBox Manager控制台中，突出显示BackTrack实例，然后从顶部导航栏中选择**设置**选项。确保只启用一个网络适配器。适配器应使用Vlan1内部网络选项。
- en: '![BackTrack guest machine](img/7744OS_08_02.jpg)'
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![BackTrack客户机](img/7744OS_08_02.jpg)'
- en: 'As previously described in [Chapter 3](ch03.html "Chapter 3. Enumeration: Choosing
    Your Targets Wisely"), *Enumeration: Choosing Your Targets Wisely* we can assign
    the IP address (`192.168.75.10` in this case) to an Ethernet adapter (eth0) from
    within BackTrack by typing the following command into a terminal:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，在[第3章](ch03.html "第3章。枚举：明智选择目标")中，*枚举：明智选择目标*，我们可以通过在BackTrack中输入以下命令将IP地址（在本例中为`192.168.75.10`）分配给以太网适配器（eth0）来进行配置。
- en: '[PRE0]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'As the pfSense machine will need to be our router as well, we need to set it
    up as the default gateway. This can be accomplished as follows:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 由于pfSense机器还需要作为我们的路由器，我们需要将其设置为默认网关。可以按照以下步骤完成：
- en: '[PRE1]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Ubuntu guest machine
  id: totrans-25
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Ubuntu客户机
- en: 'The Ubuntu machine will be used as the target. It needs to be configured to
    connect to VLAN2, which is a new internal network we have not used before. To
    create an internal network you will need to manually type VLAN2 into the network
    configuration screen in the Oracle VM VirtualBox Manager. Your settings should
    be similar to the following:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: Ubuntu机器将被用作目标。它需要配置为连接到VLAN2，这是我们以前没有使用过的新内部网络。要创建内部网络，您需要在Oracle VM VirtualBox
    Manager的网络配置屏幕中手动输入VLAN2。您的设置应该类似于以下内容：
- en: '![Ubuntu guest machine](img/7744OS_08_03.jpg)'
  id: totrans-27
  prefs: []
  type: TYPE_IMG
  zh: '![Ubuntu客户机](img/7744OS_08_03.jpg)'
- en: pfSense guest machine configuration
  id: totrans-28
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: pfSense客户机配置
- en: Configuring our firewall is a bit more work. It needs to be able to route restrictive
    traffic from the VLAN1 network to the VLAN2 subnet. There are several configuration
    changes we will need to make to ensure this works properly.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 配置我们的防火墙需要更多的工作。它需要能够将来自VLAN1网络的限制流量路由到VLAN2子网。我们需要进行几项配置更改，以确保这一点能够正常工作。
- en: Note
  id: totrans-30
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: pfSense offers the option to reset to factory defaults from the configurations
    menu. Be aware that the adapters will have to be reconfigured if this option is
    chosen. This is not difficult, but all previous settings will be lost. Be sure
    to make a copy/snapshot of your pfSense machine if concerned with losing the previous
    configuration.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: pfSense提供了从配置菜单重置为出厂默认设置的选项。请注意，如果选择此选项，则必须重新配置适配器。这并不困难，但所有先前的设置将丢失。如果担心丢失先前的配置，请务必制作pfSense机器的副本/快照。
- en: pfSense network setup
  id: totrans-32
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: pfSense网络设置
- en: 'Our firewall guest machine will use two network adapters. One will be used
    for the VLAN1 segment and the other for the VLAN2 segment. VLAN1 will be treated
    as an untrusted wide area network for the examples within this chapter. Network
    Adapter 1 should resemble the following screenshot:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的防火墙客户机将使用两个网络适配器。一个将用于VLAN1段，另一个将用于VLAN2段。在本章的示例中，VLAN1将被视为不受信任的广域网。网络适配器1应类似于以下截图：
- en: '![pfSense network setup](img/7744OS_08_04.jpg)'
  id: totrans-34
  prefs: []
  type: TYPE_IMG
  zh: '![pfSense network setup](img/7744OS_08_04.jpg)'
- en: 'Network Adapter 2 should be similar to the following:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 网络适配器2应类似于以下内容：
- en: '![pfSense network setup](img/7744OS_08_05.jpg)'
  id: totrans-36
  prefs: []
  type: TYPE_IMG
  zh: '![pfSense network setup](img/7744OS_08_05.jpg)'
- en: WAN IP configuration
  id: totrans-37
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: WAN IP配置
- en: The remaining networking setup will need to be performed from within the guest
    machine.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 剩下的网络设置将需要在客户机内部执行。
- en: Boot up your pfSense virtual instance. There may be an additional delay as pfSense
    attempts to configure the WAN adapter. Allow it to fully load until you see the
    following menu:![WAN IP configuration](img/7744OS_08_06.jpg)
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动您的pfSense虚拟实例。当pfSense尝试配置WAN适配器时可能会有额外的延迟。允许其完全加载，直到您看到以下菜单：![WAN IP configuration](img/7744OS_08_06.jpg)
- en: The WAN and LAN interfaces will need to be configured properly. Select option
    **2) Set interface(s) IP address**.
  id: totrans-40
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: WAN和LAN接口将需要正确配置。选择选项**2)设置接口IP地址**。
- en: Select option 1 — WAN.![WAN IP configuration](img/7744OS_08_07.jpg)
  id: totrans-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择选项1 — WAN。![WAN IP configuration](img/7744OS_08_07.jpg)
- en: When asked to configure the WAN interface via DHCP type *n* for no.
  id: totrans-42
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在要求通过DHCP配置WAN接口时，输入* n *以进行否。
- en: The IP for the WAN adapter should be `192.168.75.1`.
  id: totrans-43
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: WAN适配器的IP应为`192.168.75.1`。
- en: Subnet bit count should be set to 24\. Type `24` and press *Enter*.![WAN IP
    configuration](img/7744OS_08_08.jpg)
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 子网位数应设置为24。输入`24`并按*Enter*。![WAN IP configuration](img/7744OS_08_08.jpg)
- en: Press *Enter* to return to the configuration menu.
  id: totrans-45
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按*Enter*返回到配置菜单。
- en: LAN IP configuration
  id: totrans-46
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: LAN IP配置
- en: We can set up the LAN IP information from the configuration menu as well. One
    benefit of configuring the LAN here is that we can have a DHCP server configured
    for VLAN2 at the same time.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 我们也可以从配置菜单中设置LAN IP信息。在此配置LAN的一个好处是，我们可以同时为VLAN2配置DHCP服务器。
- en: Select option `2` from the configuration menu to start the LAN IP Configuration
    module.
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从配置菜单中选择选项`2`以启动LAN IP配置模块。
- en: Choose the LAN interface (Option `2)`.
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择LAN接口（选项`2`）。
- en: When prompted to enter the IP address type `192.168.101.1`.
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在提示输入IP地址时，输入`192.168.101.1`。
- en: The bit count should be set to `24`.
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 位数应设置为`24`。
- en: When asked if you would like a DHCP server to be enabled on LAN choose *y* for
    yes.
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 当询问是否要在LAN上启用DHCP服务器时，选择* y *以进行是。
- en: DHCP Client IP range start will be `192.168.101.100`.
  id: totrans-53
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: DHCP客户端IP范围起始为`192.168.101.100`。
- en: DHCP Client IP range stop will be `192.168.101.110`.
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: DHCP客户端IP范围停止为`192.168.101.110`。
- en: Press *Enter*.![LAN IP configuration](img/7744OS_08_09.jpg)
  id: totrans-55
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按*Enter*。![LAN IP configuration](img/7744OS_08_09.jpg)
- en: Press *Enter* again to return to the configuration menu.
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 再次按*Enter*返回到配置菜单。
- en: 'Your LAN and WAN IP ranges should match the following:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 您的LAN和WAN IP范围应与以下匹配：
- en: '![LAN IP configuration](img/7744OS_08_10.jpg)'
  id: totrans-58
  prefs: []
  type: TYPE_IMG
  zh: '![LAN IP configuration](img/7744OS_08_10.jpg)'
- en: Firewall configuration
  id: totrans-59
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 防火墙配置
- en: pfSense can be configured using its intuitive web interface. Boot up the Ubuntu
    machine, open a terminal and perform a `sudo dhclient` to pick up an address from
    the pfSense DHCP server on VLAN2 (192.168.101.0/24). In a web browser on the Ubuntu
    machine type `http://192.168.101.1/` to access the configuration panel. If you
    have reset to factory defaults you will need to step through the wizard to get
    to the standard console.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: pfSense可以使用直观的Web界面进行配置。启动Ubuntu机器，打开终端并执行`sudo dhclient`以从VLAN2（192.168.101.0/24）上的pfSense
    DHCP服务器获取地址。在Ubuntu机器上的Web浏览器中输入`http://192.168.101.1/`以访问配置面板。如果您已将其重置为出厂默认设置，则需要通过向导进行步骤以进入标准控制台。
- en: Note
  id: totrans-61
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: 'The default username and password combination for pfSense is: `admin/pfsense`.'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: pfSense的默认用户名和密码组合是：`admin/pfsense`。
- en: To view the current firewall rules choose **Firewall | Rules** and review the
    current configuration. By default the WAN interface should be blocked from connecting
    internally as there are not preestablished rules that allow any traffic through.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看当前的防火墙规则，请选择**Firewall | Rules**并查看当前配置。默认情况下，WAN接口应被阻止连接到内部，因为没有预先建立的规则允许任何流量通过。
- en: '![Firewall configuration](img/7744OS_08_11.jpg)'
  id: totrans-64
  prefs: []
  type: TYPE_IMG
  zh: '![Firewall configuration](img/7744OS_08_11.jpg)'
- en: 'For testing purpose, we will enable ports 80, 443, 21, and allow ICMP. Add
    the rules as follows:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 为了测试目的，我们将启用端口80、443、21，并允许ICMP。添加以下规则：
- en: Click on the **add a new rule** button displayed in the preceding screenshot.
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击前面截图中显示的**添加新规则**按钮。
- en: 'Use the following rule settings to enable ICMP pass-through:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下规则设置来启用ICMP通过：
- en: 'Action: Pass'
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 操作：通过
- en: 'Interface: WAN'
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 接口：WAN
- en: 'Protocol: ICMP'
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 协议：ICMP
- en: 'All others: Defaults'
  id: totrans-71
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 其他所有人：默认
- en: Click on the **Save** button at the bottom of the screen.
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击屏幕底部的**保存**按钮。
- en: Click on the **Apply Changes** button at the top of the screen.
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击屏幕顶部的**应用更改**按钮。
- en: Use the **Interface** | **WAN** navigation menu to enter the WAN interface configuration
    menu and uncheck **Block private networks**. Apply the changes and return to **Firewall**
    | **Rules**.![Firewall configuration](img/7744OS_08_12.jpg)
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用**Interface** | **WAN**导航菜单进入WAN接口配置菜单，并取消选中**Block private networks**。应用更改并返回到**Firewall**
    | **Rules**。![Firewall configuration](img/7744OS_08_12.jpg)
- en: Click on the **add new rule** button.
  id: totrans-75
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击**添加新规则**按钮。
- en: Use the following rule settings to enable HTTP pass-through.
  id: totrans-76
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下规则设置启用HTTP通过。
- en: 'Action: Pass'
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 操作：通过
- en: 'Interface: WAN'
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 接口：WAN
- en: 'Protocol: TCP'
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 协议：TCP
- en: 'Destination port range: HTTP'
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 目标端口范围：HTTP
- en: Continue adding ports until the configuration matches the following:![Firewall
    configuration](img/7744OS_08_13.jpg)
  id: totrans-81
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 继续添加端口，直到配置与以下匹配：![防火墙配置](img/7744OS_08_13.jpg)
- en: At this point any machine connected to VLAN1 can communicate through the open
    ports as well as ping machines on the VLAN2 segment as can be seen in the following
    screenshot (this system running the scan is at `192.168.75.10):`
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一点上，连接到VLAN1的任何机器都可以通过开放的端口进行通信，以及ping VLAN2段上的机器，如下面的屏幕截图所示（运行扫描的系统位于`192.168.75.10`）：
- en: '![Firewall configuration](img/7744OS_08_14.jpg)'
  id: totrans-83
  prefs: []
  type: TYPE_IMG
  zh: '![防火墙配置](img/7744OS_08_14.jpg)'
- en: Stealth scanning through the firewall
  id: totrans-84
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 通过防火墙进行隐秘扫描
- en: In this day and age, the most common security mechanism in place will be some
    sort of firewall. Firewalls are a great security mechanism when used in conjunction
    with other security controls; however, they must be properly maintained and monitored
    to be truly effective. There are several mechanisms that can be used to attempt
    to bypass these devices.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在当今时代，最常见的安全机制将是某种防火墙。防火墙是一个很好的安全机制，当与其他安全控制一起使用时；然而，它们必须得到适当的维护和监控才能真正发挥作用。有几种机制可以尝试绕过这些设备。
- en: Finding the ports
  id: totrans-86
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 查找端口
- en: It is important to know where you are being blocked when scanning. When testing
    through a firewall it may become difficult to prepare a stealthy attack if you
    do not have all of the information. Remember that tools such as Firewalker or
    Hping can assist with determining where the block occurs and if the port is truly
    available or just closed. Although this may seem trivial, knowing if there is
    a firewall in the first place is fairly important as well.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 在扫描时知道您被阻止的位置是很重要的。通过防火墙测试时，如果您没有所有的信息，准备一个隐秘的攻击可能会变得困难。记住，诸如Firewalker或Hping之类的工具可以帮助确定阻塞发生的位置，以及端口是否真的可用或者只是关闭。虽然这可能看起来微不足道，但首先知道是否有防火墙是相当重要的。
- en: Traceroute to find out if there is a firewall
  id: totrans-88
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用Traceroute查找是否有防火墙
- en: 'Sometimes we can use traceroute to see the path to the target system. Let''s
    take a look at a open traceroute from VLAN2 to VLAN1:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 有时我们可以使用traceroute来查看到目标系统的路径。让我们看一下从VLAN2到VLAN1的开放traceroute：
- en: '[PRE2]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Looking at this result we can see that the first hop goes through our gateway
    at `192.168.101.1` before being routed to the host. Now we will try the reverse
    from the BackTrack machine:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 查看这个结果，我们可以看到第一跳经过我们的网关`192.168.101.1`，然后被路由到主机。现在我们将尝试从BackTrack机器进行反向操作：
- en: '[PRE3]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Something is blocking us from receiving the path information (it's the pfSense
    firewall configuration). This technique is not always useful, but definitely good
    to know about.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 有些东西阻止我们接收路径信息（这是pfSense防火墙配置）。这种技术并不总是有用，但绝对值得了解。
- en: Finding out if the firewall is blocking certain ports
  id: totrans-94
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 查找防火墙是否阻止某些端口
- en: There is a firewall; now what? The next step is to determine which ports are
    being blocked by the firewall, or more importantly which are open.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 有一个防火墙；接下来呢？下一步是确定防火墙阻止了哪些端口，或者更重要的是哪些是开放的。
- en: Hping
  id: totrans-96
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: Hping
- en: 'Hping2 and Hping3 are included as part of the BackTrack 5 distribution. It
    can be accessed via the GUI navigation bar **Applications** | **BackTrack** |
    **Information Gathering** | **Network Analysis** | **Identify Live Hosts** | **Hping2**.
    It can also be invoked at the command line by simply typing: `hping2`. Hping2
    is a powerful tool that can be used for various security testing tasks. The following
    syntax can be used to find open ports while remaining fully in control of your
    scan:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: Hping2和Hping3包含在BackTrack 5发行版中。可以通过GUI导航栏**应用程序** | **BackTrack** | **信息收集**
    | **网络分析** | **识别活动主机** | **Hping2**访问。也可以通过简单地输入`hping2`来在命令行中调用。Hping2是一个强大的工具，可用于各种安全测试任务。以下语法可用于查找开放端口，同时完全控制您的扫描：
- en: '[PRE4]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: This command allowed us to perform a `SYN` scan starting at port 1 and incrementing
    for 80 steps.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 这个命令允许我们执行一个从端口1开始递增80步的`SYN`扫描。
- en: Note
  id: totrans-100
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*CTRL + Z* is used to manually increment ports. Start low and work your way
    up manually. Start an Hping2 scan and give it a try!'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: '*CTRL + Z*用于手动递增端口。从低端口开始手动递增。开始一个Hping2扫描，试一试！'
- en: 'Depending on the firewall configuration it may also be possible to send spoofed
    packets. During a test it is beneficial to ensure that the configuration does
    not allow for this behavior to occur. Hping is perfectly suited for this task.
    The following is an example of how you may test if the firewall allows this traffic
    to pass:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 根据防火墙配置，可能也可以发送伪造的数据包。在测试中，有利于确保配置不允许发生这种行为。Hping非常适合这项任务。以下是一个示例，您可以测试防火墙是否允许这个流量通过：
- en: '[PRE5]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: This command will spoof 10 packets from `192.168.101.101` to port 80 on `192.168.101.100`.
    This is the basis for an idle scan and if successful would allow you to `hping`
    the `192.168.101.101` machine to look for an increase in the IP sequence number.
    In this case we could enable monitoring on the pfSense machine to emulate what
    this traffic looks like to a network administrator reviewing the logs.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 这个命令将伪装10个数据包从`192.168.101.101`到`192.168.101.100`的80端口。这是一个空闲扫描的基础，如果成功的话，将允许您对`192.168.101.101`机器进行`hping`，以查找IP序列号的增加。在这种情况下，我们可以在pfSense机器上启用监视，模拟这个流量对于审查日志的网络管理员来说是什么样子。
- en: Challenge yourself to create and monitor different packets and uses of Hping
    so that you can gain a good understanding of the traffic flow. The best means
    of remaining undetected while testing is to fully understand the technology that
    is being used.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 挑战自己创建和监视不同的数据包和Hping的用法，以便您可以对流量流向有很好的理解。在测试时保持不被发现的最佳方法是充分了解正在使用的技术。
- en: Take a look at the logs generated from a successful scan and keep in mind that
    due to the amount of traffic involved even secured networks will sometimes only
    log and trigger events based on denied traffic.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 查看成功扫描生成的日志，并牢记由于涉及的流量量即使是安全的网络有时也只会记录和触发基于拒绝流量的事件。
- en: Note
  id: totrans-107
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Logging per rule will need to be enabled on the firewall to see allowed traffic.
    Not logging permitted traffic is fairly standard practice as it reduces the firewall
    log size. Educate your clients that proactively monitoring allowed traffic can
    also be beneficial when attempting to truly secure a network.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 需要在防火墙上启用每条规则的日志记录，以查看允许的流量。不记录允许的流量是相当标准的做法，因为它可以减少防火墙日志的大小。教育您的客户，积极监视允许的流量在试图真正保护网络时也可能是有益的。
- en: '![Hping](img/7744OS_08_15.jpg)'
  id: totrans-109
  prefs: []
  type: TYPE_IMG
  zh: '![Hping](img/7744OS_08_15.jpg)'
- en: The granular control of `hping2` in combination with the scripting capabilities
    of `hping3` makes the Hping tool an invaluable addition to every pentesters toolbox.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: '`hping2`的细粒度控制与`hping3`的脚本功能相结合，使Hping工具成为每个渗透测试人员工具箱中不可或缺的一部分。'
- en: 'Further information and tutorials about how to effectively use Hping2 and Hping3
    can be found at the Hping wiki: [http://wiki.hping.org/](http://wiki.hping.org/).'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 有关如何有效使用Hping2和Hping3的更多信息和教程可以在Hping wiki上找到：[http://wiki.hping.org/](http://wiki.hping.org/)。
- en: Nmap firewalk script
  id: totrans-112
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: Nmap firewalk脚本
- en: 'One of the easiest methods to test open ports on a firewall is to simply use
    the firewalking script for Nmap. To test the open firewall ports you will need
    a host behind the firewall as the target:'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 测试防火墙上开放端口的最简单方法之一是简单地使用Nmap的firewalking脚本。要测试开放的防火墙端口，您需要一个位于防火墙后面的主机作为目标：
- en: '[PRE6]'
  id: totrans-114
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'The command sequence is straightforward and familiar: we invoke `nmap`, use
    the script option, and choose the firewalk script. We then provide the input that
    firewalk needs by performing a traceroute to `192.168.101.100` which we know is
    behind our target firewall.'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 命令序列是简单而熟悉的：我们调用`nmap`，使用脚本选项，并选择firewalk脚本。然后，我们通过对`192.168.101.100`执行traceroute来提供firewalk所需的输入，我们知道这个地址在我们的目标防火墙后面。
- en: '![Nmap firewalk script](img/7744OS_08_16.jpg)'
  id: totrans-116
  prefs: []
  type: TYPE_IMG
  zh: '![Nmap firewalk脚本](img/7744OS_08_16.jpg)'
- en: Although we were able to determine which ports on the firewall were open (21,
    80, and 443), if you take a look at the firewall denies it quickly becomes apparent
    that this is not a quiet test and should only be used when stealth is not needed.
    What this boils down to is that stealth requires patience and a well made plan
    of action. It may be easier to manually verify if there are any common ports open
    on the firewall and then try to scan using one of the well-known ports.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管我们能够确定防火墙上开放的端口（21、80和443），但如果您查看防火墙拒绝的情况，很快就会发现这不是一个安静的测试，只有在不需要隐秘时才应使用。归根结底，隐秘需要耐心和一个精心制定的行动计划。手动验证防火墙上是否有任何常见的端口打开，然后尝试使用其中一个众所周知的端口进行扫描可能更容易。
- en: Note
  id: totrans-118
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: To effectively emulate proper firewalking or port probing with Hping the network
    would need to have a gateway behind the firewall. This can be accomplished in
    a lab when replicating a production environment but is beyond the scope of this
    chapter. The commands remain the same; the information gained can increase dramatically.
    These tools use TTL to determine if a port is open or not and as our gateway is
    on the same machine as our firewall and router the results are varied and obscured.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 要有效地模拟使用Hping进行适当的firewalking或端口探测，网络需要在防火墙后面有一个网关。在复制生产环境时，这可以在实验室中完成，但超出了本章的范围。命令保持不变；获得的信息可能会大幅增加。这些工具使用TTL来确定端口是否打开，由于我们的网关与我们的防火墙和路由器在同一台机器上，结果是多样化和模糊的。
- en: '![Nmap firewalk script](img/7744OS_08_17.jpg)'
  id: totrans-120
  prefs: []
  type: TYPE_IMG
  zh: '![Nmap firewalk脚本](img/7744OS_08_17.jpg)'
- en: 'All in all, idle scans remain the best method of determining what is behind
    a properly locked down firewall. The flavor of the moment is `SYN Cache Idle`
    scanning and a great paper about this subject titled *Idle Port Scanning and Non-interference
    Analysis of Network Protocol Stacks Using Model Checking* written by Roya Ensafi,
    Jong Chun Park, Deepak Kapur, and Jedidiah R. Crandall, University of New Mexico
    can be found at : [http://www.usenix.org/events/sec10/tech/](http://www.usenix.org/events/sec10/tech/).'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 总的来说，空闲扫描仍然是确定一个经过适当锁定的防火墙后面是什么的最佳方法。当下最流行的是`SYN Cache Idle`扫描，关于这个主题的一篇很棒的论文，题为《Idle
    Port Scanning and Non-interference Analysis of Network Protocol Stacks Using Model
    Checking》，作者是Roya Ensafi、Jong Chun Park、Deepak Kapur和Jedidiah R. Crandall，来自新墨西哥大学，可以在以下网址找到：[http://www.usenix.org/events/sec10/tech/](http://www.usenix.org/events/sec10/tech/)。
- en: Now you see me, now you don't — Avoiding IDS
  id: totrans-122
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 现在你看到我，现在你看不到我 —— 避开IDS
- en: In a secured environment you can count on running into IDS and IPS. Properly
    configured and used as part of a true defense in depth model increases their effectiveness
    tremendously. This means that the IDS will need to be properly updated, monitored,
    and used in the proper locations. A penetration tester will be expected to verify
    that the IDS's are working properly in conjunction with all other security controls
    to properly protect the environment.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 在安全环境中，您可以指望遇到IDS和IPS。正确配置并作为真正深度防御模型的一部分使用会极大地增加它们的有效性。这意味着IDS将需要得到适当的更新、监视，并在适当的位置使用。渗透测试人员将被期望验证IDS是否与所有其他安全控制一起正常工作，以正确保护环境。
- en: The primary method of bypassing any IDS is to avoid signatures that are created
    to look for specific patterns. These signatures must be fine-tuned to find only
    positively malicious behavior and should not be so restrictive that alerts are
    triggered for normal traffic patterns. Over the years, the maturity level of these
    signatures has increased significantly, but a penetration tester or knowledgeable
    attacker will be able to use various means to bypass even the most carefully crafted
    signatures. In this section, we review some of the methods that have been used
    by attackers in the wild.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 绕过任何IDS的主要方法是避免创建用于查找特定模式的签名。这些签名必须经过精细调整，只能找到明显恶意行为，不应该过于限制，以至于触发正常流量模式的警报。多年来，这些签名的成熟度显著提高，但渗透测试人员或知识渊博的攻击者将能够使用各种手段来绕过甚至是最精心制作的签名。在本节中，我们将回顾一些攻击者在野外使用的方法。
- en: Canonicalization
  id: totrans-125
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 规范化
- en: 'Canonicalization refers to the act of substituting various inputs for the canonical
    name of a file or path. This practice can be as simple as substituting hexadecimal
    representations ASCII text values. Here is an example of an equivalent string:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 规范化是指用各种输入替换文件或路径的规范名称。这种做法可以简单到用十六进制表示ASCII文本值进行替换。以下是一个等效字符串的示例：
- en: '**String A in Hex:** "54:68:69:73:20:69:73:20:61:20:73:74:72:69:6e:67"'
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**十六进制中的字符串A:** "54:68:69:73:20:69:73:20:61:20:73:74:72:69:6e:67"'
- en: '**String A in text:** "This is a string"'
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**文本中的字符串A:** "This is a string"'
- en: '**String A in ASCII:** "084 104 105 115 032 105 115 032 097 032 115 116 114
    105 110 103"'
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**ASCII中的字符串A:** "084 104 105 115 032 105 115 032 097 032 115 116 114 105 110
    103"'
- en: 'By taking advantage of the fact there are sometimes literally thousands of
    combinations possible for a single URL. To put this into perspective, let''s take
    a look at the address we can use to get from our browser to our local Ubuntu Apache
    server:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 利用事实，有时一个URL可能有成千上万种组合。为了更好地理解这一点，让我们看看我们可以使用的地址，从浏览器到本地Ubuntu Apache服务器：
- en: '[PRE7]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Luckily, this address confuses our Apache server and we receive the following
    message:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 幸运的是，这个地址让我们的Apache服务器困惑了，我们收到了以下消息：
- en: '![Canonicalization](img/7744OS_08_18.jpg)'
  id: totrans-133
  prefs: []
  type: TYPE_IMG
  zh: '![规范化](img/7744OS_08_18.jpg)'
- en: 'The previous request attempted to load the local page at `127.0.0.1`. Let''s
    see what occurs when we try to load the remote pfSense administration console
    in the same manner:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 之前的请求尝试加载本地页面`127.0.0.1`。让我们看看当我们尝试以相同的方式加载远程pfSense管理控制台时会发生什么：
- en: '[PRE8]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Here we are warned by the web server hosting the pfSense administrative console
    that a potential DNS Rebind attack occurred:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们收到了托管pfSense管理控制台的Web服务器的警告，称可能发生了DNS Rebind攻击：
- en: '![Canonicalization](img/7744OS_08_19.jpg)'
  id: totrans-137
  prefs: []
  type: TYPE_IMG
  zh: '![规范化](img/7744OS_08_19.jpg)'
- en: 'Let''s try something else that actually works properly:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们尝试一些真正有效的东西：
- en: 'In the console, `ping` one of the addresses we listed above:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 在控制台中，`ping`我们上面列出的地址之一：
- en: '[PRE9]'
  id: totrans-140
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '[PRE10]'
  id: totrans-141
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: As we can see, the IP address resolved properly and we receive our replies as
    expected. This very same concept is key when trying to bypass an IDS rule. If
    the type of IDS can be determined, then it should be possible to get the signatures.
    When reviewing these signatures you would look for opportunities to obscure the
    URLs, filenames, or other path information enough that it is able to bypass the
    existing ruleset.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我们所看到的，IP地址得到了正确解析，我们也按预期收到了回复。当试图绕过IDS规则时，这个概念非常关键。如果能够确定IDS的类型，那么应该可以获取到签名。在审查这些签名时，你需要寻找模糊化URL、文件名或其他路径信息的机会，以便能够绕过现有的规则集。
- en: Note
  id: totrans-143
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Try this out with commonly found websites. Many web servers will properly interpret
    these URLs and serve the page. This can be interesting when used in combination
    with social engineering campaigns as well. Obscuring a URL in a phishing e-mail
    will lead to more clicks from users who are not properly trained.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 尝试在常见的网站上尝试这个。许多Web服务器将正确解释这些URL并提供页面。当与社会工程活动结合使用时，这可能会很有趣。在欺诈电子邮件中模糊URL将导致未经适当培训的用户点击更多。
- en: Timing is everything
  id: totrans-145
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 时机是关键
- en: In previous chapters we have already reviewed that timing can be critical when
    performing a network scan on a secured environment. Using Nmap we can adjust the
    number of packets that are sent in a given timeframe. IDS signatures look for
    patterns, and sending packets out to many machines in a short timeframe is a definite
    pattern.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 在之前的章节中，我们已经了解到在受保护环境中进行网络扫描时，时机可能至关重要。使用Nmap，我们可以调整在给定时间内发送的数据包数量。IDS签名寻找模式，向许多机器发送数据包是一个明显的模式。
- en: When attempting to bypass these mechanisms it is important to understand the
    logic behind the devices and how they work. If your traffic does not match what
    is normally seen on a network there is good possibility that you will be blocked
    before there is a chance to gain much information. This can be frustrating at
    best and lead to a failed assessment at worst. Take your time and plan out the
    stages needed for a successful test. It is better to start off slow and determine
    which type of security mechanisms are in place than to rush in and hit every possible
    port in the world and get your testing IP ranges auto-banned.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 在尝试绕过这些机制时，了解设备背后的逻辑和工作原理非常重要。如果你的流量与网络上通常看到的不符，那么很可能会在获得大量信息的机会之前被阻止。这可能会导致最好的情况下感到沮丧，最坏的情况下导致评估失败。花点时间规划成功测试所需的阶段。最好是慢慢开始，确定安装了哪种类型的安全机制，而不是匆忙行事，打开世界上所有可能的端口，然后让你的测试IP范围自动被禁止。
- en: Nmap and many other tools have the granularity and ability to restrict the timing
    of your scans. It may even be advisable to begin with some manual controlled network
    enumeration of specific ports that are suspected to be open rather than starting
    with an automated scan.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: Nmap和许多其他工具都具有精细度和能力来限制扫描的时间。甚至可能建议开始手动控制特定端口的网络枚举，而不是从自动扫描开始。
- en: Blending in
  id: totrans-149
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 融入其中
- en: Launching attacks internally can be both satisfying and rewarding. You will
    no longer be restricted by the protected outer shell of the network and can traverse
    at will. Be careful that the tools used do not give you away.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 内部发动攻击既令人满意又有回报。您将不再受限于网络的受保护外壳，可以自由穿越。要小心使用的工具不要暴露您。
- en: Tip
  id: totrans-151
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: By understanding what an administrator would see under certain conditions a
    penetration tester is more likely to perform well thought-out work that is in
    line with the final goal of the test as described in the rules of engagement contract.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 通过了解管理员在特定条件下会看到什么，渗透测试人员更有可能进行深思熟虑的工作，符合测试的最终目标，如在规则约定合同中所述。
- en: 'Here we have a connection from a BackTrack machine to a Kioptrix level 1 machine.
    Take a look at the strange traffic being logged by the firewall:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们从BackTrack机器到Kioptrix 1级机器建立了连接。看看防火墙记录的奇怪流量：
- en: '![Blending in](img/7744OS_08_20.jpg)'
  id: totrans-154
  prefs: []
  type: TYPE_IMG
  zh: '![融入](img/7744OS_08_20.jpg)'
- en: 'Now if we were to quickly log into the system and set up or escalate privilege
    of a user account to allow us SSH capability we could merge with the existing
    traffic on the network. Let''s take a look at the difference when we are logged
    into SSH now while running the `tree` command in the SSH session:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，如果我们快速登录系统并设置或提升用户帐户的特权，以允许我们进行SSH连接，我们可以与网络上现有的流量合并。让我们看看当我们在SSH会话中运行`tree`命令时的区别：
- en: '[PRE11]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'While this command is passing back the entire directory structure of the Linux
    box we see the following in the firewall logs:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然这个命令正在传回Linux框的整个目录结构，但我们在防火墙日志中看到以下内容：
- en: '![Blending in](img/7744OS_08_21.jpg)'
  id: totrans-158
  prefs: []
  type: TYPE_IMG
  zh: '![融入](img/7744OS_08_21.jpg)'
- en: Note that there are no entries for the SSH traffic. It is minimal compared to
    the previous port 139 traffic. With proper scripting the work that is done via
    post exploitation modules can be emulated from within an SSH connection as well,
    and this traffic is completely encrypted and likely to be used by various administrators
    throughout the network being tested.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，没有SSH流量的条目。与先前的端口139流量相比，它很少。通过适当的脚本编写，可以在SSH连接中模拟通过后期利用模块完成的工作，而且这种流量是完全加密的，很可能被测试网络中的各种管理员使用。
- en: Looking at traffic patterns
  id: totrans-160
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 查看流量模式
- en: Network sniffing can be a huge time saver. It is more difficult to use remote
    Windows machines to perform this task for you as the network card needs to be
    in promiscuous mode, but it can be done. Ideally, you will find a Unix or Linux
    host that can be turned into a listening station with little to no effort.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 网络嗅探可以节省大量时间。使用远程Windows机器为您执行此任务更加困难，因为网络卡需要处于混杂模式，但这是可以做到的。理想情况下，您会找到一个可以轻松成为监听站的Unix或Linux主机。
- en: 'Here we look at a compromised Linux host on the `192.168.101.0/24` subnet.
    Our attacking machine resides on `192.168.75.0/24` and cannot see the same traffic
    that the Linux machine does. We will use `tcpdump` which is readily available
    to many Linux distributions:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们看到了`192.168.101.0/24`子网上的一个受损的Linux主机。我们的攻击机器位于`192.168.75.0/24`，无法看到Linux机器所看到的相同流量。我们将使用`tcpdump`，这在许多Linux发行版中都是可用的：
- en: '[PRE12]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Here we invoke `tcpdump` on the remote Kioptrix machine we have SSH'd into using
    the games account we set up during the post exploitation chapter. We use the `-i`
    option to specify that we would like to use `eth0` as our listening adapter. We
    then tell the adapter to only capture the next `100` packets. The `-n` switch
    is used to avoid DNS lookups and will display IP numbers rather than hostnames.
    The output from this command will provide us with unfiltered packet information
    that is primarily related to our SSH connection.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们在远程Kioptrix机器上调用`tcpdump`，使用我们在后期利用章节中设置的games帐户进行SSH连接。我们使用`-i`选项指定我们想要使用`eth0`作为我们的监听适配器。然后告诉适配器只捕获接下来的`100`个数据包。使用`-n`开关来避免DNS查找，并显示IP地址而不是主机名。此命令的输出将为我们提供与我们的SSH连接相关的未经过滤的数据包信息。
- en: 'What is more interesting is to see what else is traversing that segment. Using
    a simple filter for `icmp` for instance we can see the following:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 更有趣的是看看在该段上还有什么其他东西。例如，使用简单的`icmp`过滤器，我们可以看到以下内容：
- en: '![Looking at traffic patterns](img/7744OS_08_22.jpg)'
  id: totrans-166
  prefs: []
  type: TYPE_IMG
  zh: '![查看流量模式](img/7744OS_08_22.jpg)'
- en: Looking at the preceding screenshot we can determine that there are additional
    units on this subnet. The great part about using `tcpdump` in this manner is that
    we are not interfering with traffic and simply sifting through information as
    it passes on the wire.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 通过查看前面的屏幕截图，我们可以确定该子网上还有其他单元。使用`tcpdump`的好处在于，我们不会干扰流量，只是在流量通过时筛选信息。
- en: Cleaning up compromised hosts
  id: totrans-168
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 清理受损主机
- en: When dealing with a small network it is easy to underestimate the time and effort
    it can take to clean up your compromised hosts. This task is critical in both
    avoiding detection and in leaving the network in pristine condition once your
    testing has been completed. The last thing anyone wants is to overlook a compromised
    host that has a meterpreter backdoor installed and waiting for the next person
    to come along and take advantage of! The key is to take meticulous notes and keep
    accurate record of not only what was done while testing, but also if the things
    that were done could possibly persist after testing.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 在处理小型网络时，很容易低估清理受损主机所需的时间和精力。这项任务对于避免被发现以及在测试完成后保持网络处于完美状态至关重要。任何人都不希望忽视一个安装了meterpreter后门并等待下一个人利用的受损主机！关键是要做详细的笔记，并准确记录测试期间所做的事情，以及测试后可能会持续存在的事情。
- en: Think about what we did in the post exploitation chapter; just how easy do you
    think it would be to forget that we enabled the games account to be used for SSH
    login and with root privilege and a weak password at that! It seems the only thing
    worse would be to accidently send the wrong report to a client and give away someone's
    confidential information. It may seem that people would never do either of these
    things, but there is a small chance that either could happen if proper planning
    and organization is not used. When dealing with one, two, or even five machines
    going back and cleaning up may not be a big concern or worry. What happens when
    you have 1000 machines on 40 different subnets though?
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 想想我们在后期利用章节中所做的事情；你认为我们启用了游戏帐户用于SSH登录，并且具有root特权和一个弱密码，这有多容易被忘记！似乎唯一更糟糕的是意外向客户发送错误的报告并泄露某人的机密信息。也许人们似乎永远不会做这两件事，但如果没有使用适当的规划和组织，这两件事都有一定的可能性。当处理一个、两个或甚至五个机器时，回头清理可能不是一个大问题或担心。但是，当您在40个不同子网上有1000台机器时会发生什么呢？
- en: Using a checklist
  id: totrans-171
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用清单
- en: If you have not scripted the full exploitation and post-exploitation process
    then make sure you are keeping a checklist for all actions that must be undone.
    This is above and beyond creating notes and logging commands for your final report.
    We are talking about the guide that will be used to ensure that nothing is left
    to chance and ALL changes are reversed properly something as small as adding a
    temporary file to a world writable directory so that you could test your blind
    SQL injection. If you cannot remove the file yourself, have something ready for
    the administrator to remind them to remove the files for you. The job of a penetration
    tester is to assist in verifying the security of an environment, not to make it
    more vulnerable.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您没有为完整的利用和后期利用过程编写脚本，请确保您为必须撤消的所有操作保持清单。这超出了为最终报告创建笔记和记录命令。我们正在谈论将用于确保没有留下任何机会和所有更改都正确撤消的指南，例如将临时文件添加到可写入世界目录中，以便您可以测试您的盲SQL注入。如果您无法自行删除文件，请准备好一些内容，以提醒管理员为您删除文件。渗透测试人员的工作是协助验证环境的安全性，而不是使其更容易受到攻击。
- en: When to clean up
  id: totrans-173
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 何时清理
- en: It is never too early to begin the cleanup process. Not only will this assist
    in remaining undetected, but it also ensures that a systematic approach is used
    throughout the entire penetration test.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 现在开始清理过程永远不会太早。这不仅有助于保持不被发现，而且还确保在整个渗透测试过程中使用系统化的方法。
- en: There is no need to have 300 open shells to the same subnet. Pick a target that
    allows you to set up a proper pivot and then remove the other shells from your
    list. The fewer machines you have to touch, the easier the cleanup will be. You
    will need the additional time for reporting and verifying results anyhow!
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 不需要在同一子网中打开300个外壳。选择一个允许您建立适当枢轴的目标，然后从列表中删除其他外壳。您需要额外的时间来报告和验证结果！
- en: Local log files
  id: totrans-176
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 本地日志文件
- en: It is critical to have a good understanding of where the log files are stored,
    what they capture, and how they report the data back to the administrator. Take
    the time to learn about the various log files for at least the most widely used
    operating systems such as popular Linux distributions and Windows Servers. If
    attempting to avoid detection, simply erasing the logs will probably not help
    achieve the desired result. It would be akin to taking someone's ice cream cone,
    eating the ice cream and returning the cone back to the freezer. Someone is going
    to notice. Instead use techniques that allow you to edit portions of the log files
    or escalate privilege to an account that is not monitored. Many of the tasks needed
    to enumerate an internal network do not require administrative privileges; maybe
    it would be better to use a restricted account for those activities in hopes that
    only admin actions are being logged and monitored?
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 了解日志文件存储位置、它们捕获的内容以及它们如何将数据报告给管理员至关重要。花时间了解至少最常用的操作系统（如流行的Linux发行版和Windows服务器）的各种日志文件。如果尝试避免被发现，简单地擦除日志可能不会帮助实现期望的结果。这就像拿走别人的冰淇淋蛋筒，吃掉冰淇淋，然后把蛋筒放回冰箱。总会有人注意到。相反，使用允许您编辑日志文件部分或提升特权到未受监视的帐户的技术。许多需要枚举内部网络的任务不需要管理员特权；也许最好使用受限帐户进行这些活动，希望只有管理员操作被记录和监视？
- en: Administrators that actually review logs are not going to look for the standard
    traffic. They will be looking for anomalies. In order to avoid detection your
    traffic and actions must be able to merge with those of an average user.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 实际审查日志的管理员不会寻找标准流量。他们将寻找异常。为了避免被发现，您的流量和操作必须能够与普通用户的流量和操作融合在一起。
- en: Miscellaneous evasion techniques
  id: totrans-179
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 其他规避技术
- en: The level of detection avoidance that can be accomplished varies from network
    to network. When performing the test keep in mind that in this day and age, resources
    are usually very limited and administrators are overworked and underappreciated.
    Focus on bypassing the automated detection methodologies and you are unlikely
    to be found by an active and eager admin unless your traffic and behavior patterns
    are drastically different from those of the average power user. When sniffing
    traffic and looking at network connections and activity you should be able to
    get an idea of what is considered normal traffic on the network.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 可以实现的规避检测的程度因网络而异。在进行测试时，请记住，在当今这个时代，资源通常非常有限，管理员工作繁重且得不到赏识。专注于绕过自动检测方法，您不太可能被积极和热切的管理员发现，除非您的流量和行为模式与普通高级用户的大不相同。当嗅探流量并查看网络连接和活动时，您应该能够了解网络上被视为正常流量的内容。
- en: Divide and conquer
  id: totrans-181
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 分而治之
- en: When performing scans it may be a good idea to use multiple sources to originate
    the scan from. This is more likely to be possible in large networks after a few
    people have clicked the links to your social engineering campaign page. Once you
    have several machines under your control it is not advisable to scan from a single
    machine. Use the tools to break the scans into chunks and to reduce the scan times.
    Take advantage of idle scans, especially when there are network enabled printers
    available.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 在执行扫描时，最好使用多个来源发起扫描。在大型网络中，一旦有几个人点击了您的社会工程活动页面上的链接，这更有可能实现。一旦您控制了几台机器，就不建议从单台机器进行扫描。使用工具将扫描分成块，并减少扫描时间。利用空闲扫描，特别是在有网络打印机可用时。
- en: Hiding out (on controlled units)
  id: totrans-183
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 躲藏（在受控单位上）
- en: If any of the systems you have control of start to be cleaned, reimaged, or
    otherwise remediated before the actual penetration test has been completed, slow
    down or at minimum cease all aggressive testing until it can be determined who
    or what is taking control of remediating the systems. There may be a third party
    involved in which case it will become extremely important that your traffic and
    efforts are not confused with those of the third party, especially if that person
    or group turns out to be malicious in nature and are trying to ensure they do
    not lose control of "their" owned systems to a rival group or person. In a perfect
    world this would not be the case and instead there is just a very good security
    and administrative group taking care of business and eliminating threats as they
    occur.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您控制的任何系统开始被清理、重新映像或以其他方式进行修复，而实际的渗透测试尚未完成，请减慢速度，或者至少停止所有激进的测试，直到确定是谁或什么在控制修复系统。可能涉及第三方，如果是这种情况，那么确保您的流量和努力不会与第三方的流量和努力混淆，特别是如果该人或团体最终被证明是恶意的，并试图确保他们不会失去对“他们”拥有的系统的控制权。在一个完美的世界中，这不会是这种情况，而是一个非常好的安全和管理团队正在处理业务，并在出现威胁时予以消除。
- en: File integrity monitoring
  id: totrans-185
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 文件完整性监控
- en: One security measure that we did not discuss often in this book is the usage
    of File Integrity Monitoring. Proper usage of this control can be devastating
    to an attacker and penetration tester alike. It is very simple for an administrator
    to use these tools to let them know when key files or directories have changed.
    Keep this in mind when running into those wide open systems that are just waiting
    to be completely pillaged. One improper change and the administrator and possibly
    security group will go into overdrive and start to look for the smallest anomalies
    on the network. This will guarantee that your job just got much more difficult.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在本书中没有经常讨论的一项安全措施是使用文件完整性监控。正确使用此控件对攻击者和渗透测试人员都可能具有毁灭性的影响。管理员可以非常简单地使用这些工具，让他们知道关键文件或目录何时发生了更改。当遇到那些等待被完全掠夺的开放系统时，请记住这一点。一次不当的更改，管理员甚至可能安全组都会加速并开始寻找网络上最小的异常。这将确保您的工作变得更加困难。
- en: FIM can usually be avoided by sticking to non-intrusive means of post exploitation
    and enumeration. Some directories and files, particularly those dealing with databases
    or temporary files, will not be scanned for changes due to the high rate of false
    positives. Ensure that any files you modify or drop are in those directories,
    and stay away from attempts at changing key system files. (Log files may be included
    in this!) Once again, think like an administrator and avoid any action that could
    easily be scripted to alert.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 通常可以通过坚持使用非侵入性的后渗透和枚举手段来避免FIM。一些目录和文件，特别是处理数据库或临时文件的文件，由于误报率高，不会被扫描更改。确保您修改或放置的任何文件都在这些目录中，并避免尝试更改关键系统文件。
    （日志文件可能包括在内！）再次思考像管理员一样，并避免任何可能轻易被脚本警报的行动。
- en: Using common network management tools to do the deed
  id: totrans-188
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用常见的网络管理工具来执行任务
- en: 'Last but not least: Use the tools at hand to perform enumeration and further
    exploitation. If the targeted system has a compiler installed, use it to compile
    your own network scanner instead of going to some random website from the machine
    and downloading one. Windows machines in particular have a broad range of Net
    commands and shell commands that make many enumeration and pillaging tasks a breeze.
    Use these tools to their fullest extent when performing your testing and you will
    probably not be detected by the administrators.'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 最后但并非最不重要的：利用手头的工具进行枚举和进一步的渗透。如果目标系统安装了编译器，可以使用它来编译自己的网络扫描器，而不是从机器上访问某个随机网站并下载一个。特别是Windows系统具有广泛的Net命令和shell命令，使许多枚举和掠夺任务变得轻而易举。在执行测试时充分利用这些工具，您可能不会被管理员检测到。
- en: Summary
  id: totrans-190
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we learned how to set up firewall rules in pfSense and monitor
    our traffic so that we can learn what type of activity is loud and which type
    is not. We also discussed how an IDS works and how we can take advantage of that
    knowledge to avoid detection when performing our scans, starting social engineering
    campaigns, or simply assessing a web application.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们学习了如何在pfSense中设置防火墙规则并监控我们的流量，以便了解哪种类型的活动是合法的，哪种类型不是。我们还讨论了入侵检测系统的工作原理，以及我们如何利用这些知识来避免在执行扫描、启动社会工程活动或简单评估Web应用程序时被检测到。
- en: We discussed traffic patterns and how attempting to match the traffic will assist
    in avoiding detection; after all, if all of the information looks the same how
    can anyone determine what is legitimate and what is not.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 我们讨论了流量模式以及如何尝试匹配流量将有助于避免检测；毕竟，如果所有信息看起来都一样，那么任何人都无法确定什么是合法的，什么是不合法的。
- en: Also discussed were various strategies of how detection avoidance may be possible
    if testing in a strategic and well thought-out manner. In closing, the mindset
    necessary to effectively and efficiently avoid detection was touched upon as well.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 还讨论了各种策略，说明了如果以战略和深思熟虑的方式进行测试，可能会避免检测。最后，还触及了有效和高效地避免检测所需的心态。
- en: In the next chapter, we will take a look at data collection tools and reporting.
    This is an important aspect of penetration testing and as such should not be overlooked.
    We take a look at generating a final report as well as providing a quick overview
    of effectively using tools such as vim, nano, NoteCase, and Dradis to keep track
    of your testing efforts.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将看看数据收集工具和报告。这是渗透测试的重要方面，因此不应忽视。我们将研究生成最终报告，以及提供有效使用诸如vim、nano、NoteCase和Dradis等工具来跟踪测试工作的快速概述。
