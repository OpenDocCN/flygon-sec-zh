# 第八章：绕过防火墙和避免检测

渗透测试的类型和范围将决定在渗透测试期间需要保持隐秘的需求。避免在测试期间被检测到的原因各种各样；其中一个好处可能包括测试据说保护网络的设备，另一个可能是您的客户想知道信息技术团队对环境中的有针对性攻击做出反应需要多长时间。您不仅需要警惕目标网络上的管理员和其他观察者，还需要了解自动检测方法，例如网络、基于主机的入侵检测系统，以避免触发警报。

### 提示

当面对最有利的目标时，花时间验证一下，确保它不是一种蜜罐，当检测到异常流量或活动时会触发警报！不要走进一个聪明管理员设置的陷阱。请注意，如果您确实发现了这样的系统，仍然非常重要确保它设置正确，不要因配置错误而无意中允许访问关键内部资产！

在本章中，我们将回顾以下内容：

+   渗透测试防火墙环境

+   在 IDS 下滑

+   在内部设置店铺

+   审查网络流量

+   使用标准凭据

+   清理被入侵的系统

# 实验室准备

为了跟上本章的示例，需要进行一些实验室准备。

### 提示

在整本书中，我们一直专注于能够模拟目标网络。这对于学习和实践最新和最伟大的技术至关重要，因为安全研究领域的优秀头脑继续用新的漏洞和可能的攻击向量给我们带来惊喜。本书无法涵盖测试网络的每种可能方法，但构建实验室是为了增加长期价值的尝试，希望能够导致终身的“黑客心态”。如果您继续建立自己的实验室并增加对自己设置的练习挑战的难度，您将很快就能够舒适地测试任何类型的环境。

BackTrack、pfSense 和 Ubuntu 虚拟机应该以以下方式进行配置：

![实验室准备](img/7744OS_08_01.jpg)

需要进行某些配置更改：

## BackTrack 客户机

这台机器需要连接到`192.168.75.0/24`子网。在 Oracle VM VirtualBox Manager 控制台中，突出显示 BackTrack 实例，然后从顶部导航栏中选择**设置**选项。确保只启用一个网络适配器。适配器应使用 Vlan1 内部网络选项。

![BackTrack 客户机](img/7744OS_08_02.jpg)

如前所述，在第三章中，*枚举：明智选择目标*，我们可以通过在 BackTrack 中输入以下命令将 IP 地址（在本例中为`192.168.75.10`）分配给以太网适配器（eth0）来进行配置。

```
# ifconfig eth0 192.168.75.10 netmask 255.255.255.0 broadcast 192.168.75.255 promisc 

```

由于 pfSense 机器还需要作为我们的路由器，我们需要将其设置为默认网关。可以按照以下步骤完成：

```
# route add default gw 192.168.75.1 

```

## Ubuntu 客户机

Ubuntu 机器将被用作目标。它需要配置为连接到 VLAN2，这是我们以前没有使用过的新内部网络。要创建内部网络，您需要在 Oracle VM VirtualBox Manager 的网络配置屏幕中手动输入 VLAN2。您的设置应该类似于以下内容：

![Ubuntu 客户机](img/7744OS_08_03.jpg)

## pfSense 客户机配置

配置我们的防火墙需要更多的工作。它需要能够将来自 VLAN1 网络的限制流量路由到 VLAN2 子网。我们需要进行几项配置更改，以确保这一点能够正常工作。

### 注意

pfSense 提供了从配置菜单重置为出厂默认设置的选项。请注意，如果选择此选项，则必须重新配置适配器。这并不困难，但所有先前的设置将丢失。如果担心丢失先前的配置，请务必制作 pfSense 机器的副本/快照。

### pfSense 网络设置

我们的防火墙客户机将使用两个网络适配器。一个将用于 VLAN1 段，另一个将用于 VLAN2 段。在本章的示例中，VLAN1 将被视为不受信任的广域网。网络适配器 1 应类似于以下截图：

![pfSense network setup](img/7744OS_08_04.jpg)

网络适配器 2 应类似于以下内容：

![pfSense network setup](img/7744OS_08_05.jpg)

### WAN IP 配置

剩下的网络设置将需要在客户机内部执行。

1.  启动您的 pfSense 虚拟实例。当 pfSense 尝试配置 WAN 适配器时可能会有额外的延迟。允许其完全加载，直到您看到以下菜单：![WAN IP configuration](img/7744OS_08_06.jpg)

1.  WAN 和 LAN 接口将需要正确配置。选择选项**2)设置接口 IP 地址**。

1.  选择选项 1 — WAN。![WAN IP configuration](img/7744OS_08_07.jpg)

1.  在要求通过 DHCP 配置 WAN 接口时，输入* n *以进行否。

1.  WAN 适配器的 IP 应为`192.168.75.1`。

1.  子网位数应设置为 24。输入`24`并按*Enter*。![WAN IP configuration](img/7744OS_08_08.jpg)

1.  按*Enter*返回到配置菜单。

### LAN IP 配置

我们也可以从配置菜单中设置 LAN IP 信息。在此配置 LAN 的一个好处是，我们可以同时为 VLAN2 配置 DHCP 服务器。

1.  从配置菜单中选择选项`2`以启动 LAN IP 配置模块。

1.  选择 LAN 接口（选项`2`）。

1.  在提示输入 IP 地址时，输入`192.168.101.1`。

1.  位数应设置为`24`。

1.  当询问是否要在 LAN 上启用 DHCP 服务器时，选择* y *以进行是。

1.  DHCP 客户端 IP 范围起始为`192.168.101.100`。

1.  DHCP 客户端 IP 范围停止为`192.168.101.110`。

1.  按*Enter*。![LAN IP configuration](img/7744OS_08_09.jpg)

1.  再次按*Enter*返回到配置菜单。

您的 LAN 和 WAN IP 范围应与以下匹配：

![LAN IP configuration](img/7744OS_08_10.jpg)

## 防火墙配置

pfSense 可以使用直观的 Web 界面进行配置。启动 Ubuntu 机器，打开终端并执行`sudo dhclient`以从 VLAN2（192.168.101.0/24）上的 pfSense DHCP 服务器获取地址。在 Ubuntu 机器上的 Web 浏览器中输入`http://192.168.101.1/`以访问配置面板。如果您已将其重置为出厂默认设置，则需要通过向导进行步骤以进入标准控制台。

### 注意

pfSense 的默认用户名和密码组合是：`admin/pfsense`。

要查看当前的防火墙规则，请选择**Firewall | Rules**并查看当前配置。默认情况下，WAN 接口应被阻止连接到内部，因为没有预先建立的规则允许任何流量通过。

![Firewall configuration](img/7744OS_08_11.jpg)

为了测试目的，我们将启用端口 80、443、21，并允许 ICMP。添加以下规则：

1.  单击前面截图中显示的**添加新规则**按钮。

1.  使用以下规则设置来启用 ICMP 通过：

+   操作：通过

+   接口：WAN

+   协议：ICMP

+   其他所有人：默认

1.  单击屏幕底部的**保存**按钮。

1.  单击屏幕顶部的**应用更改**按钮。

1.  使用**Interface** | **WAN**导航菜单进入 WAN 接口配置菜单，并取消选中**Block private networks**。应用更改并返回到**Firewall** | **Rules**。![Firewall configuration](img/7744OS_08_12.jpg)

1.  单击**添加新规则**按钮。

1.  使用以下规则设置启用 HTTP 通过。

+   操作：通过

+   接口：WAN

+   协议：TCP

+   目标端口范围：HTTP

1.  继续添加端口，直到配置与以下匹配：![防火墙配置](img/7744OS_08_13.jpg)

在这一点上，连接到 VLAN1 的任何机器都可以通过开放的端口进行通信，以及 ping VLAN2 段上的机器，如下面的屏幕截图所示（运行扫描的系统位于`192.168.75.10`）：

![防火墙配置](img/7744OS_08_14.jpg)

# 通过防火墙进行隐秘扫描

在当今时代，最常见的安全机制将是某种防火墙。防火墙是一个很好的安全机制，当与其他安全控制一起使用时；然而，它们必须得到适当的维护和监控才能真正发挥作用。有几种机制可以尝试绕过这些设备。

## 查找端口

在扫描时知道您被阻止的位置是很重要的。通过防火墙测试时，如果您没有所有的信息，准备一个隐秘的攻击可能会变得困难。记住，诸如 Firewalker 或 Hping 之类的工具可以帮助确定阻塞发生的位置，以及端口是否真的可用或者只是关闭。虽然这可能看起来微不足道，但首先知道是否有防火墙是相当重要的。

### 使用 Traceroute 查找是否有防火墙

有时我们可以使用 traceroute 来查看到目标系统的路径。让我们看一下从 VLAN2 到 VLAN1 的开放 traceroute：

```
student@Phobos:~$ traceroute 192.168.75.10 
traceroute to 192.168.75.10 (192.168.75.10), 30 hops max, 60 byte packets
1 pfSense.localdomain (192.168.101.1) 0.248 ms 0.166 ms 0.117 ms
2 192.168.75.10 (192.168.75.10) 1.351 ms 1.243 ms 1.188 ms

```

查看这个结果，我们可以看到第一跳经过我们的网关`192.168.101.1`，然后被路由到主机。现在我们将尝试从 BackTrack 机器进行反向操作：

```
root@bt:~# traceroute 192.168.101.1
traceroute to 192.168.101.1 (192.168.101.1), 30 hops max, 60 byte packets
1 * * *
2 * * *
[Truncated…]
30 * * *

```

有些东西阻止我们接收路径信息（这是 pfSense 防火墙配置）。这种技术并不总是有用，但绝对值得了解。

### 查找防火墙是否阻止某些端口

有一个防火墙；接下来呢？下一步是确定防火墙阻止了哪些端口，或者更重要的是哪些是开放的。

#### Hping

Hping2 和 Hping3 包含在 BackTrack 5 发行版中。可以通过 GUI 导航栏**应用程序** | **BackTrack** | **信息收集** | **网络分析** | **识别活动主机** | **Hping2**访问。也可以通过简单地输入`hping2`来在命令行中调用。Hping2 是一个强大的工具，可用于各种安全测试任务。以下语法可用于查找开放端口，同时完全控制您的扫描：

```
root@bt:/pentest# hping2 -S 192.168.101.100 -c 80 -p ++1 
HPING 192.168.101.100 (eth0 192.168.101.100): S set, 40 headers + 0 data bytes
len=46 ip=192.168.101.100 ttl=63 DF id=0 sport=21 flags=SA seq=20 win=5840 rtt=0.6 ms
len=46 ip=192.168.101.100 ttl=63 DF id=0 sport=80 flags=SA seq=79 win=5840 rtt=0.6 ms
--- 192.168.101.100 hping statistic ---
80 packets tramitted, 2 packets received, 98% packet loss
round-trip min/avg/max = 0.6/0.6/0.6 ms

```

这个命令允许我们执行一个从端口 1 开始递增 80 步的`SYN`扫描。

### 注意

*CTRL + Z*用于手动递增端口。从低端口开始手动递增。开始一个 Hping2 扫描，试一试！

根据防火墙配置，可能也可以发送伪造的数据包。在测试中，有利于确保配置不允许发生这种行为。Hping 非常适合这项任务。以下是一个示例，您可以测试防火墙是否允许这个流量通过：

```
hping2 -c10 -S --spoof 192.168.101.101 -p 80 192.168.101.100 

```

这个命令将伪装 10 个数据包从`192.168.101.101`到`192.168.101.100`的 80 端口。这是一个空闲扫描的基础，如果成功的话，将允许您对`192.168.101.101`机器进行`hping`，以查找 IP 序列号的增加。在这种情况下，我们可以在 pfSense 机器上启用监视，模拟这个流量对于审查日志的网络管理员来说是什么样子。

挑战自己创建和监视不同的数据包和 Hping 的用法，以便您可以对流量流向有很好的理解。在测试时保持不被发现的最佳方法是充分了解正在使用的技术。

查看成功扫描生成的日志，并牢记由于涉及的流量量即使是安全的网络有时也只会记录和触发基于拒绝流量的事件。

### 注意

需要在防火墙上启用每条规则的日志记录，以查看允许的流量。不记录允许的流量是相当标准的做法，因为它可以减少防火墙日志的大小。教育您的客户，积极监视允许的流量在试图真正保护网络时也可能是有益的。

![Hping](img/7744OS_08_15.jpg)

`hping2`的细粒度控制与`hping3`的脚本功能相结合，使 Hping 工具成为每个渗透测试人员工具箱中不可或缺的一部分。

有关如何有效使用 Hping2 和 Hping3 的更多信息和教程可以在 Hping wiki 上找到：[`wiki.hping.org/`](http://wiki.hping.org/)。

#### Nmap firewalk 脚本

测试防火墙上开放端口的最简单方法之一是简单地使用 Nmap 的 firewalking 脚本。要测试开放的防火墙端口，您需要一个位于防火墙后面的主机作为目标：

```
nmap --script=firewalk --traceroute 192.168.101.100 

```

命令序列是简单而熟悉的：我们调用`nmap`，使用脚本选项，并选择 firewalk 脚本。然后，我们通过对`192.168.101.100`执行 traceroute 来提供 firewalk 所需的输入，我们知道这个地址在我们的目标防火墙后面。

![Nmap firewalk 脚本](img/7744OS_08_16.jpg)

尽管我们能够确定防火墙上开放的端口（21、80 和 443），但如果您查看防火墙拒绝的情况，很快就会发现这不是一个安静的测试，只有在不需要隐秘时才应使用。归根结底，隐秘需要耐心和一个精心制定的行动计划。手动验证防火墙上是否有任何常见的端口打开，然后尝试使用其中一个众所周知的端口进行扫描可能更容易。

### 注意

要有效地模拟使用 Hping 进行适当的 firewalking 或端口探测，网络需要在防火墙后面有一个网关。在复制生产环境时，这可以在实验室中完成，但超出了本章的范围。命令保持不变；获得的信息可能会大幅增加。这些工具使用 TTL 来确定端口是否打开，由于我们的网关与我们的防火墙和路由器在同一台机器上，结果是多样化和模糊的。

![Nmap firewalk 脚本](img/7744OS_08_17.jpg)

总的来说，空闲扫描仍然是确定一个经过适当锁定的防火墙后面是什么的最佳方法。当下最流行的是`SYN Cache Idle`扫描，关于这个主题的一篇很棒的论文，题为《Idle Port Scanning and Non-interference Analysis of Network Protocol Stacks Using Model Checking》，作者是 Roya Ensafi、Jong Chun Park、Deepak Kapur 和 Jedidiah R. Crandall，来自新墨西哥大学，可以在以下网址找到：[`www.usenix.org/events/sec10/tech/`](http://www.usenix.org/events/sec10/tech/)。

# 现在你看到我，现在你看不到我 —— 避开 IDS

在安全环境中，您可以指望遇到 IDS 和 IPS。正确配置并作为真正深度防御模型的一部分使用会极大地增加它们的有效性。这意味着 IDS 将需要得到适当的更新、监视，并在适当的位置使用。渗透测试人员将被期望验证 IDS 是否与所有其他安全控制一起正常工作，以正确保护环境。

绕过任何 IDS 的主要方法是避免创建用于查找特定模式的签名。这些签名必须经过精细调整，只能找到明显恶意行为，不应该过于限制，以至于触发正常流量模式的警报。多年来，这些签名的成熟度显著提高，但渗透测试人员或知识渊博的攻击者将能够使用各种手段来绕过甚至是最精心制作的签名。在本节中，我们将回顾一些攻击者在野外使用的方法。

## 规范化

规范化是指用各种输入替换文件或路径的规范名称。这种做法可以简单到用十六进制表示 ASCII 文本值进行替换。以下是一个等效字符串的示例：

+   **十六进制中的字符串 A:** "54:68:69:73:20:69:73:20:61:20:73:74:72:69:6e:67"

+   **文本中的字符串 A:** "This is a string"

+   **ASCII 中的字符串 A:** "084 104 105 115 032 105 115 032 097 032 115 116 114 105 110 103"

利用事实，有时一个 URL 可能有成千上万种组合。为了更好地理解这一点，让我们看看我们可以使用的地址，从浏览器到本地 Ubuntu Apache 服务器：

```
http://2130706433/ 

```

幸运的是，这个地址让我们的 Apache 服务器困惑了，我们收到了以下消息：

![规范化](img/7744OS_08_18.jpg)

之前的请求尝试加载本地页面`127.0.0.1`。让我们看看当我们尝试以相同的方式加载远程 pfSense 管理控制台时会发生什么：

```
http://3232254721/ 

```

在这里，我们收到了托管 pfSense 管理控制台的 Web 服务器的警告，称可能发生了 DNS Rebind 攻击：

![规范化](img/7744OS_08_19.jpg)

让我们尝试一些真正有效的东西：

在控制台中，`ping`我们上面列出的地址之一：

```
PING 3232254721 (192.168.75.1) 56(84) bytes of data. 

```

```
64 bytes from 192.168.75.1: icmp_seq=1 ttl=64 time=9.34 ms
64 bytes from 192.168.75.1: icmp_seq=2 ttl=64 time=0.265 ms
64 bytes from 192.168.75.1: icmp_seq=3 ttl=64 time=0.292 ms

```

正如我们所看到的，IP 地址得到了正确解析，我们也按预期收到了回复。当试图绕过 IDS 规则时，这个概念非常关键。如果能够确定 IDS 的类型，那么应该可以获取到签名。在审查这些签名时，你需要寻找模糊化 URL、文件名或其他路径信息的机会，以便能够绕过现有的规则集。

### 注意

尝试在常见的网站上尝试这个。许多 Web 服务器将正确解释这些 URL 并提供页面。当与社会工程活动结合使用时，这可能会很有趣。在欺诈电子邮件中模糊 URL 将导致未经适当培训的用户点击更多。

## 时机是关键

在之前的章节中，我们已经了解到在受保护环境中进行网络扫描时，时机可能至关重要。使用 Nmap，我们可以调整在给定时间内发送的数据包数量。IDS 签名寻找模式，向许多机器发送数据包是一个明显的模式。

在尝试绕过这些机制时，了解设备背后的逻辑和工作原理非常重要。如果你的流量与网络上通常看到的不符，那么很可能会在获得大量信息的机会之前被阻止。这可能会导致最好的情况下感到沮丧，最坏的情况下导致评估失败。花点时间规划成功测试所需的阶段。最好是慢慢开始，确定安装了哪种类型的安全机制，而不是匆忙行事，打开世界上所有可能的端口，然后让你的测试 IP 范围自动被禁止。

Nmap 和许多其他工具都具有精细度和能力来限制扫描的时间。甚至可能建议开始手动控制特定端口的网络枚举，而不是从自动扫描开始。

# 融入其中

内部发动攻击既令人满意又有回报。您将不再受限于网络的受保护外壳，可以自由穿越。要小心使用的工具不要暴露您。

### 提示

通过了解管理员在特定条件下会看到什么，渗透测试人员更有可能进行深思熟虑的工作，符合测试的最终目标，如在规则约定合同中所述。

在这里，我们从 BackTrack 机器到 Kioptrix 1 级机器建立了连接。看看防火墙记录的奇怪流量：

![融入](img/7744OS_08_20.jpg)

现在，如果我们快速登录系统并设置或提升用户帐户的特权，以允许我们进行 SSH 连接，我们可以与网络上现有的流量合并。让我们看看当我们在 SSH 会话中运行`tree`命令时的区别：

```
bash-2.05# tree | head 
.
|-- X11R6
| |-- bin
| | |-- fslsfonts
| | |-- fstobdf
| | |-- mkfontdir
| | |-- xfs
| | `-- xfsinfo
| |-- include
| |-- lib |
[Output Truncated…]
| |-- i686
| | `-- noarch
| |-- SOURCES
| |-- SPECS
| `-- SRPMS
`-- tmp -> ../var/tmp
2093 directories, 33808 files
bash-2.05#

```

虽然这个命令正在传回 Linux 框的整个目录结构，但我们在防火墙日志中看到以下内容：

![融入](img/7744OS_08_21.jpg)

请注意，没有 SSH 流量的条目。与先前的端口 139 流量相比，它很少。通过适当的脚本编写，可以在 SSH 连接中模拟通过后期利用模块完成的工作，而且这种流量是完全加密的，很可能被测试网络中的各种管理员使用。

# 查看流量模式

网络嗅探可以节省大量时间。使用远程 Windows 机器为您执行此任务更加困难，因为网络卡需要处于混杂模式，但这是可以做到的。理想情况下，您会找到一个可以轻松成为监听站的 Unix 或 Linux 主机。

在这里，我们看到了`192.168.101.0/24`子网上的一个受损的 Linux 主机。我们的攻击机器位于`192.168.75.0/24`，无法看到 Linux 机器所看到的相同流量。我们将使用`tcpdump`，这在许多 Linux 发行版中都是可用的：

```
tcpdump -i eth0 -c 100 -n 

```

在这里，我们在远程 Kioptrix 机器上调用`tcpdump`，使用我们在后期利用章节中设置的 games 帐户进行 SSH 连接。我们使用`-i`选项指定我们想要使用`eth0`作为我们的监听适配器。然后告诉适配器只捕获接下来的`100`个数据包。使用`-n`开关来避免 DNS 查找，并显示 IP 地址而不是主机名。此命令的输出将为我们提供与我们的 SSH 连接相关的未经过滤的数据包信息。

更有趣的是看看在该段上还有什么其他东西。例如，使用简单的`icmp`过滤器，我们可以看到以下内容：

![查看流量模式](img/7744OS_08_22.jpg)

通过查看前面的屏幕截图，我们可以确定该子网上还有其他单元。使用`tcpdump`的好处在于，我们不会干扰流量，只是在流量通过时筛选信息。

# 清理受损主机

在处理小型网络时，很容易低估清理受损主机所需的时间和精力。这项任务对于避免被发现以及在测试完成后保持网络处于完美状态至关重要。任何人都不希望忽视一个安装了 meterpreter 后门并等待下一个人利用的受损主机！关键是要做详细的笔记，并准确记录测试期间所做的事情，以及测试后可能会持续存在的事情。

想想我们在后期利用章节中所做的事情；你认为我们启用了游戏帐户用于 SSH 登录，并且具有 root 特权和一个弱密码，这有多容易被忘记！似乎唯一更糟糕的是意外向客户发送错误的报告并泄露某人的机密信息。也许人们似乎永远不会做这两件事，但如果没有使用适当的规划和组织，这两件事都有一定的可能性。当处理一个、两个或甚至五个机器时，回头清理可能不是一个大问题或担心。但是，当您在 40 个不同子网上有 1000 台机器时会发生什么呢？

## 使用清单

如果您没有为完整的利用和后期利用过程编写脚本，请确保您为必须撤消的所有操作保持清单。这超出了为最终报告创建笔记和记录命令。我们正在谈论将用于确保没有留下任何机会和所有更改都正确撤消的指南，例如将临时文件添加到可写入世界目录中，以便您可以测试您的盲 SQL 注入。如果您无法自行删除文件，请准备好一些内容，以提醒管理员为您删除文件。渗透测试人员的工作是协助验证环境的安全性，而不是使其更容易受到攻击。

## 何时清理

现在开始清理过程永远不会太早。这不仅有助于保持不被发现，而且还确保在整个渗透测试过程中使用系统化的方法。

不需要在同一子网中打开 300 个外壳。选择一个允许您建立适当枢轴的目标，然后从列表中删除其他外壳。您需要额外的时间来报告和验证结果！

## 本地日志文件

了解日志文件存储位置、它们捕获的内容以及它们如何将数据报告给管理员至关重要。花时间了解至少最常用的操作系统（如流行的 Linux 发行版和 Windows 服务器）的各种日志文件。如果尝试避免被发现，简单地擦除日志可能不会帮助实现期望的结果。这就像拿走别人的冰淇淋蛋筒，吃掉冰淇淋，然后把蛋筒放回冰箱。总会有人注意到。相反，使用允许您编辑日志文件部分或提升特权到未受监视的帐户的技术。许多需要枚举内部网络的任务不需要管理员特权；也许最好使用受限帐户进行这些活动，希望只有管理员操作被记录和监视？

实际审查日志的管理员不会寻找标准流量。他们将寻找异常。为了避免被发现，您的流量和操作必须能够与普通用户的流量和操作融合在一起。

# 其他规避技术

可以实现的规避检测的程度因网络而异。在进行测试时，请记住，在当今这个时代，资源通常非常有限，管理员工作繁重且得不到赏识。专注于绕过自动检测方法，您不太可能被积极和热切的管理员发现，除非您的流量和行为模式与普通高级用户的大不相同。当嗅探流量并查看网络连接和活动时，您应该能够了解网络上被视为正常流量的内容。

## 分而治之

在执行扫描时，最好使用多个来源发起扫描。在大型网络中，一旦有几个人点击了您的社会工程活动页面上的链接，这更有可能实现。一旦您控制了几台机器，就不建议从单台机器进行扫描。使用工具将扫描分成块，并减少扫描时间。利用空闲扫描，特别是在有网络打印机可用时。

## 躲藏（在受控单位上）

如果您控制的任何系统开始被清理、重新映像或以其他方式进行修复，而实际的渗透测试尚未完成，请减慢速度，或者至少停止所有激进的测试，直到确定是谁或什么在控制修复系统。可能涉及第三方，如果是这种情况，那么确保您的流量和努力不会与第三方的流量和努力混淆，特别是如果该人或团体最终被证明是恶意的，并试图确保他们不会失去对“他们”拥有的系统的控制权。在一个完美的世界中，这不会是这种情况，而是一个非常好的安全和管理团队正在处理业务，并在出现威胁时予以消除。

## 文件完整性监控

我们在本书中没有经常讨论的一项安全措施是使用文件完整性监控。正确使用此控件对攻击者和渗透测试人员都可能具有毁灭性的影响。管理员可以非常简单地使用这些工具，让他们知道关键文件或目录何时发生了更改。当遇到那些等待被完全掠夺的开放系统时，请记住这一点。一次不当的更改，管理员甚至可能安全组都会加速并开始寻找网络上最小的异常。这将确保您的工作变得更加困难。

通常可以通过坚持使用非侵入性的后渗透和枚举手段来避免 FIM。一些目录和文件，特别是处理数据库或临时文件的文件，由于误报率高，不会被扫描更改。确保您修改或放置的任何文件都在这些目录中，并避免尝试更改关键系统文件。 （日志文件可能包括在内！）再次思考像管理员一样，并避免任何可能轻易被脚本警报的行动。

## 利用常见的网络管理工具来执行任务

最后但并非最不重要的：利用手头的工具进行枚举和进一步的渗透。如果目标系统安装了编译器，可以使用它来编译自己的网络扫描器，而不是从机器上访问某个随机网站并下载一个。特别是 Windows 系统具有广泛的 Net 命令和 shell 命令，使许多枚举和掠夺任务变得轻而易举。在执行测试时充分利用这些工具，您可能不会被管理员检测到。

# 总结

在本章中，我们学习了如何在 pfSense 中设置防火墙规则并监控我们的流量，以便了解哪种类型的活动是合法的，哪种类型不是。我们还讨论了入侵检测系统的工作原理，以及我们如何利用这些知识来避免在执行扫描、启动社会工程活动或简单评估 Web 应用程序时被检测到。

我们讨论了流量模式以及如何尝试匹配流量将有助于避免检测；毕竟，如果所有信息看起来都一样，那么任何人都无法确定什么是合法的，什么是不合法的。

还讨论了各种策略，说明了如果以战略和深思熟虑的方式进行测试，可能会避免检测。最后，还触及了有效和高效地避免检测所需的心态。

在下一章中，我们将看看数据收集工具和报告。这是渗透测试的重要方面，因此不应忽视。我们将研究生成最终报告，以及提供有效使用诸如 vim、nano、NoteCase 和 Dradis 等工具来跟踪测试工作的快速概述。
