# 第十章。设置虚拟测试实验室环境

保持技能更新在大多数行业中都非常重要；对于渗透测试也是如此。渗透测试技能需要时间来发展，而且信息安全领域每天都在变化。考虑到这一点，在当今这个时代，获得一台配备 4-16GB RAM 和四核或六核处理器的半强大计算机系统并不困难。这样的设备可以让渗透测试人员构建出完整的虚拟网络，用作实践实验室。在本章中，我们将审查构建这样的环境。我们将尝试使用有限的系统资源来模拟我们可能在使用中看到的受保护网络类型。

我们将在本章讨论以下内容：

+   模拟带有防火墙的简单网络

+   设置多层 DMZ

+   在虚拟环境中模拟更复杂的网络

# 为什么要设置实验室？

看起来，在更全面的测试环境中进行实验将始终是最佳选择，但实际上，您可能只会增加不必要的复杂性，这可能会转移或完全破坏测试。

让我们来看看如何设置一个运行简单 Web 应用程序的 Web 服务器。在选择实验室环境之前，我们需要确定我们要测试什么。应该问的一些问题包括：

+   有没有特定的服务是必需的，以确保测试准确地模拟真实世界测试中所见的环境？

+   负载均衡？

+   特定版本的软件？

+   防火墙？

+   有没有因素会导致结果不准确地代表真实生产环境中发生的情况？

+   您的实验室是否为您提供了在真实世界中复制您的发现所需的实践经验；如果没有，需要做出哪些改变？

希望这个基本问题的快速列表能为您准备好在选择哪种类型的实验室更可取以及为哪项任务考虑时应考虑的因素。有许多情景可以通过简单的虚拟客户机进行测试；另一方面，有些情景将需要使用数十甚至数百台系统来准确代表您在真实环境中的体验。无论您选择如何构建您的实验室，它都应该始终允许您进行修改或构建现有系统。它还应该简单易管理，并根据需要进行更新。

### 注意

对新构建的系统进行快照可能是确保必要的操作系统构建在需要时准备就绪的一种有效和高效的方法。

# 保持简单

有时可以建立一个满足测试要求的简单实验室。在学习环境中，保持简单通常会减少学习曲线，并使相关材料能够快速吸收，而不是被琐碎的事实或不相关的配置设置所淹没。在本书中，每个部分都试图使用最少的系统设置来审查手头的任务。在构建实验室时，不应轻率选择这种选项。

## 直截了当的测试示例

许多新的漏洞和漏洞的例子可以通过简单的配置进行测试，例如：

![直截了当的测试示例](img/7744OS_10_01.jpg)

这个网络就是最简单的（除了直接从目标机器本身进行测试，这对于许多情况来说肯定是有用的）。

我们有一台 BackTrack 机器连接到与易受攻击目标机器相同的 LAN 段。没有内联防火墙或其他任何东西会妨碍验证利用代码是否按预期工作。如果在测试某些方法或技术时遇到问题，这将是一个很好的健全检查。

我们不会介绍设置这种类型的环境，因为它已经在整本书中多次涵盖过。

## 网络分割和防火墙

内联防火墙和适当的网络分割使得以下基本网络基础设施与网关或防火墙分隔测试机器与易受攻击目标成为常见现象。这种分层防御只是保护典型环境的一小步：

![网络分割和防火墙](img/7744OS_10_02.jpg)

从外部世界来看，系统将拥有一个公共可访问的 IP 地址，然后在后端它将拥有一个真实的 IP 地址（可能使用 NAT 不可路由的地址）。来回传输的任何流量都将通过网关或防火墙进行处理。让我们看看如何模拟这样的环境：

### 要求

要跟随此示例构建，您将需要以下内容：

+   Oracle 的 Virtualbox 最新版本

+   2 GB RAM

+   M0n0Wall 虚拟客户机

+   BackTrack 虚拟客户机

+   Ubuntu Server 10.04 稳定版与 LAMP（连接到 MyLab2）

这就是开始所需的一切！

### 设置

我们将从设置**M0n0Wall**防火墙安装开始。如果您在之前的章节中使用过 pfSense，您会注意到设置非常相似。在这种情况下，我们的 M0n0Wall 实例将有三个适配器：WAN、LAN、OPT1。首先在[`m0n0.ch/wall/downloads.php`](http://m0n0.ch/wall/downloads.php)下载 M0n0Wall。我们将使用`cdrom-1.33.iso`版本，尽管任何未来的版本在设置上应该非常相似。由于所需资源有限，M0n0Wall 是一个成熟的小型防火墙，非常适合我们的需求。

在 VirtualBox 中使用以下设置来设置新的客户机：

+   名称：M0n0Wall_Base_Install

+   操作系统类型：BSD/FreeBSD

+   内存：128 MB

+   虚拟硬盘：**启动盘**已选中，**创建新硬盘**已选择

+   创建新虚拟磁盘：VDI

+   虚拟磁盘存储详细信息：动态分配

+   虚拟磁盘文件位置和大小：（放在用于未来实验的文件夹中），大小为 200 MB

这台机器将需要使用 VirtualBox Manager 配置三个网络适配器。

+   **网络适配器 1**应配置为使用**NAT**，这将是我们的 WAN 连接

+   **网络适配器 2**需要配置为内部网络名称`MyLab1`，它将代表我们的 LAN 连接并

+   **网络适配器 3**应设置为内部网络名称`MyLab2`，并将与我们的内部网络（OPT 设备）绑定

### 提示

使用**PCnet-PCI II**适配器将减少可能出现问题的机会。此外，建议更改每个适配器的 MAC 地址，以便更容易确定在服务器设置中选择的适配器。例如，如果网络适配器 1 的当前 MAC 地址为 0800270DD321，则将其更改为 0800270DD31A 将提供一个易于记忆的视觉提示：1A 是适配器 1，2B 可以是适配器 2，依此类推。

`M0n0Wall`将需要安装在新的 VirtualBox 机器上。

1.  启动`M0n0Wall_Base_Install`并选择从[`m0n0.ch/wall/downloads.php`](http://m0n0.ch/wall/downloads.php)下载的安装介质。

1.  选择**7)在硬盘上安装**选项：![设置](img/7744OS_10_03.jpg)

1.  当被问及要安装在哪个硬盘时，请选择您的硬盘（在本例中是`ad0)`。![设置](img/7744OS_10_04.jpg)

1.  在提示时重新启动，并确保系统从硬盘安装而不是 ISO 启动。

现在 M0n0Wall 已经安装好了，我们必须配置接口：

1.  选择**1)接口：分配网络端口**并按*Enter*。

1.  当提示可用接口列表时，继续设置您的 VLAN。按*y*继续。

1.  输入第一个适配器的父接口名称。这将显示在您的显示器上的 MAC 地址旁边：![设置](img/7744OS_10_05.jpg)

1.  继续为每个适配器创建过程。在这种情况下，我们的`lnc0`适配器分配给 VLAN 1，`lnc1`分配给 2，`lnc2`分配给 VLAN 3。这些 VLAN 可以是 1 到 4094 之间的任何未使用的数字。

1.  确定 LAN 接口名称时，请选择分配给 MyLab1 的适配器，WAN 适配器应分配给 NAT 适配器，而 MyLab2 适配器应分配为 OPT 设备：![设置](img/7744OS_10_06.jpg)

1.  重新启动防火墙以保存您的更改。

防火墙已安装在我们的硬盘上，并且适配器已分配给 VLAN。现在我们需要设置 LAN IP 地址并连接到 Web 界面进行进一步配置。作为可选步骤，可以更改默认密码。为了简单起见，我们将在本练习的其余部分继续使用默认密码。

1.  选择选项**2）设置 LAN IP 地址**并按*Enter*继续。

1.  在提示时输入您想要您的 LAN 使用的 IP 地址。我们将选择`192.168.50.1`。![设置](img/7744OS_10_07.jpg)

现在我们可以在 MyLab1 内部网络上启动 BackTrack 实例，并通过首先在适当范围内获取新的 DHCP 地址，然后将我们的 Web 浏览器定向到`http://192.168.50.1:`来连接防火墙的 Web 界面。

![设置](img/7744OS_10_08.jpg)

我们需要设置其他接口以执行我们心中的任务，即为`192.168.75.0/24`子网提供到我们的易受攻击主机的防火墙路由，该主机位于`192.168.75.100`（将 Ubuntu 机器连接到 MyLab2）。从屏幕左侧的导航菜单中选择**OPT1 接口**，通过选中适当的复选框启用它。将**桥接到**选项保留为无，并为此接口输入 IP 地址：`192.168.75.1`。确保下拉列表中选择`24`。在进行适用更改后，单击**保存**按钮。

![设置](img/7744OS_10_09.jpg)

我们可以在 OPT1 接口上启用 DHCP 服务器。在左侧导航菜单上选择**DHCP 服务器**，然后在**服务：DHCP 服务器**下选择**OPT1**选项卡。选中启用此端口上的 DHCP 服务的复选框，并将**范围**输入为`192.168.75.100`至`192.168.75.150`。选择完您的更改后，单击**保存**按钮继续。

![设置](img/7744OS_10_10.jpg)

目前还没有为 OPT1 接口设置默认规则。让我们设置一些基本规则，以允许我们在`192.168.50.0/24`中的系统对`192.168.75.0/24`中的系统进行 ping。

单击左侧导航栏中的**防火墙规则**选项，然后选择 OPT1 选项卡。选择看起来像一个加号**（+）**符号在一个圆圈内的图标，将带您到允许配置新规则的屏幕。单击此图标继续。

在这个初始规则中，我们希望允许来自任何地方的 ICMP 数据包到达 OPT1 接口。需要选择以下设置：

+   **操作：**通过

+   **接口：**OPT1

+   **协议：**ICMP

+   **ICMP**类型：任何

+   所有其他：默认设置

保存您的设置，并单击**应用**按钮以加载更改。

现在我们可以从我们的**BackTrack 机器**到我们的**目标机器**（在本例中是一个设置为接收 DHCP 地址的 Ubuntu 服务器安装）进行 traceroute。

![设置](img/7744OS_10_11.jpg)

使用 M0n0Wall 允许我们在非常有限的空间内使用许多强大的选项。当您想要在虚拟实验室环境中放置几个防火墙时，这一点就变得非常重要。

# 增加复杂性或模拟目标环境

有时模仿客户的网络以进行真实测试之前的离线测试可能会有益。这种做法有时可以让您在进行一些简单的枚举后确定最小阻力路径。

让我们看一下以下网络示例：

![增加复杂性或模拟目标环境](img/7744OS_10_12.jpg)

查看图表后，我们可以确定至少有四个已知子网、两个防火墙和六台执行各种任务的机器。还有一个位于`192.168.25.0/24`和`192.168.50.0/24`之间以及 DMZ'd Web1 服务器的 Web 应用防火墙和入侵检测系统。不需要太多讨论就能理解我们正在处理的是什么类型的企业，并让我们假设这个客户自豪地使用开源社区驱动的最新和最优秀的软件。理想情况下，我们将尽量模拟客户环境，以确定是否存在任何安全控制没有正确定位或已知经常配置错误的情况。考虑到这一点，我们将尝试使用以下配置进行模拟：

+   1 个 M0n0Wall 防火墙

+   1 个安装和配置了 IDS 和 WAF 模块的 pfSense 防火墙

+   5 台 Ubuntu 服务器系统

+   1 台运行 MySQL 的 FreeBSD 系统（例如，虚构的业务所有者透露他希望开始使用 FreeBSD 作为所有服务器的操作系统，因为他们在 FreeBSD 服务器上的良好经验）

这总共是八台虚拟服务器，如果我们在实验室中进行直接系统构建，就需要模拟。再次查看图表后，我们确定如果合并一些服务器，可以使资源更加友好。默认情况下，我们的每个虚拟单元最多可以有四个网络适配器。

### 注意

本节中有关如何进一步配置每台机器的详细说明。在到达每台机器的部分之前，不要构建这些系统。以下清单将用作所需概述。

考虑到这一点，我们将按以下方式配置我们的虚拟实验室：

+   Firewall1

+   pfSense

+   256 MB RAM

+   1 GB HDD

+   IDS

+   WAF

+   DHCP 服务

+   适配器 1：192.168.25.0/24 内部网络名称：MyLab1

+   适配器 2：192.168.50.0/24 内部网络名称：MyLab2

+   适配器 3：192.168.75.0/24 内部网络名称：MyLab3

+   Firewall2

+   M0n0Wall

+   128 MB RAM

+   200 MB HDD

+   DHCP 服务

+   适配器 1：192.168.75.0/24 内部网络名称：MyLab3

+   适配器 2：192.168.101.0/24 内部网络名称：MyLab4

+   Web1

+   Ubuntu 服务器

+   512 MB RAM

+   1 GB HDD

+   LAMP

+   适配器 1：192.168.25.0/24 内部网络名称：MyLab1

+   WordPress 3.1

+   DB1

+   FreeBSD 8.2

+   MySQL

+   256 MB RAM

+   6 GB HDD（如果资源有限，可以减少）

+   适配器 1：192.168.50.0/24 内部网络名称：MyLab2

+   适配器 2：192.168.75.0/24 内部网络名称：MyLab3

+   App1

+   Ubuntu 服务器

+   256 MB RAM

+   1 GB HDD

+   LAMP

+   适配器 1：192.168.75.0/24 内部网络名称：MyLab3

+   适配器 2：192.168.101.0/24 内部网络名称：MyLab4

+   WordPress 3.1

+   Admin1

+   Ubuntu 服务器

+   256 MB RAM

+   1 GB HDD

+   LAMP

+   适配器 2：192.168.101.0/24 内部网络名称：MyLab4

+   安装了各种管理工具（Wireshark、Nmap 等）

这使我们总共需要 1664 MB 的 RAM 和超过 10 GB 的 HDD。大多数现代系统能够处理这种类型的虚拟网络，但如果您的系统无法处理，请根据需要有策略地减少 RAM 或 HDD 的数量。

### 注意

请注意，这不包括为您的 BackTrack 机器或主机机器保留的任何 RAM 或 HDD 空间。如果您有 16 GB 的 RAM，请不要将所有 RAM 分配给虚拟机，否则可能会遇到一些问题！

## 配置防火墙 1

下载并安装一个 pfSense 虚拟机，使用上述确定的设置：

+   Firewall1

+   pfSense 2.0

+   256 MB RAM

+   300 MB HDD

+   IDS

+   WAF

+   DHCP 服务

+   适配器 1：192.168.25.0/24 内部网络名称：MyLab1

+   适配器 2：192.168.50.0/24 内部网络名称：MyLab2

+   适配器 3：192.168.75.0/24 内部网络名称：MyLab3

请确保使用与 FreeBSD 兼容的适配器类型，以避免任何问题。我们不会再次审查设置 pfSense 基本适配器配置，因为在之前的章节中已经详细介绍过。一旦基本配置完成，您应该得到类似以下的结果：

![配置防火墙 1](img/7744OS_10_013.jpg)

一旦 IP 地址配置完成，设置应该如下所示：

![配置防火墙 1](img/7744OS_10_014.jpg)

使用 BackTrack 虚拟机连接到其中一个网络，并配置以下 pfSense Web 控制台设置：

+   DHCP 服务器：启用 X.X.X.100 X.X.X.150 范围内的所有接口。

+   创建一个规则，允许从 192.168.25.0/24（WAN）到 192.168.50.0/24（LAN）的 ICMP、80、443、53、161、25、22、23 和 21 TCP/UDP。删除现有的 WAN 规则。

+   创建一个规则，允许所有来自 192.168.50.0/24（LAN）到 192.168.75.0/24（OPT1）的流量。

+   允许所有来自 LAN 到 WAN 接口的流量。

这是一个正在进行中的工作示例，用于设置 LAN 的防火墙 1 规则：

![配置防火墙 1](img/7744OS_10_015.jpg)

### 在 pfSense 中安装额外软件包

防火墙 1 还列出了 IDS 和 WAF。我们可以使用 pfSense 提供给我们的软件包管理器在系统上安装这些额外的功能。

### 注意

pfSense 系统需要临时访问互联网才能访问和下载这些软件包。这可以通过 NAT 进行配置。在连接到互联网之前，请确保禁用任何其他测试机器。启用 WAN 接口上的互联网将使使用防火墙 1 的所有系统都能访问互联网！还要注意，在从内部网络切换到 NAT 之前，机器需要关闭。

1.  点击**系统** | **软件包**，选择**可用软件包**选项卡。

1.  选择**带有 mod_security 的代理服务器**并安装。![在 pfSense 中安装额外软件包](img/7744OS_10_016.jpg)

1.  选择**Snort**软件包并安装。![在 pfSense 中安装额外软件包](img/7744OS_10_017.jpg)

### 提示

花一些时间熟悉一键安装软件包，这些软件包可与 pfSense 一起使用。使用这些软件安装的便利性和出色选择的可用性使得安装这些软件快速高效。

每个安装的软件包都将添加到**服务**菜单中，以供进一步配置。更新软件包并根据需要进行配置。由于我们不知道这个虚构练习中的客户如何配置 WAF 或 IDS，我们可以假设默认设置正在使用，直到我们执行初始枚举时，我们可以更接近地模拟被攻击的环境。

## 防火墙 2 的设置和配置

我们需要设置一个 M0n0wall 虚拟实例，如下所示：

+   防火墙 2

+   M0n0Wall

+   128 MB RAM

+   200 MB 硬盘

+   DHCP 服务

+   适配器 1：192.168.75.0/24 内部网络名称：MyLab3

+   适配器 2：192.168.101.0/24 内部网络名称：MyLab4

由于我们已经在本章中讨论了如何设置 M0n0wall，我们将跳过到下一个机器类型。

## Web1

从典型的软件仓库下载并安装 Ubuntu Server 10.04。虚拟机需要定义如下：

+   Web1

+   Ubuntu 服务器

+   主机名：Web1

+   512 MB RAM

+   1 GB 硬盘

+   LAMP

+   OpenSSH

+   适配器 1：192.168.25.0/24 内部网络名称：MyLab1

一旦机器安装、更新和配置完成，我们将需要安装 WordPress。

### 注意

Ubuntu 网站提供了出色的资源，帮助进行直观的安装。

在 Ubuntu 服务器中安装 WordPress 可能很简单；在[`codex.wordpress.org/Installing_WordPress#Famous_5-Minute_Install`](http://codex.wordpress.org/Installing_WordPress#Famous_5-Minute_Install)上有很好的说明。总结一下，您可以简单地`wget`包在[`wordpress.org/latest.tar.gz`](http://wordpress.org/latest.tar.gz)，解压缩然后将其移动到服务器上的`/var/www`目录。这将使您能够通过`http://192.168.25.100/wordpress`访问 WordPress 安装，如果您已经按照之前的说明进行操作。请记住，这个练习的目标是了解如何创建一个模拟，模拟常见配置中所发现的情况。在这种情况下，数据库是抽象的，并存储在 FreeBSD 机器上。这允许更精细地控制谁以及谁对网络上的特定数据有访问权限。这也使得攻击者更难以间接访问机器，并且通常足以防止对机器本身的直接攻击（攻击者将使用 SQL 注入和其他基于 Web 应用程序的缺陷来访问和控制系统，而不是直接针对它）。

## DB1

DB1 是一个非常基本的 FreeBSD 8.2 安装，只运行 MySQL 服务器、Telnet 和 SSH 作为服务。在[`www.freebsd.org/where.html`](http://www.freebsd.org/where.html)获取 ISO 并使用以下虚拟机设置安装机器。请注意，该机器是多宿主的，可由管理员在`192.168.101.0/24`段直接管理。在理想的情况下，您还应该将对该机器的直接访问限制为仅限管理员和 Web1 服务器的 MySQL 端口、Telnet 端口和 SSH 端口。

+   DB1

+   FreeBSD 8.2

+   MySQL

+   256 MB RAM

+   6 GB 硬盘（如果资源有限，可以减少）

+   适配器 1：192.168.50.0/24 内部网络名称：MyLab2

+   适配器 2：192.168.75.0/24 内部网络名称：MyLab3

系统设置和配置完成后，应将其用作 Web1 和 App1 实例的 MySQL 数据库服务器，使用`WP_production`和`WP_Test`数据库。

## App1

这基本上是 Web1 服务器的克隆。在典型的环境中，这台机器可能会有最新和最好的可用更改，这也意味着它可能不像位于 DMZ 中的服务器那样安全。这是进一步入侵网络的绝佳目标，因为许多管理员不会使用强密码，或者这些系统上使用的证书可能不符合野外所见的标准。

+   App1

+   Ubuntu 服务器

+   256 MB RAM

+   1 GB 硬盘

+   LAMP

+   适配器 1：192.168.75.0/24 内部网络名称：MyLab3

+   适配器 2：192.168.101.0/24 内部网络名称：MyLab4

+   WordPress 3.1

只需使用 VirtualBox 的克隆机制创建此机器，重命名适当的项目，并确保重置适配器 MAC 地址。您还需要适当地分配 VirtualBox 中的**网络适配器**。

## Admin1

由于这台机器很可能包含许多工具和关键数据，因此您应该确保包括诸如 Nmap、WireShark 等管理员通常使用的一些强大工具。这台机器将用作管理员在网络上执行不同管理任务的管理工具和岛屿。玩得开心，并安装 Ubuntu 服务器和您感到舒适的任何服务或软件。理想情况下，在这一点上，您在真实测试期间进行的枚举工作将为您提供更多关于这个系统的信息，以便您可以更接近地模拟它。网络中的许多系统可能会有规则，允许从这个系统直接访问，而不管网络位置如何。

例如，构建一个符合以下规格的 Ubuntu 服务器：

+   管理员用户

+   Ubuntu 服务器

+   256 MB RAM

+   1 GB 硬盘

+   LAMP

+   适配器 1：192.168.101.0/24 内部网络名称：MyLab4

+   安装了各种管理工具（Wireshark、Nmap 等）

到目前为止，您应该拥有一个功能齐全的多层环境，它在某种程度上模仿了在较小的商店中经常发现的环境。要测试真正安全的网络，您还必须添加额外的模块，并依靠严格监控的日志、文件完整性检查、基于网络的防病毒扫描（在 pfSense 上尝试！）等。无论有多少安全控件，它们都必须共同工作才能完全发挥作用。通过辛勤工作和开箱即用的思维，渗透测试人员将把这些环境推向极限，并确定客户是否得到了充分的保护（或者没有……）。

# 总结

在本章中，我们回顾了设置各种类型的虚拟实验室。几乎可以使用常见的可用工具和足够的资源来模拟几乎任何类型的虚拟环境。这对于使用开源软件的任何系统尤其如此，因为它是 readily available 并且不需要购买许可证（通常取决于软件是什么）。

我们还了解了 pfSense 的功能以及如何利用它更紧密地模拟在测试高度安全网络时会遇到的环境类型。使用这些技术可以轻松安装和配置 WAF、IDS、IPS，甚至反向代理。

我们还介绍了 M0n0wall 的安装和配置，这对于资源有限且需要小的占地面积时非常合适。一些渗透测试人员已经建立了跨越多台主机和数百个虚拟机的测试实验室。这对大多数人来说可能超出了必要性，但可以以低成本实现这一点的事实仍然存在。

在下一章中，我们将创建一个非常特殊的实验室，旨在模拟真实的渗透测试。您将需要使用本书中讨论的所有方法（可能还有更多，因为没有一本书可以涵盖渗透测试中涉及的所有内容！）来测试虚构公司的始终。

下一章见！
